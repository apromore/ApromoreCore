<?xml version="1.0" encoding="utf-8"?>
<project name="Apromore - Eclipse Virgo Deployment" default="deploy-virgo">

    <description>
        Supports deployment of Apromore to Eclipse Virgo.
    </description>

    <!-- Per-site properties (network address, directories to use, etc) -->
    <property file="site.properties"/>

    <!-- Change this property to select a different database plugin for Deployment!
         You also need to make sure that the correct JDBC Driver JAR (compatible with OSGi) is available. -->
    <property name="database-name" value="mysql"/>

    <!-- Folders used to build and deploy dependencies for Apromore. -->
    <property name="dir-sups" location="${basedir}/Supplements"/>
    <property name="dir-sups-lib" location="${dir-sups}/libraries"/>
    <property name="dir-extras" location="${basedir}/Apromore-Extras"/>
    <property name="dir-extras-build-tools" location="${dir-extras}/Build-Tools"/>
    <property name="dir-extras-test-tools" location="${dir-extras}/Test-Tools"/>

    <!--  URL of the automatically downloaded and installed Eclipse Virgo -->
    <property name="virgo-url" value="https://github.com/apromore/ApromoreDev/blob/master/software/virgo-tomcat-server-3.6.2.RELEASE.zip?raw=true"/>
    <property name="dir-deployment" location="${basedir}/Apromore-Assembly"/>
    <property name="dir-virgo" location="${dir-deployment}/virgo-tomcat-server-3.6.2.RELEASE"/>

    <!-- Locations of all the plugins. as they should be separate to the Web App PAR. -->
    <property name="dir-plugins" location="${basedir}/Apromore-Plugins/"/>
    <property name="dir-annotation" location="${basedir}/Apromore-Plugins/plugin-annotation/"/>
    <property name="dir-canoniser" location="${basedir}/Apromore-Plugins/plugin-canoniser/"/>
    <property name="dir-deploy" location="${basedir}/Apromore-Plugins/plugin-deployment/"/>
    <property name="dir-metric" location="${basedir}/Apromore-Plugins/plugin-toolbox/plugin-metric/"/>
    <property name="dir-osgi" location="${basedir}/Apromore-OSGI-Bundles/"/>

    <fileset id="pickupRepo" dir=".">
        <include name="Apromore-Assembly/Filestore-Assembly/src/main/resources/org.apromore.filestore.plan"/>
        <include name="Apromore-Assembly/Manager-Assembly/src/main/resources/org.apromore.manager.plan"/>
        <include name="Apromore-Assembly/Portal-Assembly/src/main/resources/org.apromore.portal.plan"/>
    </fileset>

    <fileset id="usrRepo" dir=".">
        <include name="Apromore-Assembly/**/repository/usr/*.jar"/>
        <include name="Apromore-Assembly/**/repository/usr/*.war"/>
    </fileset>

    <fileset id="webAppRepo" dir=".">
        <include name="Apromore-Editor/target/*.war"/>
    </fileset>




    <!-- Project Setup -->
    <target name="apromore-pre-build" depends="apromore-load-libs, apromore-build-tools, apromore-site-config"/>

    <target name="apromore-load-libs">
        <!-- Load the Libraries that aren't found in the Maven Central Repo or any other -->
        <exec dir="${dir-sups-lib}/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="upload.bat"/>
        </exec>
        <exec dir="${dir-sups-lib}" executable="./upload.sh" osfamily="unix" />
    </target>

    <target name="apromore-build-tools">
        <!-- Build the tools required for the main Apromore product. -->
        <exec dir="${dir-extras-build-tools}" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="mvn"/>
            <arg value="clean"/>
            <arg value="install"/>
        </exec>
        <exec dir="${dir-extras-test-tools}" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="mvn"/>
            <arg value="clean"/>
            <arg value="install"/>
        </exec>
        <exec dir="${dir-extras-build-tools}" executable="mvn" osfamily="unix">
            <arg value="clean"/>
            <arg value="install"/>
        </exec>
        <exec dir="${dir-extras-test-tools}" executable="mvn" osfamily="unix">
            <arg value="clean"/>
            <arg value="install"/>
        </exec>
    </target>

    <target name="apromore-site-config">
        <!-- Substitute fields from site.properties into lower level configuration files -->
        <copy file="Apromore-FileStore/src/main/webapp/WEB-INF/web.xml_template"
            tofile="Apromore-FileStore/src/main/webapp/WEB-INF/web.xml"
            overwrite="true">
            <filterset>
                <filter token="FILESTORE_DIR" value="${filestore.dir}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Clients/manager-client/src/main/resources/apromore-manager-client.properties_template"
            tofile="Apromore-Clients/manager-client/src/main/resources/apromore-manager-client.properties"
            overwrite="true">
            <filterset>
                <filter token="SITE_HOST" value="${site.host}"/>
                <filter token="SITE_PORT" value="${site.port}"/>
                <filter token="SITE_EXTERNALPORT" value="${site.externalport}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Clients/portal-client/src/main/resources/apromore-portal-client.properties_template"
            tofile="Apromore-Clients/portal-client/src/main/resources/apromore-portal-client.properties"
            overwrite="true">
            <filterset>
                <filter token="SITE_HOST" value="${site.host}"/>
                <filter token="SITE_PORT" value="${site.port}"/>
                <filter token="SITE_EXTERNALPORT" value="${site.externalport}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Clients/filestore-client/src/main/resources/apromore-filestore-client.properties_template"
            tofile="Apromore-Clients/filestore-client/src/main/resources/apromore-filestore-client.properties"
            overwrite="true">
            <filterset>
                <filter token="SITE_HOST" value="${site.host}"/>
                <filter token="SITE_PORT" value="${site.port}"/>
                <filter token="SITE_EXTERNALPORT" value="${site.externalport}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Manager/src/main/resources/apromore-manager.properties_template"
            tofile="Apromore-Manager/src/main/resources/apromore-manager.properties"
            overwrite="true">
            <filterset>
                <filter token="SITE_HOST" value="${site.host}"/>
                <filter token="SITE_PORT" value="${site.port}"/>

                <filter token="JDBC_DRIVER"   value="${jdbc.driver}"/>
                <filter token="JDBC_URL"      value="${jdbc.url}"/>
                <filter token="JDBC_USERNAME" value="${jdbc.username}"/>
                <filter token="JDBC_PASSWORD" value="${jdbc.password}"/>

                <filter token="JPA_DATABASE"          value="${jpa.database}"/>
                <filter token="JPA_DATABASE_PLATFORM" value="${jpa.databasePlatform}"/>
                <filter token="JPA_SHOW_SQL"          value="${jpa.showSql}"/>
                <filter token="JPA_GENERATE_DDL"      value="${jpa.generateDDL}"/>

                <filter token="PQL_ENABLE_INDEXING"         value="${pql.enableIndexing}"/>
                <filter token="PQL_LABEL_SIMILARITY_SEARCH" value="${pql.labelSimilaritySearch}"/>
                <filter token="PQL_LOLA_DIR"                value="${pql.lola.dir}"/>
                <filter token="PQL_MYSQL_URL"               value="${pql.mysql.url}"/>
                <filter token="PQL_MYSQL_USER"              value="${pql.mysql.user}"/>
                <filter token="PQL_MYSQL_PASSWORD"          value="${pql.mysql.password}"/>
                <filter token="PQL_POSTGRES_HOST"           value="${pql.postgres.host}"/>
                <filter token="PQL_POSTGRES_NAME"           value="${pql.postgres.name}"/>
                <filter token="PQL_POSTGRES_USER"           value="${pql.postgres.user}"/>
                <filter token="PQL_POSTGRES_PASSWORD"       value="${pql.postgres.password}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Manager/src/test/resources/META-INF/spring/applicationContext-services-TEST.xml_template"
            toFile="Apromore-Manager/src/test/resources/META-INF/spring/applicationContext-services-TEST.xml"
            overwrite="true">
            <filterset>
                <filter token="PQL_LOLA_DIR" value="${pql.lola.dir}"/>
                <filter token="PQL_MYSQL_URL" value="${pql.mysql.url}"/>
                <filter token="PQL_MYSQL_USER" value="${pql.mysql.user}"/>
                <filter token="PQL_MYSQL_PASSWORD" value="${pql.mysql.password}"/>
            </filterset>
        </copy>
        <copy file="Apromore-Portal/src/main/resources/apromore-portal.properties_template"
            tofile="Apromore-Portal/src/main/resources/apromore-portal.properties"
            overwrite="true">
            <filterset>
                <filter token="SITE_HOST" value="${site.host}"/>
                <filter token="SITE_PORT" value="${site.port}"/>
            </filterset>
        </copy>
    </target>


    <!-- Virgo Related -->
    <target name="setup-virgo" depends="download-virgo, configure-virgo"/>

    <target name="check-virgo">
        <condition property="virgo.installed">
            <available file="${dir-virgo}" type="dir"/>
        </condition>
    </target>

    <target name="download-virgo" depends="check-virgo" unless="virgo.installed">
        <mkdir dir="${dir-deployment}"/>
        <get src="${virgo-url}" dest="${dir-deployment}/virgo.zip"/>
        <unzip src="${dir-deployment}/virgo.zip" dest="${dir-deployment}"/>
        <delete file="${dir-deployment}/virgo.zip"/>
    </target>

    <target name="configure-virgo" depends="check-virgo" if="virgo.installed">
        <copy todir="${dir-virgo}/repository/ext" overwrite="true">
            <fileset dir="Supplements/Virgo">
                <filename name="org.eclipse.virgo.web.properties"/>
            </fileset>
        </copy>
        <copy todir="${dir-virgo}/configuration" overwrite="true">
            <fileset dir="Supplements/Virgo">
                <include name="tomcat-server.xml"/>
                <include name="java6-server.profile"/>
            </fileset>
        </copy>
        <chmod file="${dir-virgo}/bin/*.sh" perm="ugo+rx" osfamily="unix"/>
    </target>

    <target name="clean-virgo" depends="check-virgo" if="virgo.installed">
        <delete includeemptydirs="true">
            <fileset dir="${dir-virgo}">
                <include name="repository/usr/*.jar"/>
            </fileset>
        </delete>
        <delete includeemptydirs="true">
            <fileset dir="${dir-virgo}">
                <include name="logs/*"/>
            </fileset>
        </delete>
        <delete includeemptydirs="true">
            <fileset dir="${dir-virgo}">
                <include name="pickup/*.jar"/>
                <include name="pickup/*.war"/>
                <include name="pickup/*.par"/>
                <include name="pickup/*.plan"/>
                <exclude name="pickup/org.eclipse.virgo.apps.repository_3.6.2.RELEASE.par"/>
                <exclude name="pickup/org.eclipse.virgo.apps.splash_3.6.2.RELEASE.jar"/>
                <exclude name="pickup/org.eclipse.virgo.management.console_3.6.2.RELEASE.jar"/>
            </fileset>
        </delete>
    </target>

    <target name="dist-virgo" depends="clean-virgo, setup-virgo, copy-virgo, deploy-virgo">
        <zip destfile="Apromore.zip" includes="${dir-virgo}/*"/>
    </target>

    <target name="deploy-virgo" depends="clean-virgo, setup-virgo, copy-virgo"/>

    <target name="set-permissions" depends="setup-virgo">
        <chmod file="${dir-virgo}/bin/*.sh" perm="ugo+rx" osfamily="unix"/>
    </target>

    <target name="clean-start-virgo" depends="set-permissions">
        <exec dir="${dir-virgo}/bin/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="startup.bat"/>
            <arg line="-clean"/>
        </exec>
        <exec dir="${dir-virgo}/bin/" executable="./startup.sh" osfamily="unix">
            <arg line="-clean"/>
        </exec>
    </target>

    <target name="start-virgo" depends="set-permissions,copy-virgo">
        <exec dir="${dir-virgo}/bin/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="startup.bat"/>
            <arg line="-clean"/>
        </exec>
        <exec dir="${dir-virgo}/bin/" executable="./startup.sh" osfamily="unix">
            <arg line="-clean"/>
        </exec>
    </target>

    <target name="debug-virgo" depends="set-permissions,copy-virgo">
        <exec dir="${dir-virgo}/bin/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="startup.bat"/>
            <arg line="-clean -debug 8002"/>
        </exec>
        <exec dir="${dir-virgo}/bin/" executable="./startup.sh" osfamily="unix">
            <arg line="-clean -debug"/>
        </exec>
    </target>

    <target name="debug" depends="set-permissions">
        <exec dir="${dir-virgo}/bin/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="startup.bat"/>
            <arg line="-clean -debug"/>
        </exec>
        <exec dir="${dir-virgo}/bin/" executable="./startup.sh" osfamily="unix">
            <arg line="-clean -debug"/>
        </exec>
    </target>

    <target name="stop-virgo" depends="setup-virgo">
        <exec dir="${dir-virgo}/bin/" executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="shutdown.bat"/>
        </exec>
        <exec dir="${dir-virgo}/bin/" executable="./shutdown.sh" osfamily="unix">
        </exec>
    </target>

    <target name="copy-virgo" depends="clean-virgo">
        <copy todir="${dir-virgo}/repository/usr" flatten="true" overwrite="true">
            <fileset refid="usrRepo"/>
        </copy>
        <copy todir="${dir-virgo}/pickup" flatten="true" overwrite="true">
            <fileset refid="webAppRepo"/>
            <fileset refid="pickupRepo"/>
        </copy>
        <copy todir="${dir-virgo}/pickup" flatten="true" overwrite="true">
            <fileset dir="${dir-annotation}">
                <include name="**/target/*.jar"/>
                <exclude name="**/target/*-sources.jar"/>
                <exclude name="**/core/**/*.jar"/>
            </fileset>
            <fileset dir="${dir-canoniser}">
                <include name="**/target/*.jar"/>
                <exclude name="**/target/*-sources.jar"/>
                <exclude name="**/core/**/*.jar"/>
            </fileset>
            <fileset dir="${dir-deploy}">
                <include name="**/target/*.jar"/>
                <exclude name="**/target/*-sources.jar"/>
                <exclude name="**/core/**/*.jar"/>
            </fileset>
            <fileset dir="${dir-metric}">
                <include name="**/target/*.jar"/>
                <exclude name="**/target/*-sources.jar"/>
                <exclude name="**/core/**/*.jar"/>
            </fileset>
        </copy>
    </target>

</project>
