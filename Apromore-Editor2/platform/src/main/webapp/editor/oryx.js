/**
 * Copyright (c) 2006
 * 
 * Philipp Berger, Martin Czuchra, Gero Decker, Ole Eckermann, Lutz Gericke,
 * Alexander Hold, Alexander Koglin, Oliver Kopp, Stefan Krumnow, 
 * Matthias Kunze, Philipp Maschke, Falko Menge, Christoph Neijenhuis, 
 * Hagen Overdick, Zhen Peng, Nicolas Peters, Kerstin Pfitzner, Daniel Polak,
 * Steffen Ryll, Kai Schlichting, Jan-Felix Schwarz, Daniel Taschik, 
 * Willi Tscheschner, BjÃ¶rn Wagner, Sven Wagner-Boysen, Matthias Weidlich
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 * 
 * 
 *
 * Ext JS (http://extjs.com/) is used under the terms of the Open Source LGPL 3.0
 * license.
 * The license and the source files can be found in our SVN repository at:
 * http://oryx-editor.googlecode.com/.
 **/ORYX.Utils={getParamFromUrl:function(c){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+c+"=([^&#]*)";var e=new RegExp(a);var d=e.exec(window.location.href);if(d==null){return null}else{return d[1]}},isGlossaryEntry:function(c){return typeof c==="string"&&(this.isOldGlossarySchema(c)||c.startsWith("/glossary/"))},isOldGlossarySchema:function(c){return typeof c==="string"&&!!c.match(/\glossary\:\/\/.+\/[\w\W]+\;\;/g)},getGlossaryId:function(c){if(ORYX.Utils.isOldGlossarySchema(c)){return(c||"").split(";;").invoke("replace",/\glossary\:\/\//g,"").invoke("replace",/\/[\w\W]+/g,"").first()}return""},glossaryTitle:function(c){if(ORYX.Utils.isOldGlossarySchema(c)){return(c||"").replace(/;;$/,"").replace(/\glossary\:\/\/.+?\//g,"")}return""},getInGlossarySchema:function(c,d){c=(c||"").replace(/([\/]|glossary)/g,"");return"glossary://"+c+"/"+d+";;"},isIPad:function(){return !!Ext.isIPad},getBrowserVersion:function(){var c=window.navigator.userAgent.toLowerCase();var a="";if(Ext.isIE){a=window.navigator.userAgent.toLowerCase().match(/msie.+?;/g).first().replace(/[^0-9\.]/g,"")}else{a=window.navigator.userAgent.toLowerCase().split(/\//g).last().split(/\s/g).first().replace(/[^0-9\.]/g,"")}a=(a.match(/[0-9]+\.[0-9]+/)||["xxx"]).first();return a},isMetaKey:function(c){return !!(c.shiftKey||c.ctrlKey||c.metaKey)},buildGetColorForLabel:function(c){return ORYX.Utils.createGenericPropertyCheck(c,"color","value","")},buildIsRichtextForLabel:function(c){return ORYX.Utils.createGenericPropertyCheck(c,"string","richtextEnabled",false)},createGenericPropertyCheck:function(h,l,m,g){var f=h.properties().select(function(a){return a.type().toLowerCase()===l.toLowerCase()});if(f.length===0){return function(){return g}}return function(d){var a=d.id;var c=f.find(function(e){return e.refToView().find(function(n){return a.endsWith(n)})});if(c&&c[m] instanceof Function){return c[m]()}return g}},rgbToHsl:function(u,q,h){u/=255;q/=255;h/=255;var g=Math.max(u,q,h),s=Math.min(u,q,h);var r,d,t=(g+s)/2;if(g==s){r=d=0}else{var l=g-s;d=t>0.5?l/(2-g-s):l/(g+s);switch(g){case u:r=(q-h)/l+(q<h?6:0);break;case q:r=(h-u)/l+2;break;case h:r=(u-q)/l+4;break}r/=6}return[r,d,t]},hslToRgb:function(p,g,q){var u,l,h;if(g==0){u=l=h=q}else{function r(c,d,a){if(a<0){a+=1}if(a>1){a-=1}if(a<1/6){return c+(d-c)*6*a}if(a<1/2){return d}if(a<2/3){return c+(d-c)*(2/3-a)*6}return c}var t=q<0.5?q*(1+g):q+g-q*g;var s=2*q-t;u=r(s,t,p+1/3);l=r(s,t,p);h=r(s,t,p-1/3)}return[Math.round(u*255),Math.round(l*255),Math.round(h*255)]},adjustLightness:function(s,o){if(!s){return""}else{if(o===1){return s}else{if(o===0){return"#ffffff"}}}s=s.length===7&&s[0]==="#"?s:"#ffffff";var u=Math.min(255,parseInt(s[1]+s[2],16));var r=Math.min(255,parseInt(s[3]+s[4],16));var p=Math.min(255,parseInt(s[5]+s[6],16));var l=ORYX.Utils.rgbToHsl(u,r,p);var t=l[2];l[2]=0.15*Math.tan(2.4*l[2]+1.8)+0.8;var q=ORYX.Utils.hslToRgb(l[0],l[1],(l[2]>1?t:l[2]));var g=[parseInt(Math.min(255,q[0])),parseInt(Math.min(255,q[1])),parseInt(Math.min(255,q[2]))].map(function(a){return(a<16?"0":"")+a.toString(16)});return"#"+g.join("")},adjustGradient:function(r,g){if(!r){return}var q=g.getAttributeNS(null,"stop-color")||"#ffffff";q=q.length===7&&q[0]==="#"?q:"#ffffff";var s=Math.min(255,parseInt(q[1]+q[2],16));var o=Math.min(255,parseInt(q[3]+q[4],16));var l=Math.min(255,parseInt(q[5]+q[6],16));var p=ORYX.Utils.rgbToHsl(s,o,l);p[2]=Math.min(p[2]+(0.9*p[2])+(p[2]<=0.2?(2-p[2])*0.2:0),1);var m=ORYX.Utils.hslToRgb(p[0],p[1],p[2]);var d=function(c){var a=[Math.min(255,m[0]),Math.min(255,m[1]),Math.min(255,m[2])].map(function(e){return(e<16?"0":"")+e.toString(16)});return"#"+a.join("")};$A(r.getElementsByTagName("stop")).each(function(a,c){if(c==a||(c.getAttributeNS(null,"class")||"").include("ignore-adjust")){return}c.setAttributeNS(null,"stop-color",d("#FFFFFF"))}.bind(this,g))}};XMLNS={ATOM:"http://www.w3.org/2005/Atom",XHTML:"http://www.w3.org/1999/xhtml",ERDF:"http://purl.org/NET/erdf/profile",RDFS:"http://www.w3.org/2000/01/rdf-schema#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RAZIEL:"http://b3mn.org/Raziel",SCHEMA:""};var Kickstart={started:false,callbacks:[],alreadyLoaded:[],PATH:"",load:function(){Kickstart.kick()},kick:function(){if(!Kickstart.started){Kickstart.started=true;Kickstart.callbacks.each(function(a){window.setTimeout(a,1)})}},register:function(callback){with(Kickstart){if(started){window.setTimeout(callback,1)}else{Kickstart.callbacks.push(callback)}}},require:function(a){if(Kickstart.alreadyLoaded.member(a)){return false}return Kickstart.include(a)},include:function(a){var c=document.getElementsByTagNameNS(XMLNS.XHTML,"head")[0];var d=document.createElementNS(XMLNS.XHTML,"script");d.setAttributeNS(XMLNS.XHTML,"type","text/javascript");d.src=Kickstart.PATH+a;c.appendChild(d);Kickstart.alreadyLoaded.push(a);return true}};Event.observe(window,"load",Kickstart.load);var ERDF={LITERAL:1,RESOURCE:2,DELIMITERS:[".","-"],HASH:"#",HYPHEN:"-",schemas:[],callback:undefined,log:undefined,init:function(a){ERDF.callback=a;ERDF.registerSchema("schema",XMLNS.SCHEMA);ERDF.registerSchema("rdfs",XMLNS.RDFS)},run:function(){return ERDF._checkProfile()&&ERDF.parse()},parse:function(){ERDF.__startTime=new Date();var c=document.getElementsByTagNameNS(XMLNS.XHTML,"body");var d={type:ERDF.RESOURCE,value:""};var a=ERDF._parseDocumentMetadata()&&ERDF._parseFromTag(c[0],d);ERDF.__stopTime=new Date();var e=(ERDF.__stopTime-ERDF.__startTime)/1000;return a},_parseDocumentMetadata:function(){var c=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=c[0].getElementsByTagNameNS(XMLNS.XHTML,"link");var d=c[0].getElementsByTagNameNS(XMLNS.XHTML,"meta");$A(a).each(function(f){var e=f.getAttribute("rel");var h=f.getAttribute("rev");var g=f.getAttribute("href");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",e,ERDF.RESOURCE,g);ERDF._parseTriplesFrom(ERDF.RESOURCE,g,h,ERDF.RESOURCE,"")});$A(d).each(function(g){var f=g.getAttribute("name");var e=g.getAttribute("content");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",f,ERDF.LITERAL,e)});return true},_parseFromTag:function(d,m,e){if(d.namespaceURI!=XMLNS.XHTML){return}if(!e){e=0}var a=d.getAttribute("id");if(d.nodeName.endsWith(":a")||d.nodeName=="a"){var l=d.getAttribute("rel");var f=d.getAttribute("rev");var p=d.getAttribute("href");var o=d.getAttribute("title");var h=d.textContent;ERDF._parseTriplesFrom(m.type,m.value,l,ERDF.RESOURCE,p,function(r){var q=o?o:h;ERDF._parseTriplesFrom(r.object.type,r.object.value,"rdfs.label",ERDF.LITERAL,q)});ERDF._parseTriplesFrom(m.type,m.value,f,ERDF.RESOURCE,"");ERDF._parseTypeTriplesFrom(m.type,m.value,l)}else{if(d.nodeName.endsWith(":img")||d.nodeName=="img"){var l=d.getAttribute("class");var p=d.getAttribute("src");var g=d.getAttribute("alt");ERDF._parseTriplesFrom(m.type,m.value,l,ERDF.RESOURCE,p,function(r){var q=g;ERDF._parseTriplesFrom(r.object.type,r.object.value,"rdfs.label",ERDF.LITERAL,q)})}}var l=d.getAttribute("class");var o=d.getAttribute("title");var h=d.textContent;var n=o?o:h;ERDF._parseTriplesFrom(m.type,m.value,l,ERDF.LITERAL,n);if(a){m={type:ERDF.RESOURCE,value:ERDF.HASH+a}}ERDF._parseTypeTriplesFrom(m.type,m.value,l);var c=d.childNodes;if(c){$A(c).each(function(q){if(q.nodeType==q.ELEMENT_NODE){ERDF._parseFromTag(q,m,e+1)}})}},_parseTriplesFrom:function(d,f,e,a,c,g){if(!e){return}e.toLowerCase().split(" ").each(function(l){var h=ERDF.schemas.find(function(n){return false||ERDF.DELIMITERS.find(function(o){return l.startsWith(n.prefix+o)})});if(h&&c){l=l.substring(h.prefix.length+1,l.length);var m=ERDF.registerTriple(new ERDF.Resource(f),{prefix:h.prefix,name:l},(a==ERDF.RESOURCE)?new ERDF.Resource(c):new ERDF.Literal(c));if(g){g(m)}}})},_parseTypeTriplesFrom:function(a,d,c,e){if(!c){return}c.toLowerCase().split(" ").each(function(g){var f=ERDF.schemas.find(function(l){return false||ERDF.DELIMITERS.find(function(m){return g.startsWith(ERDF.HYPHEN+l.prefix+m)})});if(f&&d){g=g.substring(f.prefix.length+2,g.length);var h=ERDF.registerTriple((a==ERDF.RESOURCE)?new ERDF.Resource(d):new ERDF.Literal(d),{prefix:"rdf",name:"type"},new ERDF.Resource(f.namespace+g));if(e){e(h)}}})},_checkProfile:function(){var c=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=c[0].getAttribute("profile");var d=false;if(a&&a.split(" ").member(XMLNS.ERDF)){return true}else{return false}},__stripHashes:function(a){return(a&&a.substring(0,1)=="#")?a.substring(1,a.length):a},registerSchema:function(c,a){ERDF.schemas.push({prefix:c,namespace:a})},registerTriple:function(d,a,c){if(a.prefix.toLowerCase()=="schema"){this.registerSchema(a.name,c.value)}var e=new ERDF.Triple(d,a,c);ERDF.callback(e);return e},__enhanceObject:function(){this.isResource=function(){return this.type==ERDF.RESOURCE};this.isLocal=function(){return this.isResource()&&this.value.startsWith("#")};this.isCurrentDocument=function(){return this.isResource()&&(this.value=="")};this.getId=function(){return this.isLocal()?ERDF.__stripHashes(this.value):false};this.isLiteral=function(){return this.type==ERDF.LIITERAL}},serialize:function(a){if(!a){return""}else{if(a.constructor==String){return a}else{if(a.constructor==Boolean){return a?"true":"false"}else{return a.toString()}}}}};ERDF.Triple=function(d,a,c){this.subject=d;this.predicate=a;this.object=c;this.toString=function(){return"[ERDF.Triple] "+this.subject.toString()+" "+this.predicate.prefix+":"+this.predicate.name+" "+this.object.toString()}};ERDF.Resource=function(a){this.type=ERDF.RESOURCE;this.value=a;ERDF.__enhanceObject.apply(this);this.toString=function(){return"&lt;"+this.value+"&gt;"}};ERDF.Literal=function(a){this.type=ERDF.LITERAL;this.value=ERDF.serialize(a);ERDF.__enhanceObject.apply(this);this.toString=function(){return'"'+this.value+'"'}};var USE_ASYNCHRONOUS_REQUESTS=true;var DISCARD_UNUSED_TRIPLES=true;var PREFER_SPANS_OVER_DIVS=true;var PREFER_TITLE_OVER_TEXTNODE=false;var RESOURCE_ID_PREFIX="resource";var SHOW_DEBUG_ALERTS_WHEN_SAVING=false;var SHOW_EXTENDED_DEBUG_INFORMATION=false;var USE_ARESS_WORKAROUNDS=true;var RESOURCE_CREATED=1;var RESOURCE_REMOVED=2;var RESOURCE_SAVED=4;var RESOURCE_RELOADED=8;var RESOURCE_SYNCHRONIZED=16;var TRIPLE_REMOVE=1;var TRIPLE_ADD=2;var TRIPLE_RELOAD=4;var TRIPLE_SAVE=8;var PROCESSDATA_REF="processdata";var DataManager={init:function(){ERDF.init(DataManager._registerTriple);DataManager.__synclocal()},_triples:[],_registerTriple:function(a){DataManager._triples.push(a)},__synclocal:function(){DataManager._triples=[];ERDF.run()},__synchronizeShape:function(a){var d=ResourceManager.getResource(a.resourceId);var c=a.serialize();c.each(function(e){var g=(e.type=="resource");var f=new ERDF.Triple(new ERDF.Resource(a.resourceId),{prefix:e.prefix,name:e.name},g?new ERDF.Resource(e.value):new ERDF.Literal(e.value));DataManager.setObject(f)});return d},__storeShape:function(a){var c=DataManager.__synchronizeShape(a);c.save()},__forceExistance:function(a){if(!$(a.resourceId)){if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}DataManager.graft(XMLNS.XHTML,$$("."+PROCESSDATA_REF)[0],["div",{id:a.resourceId,"class":(a instanceof ORYX.Core.Canvas)?"-oryx-canvas":undefined}])}else{var d=$(a.resourceId);var c=$A(d.childNodes);c.each(function(e){d.removeChild(e)})}},__persistShape:function(c){var e=c.serialize();var a=[];var d=new ERDF.Resource(c.resourceId);DataManager.removeTriples(DataManager.query(d,undefined,undefined));e.each(function(g){var f=(g.type=="resource")?new ERDF.Resource(g.value):new ERDF.Literal(g.value);DataManager.addTriple(new ERDF.Triple(d,{prefix:g.prefix,name:g.name},f))})},__persistDOM:function(e){var d=e.getCanvas();var c=d.getChildShapes(true);var a="";c.each(function(f){DataManager.__forceExistance(f)});DataManager.__renderCanvas(e);a+=DataManager.serialize($(ERDF.__stripHashes(e.getCanvas().resourceId)),true);c.each(function(f){DataManager.__persistShape(f);a+=DataManager.serialize($(ERDF.__stripHashes(f.resourceId)),true)});return a},__renderCanvas:function(f){var c=f.getCanvas();var e=f.getStencilSets();var a=c.getChildShapes(true);DataManager.__forceExistance(c);DataManager.__persistShape(c);var d=new ERDF.Resource(c.resourceId);DataManager.removeTriples(DataManager.query(d,undefined,undefined));DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"mode"},new ERDF.Literal("writable")));DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"mode"},new ERDF.Literal("fullscreen")));e.values().each(function(g){DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"stencilset"},new ERDF.Resource(g.source().replace(/&/g,"%26"))));DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"ssnamespace"},new ERDF.Resource(g.namespace())));g.extensions().keys().each(function(h){DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"ssextension"},new ERDF.Literal(h)))})});a.each(function(g){DataManager.addTriple(new ERDF.Triple(d,{prefix:"oryx",name:"render"},new ERDF.Resource("#"+g.resourceId)))})},__counter:0,__provideId:function(){while($(RESOURCE_ID_PREFIX+DataManager.__counter)){DataManager.__counter++}return RESOURCE_ID_PREFIX+DataManager.__counter},serializeDOM:function(a){return DataManager.__persistDOM(a)},syncGlobal:function(a){return DataManager.__syncglobal(a)},__syncglobal:function(d){var c=d.getCanvas();var a=c.getChildShapes(true);a.select(function(e){return !($(e.resourceId))}).each(function(e){if(USE_ARESS_WORKAROUNDS){var f=e.properties["raziel-type"];var h='<div xmlns="http://www.w3.org/1999/xhtml"><span class="raziel-type">'+f+"</span></div>";var g=ResourceManager.__createResource(h);e.resourceId=g.id()}else{var g=ResourceManager.__createResource();e.resourceId=g.id()}});a.each(function(e){DataManager.__storeShape(e)})},serialize:function(g,c){if(g.nodeType==g.ELEMENT_NODE){var f=$A(g.childNodes);var d=$A(g.attributes);var e=new String(g.getAttribute("class"));var h=e.split(" ").member("transient");if(h){return""}var a="<"+g.nodeName;if(!c){a+=' xmlns="'+(g.namespaceURI?g.namespaceURI:XMLNS.XHTML)+'" xmlns:oryx="http://oryx-editor.org"'}d.each(function(m){var l=m.nodeName,n=String(m.nodeValue||"");if(Ext.isIE9||Ext.isIE10){if(l.toLowerCase()=="preserveaspectratio"){return}if(l.toLowerCase()=="transform"&&!n.trim()){return}n=n.replace(/"/g,"'")}a+=" "+l+'="'+n+'"'});if(f.length==0){a+="/>"}else{a+=">";f.each(function(l){a+=DataManager.serialize(l,true)});a+="</"+g.nodeName+">"}return a}else{if(g.nodeType==g.TEXT_NODE){return g.nodeValue}}return""},addTriple:function(d){if(!d.subject.type==ERDF.LITERAL){throw"Cannot add the triple "+d.toString()+" because the subject is not a resource."}var a=ERDF.__stripHashes(d.subject.value);var c=$(a);if(!c){throw"Cannot add the triple "+d.toString()+' because the subject "'+a+'" is not in the document.'}if(d.object.type==ERDF.LITERAL){DataManager.graft(XMLNS.XHTML,c,["span",{"class":(d.predicate.prefix+"-"+d.predicate.name)},d.object.value.escapeHTML()])}else{DataManager.graft(XMLNS.XHTML,c,["a",{rel:(d.predicate.prefix+"-"+d.predicate.name),href:d.object.value}])}return true},removeTriples:function(c){var a=c.select(function(d){return DataManager.__removeTriple(d)});return a},removeTriple:function(c){var a=DataManager.__removeTriple(c);return a},__removeTriple:function(e){if(!e.subject.type==ERDF.LITERAL){throw"Cannot remove the triple "+e.toString()+" because the subject is not a resource."}var c=ERDF.__stripHashes(e.subject.value);var d=$(c);if(!d){throw"Cannot remove the triple "+e.toString()+" because the subject is not in the document."}if(e.object.type==ERDF.LITERAL){var a=DataManager.__removeTripleRecursively(e,d);return a}},__removeTripleRecursively:function(f,e){if(e.nodeType!=e.ELEMENT_NODE){return false}var c=new String(e.getAttribute("class"));var a=$A(e.childNodes);if(c.include(f.predicate.prefix+"-"+f.predicate.name)){var d=e.textContent;if((f.object.type==ERDF.LITERAL)&&(f.object.value==d)){e.parentNode.removeChild(e)}return true}else{a.each(function(g){DataManager.__removeTripleRecursively(f,g)});return false}},graft:function(h,g,f,m){m=(m||(g&&g.ownerDocument)||document);var l;if(f===undefined){echo("Can't graft an undefined value")}else{if(f.constructor==String){l=m.createTextNode(f)}else{for(var d=0;d<f.length;d++){if(d===0&&f[d].constructor==String){var a=f[d].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){l=m.createElementNS(h,a[1]);l.setAttributeNS(null,"class",a[2]);continue}a=f[d].match(/^([a-z][a-z0-9]*)$/i);if(a){l=m.createElementNS(h,a[1]);continue}l=m.createElementNS(h,"span");l.setAttribute(null,"class","namelessFromLOL")}if(f[d]===undefined){echo("Can't graft an undefined value in a list!")}else{if(f[d].constructor==String||f[d].constructor==Array){this.graft(h,l,f[d],m)}else{if(f[d].constructor==Number){this.graft(h,l,f[d].toString(),m)}else{if(f[d].constructor==Object){for(var c in f[d]){l.setAttributeNS(null,c,f[d][c])}}else{if(f[d].constructor==Boolean){this.graft(h,l,f[d]?"true":"false",m)}else{throw"Object "+f[d]+" is inscrutable as an graft arglet."}}}}}}}}if(g){g.appendChild(l)}return Element.extend(l)},setObject:function(a){var c=DataManager.query(a.subject,a.predicate,undefined);DataManager.removeTriples(c);DataManager.addTriple(a);return true},query:function(d,a,c){return DataManager._triples.select(function(f){var e=((d)?(f.subject.type==d.type)&&(f.subject.value==d.value):true);if(a){e=e&&((a.prefix)?(f.predicate.prefix==a.prefix):true);e=e&&((a.name)?(f.predicate.name==a.name):true)}e=e&&((c)?(f.object.type==c.type)&&(f.object.value==c.value):true);return e})}};Kickstart.register(DataManager.init);function assert(c,a){if(!c){throw a}}function DMCommand(a,c){this.action=a;this.triple=c;this.toString=function(){return"Command("+a+", "+c+")"}}function DMCommandHandler(a){this.__setNext=function(d){var c=this.__next;this.__next=a;return c?c:true};this.__setNext(a);this.__invokeNext=function(c){return this.__next?this.__next.handle(c):false};this.handle=function(c){return this.process(c)?true:this.__invokeNext(c)};this.process=function(c){return false}}function MetaTagHandler(next){DMCommandHandler.apply(this,[next]);this.process=function(command){with(command.triple){if(!((subject instanceof ERDF.Resource)&&(subject.isCurrentDocument())&&(object instanceof ERDF.Literal))){return false}}}}var chain=new MetaTagHandler();var command=new DMCommand(TRIPLE_ADD,new ERDF.Triple(new ERDF.Resource(""),"rdf:tool",new ERDF.Literal("")));ResourceManager={__corrupt:false,__latelyCreatedResource:undefined,__listeners:$H(),__token:1,addListener:function(e,c){if(!(e instanceof Function)){throw"Resource event listener is not a function!"}if(!(c)){throw"Invalid mask for resource event listener registration."}var a={listener:e,mask:c};var d=ResourceManager.__token++;ResourceManager.__listeners[d]=a;return d},removeListener:function(a){return ResourceManager.__listners.remove(a)},__Event:function(a,c){this.action=a;this.resourceId=c},__dispatchEvent:function(a){ResourceManager.__listeners.values().each(function(c){if(a.action&c.mask){return c.listener(a)}})},getResource:function(d){d=ERDF.__stripHashes(d);var c=DataManager.query(new ERDF.Resource("#"+d),{prefix:"raziel",name:"entry"},undefined);if((c.length==1)&&(c[0].object.isResource())){var a=c[0].object.value;return new ResourceManager.__Resource(d,a)}throw ("Resource with id "+d+" not recognized as such. "+((c.length>1)?" There is more than one raziel:entry URL.":" There is no raziel:entry URL."));return false},__createResource:function(f){var e=DataManager.query(new ERDF.Resource(""),{prefix:"raziel",name:"collection"},undefined);if((e.length==1)&&(e[0].object.isResource())){var c=e[0].object.value;var d=undefined;var a=f?f:'<div xmlns="http://www.w3.org/1999/xhtml"></div>';ResourceManager.__request("POST",c,a,function(){var g=(this.responseXML);var l=g.childNodes[0];var h=l.getAttribute("id");if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}$$("."+PROCESSDATA_REF)[0].appendChild(l.cloneNode(true));DataManager.__synclocal();d=new ResourceManager.getResource(h);ResourceManager.__resourceActionSucceeded(this,RESOURCE_CREATED,undefined)},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_CREATED,undefined)},false);return d}throw"Could not create resource! raziel:collection URL is missing!";return false},__Resource:function(c,a){this.__id=c;this.__url=a;this.id=function(){return this.__id};this.url=function(){return this.__url};this.reload=function(){var e=this.__url;var d=this.__id;ResourceManager.__request("GET",e,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_RELOADED,d)},function(){ResourceManager.__resourceActionFailed(this,RESURCE_RELOADED,d)},USE_ASYNCHRONOUS_REQUESTS)};this.save=function(f){var e=this.__url;var d=this.__id;data=DataManager.serialize($(d));ResourceManager.__request("PUT",e,data,function(){ResourceManager.__resourceActionSucceeded(this,f?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE_SAVED,d)},function(){ResourceManager.__resourceActionFailed(this,f?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE.SAVED,d)},USE_ASYNCHRONOUS_REQUESTS)};this.remove=function(){var e=this.__url;var d=this.__id;ResourceManager.__request("DELETE",e,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_REMOVED,d)},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_REMOVED,d)},USE_ASYNCHRONOUS_REQUESTS)}},request:function(d,a){var c={method:"get",asynchronous:true,parameters:{}};Object.extend(c,a||{});var e=Hash.toQueryString(c.parameters);if(e){d+=(d.include("?")?"&":"?")+e}return ResourceManager.__request(c.method,d,c.data,(c.onSuccess instanceof Function?function(){c.onSuccess(this)}:undefined),(c.onFailure instanceof Function?function(){c.onFailure(this)}:undefined),c.asynchronous&&USE_ASYNCHRONOUS_REQUESTS,c.headers)},__request:function(a,c,g,p,o,f,d){var l=Try.these(function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")});if(!l){if(!this.__corrupt){throw"This browser does not provide any AJAX functionality. You will not be able to use the software provided with the page you are viewing. Please consider installing appropriate extensions."}this.__corrupt=true;return false}if(p instanceof Function){l.onload=p}if(o instanceof Function){l.onerror=o}var m=$H(d);m.keys().each(function(e){l.setRequestHeader(e,m[e])});try{if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+c+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?g:"")}l.open(a,c,!f?false:true);l.send(g)}catch(n){return false}return true},__resourceActionSucceeded:function(h,d,g){var a=h.status;var c=h.responseText;if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+url+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?data:"")}if(a>=300){throw"The server responded with an error: "+a+"\n"+(SHOW_EXTENDED_DEBUG_INFORMATION?+data:"If you need additional information here, including the data sent by the server, consider setting SHOW_EXTENDED_DEBUG_INFORMATION to true.")}switch(d){case RESOURCE_REMOVED:var c=(h.responseXML);var f=c.childNodes[0];var g=f.getAttribute("id");var e=document.getElementById(g);e.parentNode.removeChild(e);break;case RESOURCE_CREATED:break;case RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:DataManager.__synclocal();case RESOURCE_SAVED:break;case RESOURCE_RELOADED:var c=(h.responseXML);var f=c.childNodes[0];var g=f.getAttribute("id");var e=document.getElementById(g);e.parentNode.removeChild(e);if(!$$(PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}$$(PROCESSDATA_REF)[0].appendChild(f.cloneNode(true));DataManager.__synclocal();break;default:DataManager.__synclocal()}ResourceManager.__dispatchEvent(new ResourceManager.__Event(d,g))},__resourceActionFailed:function(d,a,c){throw"Fatal: Resource action failed. There is something horribly wrong with either the server, the transport protocol or your online status. Sure you're online?"}};var Clazz=function(){};Clazz.prototype.construct=function(){};Clazz.extend=function(f){var a=function(){if(arguments[0]!==Clazz){this.construct.apply(this,arguments)}};var e=new this(Clazz);var c=this.prototype;for(var g in f){var d=f[g];if(d instanceof Function){d.$=c}e[g]=d}a.prototype=e;a.extend=this.extend;return a};if(!ORYX){var ORYX={}}if(!ORYX.CONFIG){ORYX.CONFIG={}}ORYX.CONFIG.ROOT_PATH=(ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX)?ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX+"/editor/":"../editor/";ORYX.CONFIG.EXPLORER_PATH=(ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX)?ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX+"/explorer/":"../explorer";ORYX.CONFIG.LIBS_PATH=(ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX)?ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX+"/libs/":"../libs";ORYX.CONFIG.SERVER_HANDLER_ROOT=(ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX)?ORYX.CONFIG.SERVER_HANDLER_ROOT_PREFIX+"/p":"../p";ORYX.CONFIG.SERVER_EDITOR_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor";ORYX.CONFIG.SERVER_MODEL_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/model";ORYX.CONFIG.STENCILSET_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_stencilset?embedsvg=true&url=true&namespace=";ORYX.CONFIG.STENCIL_SETS_URL=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_stencilset";ORYX.CONFIG.PLUGINS_CONFIG=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_plugins";ORYX.CONFIG.SYNTAXCHECKER_URL=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/syntaxchecker";ORYX.CONFIG.SS_EXTENSIONS_FOLDER=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/";ORYX.CONFIG.SS_EXTENSIONS_CONFIG=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_ssextensions";ORYX.CONFIG.ORYX_NEW_URL="/new";ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayouter";ORYX.CONFIG.GLOSSARY_PATH="/glossary";ORYX.CONFIG.GLOSSARY_PROPERTY_SUFFIX="_glossary";ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX="_glossary_dirty";if(!ORYX){var ORYX={}}if(!ORYX.CONFIG){ORYX.CONFIG={}}ORYX.CONFIG.BACKEND_SWITCH=true;ORYX.CONFIG.PANEL_LEFT_COLLAPSED=false;ORYX.CONFIG.PANEL_LEFT_WIDTH=250;ORYX.CONFIG.PANEL_RIGHT_COLLAPSED=true;ORYX.CONFIG.PANEL_RIGHT_WIDTH=300;ORYX.CONFIG.APPNAME="Signavio";ORYX.CONFIG.WEB_URL="explorer";ORYX.CONFIG.PDF_EXPORT_URL=ORYX.CONFIG.EDITOR_PATH+"/pdf";ORYX.CONFIG.BPSTRUCT_URL=ORYX.CONFIG.EDITOR_PATH+"/bpstruct";ORYX.CONFIG.BIMP_URL="http://bimp.cs.ut.ee/uploadsignavio";ORYX.CONFIG.DIAGRAM_PRINTER_URL="/printsvg";ORYX.CONFIG.LICENSE_URL="/LICENSE";ORYX.CONFIG.BLANK_IMAGE=ORYX.CONFIG.LIBS_PATH+"/ext-2.0.2/resources/images/default/s.gif";ORYX.CONFIG.SHOW_GRIDLINE=false;ORYX.CONFIG.MODE_READONLY="readonly";ORYX.CONFIG.MODE_FULLSCREEN="fullscreen";ORYX.CONFIG.WINDOW_HEIGHT=400;ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY=true;ORYX.CONFIG.PLUGINS_ENABLED=true;ORYX.CONFIG.PLUGINS_FOLDER="Plugins/";ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON=true;ORYX.CONFIG.NAMESPACE_ORYX="http://www.b3mn.org/oryx";ORYX.CONFIG.NAMESPACE_SVG="http://www.w3.org/2000/svg";ORYX.CONFIG.CANVAS_WIDTH=1485;ORYX.CONFIG.CANVAS_HEIGHT=1050;ORYX.CONFIG.CANVAS_RESIZE_INTERVAL=300;ORYX.CONFIG.SELECTED_AREA_PADDING=4;ORYX.CONFIG.CANVAS_BACKGROUND_COLOR="none";ORYX.CONFIG.GRID_DISTANCE=30;ORYX.CONFIG.GRID_ENABLED=true;ORYX.CONFIG.ZOOM_OFFSET=0.1;ORYX.CONFIG.DEFAULT_SHAPE_MARGIN=60;ORYX.CONFIG.SCALERS_SIZE=7;ORYX.CONFIG.MINIMUM_SIZE=20;ORYX.CONFIG.MAXIMUM_SIZE=10000;ORYX.CONFIG.OFFSET_MAGNET=15;ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP=8;ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM=8;ORYX.CONFIG.OFFSET_EDGE_BOUNDS=5;ORYX.CONFIG.COPY_MOVE_OFFSET=30;ORYX.CONFIG.BORDER_OFFSET=14;ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP=12;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER=30;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET=45;ORYX.CONFIG.SHAPEMENU_RIGHT="Oryx_Right";ORYX.CONFIG.SHAPEMENU_BOTTOM="Oryx_Bottom";ORYX.CONFIG.SHAPEMENU_LEFT="Oryx_Left";ORYX.CONFIG.SHAPEMENU_TOP="Oryx_Top";ORYX.CONFIG.MORPHITEM_DISABLED="Oryx_MorphItem_disabled";ORYX.CONFIG.TYPE_STRING="string";ORYX.CONFIG.TYPE_BOOLEAN="boolean";ORYX.CONFIG.TYPE_INTEGER="integer";ORYX.CONFIG.TYPE_FLOAT="float";ORYX.CONFIG.TYPE_COLOR="color";ORYX.CONFIG.TYPE_DATE="date";ORYX.CONFIG.TYPE_CHOICE="choice";ORYX.CONFIG.TYPE_URL="url";ORYX.CONFIG.TYPE_DIAGRAM_LINK="diagramlink";ORYX.CONFIG.TYPE_COMPLEX="complex";ORYX.CONFIG.TYPE_TEXT="text";ORYX.CONFIG.TYPE_EPC_FREQ="epcfrequency";ORYX.CONFIG.TYPE_GLOSSARY_LINK="glossarylink";ORYX.CONFIG.LABEL_LINE_DISTANCE=2;ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT=12;ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER=false;ORYX.CONFIG.EDITOR_ALIGN_BOTTOM=1;ORYX.CONFIG.EDITOR_ALIGN_MIDDLE=2;ORYX.CONFIG.EDITOR_ALIGN_TOP=4;ORYX.CONFIG.EDITOR_ALIGN_LEFT=8;ORYX.CONFIG.EDITOR_ALIGN_CENTER=16;ORYX.CONFIG.EDITOR_ALIGN_RIGHT=32;ORYX.CONFIG.EDITOR_ALIGN_SIZE=48;ORYX.CONFIG.EVENT_MOUSEDOWN="mousedown";ORYX.CONFIG.EVENT_MOUSEUP="mouseup";ORYX.CONFIG.EVENT_MOUSEOVER="mouseover";ORYX.CONFIG.EVENT_MOUSEOUT="mouseout";ORYX.CONFIG.EVENT_MOUSEMOVE="mousemove";ORYX.CONFIG.EVENT_DBLCLICK="dblclick";ORYX.CONFIG.EVENT_KEYDOWN="keydown";ORYX.CONFIG.EVENT_KEYUP="keyup";ORYX.CONFIG.EVENT_LOADED="editorloaded";ORYX.CONFIG.EVENT_EXECUTE_COMMANDS="executeCommands";ORYX.CONFIG.EVENT_STENCIL_SET_LOADED="stencilSetLoaded";ORYX.CONFIG.EVENT_SELECTION_CHANGED="selectionchanged";ORYX.CONFIG.EVENT_SHAPEADDED="shapeadded";ORYX.CONFIG.EVENT_SHAPEREMOVED="shaperemoved";ORYX.CONFIG.EVENT_PROPERTY_CHANGED="propertyChanged";ORYX.CONFIG.EVENT_DRAGDROP_START="dragdrop.start";ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE="shape.menu.close";ORYX.CONFIG.EVENT_DRAGDROP_END="dragdrop.end";ORYX.CONFIG.EVENT_RESIZE_START="resize.start";ORYX.CONFIG.EVENT_RESIZE_END="resize.end";ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED="dragDocker.docked";ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW="highlight.showHighlight";ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE="highlight.hideHighlight";ORYX.CONFIG.EVENT_LOADING_ENABLE="loading.enable";ORYX.CONFIG.EVENT_LOADING_DISABLE="loading.disable";ORYX.CONFIG.EVENT_LOADING_STATUS="loading.status";ORYX.CONFIG.EVENT_OVERLAY_SHOW="overlay.show";ORYX.CONFIG.EVENT_OVERLAY_HIDE="overlay.hide";ORYX.CONFIG.EVENT_ARRANGEMENT_TOP="arrangement.setToTop";ORYX.CONFIG.EVENT_ARRANGEMENT_BACK="arrangement.setToBack";ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD="arrangement.setForward";ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD="arrangement.setBackward";ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED="propertyWindow.propertyChanged";ORYX.CONFIG.EVENT_LAYOUT_ROWS="layout.rows";ORYX.CONFIG.EVENT_LAYOUT_BPEL="layout.BPEL";ORYX.CONFIG.EVENT_LAYOUT_BPEL_VERTICAL="layout.BPEL.vertical";ORYX.CONFIG.EVENT_LAYOUT_BPEL_HORIZONTAL="layout.BPEL.horizontal";ORYX.CONFIG.EVENT_LAYOUT_BPEL_SINGLECHILD="layout.BPEL.singlechild";ORYX.CONFIG.EVENT_LAYOUT_BPEL_AUTORESIZE="layout.BPEL.autoresize";ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT="autolayout.layout";ORYX.CONFIG.EVENT_UNDO_EXECUTE="undo.execute";ORYX.CONFIG.EVENT_UNDO_ROLLBACK="undo.rollback";ORYX.CONFIG.EVENT_BUTTON_UPDATE="toolbar.button.update";ORYX.CONFIG.EVENT_LAYOUT="layout.dolayout";ORYX.CONFIG.EVENT_GLOSSARY_LINK_EDIT="glossary.link.edit";ORYX.CONFIG.EVENT_GLOSSARY_SHOW="glossary.show.info";ORYX.CONFIG.EVENT_GLOSSARY_NEW="glossary.show.new";ORYX.CONFIG.EVENT_DOCKERDRAG="dragTheDocker";ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW="propertywindow.show";ORYX.CONFIG.EVENT_ABOUT_TO_SAVE="file.aboutToSave";ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE=5;ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR="#4444FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR2="#9999FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_CORNER="corner";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE="rectangle";ORYX.CONFIG.SELECTION_VALID_COLOR="#00FF00";ORYX.CONFIG.SELECTION_INVALID_COLOR="#FF0000";ORYX.CONFIG.DOCKER_DOCKED_COLOR="#00FF00";ORYX.CONFIG.DOCKER_UNDOCKED_COLOR="#FF0000";ORYX.CONFIG.DOCKER_SNAP_OFFSET=10;ORYX.CONFIG.EDIT_OFFSET_PASTE=10;ORYX.CONFIG.KEY_CODE_X=88;ORYX.CONFIG.KEY_CODE_C=67;ORYX.CONFIG.KEY_CODE_V=86;ORYX.CONFIG.KEY_CODE_DELETE=46;ORYX.CONFIG.KEY_CODE_META=224;ORYX.CONFIG.KEY_CODE_BACKSPACE=8;ORYX.CONFIG.KEY_CODE_LEFT=37;ORYX.CONFIG.KEY_CODE_RIGHT=39;ORYX.CONFIG.KEY_CODE_UP=38;ORYX.CONFIG.KEY_CODE_DOWN=40;ORYX.CONFIG.KEY_Code_enter=12;ORYX.CONFIG.KEY_Code_left=37;ORYX.CONFIG.KEY_Code_right=39;ORYX.CONFIG.KEY_Code_top=38;ORYX.CONFIG.KEY_Code_bottom=40;ORYX.CONFIG.META_KEY_META_CTRL="metactrl";ORYX.CONFIG.META_KEY_ALT="alt";ORYX.CONFIG.META_KEY_SHIFT="shift";ORYX.CONFIG.KEY_ACTION_DOWN="down";ORYX.CONFIG.KEY_ACTION_UP="up";ORYX.CONFIG.REMOTE_WINDOW_HEIGHT_DEFAULT=300;ORYX.CONFIG.REMOTE_WINDOW_WIDTH_DEFAULT=300;function printf(){var a=arguments[0];for(var c=1;c<arguments.length;c++){a=a.replace("%"+(c-1),arguments[c])}return a}var ORYX_LOGLEVEL_TRACE=5;var ORYX_LOGLEVEL_DEBUG=4;var ORYX_LOGLEVEL_INFO=3;var ORYX_LOGLEVEL_WARN=2;var ORYX_LOGLEVEL_ERROR=1;var ORYX_LOGLEVEL_FATAL=0;var ORYX_LOGLEVEL=0;var ORYX_CONFIGURATION_DELAY=100;var ORYX_CONFIGURATION_WAIT_ATTEMPTS=10;if(!ORYX){var ORYX={}}ORYX=Object.extend(ORYX,{PATH:ORYX.CONFIG.ROOT_PATH,URLS:[],alreadyLoaded:[],configrationRetries:0,Version:"0.1.1",availablePlugins:[],Log:{__appenders:[{append:function(a){console.log(a)}}],trace:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_TRACE){ORYX.Log.__log("TRACE",arguments)}},debug:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_DEBUG){ORYX.Log.__log("DEBUG",arguments)}},info:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_INFO){ORYX.Log.__log("INFO",arguments)}},warn:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_WARN){ORYX.Log.__log("WARN",arguments)}},error:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_ERROR){ORYX.Log.__log("ERROR",arguments)}},fatal:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_FATAL){ORYX.Log.__log("FATAL",arguments)}},__log:function(d,a){a[0]=(new Date()).getTime()+" "+d+" "+a[0];var c=printf.apply(null,a);ORYX.Log.__appenders.each(function(e){e.append(c)})},addAppender:function(a){ORYX.Log.__appenders.push(a)}},load:function(){if(ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY!==true){var a=new Ext.Window({renderTo:Ext.getBody(),id:"oryx-loading-panel",bodyStyle:"padding: 8px;background:white",title:ORYX.I18N.Oryx.title,width:"auto",height:"auto",modal:true,resizable:false,closable:false,html:'<span style="font-size:11px;">'+ORYX.I18N.Oryx.pleaseWait+"</span>"});a.show()}ORYX.Log.debug("Oryx begins loading procedure.");if((typeof Prototype=="undefined")||(typeof Element=="undefined")||(typeof Element.Methods=="undefined")||parseFloat(Prototype.Version.split(".")[0]+"."+Prototype.Version.split(".")[1])<1.5){throw ("Application requires the Prototype JavaScript framework >= 1.5.3")}ORYX.Log.debug("Prototype > 1.5 found.");ORYX._load()},_load:function(){ORYX.loadPlugins()},loadPlugins:function(){if(ORYX.CONFIG.PLUGINS_ENABLED){ORYX._loadPlugins()}else{ORYX.Log.warn("Ignoring plugins, loading Core only.")}init()},_loadPlugins:function(){var a=ORYX.CONFIG.PLUGINS_CONFIG;ORYX.Log.debug("Loading plugin configuration from '%0'.",a);new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(d){ORYX.Log.info("Plugin configuration file loaded.");var g=d.responseXML;var c=[];var e=$A(g.getElementsByTagName("properties"));e.each(function(l){var h=$A(l.childNodes);h.each(function(o){var n=new Hash();var m=$A(o.attributes);m.each(function(p){n[p.nodeName]=p.nodeValue});if(m.length>0){c.push(n)}})});var f=g.getElementsByTagName("plugin");$A(f).each(function(m){var r=new Hash();$A(m.attributes).each(function(t){r[t.nodeName]=t.nodeValue});if(!r.name){ORYX.Log.error("A plugin is not providing a name. Ingnoring this plugin.");return}if(!r.source){ORYX.Log.error("Plugin with name '%0' doesn't provide a source attribute.",r.name);return}var p=m.getElementsByTagName("property");var q=[];$A(p).each(function(v){var u=new Hash();var t=$A(v.attributes);t.each(function(w){u[w.nodeName]=w.nodeValue});if(t.length>0){q.push(u)}});q=q.concat(c);r.properties=q;var n=m.getElementsByTagName("requires");var s;$A(n).each(function(u){var t=$A(u.attributes).find(function(v){return v.name=="namespace"});if(t&&t.nodeValue){if(!s){s={namespaces:[]}}s.namespaces.push(t.nodeValue)}});if(s){r.requires=s}var o=m.getElementsByTagName("notUsesIn");var l;$A(o).each(function(u){var t=$A(u.attributes).find(function(v){return v.name=="namespace"});if(t&&t.nodeValue){if(!l){l={namespaces:[]}}l.namespaces.push(t.nodeValue)}});if(l){r.notUsesIn=l}var h=ORYX.PATH+ORYX.CONFIG.PLUGINS_FOLDER+r.source;ORYX.Log.debug("Requireing '%0'",h);ORYX.Log.info("Plugin '%0' successfully loaded.",r.name);ORYX.availablePlugins.push(r)})},onFailure:this._loadPluginsOnFails})},_loadPluginsOnFails:function(a){ORYX.Log.error("Plugin configuration file not available.")}});ORYX.Log.debug("Registering Oryx with Kickstart");Kickstart.register(ORYX.load);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.EditPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.x=0;this.y=0;this.oldX=0;this.oldY=0;this.deltaWidth=1;this.deltaHeight=1;this.d=""},init:function(a,g,e,c,d,f){this.x=a;this.y=g;this.oldX=e;this.oldY=c;this.deltaWidth=d;this.deltaHeight=f;this.d=""},editPointsAbs:function(d){if(d instanceof Array){var e=[];var a,f;for(var c=0;c<d.length;c++){a=(parseFloat(d[c])-this.oldX)*this.deltaWidth+this.x;c++;f=(parseFloat(d[c])-this.oldY)*this.deltaHeight+this.y;e.push(a);e.push(f)}return e}else{}},editPointsRel:function(d){if(d instanceof Array){var e=[];var a,f;for(var c=0;c<d.length;c++){a=parseFloat(d[c])*this.deltaWidth;c++;f=parseFloat(d[c])*this.deltaHeight;e.push(a);e.push(f)}return e}else{}},arcAbs:function(f,d,m,c,g,l,h){var e=this.editPointsAbs([l,h]);var a=this.editPointsRel([f,d]);this.d=this.d.concat(" A"+a[0]+" "+a[1]+" "+m+" "+c+" "+g+" "+e[0]+" "+e[1]+" ")},arcRel:function(g,e,c,f,d,a,l){var h=this.editPointsRel([g,e,a,l]);this.d=this.d.concat(" a"+h[0]+" "+h[1]+" "+c+" "+f+" "+d+" "+h[2]+" "+h[3]+" ")},curvetoCubicAbs:function(d,f,c,e,a,h){var g=this.editPointsAbs([d,f,c,e,a,h]);this.d=this.d.concat(" C"+g[0]+" "+g[1]+" "+g[2]+" "+g[3]+" "+g[4]+" "+g[5]+" ")},curvetoCubicRel:function(d,f,c,e,a,h){var g=this.editPointsRel([d,f,c,e,a,h]);this.d=this.d.concat(" c"+g[0]+" "+g[1]+" "+g[2]+" "+g[3]+" "+g[4]+" "+g[5]+" ")},linetoHorizontalAbs:function(a){var c=this.editPointsAbs([a,0]);this.d=this.d.concat(" H"+c[0]+" ")},linetoHorizontalRel:function(a){var c=this.editPointsRel([a,0]);this.d=this.d.concat(" h"+c[0]+" ")},linetoAbs:function(a,d){var c=this.editPointsAbs([a,d]);this.d=this.d.concat(" L"+c[0]+" "+c[1]+" ")},linetoRel:function(a,d){var c=this.editPointsRel([a,d]);this.d=this.d.concat(" l"+c[0]+" "+c[1]+" ")},movetoAbs:function(a,d){var c=this.editPointsAbs([a,d]);this.d=this.d.concat(" M"+c[0]+" "+c[1]+" ")},movetoRel:function(a,d){var c;if(this.d===""){c=this.editPointsAbs([a,d])}else{c=this.editPointsRel([a,d])}this.d=this.d.concat(" m"+c[0]+" "+c[1]+" ")},curvetoQuadraticAbs:function(c,d,a,f){var e=this.editPointsAbs([c,d,a,f]);this.d=this.d.concat(" Q"+e[0]+" "+e[1]+" "+e[2]+" "+e[3]+" ")},curvetoQuadraticRel:function(c,d,a,f){var e=this.editPointsRel([c,d,a,f]);this.d=this.d.concat(" q"+e[0]+" "+e[1]+" "+e[2]+" "+e[3]+" ")},curvetoCubicSmoothAbs:function(c,d,a,f){var e=this.editPointsAbs([c,d,a,f]);this.d=this.d.concat(" S"+e[0]+" "+e[1]+" "+e[2]+" "+e[3]+" ")},curvetoCubicSmoothRel:function(c,d,a,f){var e=this.editPointsRel([c,d,a,f]);this.d=this.d.concat(" s"+e[0]+" "+e[1]+" "+e[2]+" "+e[3]+" ")},curvetoQuadraticSmoothAbs:function(a,d){var c=this.editPointsAbs([a,d]);this.d=this.d.concat(" T"+c[0]+" "+c[1]+" ")},curvetoQuadraticSmoothRel:function(a,d){var c=this.editPointsRel([a,d]);this.d=this.d.concat(" t"+c[0]+" "+c[1]+" ")},linetoVerticalAbs:function(c){var a=this.editPointsAbs([0,c]);this.d=this.d.concat(" V"+a[1]+" ")},linetoVerticalRel:function(c){var a=this.editPointsRel([0,c]);this.d=this.d.concat(" v"+a[1]+" ")},closePath:function(){this.d=this.d.concat(" z")}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.MinMaxPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.minX=undefined;this.minY=undefined;this.maxX=undefined;this.maxY=undefined;this._lastAbsX=undefined;this._lastAbsY=undefined},calculateMinMax:function(d){if(d instanceof Array){var a,e;for(var c=0;c<d.length;c++){a=parseFloat(d[c]);c++;e=parseFloat(d[c]);this.minX=(this.minX!==undefined)?Math.min(this.minX,a):a;this.maxX=(this.maxX!==undefined)?Math.max(this.maxX,a):a;this.minY=(this.minY!==undefined)?Math.min(this.minY,e):e;this.maxY=(this.maxY!==undefined)?Math.max(this.maxY,e):e;this._lastAbsX=a;this._lastAbsY=e}}else{}},arcAbs:function(g,e,c,f,d,a,h){this.calculateMinMax([a,h])},arcRel:function(g,e,c,f,d,a,h){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+h])},curvetoCubicAbs:function(d,f,c,e,a,g){this.calculateMinMax([d,f,c,e,a,g])},curvetoCubicRel:function(d,f,c,e,a,g){this.calculateMinMax([this._lastAbsX+d,this._lastAbsY+f,this._lastAbsX+c,this._lastAbsY+e,this._lastAbsX+a,this._lastAbsY+g])},linetoHorizontalAbs:function(a){this.calculateMinMax([a,this._lastAbsY])},linetoHorizontalRel:function(a){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY])},linetoAbs:function(a,c){this.calculateMinMax([a,c])},linetoRel:function(a,c){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+c])},movetoAbs:function(a,c){this.calculateMinMax([a,c])},movetoRel:function(a,c){if(this._lastAbsX&&this._lastAbsY){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+c])}else{this.calculateMinMax([a,c])}},curvetoQuadraticAbs:function(c,d,a,e){this.calculateMinMax([c,d,a,e])},curvetoQuadraticRel:function(c,d,a,e){this.calculateMinMax([this._lastAbsX+c,this._lastAbsY+d,this._lastAbsX+a,this._lastAbsY+e])},curvetoCubicSmoothAbs:function(c,d,a,e){this.calculateMinMax([c,d,a,e])},curvetoCubicSmoothRel:function(c,d,a,e){this.calculateMinMax([this._lastAbsX+c,this._lastAbsY+d,this._lastAbsX+a,this._lastAbsY+e])},curvetoQuadraticSmoothAbs:function(a,c){this.calculateMinMax([a,c])},curvetoQuadraticSmoothRel:function(a,c){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+c])},linetoVerticalAbs:function(a){this.calculateMinMax([this._lastAbsX,a])},linetoVerticalRel:function(a){this.calculateMinMax([this._lastAbsX,this._lastAbsY+a])},closePath:function(){return}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.PointsPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.points=[];this._lastAbsX=undefined;this._lastAbsY=undefined},addPoints:function(d){if(d instanceof Array){var a,e;for(var c=0;c<d.length;c++){a=parseFloat(d[c]);c++;e=parseFloat(d[c]);this.points.push(a);this.points.push(e);this._lastAbsX=a;this._lastAbsY=e}}else{}},arcAbs:function(g,e,c,f,d,a,h){this.addPoints([a,h])},arcRel:function(g,e,c,f,d,a,h){this.addPoints([this._lastAbsX+a,this._lastAbsY+h])},curvetoCubicAbs:function(d,f,c,e,a,g){this.addPoints([a,g])},curvetoCubicRel:function(d,f,c,e,a,g){this.addPoints([this._lastAbsX+a,this._lastAbsY+g])},linetoHorizontalAbs:function(a){this.addPoints([a,this._lastAbsY])},linetoHorizontalRel:function(a){this.addPoints([this._lastAbsX+a,this._lastAbsY])},linetoAbs:function(a,c){this.addPoints([a,c])},linetoRel:function(a,c){this.addPoints([this._lastAbsX+a,this._lastAbsY+c])},movetoAbs:function(a,c){this.addPoints([a,c])},movetoRel:function(a,c){if(this._lastAbsX&&this._lastAbsY){this.addPoints([this._lastAbsX+a,this._lastAbsY+c])}else{this.addPoints([a,c])}},curvetoQuadraticAbs:function(c,d,a,e){this.addPoints([a,e])},curvetoQuadraticRel:function(c,d,a,e){this.addPoints([this._lastAbsX+a,this._lastAbsY+e])},curvetoCubicSmoothAbs:function(c,d,a,e){this.addPoints([a,e])},curvetoCubicSmoothRel:function(c,d,a,e){this.addPoints([this._lastAbsX+a,this._lastAbsY+e])},curvetoQuadraticSmoothAbs:function(a,c){this.addPoints([a,c])},curvetoQuadraticSmoothRel:function(a,c){this.addPoints([this._lastAbsX+a,this._lastAbsY+c])},linetoVerticalAbs:function(a){this.addPoints([this._lastAbsX,a])},linetoVerticalRel:function(a){this.addPoints([this._lastAbsX,this._lastAbsY+a])},closePath:function(){return}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.SVGMarker=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.id=undefined;this.element=a;this.refX=undefined;this.refY=undefined;this.markerWidth=undefined;this.markerHeight=undefined;this.oldRefX=undefined;this.oldRefY=undefined;this.oldMarkerWidth=undefined;this.oldMarkerHeight=undefined;this.optional=false;this.enabled=true;this.minimumLength=undefined;this.resize=false;this.svgShapes=[];this._init()},_init:function(){if(!(this.element=="[object SVGMarkerElement]")){throw"SVGMarker: Argument is not an instance of SVGMarkerElement."}this.id=this.element.getAttributeNS(null,"id");var a=this.element.getAttributeNS(null,"refX");if(a){this.refX=parseFloat(a)}else{this.refX=0}var l=this.element.getAttributeNS(null,"refY");if(l){this.refY=parseFloat(l)}else{this.refY=0}var g=this.element.getAttributeNS(null,"markerWidth");if(g){this.markerWidth=parseFloat(g)}else{this.markerWidth=3}var d=this.element.getAttributeNS(null,"markerHeight");if(d){this.markerHeight=parseFloat(d)}else{this.markerHeight=3}this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;var h=this.element.getAttributeNS(NAMESPACE_ORYX,"optional");if(h){h=h.strip();this.optional=(h.toLowerCase()==="yes")}else{this.optional=false}var f=this.element.getAttributeNS(NAMESPACE_ORYX,"enabled");if(f){f=f.strip();this.enabled=!(f.toLowerCase()==="no")}else{this.enabled=true}var e=this.element.getAttributeNS(NAMESPACE_ORYX,"minimumLength");if(e){this.minimumLength=parseFloat(e)}var c=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(c){c=c.strip();this.resize=(c.toLowerCase()==="yes")}else{this.resize=false}},_getSVGShapes:function(d){if(d.hasChildNodes){var a=[];var c=this;$A(d.childNodes).each(function(f){try{var h=new ORYX.Core.SVG.SVGShape(f);a.push(h)}catch(g){a=a.concat(c._getSVGShapes(f))}});return a}},update:function(){this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight},toString:function(){return(this.element)?"SVGMarker "+this.element.id:"SVGMarker "+this.element}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.SVGShape=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.type;this.element=a;this.x=undefined;this.y=undefined;this.width=undefined;this.height=undefined;this.oldX=undefined;this.oldY=undefined;this.oldWidth=undefined;this.oldHeight=undefined;this.radiusX=undefined;this.radiusY=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.anchorLeft=false;this.anchorRight=false;this.anchorTop=false;this.anchorBottom=false;this.allowDockers=true;this.resizeMarkerMid=false;this.editPathParser;this.editPathHandler;this.init()},init:function(){if(ORYX.Editor.checkClassType(this.element,SVGRectElement)||ORYX.Editor.checkClassType(this.element,SVGImageElement)){this.type="Rect";var K=this.element.getAttributeNS(null,"x");if(K){this.oldX=parseFloat(K)}else{throw"Missing attribute in element "+this.element}var r=this.element.getAttributeNS(null,"y");if(r){this.oldY=parseFloat(r)}else{throw"Missing attribute in element "+this.element}var t=this.element.getAttributeNS(null,"width");if(t){this.oldWidth=parseFloat(t)}else{throw"Missing attribute in element "+this.element}var w=this.element.getAttributeNS(null,"height");if(w){this.oldHeight=parseFloat(w)}else{throw"Missing attribute in element "+this.element}}else{if(ORYX.Editor.checkClassType(this.element,SVGCircleElement)){this.type="Circle";var l=undefined;var f=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){l=parseFloat(a)}else{throw"Missing attribute in element "+this.element}var y=this.element.getAttributeNS(null,"cy");if(y){f=parseFloat(y)}else{throw"Missing attribute in element "+this.element}var m=this.element.getAttributeNS(null,"r");if(m){this.radiusX=parseFloat(m)}else{throw"Missing attribute in element "+this.element}this.oldX=l-this.radiusX;this.oldY=f-this.radiusX;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusX}else{if(ORYX.Editor.checkClassType(this.element,SVGEllipseElement)){this.type="Ellipse";var l=undefined;var f=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){l=parseFloat(a)}else{throw"Missing attribute in element "+this.element}var y=this.element.getAttributeNS(null,"cy");if(y){f=parseFloat(y)}else{throw"Missing attribute in element "+this.element}var L=this.element.getAttributeNS(null,"rx");if(L){this.radiusX=parseFloat(L)}else{throw"Missing attribute in element "+this.element}var s=this.element.getAttributeNS(null,"ry");if(s){this.radiusY=parseFloat(s)}else{throw"Missing attribute in element "+this.element}this.oldX=l-this.radiusX;this.oldY=f-this.radiusY;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusY}else{if(ORYX.Editor.checkClassType(this.element,SVGLineElement)){this.type="Line";var E=undefined;var h=undefined;var C=undefined;var e=undefined;var J=this.element.getAttributeNS(null,"x1");if(J){E=parseFloat(J)}else{throw"Missing attribute in element "+this.element}var c=this.element.getAttributeNS(null,"y1");if(c){h=parseFloat(c)}else{throw"Missing attribute in element "+this.element}var o=this.element.getAttributeNS(null,"x2");if(o){C=parseFloat(o)}else{throw"Missing attribute in element "+this.element}var x=this.element.getAttributeNS(null,"y2");if(x){e=parseFloat(x)}else{throw"Missing attribute in element "+this.element}this.oldX=Math.min(E,C);this.oldY=Math.min(h,e);this.oldWidth=Math.abs(E-C);this.oldHeight=Math.abs(h-e)}else{if(ORYX.Editor.checkClassType(this.element,SVGPolylineElement)||ORYX.Editor.checkClassType(this.element,SVGPolygonElement)){this.type="Polyline";var p=[];if(this.element.points&&this.element.points.numberOfItems){for(var B=0,u=this.element.points.numberOfItems;B<u;B++){p.push(this.element.points.getItem(B).x);p.push(this.element.points.getItem(B).y)}}else{var A=this.element.getAttributeNS(null,"points");if(A){A=A.replace(/,/g," ");p=A.split(" ");p=p.without("")}else{throw"Missing attribute in element "+this.element}}if(p&&p.length&&p.length>1){var I=parseFloat(p[0]);var H=parseFloat(p[1]);var G=parseFloat(p[0]);var F=parseFloat(p[1]);for(var B=0;B<p.length;B++){I=Math.min(I,parseFloat(p[B]));G=Math.max(G,parseFloat(p[B]));B++;H=Math.min(H,parseFloat(p[B]));F=Math.max(F,parseFloat(p[B]))}this.oldX=I;this.oldY=H;this.oldWidth=G-I;this.oldHeight=F-H}else{throw"Missing attribute in element "+this.element}}else{if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){this.type="Path";this.editPathParser=new PathParser();this.editPathHandler=new ORYX.Core.SVG.EditPathHandler();this.editPathParser.setHandler(this.editPathHandler);var g=new PathParser();var d=new ORYX.Core.SVG.MinMaxPathHandler();g.setHandler(d);g.parsePath(this.element);this.oldX=d.minX;this.oldY=d.minY;this.oldWidth=d.maxX-d.minX;this.oldHeight=d.maxY-d.minY;delete g;delete d}else{throw"Element is not a shape."}}}}}}var v=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(v){v=v.toLowerCase();if(v.match(/horizontal/)){this.isHorizontallyResizable=true}else{this.isHorizontallyResizable=false}if(v.match(/vertical/)){this.isVerticallyResizable=true}else{this.isVerticallyResizable=false}}else{this.isHorizontallyResizable=false;this.isVerticallyResizable=false}var z=this.element.getAttributeNS(NAMESPACE_ORYX,"anchors");if(z){z=z.replace("/,/g"," ");var q=z.split(" ").without("");for(var B=0;B<q.length;B++){switch(q[B].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break}}}if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){var n=this.element.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(n){if(n.toLowerCase()==="no"){this.allowDockers=false}else{this.allowDockers=true}}var D=this.element.getAttributeNS(NAMESPACE_ORYX,"resizeMarker-mid");if(D){if(D.toLowerCase()==="yes"){this.resizeMarkerMid=true}else{this.resizeMarkerMid=false}}}this.x=this.oldX;this.y=this.oldY;this.width=this.oldWidth;this.height=this.oldHeight},update:function(){if(this.x!==this.oldX||this.y!==this.oldY||this.width!==this.oldWidth||this.height!==this.oldHeight){switch(this.type){case"Rect":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x",this.x)}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y",this.y)}if(this.width!==this.oldWidth){this.element.setAttributeNS(null,"width",this.width)}if(this.height!==this.oldHeight){this.element.setAttributeNS(null,"height",this.height)}break;case"Circle":this.radiusX=((this.width<this.height)?this.width:this.height)/2;this.element.setAttributeNS(null,"cx",this.x+this.width/2);this.element.setAttributeNS(null,"cy",this.y+this.height/2);this.element.setAttributeNS(null,"r",this.radiusX);break;case"Ellipse":this.radiusX=this.width/2;this.radiusY=this.height/2;this.element.setAttributeNS(null,"cx",this.x+this.radiusX);this.element.setAttributeNS(null,"cy",this.y+this.radiusY);this.element.setAttributeNS(null,"rx",this.radiusX);this.element.setAttributeNS(null,"ry",this.radiusY);break;case"Line":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x1",this.x)}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y1",this.y)}if(this.x!==this.oldX||this.width!==this.oldWidth){this.element.setAttributeNS(null,"x2",this.x+this.width)}if(this.y!==this.oldY||this.height!==this.oldHeight){this.element.setAttributeNS(null,"y2",this.y+this.height)}break;case"Polyline":var e=this.element.getAttributeNS(null,"points");if(e){e=e.replace(/,/g," ").split(" ").without("");if(e&&e.length&&e.length>1){var h=(this.oldWidth===0)?0:this.width/this.oldWidth;var f=(this.oldHeight===0)?0:this.height/this.oldHeight;var c="";for(var d=0;d<e.length;d++){var a=(parseFloat(e[d])-this.oldX)*h+this.x;d++;var g=(parseFloat(e[d])-this.oldY)*f+this.y;c+=a+" "+g+" "}this.element.setAttributeNS(null,"points",c)}else{}}else{}break;case"Path":var h=(this.oldWidth===0)?0:this.width/this.oldWidth;var f=(this.oldHeight===0)?0:this.height/this.oldHeight;this.editPathHandler.init(this.x,this.y,this.oldX,this.oldY,h,f);this.editPathParser.parsePath(this.element);this.element.setAttributeNS(null,"d",this.editPathHandler.d);break}this.oldX=this.x;this.oldY=this.y;this.oldWidth=this.width;this.oldHeight=this.height}delete this.visible;delete this.handler},isPointIncluded:function(e,c){if(!e||!c||!this.isVisible()){return false}switch(this.type){case"Rect":return(e>=this.x&&e<=this.x+this.width&&c>=this.y&&c<=this.y+this.height);break;case"Circle":return ORYX.Core.Math.isPointInEllipse(e,c,this.x+this.width/2,this.y+this.height/2,this.radiusX,this.radiusX);break;case"Ellipse":return ORYX.Core.Math.isPointInEllipse(e,c,this.x+this.radiusX,this.y+this.radiusY,this.radiusX,this.radiusY);break;case"Line":return ORYX.Core.Math.isPointInLine(e,c,this.x,this.y,this.x+this.width,this.y+this.height);break;case"Polyline":var a=this.element.getAttributeNS(null,"points");if(a){a=a.replace(/,/g," ").split(" ").without("");a=a.collect(function(f){return parseFloat(f)});return ORYX.Core.Math.isPointInPolygone(e,c,a)}else{return false}break;case"Path":if(!this.handler){var d=new PathParser();this.handler=new ORYX.Core.SVG.PointsPathHandler();d.setHandler(this.handler);d.parsePath(this.element)}return ORYX.Core.Math.isPointInPolygone(e,c,this.handler.points);break;default:return false}},isVisible:function(d){if(this.visible!==undefined){return this.visible}if(!d){d=this.element}var c=false;try{c=!!d.ownerSVGElement}catch(h){}if(c){if(ORYX.Editor.checkClassType(d,SVGGElement)){if(d.className&&d.className.baseVal=="me"){this.visible=true;return this.visible}}var g=d.getAttributeNS(null,"fill");var f=d.getAttributeNS(null,"stroke");if(g&&g=="none"&&f&&f=="none"){this.visible=false}else{var a=d.getAttributeNS(null,"display");if(!a){this.visible=this.isVisible(d.parentNode)}else{if(a=="none"){this.visible=false}else{this.visible=true}}}}else{this.visible=true}return this.visible},toString:function(){return(this.element)?"SVGShape "+this.element.id:"SVGShape "+this.element}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.Label=Clazz.extend({_characterSets:["%W","@","m","wDGMOQÃ#+=<>~^","ABCHKNRSUVXZÃÃ&","bdghnopquxÃ¶Ã¼ETY1234567890Ã_Â§${}*Â´`Âµâ¬","aeksvyzÃ¤FLP?Â°Â²Â³","c-",'rtJ"/()[]:;!|\\',"fjI., ","'","il"],_characterSetValues:[15,14,13,11,10,9,8,7,6,5,4,3],construct:function(o){arguments.callee.$.construct.apply(this,arguments);if(!o.textElement){throw"Label: No parameter textElement."}else{if(!ORYX.Editor.checkClassType(o.textElement,SVGTextElement)){throw"Label: Parameter textElement is not an SVGTextElement."}}this.invisibleRenderPoint=-5000;this.node=o.textElement;this.node.setAttributeNS(null,"stroke-width","0pt");this.node.setAttributeNS(null,"letter-spacing","-0.01px");this.shapeId=o.shapeId;this.id;this.fitToElemId;this.edgePosition;this.x;this.y;this.oldX;this.oldY;this.isVisible=true;this._text;this._verticalAlign;this._horizontalAlign;this._rotate;this._rotationPoint;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this._isChanged=true;var m=this.node.getAttributeNS(null,"id");if(m){this.id=m}this.fitToElemId=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"fittoelem");if(this.fitToElemId){this.fitToElemId=this.shapeId+this.fitToElemId}var g=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"align");if(g){g=g.replace(/,/g," ");g=g.split(" ");g=g.without("");g.each((function(e){switch(e){case"top":case"middle":case"bottom":if(!this._verticalAlign){this._originVerticalAlign=this._verticalAlign=e}break;case"left":case"center":case"right":if(!this._horizontalAlign){this._originHorizontalAlign=this._horizontalAlign=e}break}}).bind(this))}this.edgePosition=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"edgePosition");if(this.edgePosition){this.originEdgePosition=this.edgePosition=this.edgePosition.toLowerCase()}this.offsetTop=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetTop")||ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP;if(this.offsetTop){this.offsetTop=parseInt(this.offsetTop)}this.offsetBottom=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetBottom")||ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM;if(this.offsetBottom){this.offsetBottom=parseInt(this.offsetBottom)}var n=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"rotate");if(n){try{this._rotate=parseFloat(n)}catch(h){this._rotate=0}}else{this._rotate=0}var c=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(c){c=c.replace("/,/g"," ");var a=c.split(" ").without("");for(var f=0;f<a.length;f++){switch(a[f].toLowerCase()){case"left":this.originAnchorLeft=this.anchorLeft=true;break;case"right":this.originAnchorRight=this.anchorRight=true;break;case"top":this.originAnchorTop=this.anchorTop=true;break;case"bottom":this.originAnchorBottom=this.anchorBottom=true;break}}}if(!this._verticalAlign){this._verticalAlign="bottom"}if(!this._horizontalAlign){this._horizontalAlign="left"}var d=this.node.getAttributeNS(null,"x");if(d){this.oldX=this.x=parseFloat(d)}else{}var l=this.node.getAttributeNS(null,"y");if(l){this.oldY=this.y=parseFloat(l)}else{}this.text(this.node.textContent)},resetAnchorPosition:function(){this.anchorLeft=this.originAnchorLeft||false;this.anchorRight=this.originAnchorRight||false;this.anchorTop=this.originAnchorTop||false;this.anchorBottom=this.originAnchorBottom||false},isOriginAnchorLeft:function(){return this.originAnchorLeft||false},isOriginAnchorRight:function(){return this.originAnchorRight||false},isOriginAnchorTop:function(){return this.originAnchorTop||false},isOriginAnchorBottom:function(){return this.originAnchorBottom||false},isAnchorLeft:function(){return this.anchorLeft||false},isAnchorRight:function(){return this.anchorRight||false},isAnchorTop:function(){return this.anchorTop||false},isAnchorBottom:function(){return this.anchorBottom||false},getX:function(){try{var a=this.node.x.baseVal.getItem(0).value;switch(this.horizontalAlign()){case"left":return a;case"center":return a-(this.getWidth()/2);case"right":return a-this.getWidth()}return this.node.getBBox().x}catch(c){return this.x}},setX:function(a){if(this.position){this.position.x=a}else{this.setOriginX(a)}},getY:function(){try{return this.node.getBBox().y}catch(a){return this.y}},setY:function(a){if(this.position){this.position.y=a}else{this.setOriginY(a)}},setOriginX:function(a){this.x=a},setOriginY:function(a){this.y=a},getWidth:function(){try{try{var g,l=this.node.childNodes;if(l.length==0||!Ext.isGecko){g=this.node.getBBox().width}else{for(var f=0,d=l.length;f<d;++f){var c=l[f].getComputedTextLength();if("undefined"==typeof g||g<c){g=c}}}return g+(g%2==0?0:1)}catch(a){return this.node.getBBox().width}}catch(h){return 0}},getOriginUpperLeft:function(){var a=this.x,c=this.y;switch(this._horizontalAlign){case"center":a-=this.getWidth()/2;break;case"right":a-=this.getWidth();break}switch(this._verticalAlign){case"middle":c-=this.getHeight()/2;break;case"bottom":c-=this.getHeight();break}return{x:a,y:c}},getHeight:function(){try{return this.node.getBBox().height}catch(a){return 0}},getCenter:function(){var a={x:this.getX(),y:this.getY()};a.x+=this.getWidth()/2;a.y+=this.getHeight()/2;return a},setPosition:function(a){if(!a||a.x===undefined||a.y===undefined){delete this.position}else{this.position=a}if(this.position){delete this._referencePoint;delete this.edgePosition}this._isChanged=true;this.update()},getPosition:function(){return this.position},setReferencePoint:function(a){if(a){this._referencePoint=a}else{delete this._referencePoint}if(this._referencePoint){delete this.position}},getReferencePoint:function(){return this._referencePoint||undefined},changed:function(){this._isChanged=true},registerOnChange:function(a){if(!this.changeCallbacks){this.changeCallbacks=[]}if(a instanceof Function&&!this.changeCallbacks.include(a)){this.changeCallbacks.push(a)}},unregisterOnChange:function(a){if(this.changeCallbacks&&a instanceof Function&&this.changeCallbacks.include(a)){this.changeCallbacks=this.changeCallbacks.without(a)}},isUpdating:function(){return !!this._isUpdating},getOriginEdgePosition:function(){return this.originEdgePosition},getEdgePosition:function(){return this.edgePosition||null},setEdgePosition:function(a){if(["starttop","startmiddle","startbottom","midtop","midbottom","endtop","endbottom"].include(a)){this.edgePosition=a;delete this.position;delete this._referencePoint}else{delete this.edgePosition}},update:function(d){var a=this.x,e=this.y;if(this.position){a=this.position.x;e=this.position.y}a=Math.floor(a);e=Math.floor(e);if(this._isChanged||a!==this.oldX||e!==this.oldY||d===true){if(this.isVisible){this._isChanged=false;this._isUpdating=true;this.node.setAttributeNS(null,"x",a);this.node.setAttributeNS(null,"y",e);this.node.removeAttributeNS(null,"fill-opacity");this.oldX=a;this.oldY=e;if(!this.position&&!this.getReferencePoint()){if(this._rotate!==undefined){if(this._rotationPoint){this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+Math.floor(this._rotationPoint.x)+" "+Math.floor(this._rotationPoint.y)+")")}else{this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+Math.floor(a)+" "+Math.floor(e)+")")}}}else{this.node.removeAttributeNS(null,"transform")}var c=this._text.split("\n");while(c.last()==""){c.pop()}if(this.node.ownerDocument){if(this.fitToElemId||this._textHasChanged){this.node.textContent="";c.each((function(g,f){var h=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");h.textContent=g.trim();if(this.fitToElemId){h.setAttributeNS(null,"x",this.invisibleRenderPoint);h.setAttributeNS(null,"y",this.invisibleRenderPoint)}if(h.textContent===""){h.textContent=" "}this.node.appendChild(h)}).bind(this));delete this._textHasChanged;delete this.indices}if(this.isVisible&&this.fitToElemId){this.node.setAttributeNS(null,"visibility","hidden")}if(this.fitToElemId){window.setTimeout(this._checkFittingToReferencedElem.bind(this),0)}else{this._positionText()}}}else{this.node.setAttributeNS(null,"fill-opacity","0.2")}}},_checkFittingToReferencedElem:function(){try{var c=$A(this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan"));var f=[];var n=this.node.ownerDocument.getElementById(this.fitToElemId);if(n){var m=n.getBBox();var u=this.getFontSize();for(var g=0;g<c.length;g++){var r=c[g];var v=this._getRenderedTextLength(r,undefined,undefined,u);var l=(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?m.height:m.width);if(v>l){var s=0;var p=0;var q=this.getTrimmedTextLength(r.textContent);for(var h=0;h<q;h++){var t=this._getRenderedTextLength(r,s,h-s,u);if(t>l-2){var d=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");if(p<=s){p=(h==0)?h:h-1;d.textContent=r.textContent.slice(s,p).trim()}else{d.textContent=r.textContent.slice(s,++p).trim()}d.setAttributeNS(null,"x",this.invisibleRenderPoint);d.setAttributeNS(null,"y",this.invisibleRenderPoint);f.push(d);s=p}else{var a=r.textContent.charAt(h);if(a==" "||a=="-"||a=="."||a==","||a==";"||a==":"){p=h}}}r.textContent=r.textContent.slice(s).trim()}f.push(r)}while(this.node.hasChildNodes()){this.node.removeChild(this.node.childNodes[0])}while(f.length>0){this.node.appendChild(f.shift())}}}catch(o){}window.setTimeout(this._positionText.bind(this),0)},_positionText:function(){try{var f=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");var o=this.getFontSize(this.node);var c=[];var n=this.x,m=this.y;if(this.position){n=this.position.x;m=this.position.y}n=Math.floor(n);m=Math.floor(m);var g=0,a=[];var h=(this.indices||$R(0,f.length-1).toArray());var d=h.length;h.each((function(p){if("undefined"==typeof p){return}var q=f[g++];if(q.textContent.trim()===""){c.push(q)}else{var e=0;switch(this._verticalAlign){case"bottom":e=-(d-p-1)*(o);break;case"middle":e=-(d/2-p-1)*(o);e-=ORYX.CONFIG.LABEL_LINE_DISTANCE/2;break;case"top":e=p*(o);e+=o;break}q.setAttributeNS(null,"dy",Math.floor(e));q.setAttributeNS(null,"x",n);q.setAttributeNS(null,"y",m);a.push(p)}}).bind(this));a.length=f.length;this.indices=this.indices||a;c.each(function(e){this.node.removeChild(e)}.bind(this));switch(this._horizontalAlign){case"left":this.node.setAttributeNS(null,"text-anchor","start");break;case"center":this.node.setAttributeNS(null,"text-anchor","middle");break;case"right":this.node.setAttributeNS(null,"text-anchor","end");break}}catch(l){this._isChanged=true}if(this.isVisible){this.node.removeAttributeNS(null,"visibility")}delete this._isUpdating;(this.changeCallbacks||[]).each(function(e){e.apply(e)})},_getRenderedTextLength:function(d,e,c,a){if(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){if(e===undefined){return d.getComputedTextLength()}else{return d.getSubStringLength(e,c)}}else{if(e===undefined){return this._estimateTextWidth(d.textContent,a)}else{return this._estimateTextWidth(d.textContent.substr(e,c).trim(),a)}}},_estimateTextWidth:function(e,d){var c=0;for(var a=0;a<e.length;a++){c+=this._estimateCharacterWidth(e.charAt(a))}return c*(d/14)},_estimateCharacterWidth:function(c){for(var a=0;a<this._characterSets.length;a++){if(this._characterSets[a].indexOf(c)>=0){return this._characterSetValues[a]}}return 9},getReferencedElementWidth:function(){var a=this.node.ownerDocument.getElementById(this.fitToElemId);if(a){var c=a.getBBox();if(c){return(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?c.height:c.width)}}return undefined},text:function(){switch(arguments.length){case 0:return this._text;break;case 1:var a=this._text;if(arguments[0]){this._text=arguments[0].toString()}else{this._text=""}if(a!==this._text){this._isChanged=true;this._textHasChanged=true}break;default:break}},getOriginVerticalAlign:function(){return this._originVerticalAlign},verticalAlign:function(){switch(arguments.length){case 0:return this._verticalAlign;case 1:if(["top","middle","bottom"].member(arguments[0])){var a=this._verticalAlign;this._verticalAlign=arguments[0];if(this._verticalAlign!==a){this._isChanged=true}}break;default:break}},getOriginHorizontalAlign:function(){return this._originHorizontalAlign},horizontalAlign:function(){switch(arguments.length){case 0:return this._horizontalAlign;case 1:if(["left","center","right"].member(arguments[0])){var a=this._horizontalAlign;this._horizontalAlign=arguments[0];if(this._horizontalAlign!==a){this._isChanged=true}}break;default:break}},rotate:function(){switch(arguments.length){case 0:return this._rotate;case 1:if(this._rotate!=arguments[0]){this._rotate=arguments[0];this._rotationPoint=undefined;this._isChanged=true}case 2:if(this._rotate!=arguments[0]||!this._rotationPoint||this._rotationPoint.x!=arguments[1].x||this._rotationPoint.y!=arguments[1].y){this._rotate=arguments[0];this._rotationPoint=arguments[1];this._isChanged=true}}},hide:function(){if(this.isVisible){this.isVisible=false;this._isChanged=true}},show:function(){if(!this.isVisible){this.isVisible=true;this._isChanged=true}},getInheritedFontSize:function(c){if(!c||!c.getAttributeNS){return}var a=c.getAttributeNS(null,"font-size");if(a){return parseFloat(a)}else{if(!ORYX.Editor.checkClassType(c,SVGSVGElement)){return this.getInheritedFontSize(c.parentNode)}}},getFontSize:function(c){var a=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");var d=this.getInheritedFontSize(this.node);if(!d){if(a[0]&&/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){d=a[0].getExtentOfChar(0).height}else{d=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT}if(d<=0){d=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT}}if(d){this.node.setAttribute("oryx:fontSize",d)}return d},getTrimmedTextLength:function(c){c=c.strip().gsub("  "," ");var a;do{a=c.length;c=c.gsub("  "," ")}while(a>c.length);return c.length},getOffsetBottom:function(){return this.offsetBottom},getOffsetTop:function(){return this.offsetTop},deserialize:function(c,a){if(c&&"undefined"!=typeof c.x&&"undefined"!=typeof c.y){this.setPosition({x:c.x,y:c.y});if("undefined"!=typeof c.distance){var e=a.dockers[c.from];var d=a.dockers[c.to];if(e&&d){this.setReferencePoint({dirty:true,distance:c.distance,intersection:{x:c.x,y:c.y},orientation:c.orientation,segment:{from:e,fromIndex:c.from,fromPosition:e.bounds.center(),to:d,toIndex:c.to,toPosition:d.bounds.center()}})}}if(c.left){this.anchorLeft=true}if(c.right){this.anchorRight=true}if(c.top){this.anchorTop=true}if(c.bottom){this.anchorBottom=true}if(c.valign){this.verticalAlign(c.valign)}if(c.align){this.horizontalAlign(c.align)}}else{if(c&&"undefined"!=typeof c.edge){this.setEdgePosition(c.edge)}}},serialize:function(){if(this.getEdgePosition()){if(this.getOriginEdgePosition()!==this.getEdgePosition()){return{edge:this.getEdgePosition()}}else{return null}}if(this.position){var c={x:this.position.x,y:this.position.y};if(this.isAnchorLeft()&&this.isAnchorLeft()!==this.isOriginAnchorLeft()){c.left=true}if(this.isAnchorRight()&&this.isAnchorRight()!==this.isOriginAnchorRight()){c.right=true}if(this.isAnchorTop()&&this.isAnchorTop()!==this.isOriginAnchorTop()){c.top=true}if(this.isAnchorBottom()&&this.isAnchorBottom()!==this.isOriginAnchorBottom()){c.bottom=true}if(this.getOriginVerticalAlign()!==this.verticalAlign()){c.valign=this.verticalAlign()}if(this.getOriginHorizontalAlign()!==this.horizontalAlign()){c.align=this.horizontalAlign()}return c}if(this.getReferencePoint()){var a=this.getReferencePoint();return{distance:a.distance,x:a.intersection.x,y:a.intersection.y,from:a.segment.fromIndex,to:a.segment.toIndex,orientation:a.orientation,valign:this.verticalAlign(),align:this.horizontalAlign()}}return null},toString:function(){return"Label "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Math){ORYX.Core.Math={}}ORYX.Core.Math.midPoint=function(c,a){return{x:(c.x+a.x)/2,y:(c.y+a.y)/2}};ORYX.Core.Math.isPointInLine=function(l,g,h,f,c,a,e){e=e?Math.abs(e):1;if(Math.abs(h-c)<=e&&Math.abs(l-h)<=e&&g-Math.max(f,a)<=e&&Math.min(f,a)-g<=e){return true}if(Math.abs(f-a)<=e&&Math.abs(g-f)<=e&&l-Math.max(h,c)<=e&&Math.min(h,c)-l<=e){return true}if(l>Math.max(h,c)||l<Math.min(h,c)){return false}if(g>Math.max(f,a)||g<Math.min(f,a)){return false}var d=(f-a)/(h-c);return Math.abs(g-((d*l)+f-d*h))<e};ORYX.Core.Math.isPointInEllipse=function(l,g,c,h,f,e){if(c===undefined||h===undefined||f===undefined||e===undefined){throw"ORYX.Core.Math.isPointInEllipse needs a ellipse with these properties: x, y, radiusX, radiusY"}var d=(l-c)/f;var a=(g-h)/e;return d*d+a*a<1};ORYX.Core.Math.isPointInPolygone=function(a,p,f){if(arguments.length<3){throw"ORYX.Core.Math.isPointInPolygone needs two arguments"}var h=f.length-1;if(f[0]!==f[h-1]||f[1]!==f[h]){f.push(f[0]);f.push(f[1])}var l=0;var e,o,c,n,m;for(var g=0;g<f.length-3;){e=f[g];o=f[++g];c=f[++g];n=f[g+1];m=(p-o)*(c-e)-(a-e)*(n-o);if((o>=p)!=(n>=p)){l+=n-o>=0?m>=0:m<=0}if(!m&&Math.min(e,c)<=a&&a<=Math.max(e,c)&&Math.min(o,n)<=p&&p<=Math.max(o,n)){return true}}return(l%2)?true:false};ORYX.Core.Math.distancePointLinie=function(f,e,a,c){var d=ORYX.Core.Math.getPointOfIntersectionPointLine(f,e,a,c);if(!d){return null}return ORYX.Core.Math.getDistancePointToPoint(a,d)};ORYX.Core.Math.getDistancePointToPoint=function(c,a){return Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2))};ORYX.Core.Math.getDistanceBetweenTwoPoints=function(d,c,a){return ORYX.Core.Math.getDistancePointToPoint(a,d)/ORYX.Core.Math.getDistancePointToPoint(d,c)};ORYX.Core.Math.pointIsLeftOfLine=function(f,e,a){var d=ORYX.Core.Math.getVector(f,e);var c=ORYX.Core.Math.getVector(f,a);return((d.x*c.y)-(c.x*d.y))>0};ORYX.Core.Math.getPointBetweenTwoPoints=function(c,a,d){d=Math.max(Math.min(d||0,1),0);if(d===0){return c}else{if(d===1){return a}}return{x:c.x+((a.x-c.x)*d),y:c.y+((a.y-c.y)*d)}};ORYX.Core.Math.getVector=function(c,a){return{x:a.x-c.x,y:a.y-c.y}};ORYX.Core.Math.getIdentityVector=function(a){if(arguments.length==2){a=ORYX.Core.Math.getVector(arguments[0],arguments[1])}var c=Math.sqrt((a.x*a.x)+(a.y*a.y));return{x:a.x/(c||1),y:a.y/(c||1)}};ORYX.Core.Math.getOrthogonalIdentityVector=function(d,c){var a=arguments.length==1?d:ORYX.Core.Math.getIdentityVector(d,c);return{x:a.y,y:-a.x}};ORYX.Core.Math.getPointOfIntersectionPointLine=function(g,d,a,f){var e=Math.pow(d.x-g.x,2)+Math.pow(d.y-g.y,2);if(e==0){return undefined}var c=((a.x-g.x)*(d.x-g.x)+(a.y-g.y)*(d.y-g.y))/e;if(f){if(!(0<=c&&c<=1)){return undefined}}pointOfIntersection=new Object();pointOfIntersection.x=g.x+c*(d.x-g.x);pointOfIntersection.y=g.y+c*(d.y-g.y);return pointOfIntersection};ORYX.Core.Math.getTranslatedPoint=function(c,d){var a=d.a*c.x+d.c*c.y+d.e*1;var e=d.b*c.x+d.d*c.y+d.f*1;return{x:a,y:e}};ORYX.Core.Math.getInverseMatrix=function(c){var d=ORYX.Core.Math.getDeterminant(c),a=c;return{a:d*((a.d*1)-(a.f*0)),b:d*((a.f*0)-(a.b*1)),c:d*((a.e*0)-(a.c*1)),d:d*((a.a*1)-(a.e*0)),e:d*((a.c*a.f)-(a.e*a.d)),f:d*((a.e*a.b)-(a.a*a.f))}};ORYX.Core.Math.getDeterminant=function(a){return(a.a*a.d*1)+(a.c*a.f*0)+(a.e*a.b*0)-(a.e*a.d*0)-(a.c*a.b*1)-(a.a*a.f*0)};ORYX.Core.Math.getTranslatedBoundingBox=function(c){var n=c.getCTM();var h=c.getBBox();var g=ORYX.Core.Math.getTranslatedPoint({x:h.x,y:h.y},n);var l=ORYX.Core.Math.getTranslatedPoint({x:h.x,y:h.y+h.height},n);var d=ORYX.Core.Math.getTranslatedPoint({x:h.x+h.width,y:h.y},n);var e=ORYX.Core.Math.getTranslatedPoint({x:h.x+h.width,y:h.y+h.height},n);var o={x:Math.min(g.x,l.x,d.x,e.x),y:Math.min(g.y,l.y,d.y,e.y)};var f={x:Math.max(g.x,l.x,d.x,e.x),y:Math.max(g.y,l.y,d.y,e.y)};var a=c.ownerSVGElement.childNodes[1].getCTM().node;return{x:o.x/a,y:o.y/a,width:(f.x-o.x)/a,height:(f.y-o.y)/a}};ORYX.Core.Math.getAngle=function(d,a){if(d.x==a.x&&d.y==a.y){return 0}var c=Math.asin(Math.sqrt(Math.pow(d.y-a.y,2))/(Math.sqrt(Math.pow(a.x-d.x,2)+Math.pow(d.y-a.y,2))))*180/Math.PI;if(a.x>=d.x&&a.y<=d.y){return c}else{if(a.x<d.x&&a.y<=d.y){return 180-c}else{if(a.x<d.x&&a.y>d.y){return 180+c}else{return 360-c}}}};new function(){var c=2,d=8,f=4,a=1;function e(h,p,o,m,l,g){var n=0;if(p>g){n|=d}else{if(p<m){n|=f}}if(h>l){n|=c}else{if(h<o){n|=a}}return n}ORYX.Core.Math.isRectOverLine=function(m,p,h,o,q,n,l,g){return !!ORYX.Core.Math.clipLineOnRect.apply(ORYX.Core.Math,arguments)};ORYX.Core.Math.getIntersectionPointOfRect=function(w,s,x,t,y,r,u,v){var l=ORYX.Core.Math.clipLineOnRect(w,s,x,t,y,r,u,v);if(l){if((l.a.x==w&&l.a.y==s)||(l.a.x==x&&l.a.y==t)){return l.b}else{if(l.b.x==w&&l.b.y==s||(l.b.x==x&&l.b.y==t)){return l.a}}}return null};ORYX.Core.Math.clipLineOnRect=function(l,w,h,u,g,z,s,n){var o,m,r,A=0;var p=false,q=false;o=e(l,w,g,z,s,n);m=e(h,u,g,z,s,n);do{if((o|m)==0){p=true;q=true}else{if((o&m)>0){q=true}else{var v=0,t=0;r=o!=0?o:m;if((r&d)>0){v=l+(h-l)*(n-w)/(u-w);t=n}else{if((r&f)>0){v=l+(h-l)*(z-w)/(u-w);t=z}else{if((r&c)>0){t=w+(u-w)*(s-l)/(h-l);v=s}else{if((r&a)>0){t=w+(u-w)*(g-l)/(h-l);v=g}}}}if(r==o){l=v;w=t;o=e(l,w,g,z,s,n)}else{h=v;u=t;m=e(h,u,g,z,s,n)}}}A++}while(q!=true&&A<5000);if(p){return{a:{x:l,y:w},b:{x:h,y:u}}}return null}}();if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Stencil={construct:function(e,f,a,n,m,l){arguments.callee.$.construct.apply(this,arguments);if(!e){throw"Stencilset seems corrupt."}if(!f){throw"Stencil does not provide namespace."}if(!a){throw"Stencil does not provide SVG source."}if(!n){throw"Fatal internal error loading stencilset."}this._source=a;this._jsonStencil=e;this._stencilSet=n;this._namespace=f;this._propertyPackages=m;if(l&&!this._jsonStencil.position){this._jsonStencil.position=l}this._view;this._properties=new Hash();if(!this._jsonStencil.type||!(this._jsonStencil.type==="edge"||this._jsonStencil.type==="node")){throw"ORYX.Core.StencilSet.Stencil(construct): Type is not defined."}if(!this._jsonStencil.id||this._jsonStencil.id===""){throw"ORYX.Core.StencilSet.Stencil(construct): Id is not defined."}if(!this._jsonStencil.title||this._jsonStencil.title===""){throw"ORYX.Core.StencilSet.Stencil(construct): Title is not defined."}if(!this._jsonStencil.description){this._jsonStencil.description=""}if(!this._jsonStencil.groups){this._jsonStencil.groups=[]}if(!this._jsonStencil.roles){this._jsonStencil.roles=[]}this._jsonStencil.roles.push(this._jsonStencil.id);this._jsonStencil.roles.each((function(p,o){this._jsonStencil.roles[o]=f+p}).bind(this));this._jsonStencil.roles=this._jsonStencil.roles.uniq();this._jsonStencil.id=f+this._jsonStencil.id;this.postProcessProperties();if(!this._jsonStencil.serialize){this._jsonStencil.serialize={}}if(!this._jsonStencil.deserialize){this._jsonStencil.deserialize={}}if(!this._jsonStencil.layout){this._jsonStencil.layout=[]}if(!this._jsonStencil.keepState){this._jsonStencil.keepState=false}var d=a+"view/"+e.view;if(this._jsonStencil.view.trim().match(/</)){var c=new DOMParser();var g=c.parseFromString(this._jsonStencil.view,"text/xml");if(ORYX.Editor.checkClassType(g.documentElement,SVGSVGElement)){this._view=g.documentElement;var h=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(h).each((function(p){var o=p.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(o&&o.value.indexOf("://")==-1){o.textContent=this._source+"view/"+o.value}}).bind(this))}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}}else{new Ajax.Request(d,{asynchronous:false,method:"get",onSuccess:this._loadSVGOnSuccess.bind(this),onFailure:this._loadSVGOnFailure.bind(this)})}},postProcessProperties:function(){if(this._jsonStencil.icon&&this._jsonStencil.icon.indexOf("://")===-1){this._jsonStencil.icon=this._source+"icons/"+this._jsonStencil.icon}else{this._jsonStencil.icon=""}if(this._jsonStencil.propertyPackages&&this._jsonStencil.propertyPackages instanceof Array){this._jsonStencil.propertyPackages.each((function(c){var a=this._propertyPackages[c];if(a){a.each((function(e){var d=new ORYX.Core.StencilSet.Property(e,this._namespace,this);this._properties[d.prefix()+"-"+d.id()]=d}).bind(this))}}).bind(this))}if(this._jsonStencil.properties&&this._jsonStencil.properties instanceof Array){this._jsonStencil.properties.each((function(c){var a=new ORYX.Core.StencilSet.Property(c,this._namespace,this);this._properties[a.prefix()+"-"+a.id()]=a}).bind(this))}},equals:function(a){return(this.id()===a.id())},stencilSet:function(){return this._stencilSet},type:function(){return this._jsonStencil.type},namespace:function(){return this._namespace},id:function(){return this._jsonStencil.id},idWithoutNs:function(){return this.id().replace(this.namespace(),"")},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"title")},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"description")},groups:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"groups")},position:function(){return(isNaN(this._jsonStencil.position)?0:this._jsonStencil.position)},view:function(){return this._view.cloneNode(true)||this._view},icon:function(){return this._jsonStencil.icon},fixedAspectRatio:function(){return this._jsonStencil.fixedAspectRatio===true},hasMultipleRepositoryEntries:function(){return(this.getRepositoryEntries().length>0)},getRepositoryEntries:function(){return(this._jsonStencil.repositoryEntries)?$A(this._jsonStencil.repositoryEntries):$A([])},properties:function(){return this._properties.values()},property:function(a){return this._properties[a]},roles:function(){return this._jsonStencil.roles},defaultAlign:function(){if(!this._jsonStencil.defaultAlign){return"east"}return this._jsonStencil.defaultAlign},serialize:function(a,c){return this._jsonStencil.serialize},deserialize:function(a,c){return this._jsonStencil.deserialize},keepState:function(){return this._jsonStencil.keepState},layout:function(a){return this._jsonStencil.layout},addProperty:function(d,c){if(d&&c){var a=new ORYX.Core.StencilSet.Property(d,c,this);this._properties[a.prefix()+"-"+a.id()]=a}},removeProperty:function(c){if(c){var a=this._properties.values().find(function(d){return(c==d.id())});if(a){delete this._properties[a.prefix()+"-"+a.id()]}}},_loadSVGOnSuccess:function(a){var c=null;c=a.responseXML;if(ORYX.Editor.checkClassType(c.documentElement,SVGSVGElement)){this._view=c.documentElement;var d=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(d).each((function(f){var e=f.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(e&&e.value.indexOf("://")==-1){e.textContent=this._source+"view/"+e.value}}).bind(this))}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}},_loadSVGOnFailure:function(a){throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnFailure): Loading SVG document failed."},toString:function(){return"Stencil "+this.title()+" ("+this.id()+")"}};ORYX.Core.StencilSet.Stencil=Clazz.extend(ORYX.Core.StencilSet.Stencil);function _evenMoreEvilHack(e,f){if(window.ActiveXObject){var c=new ActiveXObject("MSXML.DomDocument");c.loadXML(e);return c}else{if(window.XMLHttpRequest){var a=new XMLHttpRequest;a.open("GET","data:"+(f||"application/xml")+";charset=utf-8,"+encodeURIComponent(e),false);if(a.overrideMimeType){a.overrideMimeType(f)}a.send(null);return a.responseXML}}}function _evilSafariHack(e){var c=e;var a="data:text/xml;charset=utf-8,"+encodeURIComponent(c);var f=null;var d=new XMLHttpRequest();d.open("GET",a);d.onload=function(){f=d.responseXML};d.send(null);return f}if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Property=Clazz.extend({construct:function(e,c,d){arguments.callee.$.construct.apply(this,arguments);this._jsonProp=e||ORYX.Log.error("Parameter jsonProp is not defined.");this._namespace=c||ORYX.Log.error("Parameter namespace is not defined.");this._stencil=d||ORYX.Log.error("Parameter stencil is not defined.");this._items={};this._complexItems={};e.id=e.id||ORYX.Log.error("ORYX.Core.StencilSet.Property(construct): Id is not defined.");e.id=e.id.toLowerCase();if(!e.type){ORYX.Log.info("Type is not defined for stencil '%0', id '%1'. Falling back to 'String'.",d,e.id);e.type="string"}else{e.type=e.type.toLowerCase()}e.prefix=e.prefix||"oryx";e.title=e.title||"";e.value=e.value||"";e.description=e.description||"";e.readonly=e.readonly||false;e.optional=e.optional!==false;if(this._jsonProp.refToView){if(!(this._jsonProp.refToView instanceof Array)){this._jsonProp.refToView=[this._jsonProp.refToView]}}else{this._jsonProp.refToView=[]}var a=this.getMinForType(e.type);if(e.min===undefined||e.min===null){e.min=a}else{if(e.min<a){e.min=a}}var f=this.getMaxForType(e.type);if(e.max===undefined||e.max===null){e.max=f}else{if(e.max>f){e.min=f}}if(!e.fillOpacity){e.fillOpacity=false}if("number"!=typeof e.lightness){e.lightness=1}else{e.lightness=Math.max(0,Math.min(1,e.lightness))}if(!e.strokeOpacity){e.strokeOpacity=false}if(e.length===undefined||e.length===null){e.length=Number.MAX_VALUE}if(!e.wrapLines){e.wrapLines=false}if(!e.dateFormat){e.dateFormat=ORYX.I18N.PropertyWindow.dateFormat||"m/d/y"}if(!e.fill){e.fill=false}if(!e.stroke){e.stroke=false}if(!e.inverseBoolean){e.inverseBoolean=false}if(!e.directlyEditable&&e.directlyEditable!=false){e.directlyEditable=true}if(e.visible!==false){e.visible=true}if(e.isList!==true){e.isList=false;if(!e.list||!(e.list instanceof Array)){e.list=[]}}if(!e.category){if(e.popular){e.category="popular"}else{e.category="others"}}if(!e.alwaysAppearInMultiselect){e.alwaysAppearInMultiselect=false}if(e.type===ORYX.CONFIG.TYPE_CHOICE){if(e.items&&e.items instanceof Array){e.items.each((function(g){this._items[g.value.toLowerCase()]=new ORYX.Core.StencilSet.PropertyItem(g,c,this)}).bind(this))}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}else{if(e.type===ORYX.CONFIG.TYPE_COMPLEX){if(e.complexItems&&e.complexItems instanceof Array){e.complexItems.each((function(g){this._complexItems[g.id.toLowerCase()]=new ORYX.Core.StencilSet.ComplexPropertyItem(g,c,this)}).bind(this))}else{throw"ORYX.Core.StencilSet.Property(construct): No complex property items defined."}}}},getMinForType:function(a){if(a.toLowerCase()==ORYX.CONFIG.TYPE_INTEGER){return -Math.pow(2,31)}else{return -Number.MAX_VALUE+1}},getMaxForType:function(a){if(a.toLowerCase()==ORYX.CONFIG.TYPE_INTEGER){return Math.pow(2,31)-1}else{return Number.MAX_VALUE}},equals:function(a){return(this._namespace===a.namespace()&&this.id()===a.id())?true:false},namespace:function(){return this._namespace},stencil:function(){return this._stencil},id:function(){return this._jsonProp.id},prefix:function(){return this._jsonProp.prefix},type:function(){return this._jsonProp.type},inverseBoolean:function(){return this._jsonProp.inverseBoolean},category:function(){return this._jsonProp.category},setCategory:function(a){this._jsonProp.category=a},directlyEditable:function(){return this._jsonProp.directlyEditable},visible:function(){return this._jsonProp.visible},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"title")},value:function(){return this._jsonProp.value},readonly:function(){return this._jsonProp.readonly},optional:function(){return this._jsonProp.optional},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"description")},refToView:function(){return this._jsonProp.refToView},min:function(){return this._jsonProp.min},max:function(){return this._jsonProp.max},fillOpacity:function(){return this._jsonProp.fillOpacity},strokeOpacity:function(){return this._jsonProp.strokeOpacity},length:function(){return this._jsonProp.length?this._jsonProp.length:Number.MAX_VALUE},wrapLines:function(){return this._jsonProp.wrapLines},dateFormat:function(){return this._jsonProp.dateFormat},fill:function(){return this._jsonProp.fill},lightness:function(){return this._jsonProp.lightness},stroke:function(){return this._jsonProp.stroke},items:function(){return $H(this._items).values()},item:function(a){if(a){return this._items[a.toLowerCase()]}else{return null}},toString:function(){return"Property "+this.title()+" ("+this.id()+")"},complexItems:function(){return $H(this._complexItems).values()},complexItem:function(a){if(a){return this._complexItems[a.toLowerCase()]}else{return null}},complexAttributeToView:function(){return this._jsonProp.complexAttributeToView||""},isList:function(){return !!this._jsonProp.isList},getListItems:function(){return this._jsonProp.list},linkableType:function(){return this._jsonProp.linkableType||""},alwaysAppearInMultiselect:function(){return this._jsonProp.alwaysAppearInMultiselect},popular:function(){return this._jsonProp.configurationExtension?2:this._jsonProp.popular?1:3},setPopular:function(){this._jsonProp.popular=true},rowDelimiter:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"rowDelimiter")},itemDelimiter:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"rowDelimiter")},viewPrefix:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"viewPrefix")},viewSuffix:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"viewSuffix")}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.PropertyItem=Clazz.extend({construct:function(a,c,d){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter jsonItem is not defined."}if(!c){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter namespace is not defined."}if(!d){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter property is not defined."}this._jsonItem=a;this._namespace=c;this._property=d;if(!a.value){throw"ORYX.Core.StencilSet.PropertyItem(construct): Value is not defined."}if(this._jsonItem.refToView){if(!(this._jsonItem.refToView instanceof Array)){this._jsonItem.refToView=[this._jsonItem.refToView]}}else{this._jsonItem.refToView=[]}},equals:function(a){return(this.property().equals(a.property())&&this.value()===a.value())},namespace:function(){return this._namespace},property:function(){return this._property},value:function(){return this._jsonItem.value},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"title")},refToView:function(){return this._jsonItem.refToView},icon:function(){return(this._jsonItem.icon)?this.property().stencil()._source+"icons/"+this._jsonItem.icon:""},toString:function(){return"PropertyItem "+this.property()+" ("+this.value()+")"}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.ComplexPropertyItem=Clazz.extend({construct:function(a,c,d){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter jsonItem is not defined."}if(!c){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter namespace is not defined."}if(!d){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter property is not defined."}this._jsonItem=a;this._namespace=c;this._property=d;this._items=new Hash();this._complexItems={};if(!a.name){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Name is not defined."}if(!a.type){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Type is not defined."}else{a.type=a.type.toLowerCase()}if(a.type===ORYX.CONFIG.TYPE_CHOICE){if(a.items&&a.items instanceof Array){a.items.each((function(e){this._items[e.value]=new ORYX.Core.StencilSet.PropertyItem(e,c,this)}).bind(this))}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}},equals:function(a){return(this.property().equals(a.property())&&this.name()===a.name())},namespace:function(){return this._namespace},property:function(){return this._property},name:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"name")},id:function(){return this._jsonItem.id},type:function(){return this._jsonItem.type},optional:function(){return this._jsonItem.optional},width:function(){return this._jsonItem.width},value:function(){return this._jsonItem.value},items:function(){return this._items.values()},complexItems:function(){return $H(this._complexItems).values()},complexItem:function(a){if(a){return this._complexItems[a.toLowerCase()]}else{return null}},disable:function(){return this._jsonItem.disable},includeInView:function(){return this._jsonItem.includeInView},viewPrefix:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"viewPrefix")},viewSuffix:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"viewSuffix")}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Rules={construct:function(){arguments.callee.$.construct.apply(this,arguments);this._stencilSets=[];this._stencils=[];this._containerStencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._containmentRulesExcludes=[];this._morphingRules=new Hash();this._layoutRules=new Hash()},initializeRules:function(n){var m=this._stencilSets.find(function(q){return(q.namespace()==n.namespace())});if(m){var g=this._stencilSets.clone();g=g.without(m);g.push(n);this._stencilSets=[];this._stencils=[];this._containerStencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._containmentRulesExcludes=[];this._morphingRules=new Hash();this._layoutRules=new Hash();g.each(function(q){this.initializeRules(q)}.bind(this));return}else{this._stencilSets.push(n);var o=new Hash(n.jsonRules());var f=n.namespace();var c=n.stencils();n.extensions().values().each(function(r){if(r.rules){if(r.rules.connectionRules){o.connectionRules=o.connectionRules.concat(r.rules.connectionRules)}if(r.rules.cardinalityRules){o.cardinalityRules=o.cardinalityRules.concat(r.rules.cardinalityRules)}if(r.rules.containmentRules){o.containmentRules=o.containmentRules.concat(r.rules.containmentRules)}if(r.rules.morphingRules){var q=[].concat(r.rules.morphingRules).pluck("role");o.morphingRules=[].concat(r.rules.morphingRules,o.morphingRules.findAll(function(t){return !q.include(t.role)}))}}if(r.stencils){c=c.concat(r.stencils)}});this._stencils=this._stencils.concat(n.stencils());var h=this._connectionRules;if(o.connectionRules){o.connectionRules.each((function(q){if(this._isRoleOfOtherNamespace(q.role)){if(!h[q.role]){h[q.role]=new Hash()}}else{if(!h[f+q.role]){h[f+q.role]=new Hash()}}q.connects.each((function(r){var u=[];if(r.to){if(!(r.to instanceof Array)){r.to=[r.to]}r.to.each((function(v){if(this._isRoleOfOtherNamespace(v)){u.push(v)}else{u.push(f+v)}}).bind(this))}var t,s;if(this._isRoleOfOtherNamespace(q.role)){t=q.role}else{t=f+q.role}if(this._isRoleOfOtherNamespace(r.from)){s=r.from}else{s=f+r.from}if(!h[t][s]){h[t][s]=u}else{h[t][s]=h[t][s].concat(u)}}).bind(this))}).bind(this))}var d=this._cardinalityRules;if(o.cardinalityRules){o.cardinalityRules.each((function(s){var q;if(this._isRoleOfOtherNamespace(s.role)){q=s.role}else{q=f+s.role}if(!d[q]){d[q]={};for(i in s){d[q][i]=s[i]}}var t=new Hash();if(s.outgoingEdges){s.outgoingEdges.each((function(u){if(this._isRoleOfOtherNamespace(u.role)){t[u.role]=u}else{t[f+u.role]=u}}).bind(this))}d[q].outgoingEdges=t;var r=new Hash();if(s.incomingEdges){s.incomingEdges.each((function(u){if(this._isRoleOfOtherNamespace(u.role)){r[u.role]=u}else{r[f+u.role]=u}}).bind(this))}d[q].incomingEdges=r}).bind(this))}var a=this._containmentRules;if(o.containmentRules){o.containmentRules.each((function(r){var q;if(this._isRoleOfOtherNamespace(r.role)){q=r.role}else{this._containerStencils.push(f+r.role);q=f+r.role}if(!a[q]){a[q]=[]}(r.contains||[]).each((function(s){if(this._isRoleOfOtherNamespace(s)){a[q].push(s)}else{a[q].push(f+s)}}).bind(this))}).bind(this))}var e=this._morphingRules;if(o.morphingRules){o.morphingRules.each((function(r){var q;if(this._isRoleOfOtherNamespace(r.role)){q=r.role}else{q=f+r.role}if(!e[q]){e[q]=[]}if(!r.preserveBounds){r.preserveBounds=false}r.baseMorphs.each((function(t){var s=this._getStencilById(f+t);if(s){e[q].push(s)}}).bind(this))}).bind(this))}var l=this._layoutRules;if(o.layoutRules){var p=function(q){return{edgeRole:q.edgeRole||undefined,orientation:q.orientation||undefined,t:q.t||1,r:q.r||1,b:q.b||1,l:q.l||1}};o.layoutRules.each(function(r){var q;if(this._isRoleOfOtherNamespace(r.role)){q=r.role}else{q=f+r.role}if(!l[q]){l[q]={}}if(r["in"]){l[q]["in"]=p(r["in"])}if(r.ins){l[q]["ins"]=(r.ins||[]).map(function(s){return p(s)})}if(r.out){l[q]["out"]=p(r.out)}if(r.outs){l[q]["outs"]=(r.outs||[]).map(function(s){return p(s)})}}.bind(this))}}},_getStencilById:function(a){return this._stencils.find(function(c){return c.id()==a})},_cacheConnect:function(a){result=this._canConnect(a);if(a.sourceStencil&&a.targetStencil){var d=this._cachedConnectSET[a.sourceStencil.id()];if(!d){d=new Hash();this._cachedConnectSET[a.sourceStencil.id()]=d}var c=d[a.edgeStencil.id()];if(!c){c=new Hash();d[a.edgeStencil.id()]=c}c[a.targetStencil.id()]=result}else{if(a.sourceStencil){var d=this._cachedConnectSE[a.sourceStencil.id()];if(!d){d=new Hash();this._cachedConnectSE[a.sourceStencil.id()]=d}d[a.edgeStencil.id()]=result}else{var e=this._cachedConnectTE[a.targetStencil.id()];if(!e){e=new Hash();this._cachedConnectTE[a.targetStencil.id()]=e}e[a.edgeStencil.id()]=result}}return result},_cacheCard:function(c){if(c.sourceStencil){var d=this._cachedCardSE[c.sourceStencil.id()];if(!d){d=new Hash();this._cachedCardSE[c.sourceStencil.id()]=d}var a=this._getMaximumNumberOfOutgoingEdge(c);if(a==undefined){a=-1}d[c.edgeStencil.id()]=a}if(c.targetStencil){var e=this._cachedCardTE[c.targetStencil.id()];if(!e){e=new Hash();this._cachedCardTE[c.targetStencil.id()]=e}var a=this._getMaximumNumberOfIncomingEdge(c);if(a==undefined){a=-1}e[c.edgeStencil.id()]=a}},_cacheContain:function(c){var a=[this._canContain(c),this._getMaximumOccurrence(c.containingStencil,c.containedStencil)];if(a[1]==undefined){a[1]=-1}var d=this._cachedContainPC[c.containingStencil.id()];if(!d){d=new Hash();this._cachedContainPC[c.containingStencil.id()]=d}d[c.containedStencil.id()]=a;return a},_cacheMorph:function(c){var a=this._cachedMorphRS[c];if(!a){a=[];if(this._morphingRules.keys().include(c)){a=this._stencils.select(function(d){return d.roles().include(c)})}this._cachedMorphRS[c]=a}return a},outgoingEdgeStencils:function(a){if(!a.sourceShape&&!a.sourceStencil){return[]}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil()}var c=[];this._stencils.each((function(e){if(e.type()==="edge"){var d=Object.clone(a);d.edgeStencil=e;if(this.canConnect(d)){c.push(e)}}}).bind(this));return c},incomingEdgeStencils:function(a){if(!a.targetShape&&!a.targetStencil){return[]}if(a.targetShape){a.targetStencil=a.targetShape.getStencil()}var c=[];this._stencils.each((function(e){if(e.type()==="edge"){var d=Object.clone(a);d.edgeStencil=e;if(this.canConnect(d)){c.push(e)}}}).bind(this));return c},sourceStencils:function(c){if(!c||!c.edgeShape&&!c.edgeStencil){return[]}if(c.targetShape){c.targetStencil=c.targetShape.getStencil()}if(c.edgeShape){c.edgeStencil=c.edgeShape.getStencil()}var a=[];this._stencils.each((function(e){var d=Object.clone(c);d.sourceStencil=e;if(this.canConnect(d)){a.push(e)}}).bind(this));return a},targetStencils:function(a){if(!a||!a.edgeShape&&!a.edgeStencil){return[]}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil()}if(a.edgeShape){a.edgeStencil=a.edgeShape.getStencil()}var c=[];this._stencils.each((function(e){var d=Object.clone(a);d.targetStencil=e;if(this.canConnect(d)){c.push(e)}}).bind(this));return c},canConnect:function(d){if(!d||(!d.sourceShape&&!d.sourceStencil&&!d.targetShape&&!d.targetStencil)||!d.edgeShape&&!d.edgeStencil){return false}if(d.sourceShape){d.sourceStencil=d.sourceShape.getStencil()}if(d.targetShape){d.targetStencil=d.targetShape.getStencil()}if(d.edgeShape){d.edgeStencil=d.edgeShape.getStencil()}var c;if(d.sourceStencil&&d.targetStencil){var f=this._cachedConnectSET[d.sourceStencil.id()];if(!f){c=this._cacheConnect(d)}else{var e=f[d.edgeStencil.id()];if(!e){c=this._cacheConnect(d)}else{var g=e[d.targetStencil.id()];if(g==undefined){c=this._cacheConnect(d)}else{c=g}}}}else{if(d.sourceStencil){var f=this._cachedConnectSE[d.sourceStencil.id()];if(!f){c=this._cacheConnect(d)}else{var e=f[d.edgeStencil.id()];if(e==undefined){c=this._cacheConnect(d)}else{c=e}}}else{var g=this._cachedConnectTE[d.targetStencil.id()];if(!g){c=this._cacheConnect(d)}else{var e=g[d.edgeStencil.id()];if(e==undefined){c=this._cacheConnect(d)}else{c=e}}}}if(c){if(d.sourceShape){var f=this._cachedCardSE[d.sourceStencil.id()];if(!f){this._cacheCard(d);f=this._cachedCardSE[d.sourceStencil.id()]}var a=f[d.edgeStencil.id()];if(a==undefined){this._cacheCard(d)}a=f[d.edgeStencil.id()];if(a!=-1){c=d.sourceShape.getOutgoingShapes().all(function(h){if((h.getStencil().id()===d.edgeStencil.id())&&((d.edgeShape)?h!==d.edgeShape:true)){a--;return(a>0)?true:false}else{return true}})}}if(d.targetShape){var g=this._cachedCardTE[d.targetStencil.id()];if(!g){this._cacheCard(d);g=this._cachedCardTE[d.targetStencil.id()]}var a=g[d.edgeStencil.id()];if(a==undefined){this._cacheCard(d)}a=g[d.edgeStencil.id()];if(a!=-1){c=d.targetShape.getIncomingShapes().all(function(h){if((h.getStencil().id()===d.edgeStencil.id())&&((d.edgeShape)?h!==d.edgeShape:true)){a--;return(a>0)?true:false}else{return true}})}}}return c},_canConnect:function(c){if(!c||(!c.sourceShape&&!c.sourceStencil&&!c.targetShape&&!c.targetStencil)||!c.edgeShape&&!c.edgeStencil){return false}if(c.sourceShape){c.sourceStencil=c.sourceShape.getStencil()}if(c.targetShape){c.targetStencil=c.targetShape.getStencil()}if(c.edgeShape){c.edgeStencil=c.edgeShape.getStencil()}var d;var a=this._getConnectionRulesOfEdgeStencil(c.edgeStencil);if(a.keys().length===0){d=false}else{if(c.sourceStencil){d=c.sourceStencil.roles().any(function(f){var e=a[f];if(!e){return false}if(c.targetStencil){return(e.any(function(g){return c.targetStencil.roles().member(g)}))}else{return true}})}else{d=a.values().any(function(e){return c.targetStencil.roles().any(function(f){return e.member(f)})})}}return d},isContainer:function(a){return this._containerStencils.member(a.getStencil().id())},isContainable:function(c){if(this._containmentRulesExcludes.length===0){return true}if(c instanceof ORYX.Core.Shape){c=c.getStencil()}if(!(c instanceof ORYX.Core.StencilSet.Stencil)){return true}var a=c.roles();return !this._containmentRulesExcludes.any(function(d){return a.include(d)})},canContain:function(d){if(!d||!d.containingStencil&&!d.containingShape||!d.containedStencil&&!d.containedShape){return false}if(d.containedShape){d.containedStencil=d.containedShape.getStencil()}if(d.containingShape){d.containingStencil=d.containingShape.getStencil()}if(d.containedStencil.type()=="edge"){return false}var c;var e=this._cachedContainPC[d.containingStencil.id()];if(!e){c=this._cacheContain(d)}else{c=e[d.containedStencil.id()];if(!c){c=this._cacheContain(d)}}if(!c[0]){return false}else{if(c[1]==-1){return true}else{if(d.containingShape){var a=c[1];return d.containingShape.getChildShapes(false).all(function(f){if(f.getStencil().id()===d.containedStencil.id()){a--;return(a>0)?true:false}else{return true}})}else{return true}}}},_canContain:function(c){if(!c||!c.containingStencil&&!c.containingShape||!c.containedStencil&&!c.containedShape){return false}if(c.containedShape){c.containedStencil=c.containedShape.getStencil()}if(c.containingShape){c.containingStencil=c.containingShape.getStencil()}var a;a=c.containingStencil.roles().any((function(e){var d=this._containmentRules[e];if(d){return d.any(function(f){return c.containedStencil.roles().member(f)})}else{return false}}).bind(this));return a},morphStencils:function(c){if(!c.stencil&&!c.shape){return[]}if(c.shape){c.stencil=c.shape.getStencil()}var a=[];c.stencil.roles().each(function(e){this._cacheMorph(e).each(function(f){a.push(f)})}.bind(this));var d=this.baseMorphs();a=a.uniq().sort(function(f,e){return d.include(f)&&!d.include(e)?-1:(d.include(e)&&!d.include(f)?1:0)});return a},baseMorphs:function(){var a=[];this._morphingRules.each(function(c){c.value.each(function(d){a.push(d)})});return a},containsMorphingRules:function(){return this._stencilSets.any(function(a){return !!a.jsonRules().morphingRules})},connectMorph:function(f){if(!f||(!f.sourceShape&&!f.sourceStencil&&!f.targetShape&&!f.targetStencil)){return false}if(f.sourceShape){f.sourceStencil=f.sourceShape.getStencil()}if(f.targetShape){f.targetStencil=f.targetShape.getStencil()}var a=this.incomingEdgeStencils(f);var e=this.outgoingEdgeStencils(f);var d=a.select(function(g){return e.member(g)});var c=this.baseMorphs().select(function(g){return d.member(g)});if(c.size()>0){return c[0]}else{if(d.size()>0){return d[0]}}return null},showInShapeMenu:function(a){return this._stencilSets.any(function(c){return c.jsonRules().morphingRules.any(function(d){return a.roles().include(c.namespace()+d.role)&&d.showInShapeMenu!==false})})},preserveBounds:function(a){return this._stencilSets.any(function(c){return c.jsonRules().morphingRules.any(function(d){return a.roles().include(c.namespace()+d.role)&&d.preserveBounds})})},getLayoutingRules:function(e,g,d){if(!e||!(e instanceof ORYX.Core.Shape)){return}var f={"in":{},out:{}};var c=function(l,a,h){if(l&&l[a]){["t","r","b","l"].each(function(m){f[a][m]=Math.max(l[a][m],f[a][m]||0)})}if(l&&l[a+"s"] instanceof Array){["t","r","b","l"].each(function(q){var p=undefined;if(h){p=l[a+"s"].find(function(m){return !m.edgeRole&&h===m.orientation})}if(!p){p=l[a+"s"].find(function(m){return !m.edgeRole&&!m.orientation})}var o=undefined;if(h&&g instanceof ORYX.Core.Edge){o=l[a+"s"].find(function(m){return this._hasRole(g,m.edgeRole)&&h===m.orientation}.bind(this))}if(!o){o=l[a+"s"].find(function(m){return this._hasRole(g,m.edgeRole)&&!m.orientation}.bind(this))}f[a][q]=Math.max(o?o[q]:p[q],f[a][q]||0)}.bind(this))}}.bind(this);e.getStencil().roles().each(function(a){if(this._layoutRules[a]){c(this._layoutRules[a],"in",d);c(this._layoutRules[a],"out",d)}}.bind(this));["in","out"].each(function(a){["t","r","b","l"].each(function(h){f[a][h]=f[a][h]!==undefined?f[a][h]:1})});return f},_hasRole:function(c,d){if(!(c instanceof ORYX.Core.Shape)||!d){return}var a=c.getStencil().roles().any(function(e){return e==d});return a||c.getStencil().id()==(c.getStencil().namespace()+d)},_stencilsWithRole:function(a){return this._stencils.findAll(function(c){return(c.roles().member(a))?true:false})},_edgesWithRole:function(a){return this._stencils.findAll(function(c){return(c.roles().member(a)&&c.type()==="edge")?true:false})},_nodesWithRole:function(a){return this._stencils.findAll(function(c){return(c.roles().member(a)&&c.type()==="node")?true:false})},_getMaximumOccurrence:function(c,d){var a;d.roles().each((function(f){var e=this._cardinalityRules[f];if(e&&e.maximumOccurrence){if(a){a=Math.min(a,e.maximumOccurrence)}else{a=e.maximumOccurrence}}}).bind(this));return a},_getMaximumNumberOfOutgoingEdge:function(c){if(!c||!c.sourceStencil||!c.edgeStencil){return false}var a;c.sourceStencil.roles().each((function(e){var d=this._cardinalityRules[e];if(d&&d.outgoingEdges){c.edgeStencil.roles().each(function(f){var g=d.outgoingEdges[f];if(g&&g.maximum){if(a){a=Math.min(a,g.maximum)}else{a=g.maximum}}})}}).bind(this));return a},_getMaximumNumberOfIncomingEdge:function(c){if(!c||!c.targetStencil||!c.edgeStencil){return false}var a;c.targetStencil.roles().each((function(e){var d=this._cardinalityRules[e];if(d&&d.incomingEdges){c.edgeStencil.roles().each(function(f){var g=d.incomingEdges[f];if(g&&g.maximum){if(a){a=Math.min(a,g.maximum)}else{a=g.maximum}}})}}).bind(this));return a},_getConnectionRulesOfEdgeStencil:function(c){var a=new Hash();c.roles().each((function(d){if(this._connectionRules[d]){this._connectionRules[d].each(function(e){if(a[e.key]){a[e.key]=a[e.key].concat(e.value)}else{a[e.key]=e.value}})}}).bind(this));return a},_isRoleOfOtherNamespace:function(a){return(a.indexOf("#")>0)},toString:function(){return"Rules"}};ORYX.Core.StencilSet.Rules=Clazz.extend(ORYX.Core.StencilSet.Rules);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.StencilSet=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.StencilSet(construct): Parameter 'source' is not defined."}if(a.endsWith("/")){a=a.substr(0,a.length-1)}this._extensions=new Hash();this._source=a;this._baseUrl=a.substring(0,a.lastIndexOf("/")+1);this._jsonObject={};this._stencils=new Hash();this._availableStencils=new Hash();if(ORYX.CONFIG.BACKEND_SWITCH){new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._getJSONURL.bind(this),onFailure:this._cancelInit.bind(this)})}else{new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)})}if(this.errornous){throw"Loading stencil set "+a+" failed."}},findRootStencilName:function(){var a=this._stencils.values().find(function(c){return c._jsonStencil.mayBeRoot});if(!a){ORYX.Log.warn("Did not find any stencil that may be root. Taking a guess.");a=this._stencils.values()[0]}return a.id()},equals:function(a){return(this.namespace()===a.namespace())},stencils:function(m,n,l){if(m&&n){var a=this._availableStencils.values();var f=[m];var e=[];var o=[];while(f.size()>0){var c=f.pop();e.push(c);var d=a.findAll(function(q){var p={containingStencil:c,containedStencil:q};return n.canContain(p)});for(var h=0;h<d.size();h++){if(!e.member(d[h])){f.push(d[h])}}o=o.concat(d).uniq()}o=o.sortBy(function(p){return a.indexOf(p)});if(l){o=o.sortBy(function(p){return p.groups().first()})}var g=a.findAll(function(p){return p.type()=="edge"});o=o.concat(g);return o}else{if(l){return this._availableStencils.values().sortBy(function(p){return p.groups().first()})}else{return this._availableStencils.values()}}},nodes:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="node")})},edges:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="edge")})},stencil:function(a){return this._stencils[a]},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"title")},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"description")},namespace:function(){return this._jsonObject?this._jsonObject.namespace:null},jsonRules:function(){return this._jsonObject?this._jsonObject.rules:null},source:function(){return this._source},extensions:function(){return this._extensions},addExtension:function(a){new Ajax.Request(a,{method:"GET",asynchronous:false,onSuccess:(function(c){this.addExtensionDirectly(c.responseText)}).bind(this),onFailure:(function(c){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+c)}).bind(this),onException:(function(c){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+c)}).bind(this)})},addExtensionDirectly:function(str){try{eval("var jsonExtension = "+str);if(!(jsonExtension["extends"].endsWith("#"))){jsonExtension["extends"]+="#"}if(jsonExtension["extends"]==this.namespace()){this._extensions[jsonExtension.namespace]=jsonExtension;var defaultPosition=this._stencils.keys().size();if(jsonExtension.stencils){$A(jsonExtension.stencils).each(function(stencil){defaultPosition++;var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this,undefined,defaultPosition);this._stencils[oStencil.id()]=oStencil;this._availableStencils[oStencil.id()]=oStencil}.bind(this))}if(jsonExtension.properties){var stencils=this._stencils.values();stencils.each(function(stencil){var roles=stencil.roles();jsonExtension.properties.each(function(prop){prop.roles.any(function(role){role=jsonExtension["extends"]+role;if(roles.member(role)){prop.properties.each(function(property){stencil.addProperty(property,jsonExtension.namespace)});return true}else{return false}})})}.bind(this))}if(jsonExtension.removeproperties){jsonExtension.removeproperties.each(function(remprop){var stencil=this.stencil(jsonExtension["extends"]+remprop.stencil);if(stencil){remprop.properties.each(function(propId){stencil.removeProperty(propId)})}}.bind(this))}if(jsonExtension.removestencils){$A(jsonExtension.removestencils).each(function(remstencil){delete this._availableStencils[jsonExtension["extends"]+remstencil]}.bind(this))}}}catch(e){ORYX.Log.debug("StencilSet.addExtension: Something went wrong when initialising the stencil set extension. "+e)}},removeExtension:function(a){var c=this._extensions[a];if(c){if(c.stencils){$A(c.stencils).each(function(f){var e=new ORYX.Core.StencilSet.Stencil(f,this.namespace(),this._baseUrl,this);delete this._stencils[e.id()];delete this._availableStencils[e.id()]}.bind(this))}if(c.properties){var d=this._stencils.values();d.each(function(f){var e=f.roles();c.properties.each(function(g){g.roles.any(function(h){h=c["extends"]+h;if(e.member(h)){g.properties.each(function(l){f.removeProperty(l.id)});return true}else{return false}})})}.bind(this))}if(c.removeproperties){c.removeproperties.each(function(g){var f=this.stencil(c["extends"]+g.stencil);if(f){var e=$A(this._jsonObject.stencils).find(function(h){return h.id==f.id()});g.properties.each(function(l){var h=$A(e.properties).find(function(m){return m.id==l});f.addProperty(h,this.namespace())}.bind(this))}}.bind(this))}if(c.removestencils){$A(c.removestencils).each(function(e){var f=c["extends"]+e;this._availableStencils[f]=this._stencils[f]}.bind(this))}}delete this._extensions[a]},__handleStencilset:function(response){try{eval("this._jsonObject ="+response.responseText)}catch(e){throw"Stenciset corrupt: "+e}if(!this._jsonObject){throw"Error evaluating stencilset. It may be corrupt."}with(this._jsonObject){if(!namespace||namespace===""){throw"Namespace definition missing in stencilset."}if(!(stencils instanceof Array)){throw"Stencilset corrupt."}if(!namespace.endsWith("#")){namespace=namespace+"#"}if(!title){title=""}if(!description){description=""}}},_getJSONURL:function(a){this._baseUrl=a.responseText.substring(0,a.responseText.lastIndexOf("/")+1);this._source=a.responseText;new Ajax.Request(a.responseText,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)})},_init:function(d){this.__handleStencilset(d);var c=new Hash();if(this._jsonObject.propertyPackages){$A(this._jsonObject.propertyPackages).each((function(e){c[e.name]=e.properties}).bind(this))}var a=0;$A(this._jsonObject.stencils).each((function(f){a++;var e=new ORYX.Core.StencilSet.Stencil(f,this.namespace(),this._baseUrl,this,c,a);this._stencils[e.id()]=e;this._availableStencils[e.id()]=e}).bind(this))},_cancelInit:function(a){this.errornous=true},toString:function(){return"StencilSet "+this.title()+" ("+this.namespace()+")"}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet._stencilSetsByNamespace=new Hash();ORYX.Core.StencilSet._stencilSetsByUrl=new Hash();ORYX.Core.StencilSet._StencilSetNSByEditorInstance=new Hash();ORYX.Core.StencilSet._rulesByEditorInstance=new Hash();ORYX.Core.StencilSet.stencilSets=function(c){var d=ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c];var a=new Hash();if(d){d.each(function(f){var e=ORYX.Core.StencilSet.stencilSet(f);a[e.namespace()]=e})}return a};ORYX.Core.StencilSet.stencilSet=function(a){ORYX.Log.trace("Getting stencil set %0",a);var c=a.split("#",1);if(c.length===1){ORYX.Log.trace("Getting stencil set %0",c[0]);return ORYX.Core.StencilSet._stencilSetsByNamespace[c[0]+"#"]}else{return undefined}};ORYX.Core.StencilSet.stencil=function(c){ORYX.Log.trace("Getting stencil for %0",c);var a=ORYX.Core.StencilSet.stencilSet(c);if(a){return a.stencil(c)}else{ORYX.Log.trace("Cannot fild stencil for %0",c);return undefined}};ORYX.Core.StencilSet.rules=function(a){if(!ORYX.Core.StencilSet._rulesByEditorInstance[a]){ORYX.Core.StencilSet._rulesByEditorInstance[a]=new ORYX.Core.StencilSet.Rules()}return ORYX.Core.StencilSet._rulesByEditorInstance[a]};ORYX.Core.StencilSet.loadStencilSet=function(a,d){var e=ORYX.Core.StencilSet._stencilSetsByUrl[a];if(!e){e=new ORYX.Core.StencilSet.StencilSet(a);ORYX.Core.StencilSet._stencilSetsByNamespace[e.namespace()]=e;ORYX.Core.StencilSet._stencilSetsByUrl[a]=e}var c=e.namespace();if(ORYX.Core.StencilSet._StencilSetNSByEditorInstance[d]){ORYX.Core.StencilSet._StencilSetNSByEditorInstance[d].push(c)}else{ORYX.Core.StencilSet._StencilSetNSByEditorInstance[d]=[c]}if(ORYX.Core.StencilSet._rulesByEditorInstance[d]){ORYX.Core.StencilSet._rulesByEditorInstance[d].initializeRules(e)}else{var f=new ORYX.Core.StencilSet.Rules();f.initializeRules(e);ORYX.Core.StencilSet._rulesByEditorInstance[d]=f}};ORYX.Core.StencilSet.getTranslation=function(d,c){var e=ORYX.I18N.Language.toLowerCase();var a=d[c+"_"+e];if(a){return a}a=d[c+"_"+e.substr(0,2)];if(a){return a}return d[c]};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Command=Clazz.extend({construct:function(){},execute:function(){throw"Command.execute() has to be implemented!"},rollback:function(){throw"Command.rollback() has to be implemented!"}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Bounds={construct:function(){this._changedCallbacks=[];this.a={};this.b={};this.set.apply(this,arguments);this.suspendChange=false;this.changedWhileSuspend=false},_changed:function(a){if(!this.suspendChange){this._changedCallbacks.each(function(c){c(this,a)}.bind(this));this.changedWhileSuspend=false}else{this.changedWhileSuspend=true}},registerCallback:function(a){if(!this._changedCallbacks.member(a)){this._changedCallbacks.push(a)}},unregisterCallback:function(a){this._changedCallbacks=this._changedCallbacks.without(a)},set:function(){var f=false;switch(arguments.length){case 1:if(this.a.x!==arguments[0].a.x){f=true;this.a.x=arguments[0].a.x}if(this.a.y!==arguments[0].a.y){f=true;this.a.y=arguments[0].a.y}if(this.b.x!==arguments[0].b.x){f=true;this.b.x=arguments[0].b.x}if(this.b.y!==arguments[0].b.y){f=true;this.b.y=arguments[0].b.y}break;case 2:var c=Math.min(arguments[0].x,arguments[1].x);var a=Math.min(arguments[0].y,arguments[1].y);var e=Math.max(arguments[0].x,arguments[1].x);var d=Math.max(arguments[0].y,arguments[1].y);if(this.a.x!==c){f=true;this.a.x=c}if(this.a.y!==a){f=true;this.a.y=a}if(this.b.x!==e){f=true;this.b.x=e}if(this.b.y!==d){f=true;this.b.y=d}break;case 4:var c=Math.min(arguments[0],arguments[2]);var a=Math.min(arguments[1],arguments[3]);var e=Math.max(arguments[0],arguments[2]);var d=Math.max(arguments[1],arguments[3]);if(this.a.x!==c){f=true;this.a.x=c}if(this.a.y!==a){f=true;this.a.y=a}if(this.b.x!==e){f=true;this.b.x=e}if(this.b.y!==d){f=true;this.b.y=d}break}if(f){this._changed(true)}},moveTo:function(){var a=this.upperLeft();switch(arguments.length){case 1:this.moveBy({x:arguments[0].x-a.x,y:arguments[0].y-a.y});break;case 2:this.moveBy({x:arguments[0]-a.x,y:arguments[1]-a.y});break;default:}},moveBy:function(){var d=false;switch(arguments.length){case 1:var c=arguments[0];if(c.x!==0||c.y!==0){d=true;this.a.x+=c.x;this.b.x+=c.x;this.a.y+=c.y;this.b.y+=c.y}break;case 2:var a=arguments[0];var e=arguments[1];if(a!==0||e!==0){d=true;this.a.x+=a;this.b.x+=a;this.a.y+=e;this.b.y+=e}break;default:}if(d){this._changed()}},include:function(c){if((this.a.x===undefined)&&(this.a.y===undefined)&&(this.b.x===undefined)&&(this.b.y===undefined)){return c}var a=Math.min(this.a.x,c.a.x);var f=Math.min(this.a.y,c.a.y);var e=Math.max(this.b.x,c.b.x);var d=Math.max(this.b.y,c.b.y);this.set(a,f,e,d)},extend:function(a){if(a.x!==0||a.y!==0){this.b.x+=a.x;this.b.y+=a.y;this._changed(true)}},widen:function(a){if(a!==0){this.suspendChange=true;this.moveBy({x:-a,y:-a});this.extend({x:2*a,y:2*a});this.suspendChange=false;if(this.changedWhileSuspend){this._changed(true)}}},upperLeft:function(){return{x:this.a.x,y:this.a.y}},lowerRight:function(){return{x:this.b.x,y:this.b.y}},width:function(){return this.b.x-this.a.x},height:function(){return this.b.y-this.a.y},center:function(){return{x:(this.a.x+this.b.x)/2,y:(this.a.y+this.b.y)/2}},midPoint:function(){return{x:(this.b.x-this.a.x)/2,y:(this.b.y-this.a.y)/2}},centerMoveTo:function(){var a=this.center();switch(arguments.length){case 1:this.moveBy(arguments[0].x-a.x,arguments[0].y-a.y);break;case 2:this.moveBy(arguments[0]-a.x,arguments[1]-a.y);break}},isIncluded:function(a,f){var g,e,f;switch(arguments.length){case 1:g=arguments[0].x;e=arguments[0].y;f=0;break;case 2:if(arguments[0].x&&arguments[0].y){g=arguments[0].x;e=arguments[0].y;f=Math.abs(arguments[1])}else{g=arguments[0];e=arguments[1];f=0}break;case 3:g=arguments[0];e=arguments[1];f=Math.abs(arguments[2]);break;default:throw"isIncluded needs one, two or three arguments"}var d=this.upperLeft();var c=this.lowerRight();if(g>=d.x-f&&g<=c.x+f&&e>=d.y-f&&e<=c.y+f){return true}else{return false}},clone:function(){return new ORYX.Core.Bounds(this)},toString:function(){return"( "+this.a.x+" | "+this.a.y+" )/( "+this.b.x+" | "+this.b.y+" )"},serializeForERDF:function(){return this.a.x+","+this.a.y+","+this.b.x+","+this.b.y}};ORYX.Core.Bounds=Clazz.extend(ORYX.Core.Bounds);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.UIObject={construct:function(a){this.isChanged=true;this.isResized=true;this.isVisible=true;this.isSelectable=false;this.isResizable=false;this.isMovable=false;this.id=ORYX.Editor.provideId();this.parent=undefined;this.node=undefined;this.children=[];this.bounds=new ORYX.Core.Bounds();this._changedCallback=this._changed.bind(this);this.bounds.registerCallback(this._changedCallback);if(a&&a.eventHandlerCallback){this.eventHandlerCallback=a.eventHandlerCallback}},_changed:function(c,a){this.isChanged=true;if(this.bounds==c){this.isResized=a||this.isResized}},update:function(){if(this.isChanged){this.refresh();this.isChanged=false;this.children.each(function(a){a.update()})}},refresh:function(){},getChildren:function(){return this.children.clone()},getParents:function(){var a=[];var c=this.parent;while(c){a.push(c);c=c.parent}return a},isParent:function(a){var c=this;while(c){if(c===a){return true}c=c.parent}return false},getId:function(){return this.id},getChildById:function(c,a){return this.children.find(function(d){if(d.getId()===c){return d}else{if(a){var e=d.getChildById(c,a);if(e){return e}}}})},add:function(a){if(!(this.children.member(a))){if(a.parent){a.remove(a)}this.children.push(a);a.parent=this;a.node=this.node.appendChild(a.node);a.bounds.registerCallback(this._changedCallback)}else{ORYX.Log.info("add: ORYX.Core.UIObject is already a child of this object.")}},remove:function(a){if(this.children.member(a)){this.children=this._uiObjects.without(a);a.parent=undefined;a.node=this.node.removeChild(a.node);a.bounds.unregisterCallback(this._changedCallback)}else{ORYX.Log.info("remove: ORYX.Core.UIObject is not a child of this object.")}},absoluteBounds:function(){if(this.parent){var a=this.absoluteXY();return new ORYX.Core.Bounds(a.x,a.y,a.x+this.bounds.width(),a.y+this.bounds.height())}else{return this.bounds.clone()}},absoluteXY:function(){if(this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.upperLeft().x,y:a.y+this.bounds.upperLeft().y}}else{return{x:this.bounds.upperLeft().x,y:this.bounds.upperLeft().y}}},absoluteCenterXY:function(){if(this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.center().x,y:a.y+this.bounds.center().y}}else{return{x:this.bounds.center().x,y:this.bounds.center().y}}},hide:function(){this.node.setAttributeNS(null,"display","none");this.isVisible=false;this.children.each(function(a){a.hide()})},show:function(){this.node.setAttributeNS(null,"display","inherit");this.isVisible=true;this.children.each(function(a){a.show()})},addEventHandlers:function(a){a.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this._delegateEvent.bind(this),false);a.addEventListener("click",this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_DBLCLICK,this._delegateEvent.bind(this),false)},_delegateEvent:function(a){if(this.eventHandlerCallback){this.eventHandlerCallback(a,this)}},toString:function(){return"UIObject "+this.id}};ORYX.Core.UIObject=Clazz.extend(ORYX.Core.UIObject);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.AbstractShape=ORYX.Core.UIObject.extend({construct:function(a,c){arguments.callee.$.construct.apply(this,arguments);this.resourceId=ORYX.Editor.provideId();this._stencil=c;if(this._stencil._jsonStencil.superId){stencilId=this._stencil.id();superStencilId=stencilId.substring(0,stencilId.indexOf("#")+1)+c._jsonStencil.superId;stencilSet=this._stencil.stencilSet();this._stencil=stencilSet.stencil(superStencilId)}this.properties=new Hash();this.propertiesChanged=new Hash();this.hiddenProperties=new Hash();this._stencil.properties().each((function(e){var d=e.prefix()+"-"+e.id();this.properties[d]=e.value();this.propertiesChanged[d]=true}).bind(this));if(c._jsonStencil.superId){c.properties().each((function(g){var e=g.prefix()+"-"+g.id();var f=g.value();var d=this.properties[e];this.properties[e]=f;this.propertiesChanged[e]=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,name:e,value:f,oldValue:d})}).bind(this))}},setResourceId:function(a){this.resourceId=a;this.node.id="svg-"+a},layout:function(){},getStencil:function(){return this._stencil},getChildShapeByResourceId:function(a){a=ERDF.__stripHashes(a);return this.getChildShapes(true).find(function(c){return c.resourceId==a})},getChildShapes:function(c,d){var a=[];this.children.each(function(e){if(e instanceof ORYX.Core.Shape&&e.isVisible){if(d){d(e)}a.push(e);if(c){a=a.concat(e.getChildShapes(c,d))}}});return a},hasChildShape:function(a){return this.getChildShapes().any(function(c){return(c===a)||c.hasChildShape(a)})},getChildNodes:function(c,d){var a=[];this.children.each(function(e){if(e instanceof ORYX.Core.Node&&e.isVisible){if(d){d(e)}a.push(e)}if(e instanceof ORYX.Core.Shape){if(c){a=a.concat(e.getChildNodes(c,d))}}});return a},getChildEdges:function(c,d){var a=[];this.children.each(function(e){if(e instanceof ORYX.Core.Edge&&e.isVisible){if(d){d(e)}a.push(e)}if(e instanceof ORYX.Core.Shape){if(c){a=a.concat(e.getChildEdges(c,d))}}});return a},getAbstractShapesAtPosition:function(){var c,f;switch(arguments.length){case 1:c=arguments[0].x;f=arguments[0].y;break;case 2:c=arguments[0];f=arguments[1];break;default:throw"getAbstractShapesAtPosition needs 1 or 2 arguments!"}if(this.isPointIncluded(c,f)){var a=[];a.push(this);var e=this.getChildNodes();var d=this.getChildEdges();[e,d].each(function(g){var h=new Hash();g.each(function(l){if(!l.isVisible){return}var n=l.getAbstractShapesAtPosition(c,f);if(n.length>0){var m=$A(l.node.parentNode.childNodes);var o=m.indexOf(l.node);h[o]=n}});h.keys().sort().each(function(l){a=a.concat(h[l])})});return a}else{return[]}},setProperty:function(e,g,h){e=(e||"").toLowerCase();if(!e.startsWith("oryx-")){e="oryx-"+e}var f=this.properties[e];if(f!==g||h===true){if("string"==typeof g){g=g.replace(/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"");g=g.gsub(String.fromCharCode(11),"")}this.properties[e]=g;this.propertiesChanged[e]=true;this._changed();if(!this._isInSetProperty){this._isInSetProperty=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,elements:[this],name:e,value:g,oldValue:f});delete this._isInSetProperty}}},getProperty:function(c){c=(c||"").toLowerCase();if(!c.startsWith("oryx-")){c="oryx-"+c}return this.properties[c]},hasProperty:function(c){c=(c||"").toLowerCase();if(!c.startsWith("oryx-")){c="oryx-"+c}return $H(this.properties).keys().include(c)},getGlossaryLinks:function(c){if(c instanceof ORYX.Core.StencilSet.Property){c=c.id()}c=(c||"").toLowerCase();if(c.startsWith("oryx-")){c=c.replace("oryx-","")}return this.glossaryLinks[c]||[]},setGlossaryLinks:function(d,c){if(!d){return false}if(d instanceof ORYX.Core.StencilSet.Property){d=d.id()}if(d.startsWith("oryx-")){d=d.replace("oryx-","")}c=[].concat(c||undefined).compact();if(c.length){this.glossaryLinks[d]=c.map(function(a){return a instanceof Ext.data.Record?a.get("href"):a})}else{delete this.glossaryLinks[d]}return true},setFormat:function(d,f){var e=this.formats[d];if(f instanceof Array){if(f.length>0){this.formats[d]=f}else{delete this.formats[d]}this.propertiesChanged[d]=true;this._changed()}},getFormat:function(c){return this.formats[c]},isPropertyChanged:function(){return this.propertiesChanged.any(function(a){return a.value})},setHiddenProperty:function(c,d){if(d===undefined){delete this.hiddenProperties[c];return}var a=this.hiddenProperties[c];if(a!==d){this.hiddenProperties[c]=d}},isPointIncluded:function(e,d,c){var a=c?c:this.absoluteBounds();return a.isIncluded(e,d)},serialize:function(){var a=[];a.push({name:"type",prefix:"oryx",value:this.getStencil().id(),type:"literal"});this.hiddenProperties.each(function(c){a.push({name:c.key.replace("oryx-",""),prefix:"oryx",value:c.value,type:"literal"})}.bind(this));this.getStencil().properties().each((function(e){var d=e.prefix();var c=e.id();a.push({name:c,prefix:d,value:this.properties[d+"-"+c],type:"literal"})}).bind(this));return a},deserialize:function(c){var a=0;c=c.sort(function(e,d){e=Number(this.properties.keys().member(e.prefix+"-"+e.name));d=Number(this.properties.keys().member(d.prefix+"-"+d.name));return e>d?1:(e<d?-1:0)}.bind(this));c.each((function(h){var d=h.name;var g=h.prefix;var f=h.value;if(Ext.type(f)==="object"){f=Ext.encode(f)}switch(g+"-"+d){case"raziel-parent":if(!this.parent){break}var e=this.getCanvas().getChildShapeByResourceId(f);if(e){e.add(this)}break;default:var l=this.getStencil().property(g+"-"+d);if(l&&l.isList()&&typeof f==="string"){if((f||"").strip()&&!f.startsWith("[")&&!f.startsWith("]")){f='["'+f.strip()+'"]'}f=((f||"").strip()||"[]").evalJSON()}if(this.properties.keys().member(g+"-"+d)){this.setProperty(g+"-"+d,f)}else{if(!(d==="bounds"||d==="parent"||d==="target"||d==="dockers"||d==="docker"||d==="outgoing"||d==="incoming")){this.setHiddenProperty(g+"-"+d,f)}}}}).bind(this))},migrateOldGlossarySchema:function(c,a){if(c&&a){if("string"==typeof a&&c.refToView().length&&ORYX.Utils.isOldGlossarySchema(a)){this.setGlossaryLinks(c.origin(),ORYX.CONFIG.GLOSSARY_PATH+"/"+ORYX.Utils.getGlossaryId(a));a=ORYX.Utils.glossaryTitle(a)}else{if(c.type()===ORYX.CONFIG.TYPE_GLOSSARY_LINK){if("string"==typeof a&&ORYX.Utils.isOldGlossarySchema(a)){a=ORYX.CONFIG.GLOSSARY_PATH+"/"+ORYX.Utils.getGlossaryId(a)}else{if(a instanceof Array){a=a.map(function(d){return ORYX.Utils.isOldGlossarySchema(d)?ORYX.CONFIG.GLOSSARY_PATH+"/"+ORYX.Utils.getGlossaryId(d):d})}}}}}return a},toString:function(){return"ORYX.Core.AbstractShape "+this.id},toJSON:function(){var a={resourceId:this.resourceId,properties:Ext.apply({},this.properties,this.hiddenProperties).inject({},function(f,l){var d=l[0];var g=l[1];if(this.getStencil().property(d)&&this.getStencil().property(d).type()===ORYX.CONFIG.TYPE_COMPLEX&&Ext.type(g)==="string"){try{g=Ext.decode(g)}catch(c){}}else{if(g instanceof Date&&this.getStencil().property(d)){try{g=g.format(this.getStencil().property(d).dateFormat())}catch(h){}}}d=d.replace(/^[\w_]+-/,"");f[d]=g;return f}.bind(this)),stencil:{id:this.getStencil().idWithoutNs()},childShapes:this.getChildShapes().map(function(c){return c.toJSON()})};if(this.getOutgoingShapes){a.outgoing=this.getOutgoingShapes().map(function(c){return{resourceId:c.resourceId}})}if(this.bounds){a.bounds={lowerRight:this.bounds.lowerRight(),upperLeft:this.bounds.upperLeft()}}if(this.dockers){a.dockers=this.dockers.map(function(c){var e=c.getDockedShape()&&c.referencePoint?c.referencePoint:c.bounds.center();e.getDocker=function(){return c};return e})}Ext.apply(a,ORYX.Core.AbstractShape.JSONHelper);a.getShape=function(){return this}.bind(this);return a}});ORYX.Core.AbstractShape.JSONHelper={eachChild:function(d,c,e){if(!this.childShapes){return}var a=[];this.childShapes.each(function(f){if(!(f.eachChild instanceof Function)){Ext.apply(f,ORYX.Core.AbstractShape.JSONHelper)}var g=d(f,this);if(g){a.push(g)}if(c){f.eachChild(d,c,e)}}.bind(this));if(e){this.childShapes=a}},getShape:function(){return null},getChildShapes:function(a){var c=this.childShapes;if(a){this.eachChild(function(d){if(!(d.getChildShapes instanceof Function)){Ext.apply(d,ORYX.Core.AbstractShape.JSONHelper)}c=c.concat(d.getChildShapes(a))},true)}return c},serialize:function(){return Ext.encode(this)}};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Canvas=ORYX.Core.AbstractShape.extend({zoomLevel:1,construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!(a&&a.width&&a.height)){ORYX.Log.fatal("Canvas is missing mandatory parameters options.width and options.height.");return}this.resourceId=a.id;this.nodes=[];this.edges=[];this.rootNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",a.parentNode,["svg",{id:this.id,width:a.width,height:a.height},["defs",{}]]);this.rootNode.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");this.rootNode.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");this._htmlContainer=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",a.parentNode,["div",{style:"position:absolute; top:5px"}]);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.rootNode,["g",{},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children"}],["g",{"class":"edge"}]],["g",{"class":"svgcontainer"}]]);this.node.setAttributeNS(null,"stroke","black");this.node.setAttributeNS(null,"font-family","Verdana, sans-serif");this.node.setAttributeNS(null,"font-size-adjust","none");this.node.setAttributeNS(null,"font-style","normal");this.node.setAttributeNS(null,"font-variant","normal");this.node.setAttributeNS(null,"font-weight","normal");this.node.setAttributeNS(null,"line-heigth","normal");this.node.setAttributeNS(null,"font-size",ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT);this.bounds.set(0,0,a.width,a.height);this.addEventHandlers(this.rootNode.parentNode);this.rootNode.oncontextmenu=function(){return false}},getScrollNode:function(){return Ext.get(this.rootNode).parent("div{overflow=auto}",true)},focus:function(){try{if(!this.focusEl){this.focusEl=Ext.getBody().createChild({tag:"a",href:"#",cls:"x-grid3-focus x-grid3-focus-canvas",tabIndex:"-1"});this.focusEl.swallowEvent("click",true)}if(Ext.isGecko){this.focusEl.focus()}else{this.focusEl.focus.defer(1,this.focusEl)}this.focusEl.blur.defer(3,this.focusEl)}catch(a){}},update:function(){this.nodes.each(function(c){this._traverseForUpdate(c)}.bind(this));var a=this.getStencil().layout();if(a){a.each(function(c){c.shape=this;c.forceExecution=true;c.target=this.rootNode;this._delegateEvent(c)}.bind(this))}this.nodes.invoke("_update");this.edges.invoke("_update",true)},_traverseForUpdate:function(a){var c=a.isChanged;a.getChildNodes(false,function(d){if(this._traverseForUpdate(d)){c=true}}.bind(this));if(c){a.layout();return true}else{return false}},layout:function(){},getChildNodes:function(c,d){if(!c&&!d){return this.nodes.clone()}else{var a=[];this.nodes.each(function(e){if(d){d(e)}a.push(e);if(c&&e instanceof ORYX.Core.Shape){a=a.concat(e.getChildNodes(c,d))}});return a}},add:function(a,d,c){if(a instanceof ORYX.Core.UIObject){if(!(this.children.member(a))){if(a.parent){a.parent.remove(a,true)}if(d!==undefined){this.children.splice(d,0,a)}else{this.children.push(a)}a.parent=this;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.addMarkers(this.rootNode.getElementsByTagNameNS(NAMESPACE_SVG,"defs")[0]);a.node=this.node.childNodes[0].childNodes[2].appendChild(a.node);this.edges.push(a)}else{a.node=this.node.childNodes[0].childNodes[1].appendChild(a.node);this.nodes.push(a)}}else{a.node=this.node.appendChild(a.node)}a.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback&&c!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:a})}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.")}}else{ORYX.Log.fatal("add: Parameter is not of type ORYX.Core.UIObject.")}},remove:function(a,c){if(this.children.member(a)){var d=a.parent;this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();if($A(this.node.childNodes[0].childNodes[2].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node)}this.edges=this.edges.without(a)}else{if($A(this.node.childNodes[0].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node)}this.nodes=this.nodes.without(a)}}else{if($A(this.node.childNodes).include(a.node)){a.node=this.node.removeChild(a.node)}}if(this.eventHandlerCallback&&c!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEREMOVED,shape:a,parent:d})}a.bounds.unregisterCallback(this._changedCallback)}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.")}},addShapeObjects:function(g,f,e){try{if(!g){return}this.initializingShapes=true;var c=function(l,p){var q=ORYX.Core.StencilSet.stencil(this.getStencil().namespace()+l.stencil.id,f);if(!q){try{throw new Error(this.getStencil().namespace()+l.stencil.id+" is undefined.")}catch(o){if(window.console&&console.log){console.log(o)}}return}var n=(q.type()==="node")?ORYX.Core.Node:ORYX.Core.Edge;var m=new n({eventHandlerCallback:e},q);m.setResourceId(l.resourceId);l.parent="#"+((l.parent&&l.parent.resourceId)||p.resourceId);this.add(m);return{json:l,object:m}}.bind(this);var h=function(l){var m=[];l.childShapes.each(function(n){m.push(c(n,l));m=m.concat(h(n))});return m}.bind(this);var a=h({childShapes:g,resourceId:this.resourceId});a.each(function(l){var m=[];for(var o in l.json.properties){m.push({prefix:"oryx",name:o,value:l.json.properties[o]})}l.json.outgoing.each(function(p){if(p){m.push({prefix:"raziel",name:"outgoing",value:"#"+p.resourceId})}});if(l.object instanceof ORYX.Core.Edge){var n=l.json.target||l.json.outgoing[0];if(n){m.push({prefix:"raziel",name:"target",value:"#"+n.resourceId})}}if(l.json.bounds&&l.json.bounds.upperLeft&&l.json.bounds.lowerRight&&[l.json.bounds.upperLeft.x,l.json.bounds.upperLeft.y,l.json.bounds.lowerRight.x,l.json.bounds.lowerRight.y].all(function(p){return"number"==typeof p})){m.push({prefix:"oryx",name:"bounds",value:l.json.bounds.upperLeft.x+","+l.json.bounds.upperLeft.y+","+l.json.bounds.lowerRight.x+","+l.json.bounds.lowerRight.y})}if(l.json.dockers){m.push({prefix:"oryx",name:"dockers",value:l.json.dockers.inject("",function(q,p){return q+p.x+" "+p.y+" "})+" #"})}m.push({prefix:"raziel",name:"parent",value:l.json.parent});l.__properties=m}.bind(this));a.each(function(l){if(l.object instanceof ORYX.Core.Node){l.object.deserialize(l.__properties,l.json)}});a.each(function(l){if(l.object instanceof ORYX.Core.Edge){l.object.deserialize(l.__properties,l.json);l.object._oldBounds=l.object.bounds.clone();l.object._update()}});delete this.initializingShapes;return a.pluck("object")}catch(d){if(window.console&&console.log){console.log(d)}}},updateSize:function(){var c=0;var a=0;var d=100;this.getChildShapes(true,function(f){var e=f.bounds;c=Math.max(c,e.lowerRight().x+d);a=Math.max(a,e.lowerRight().y+d)});if(this.bounds.width()<c||this.bounds.height()<a){this.setSize({width:Math.max(this.bounds.width(),c),height:Math.max(this.bounds.height(),a)})}},getRootNode:function(){return this.rootNode},getSvgContainer:function(){return this.node.childNodes[1]},getChildContainer:function(){return this.node.childNodes[0].childNodes[1]},getEdgeContainer:function(){return this.node.childNodes[0].childNodes[2]},getHTMLContainer:function(){return this._htmlContainer},getShapesWithSharedParent:function(a){if(!a||a.length<1){return[]}if(a.length==1){return a}return a.findAll(function(d){var c=d.parent;while(c){if(a.member(c)){return false}c=c.parent}return true})},setSize:function(c,a){if(!c||!c.width||!c.height){return}if(this.rootNode.parentNode){this.rootNode.parentNode.style.width=c.width+"px";this.rootNode.parentNode.style.height=c.height+"px"}this.rootNode.setAttributeNS(null,"width",c.width);this.rootNode.setAttributeNS(null,"height",c.height);this.updateScrollArea();if(!a){this.bounds.set({a:{x:0,y:0},b:{x:c.width/this.zoomLevel,y:c.height/this.zoomLevel}})}},updateScrollArea:function(){if(Ext.isIPad&&"undefined"!==window.iScroll&&this.iscroll){this.iscroll.destroy();this.iscroll=new iScroll(this.rootNode.parentNode,{touchCount:2})}},getShapeSize:function(){var z,s,A,t;var y=false;if(Ext.isChrome){try{var e=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();if(e.x===0||e.y===0){var B;this.getChildShapes(true).each(function(c){var a=c.absoluteBounds();if(!B){B=a.clone()}else{B.include(a)}c.getLabels().each(function(f){if(f.node.textContent){if(Ext.isChrome){if(f.node.getAttributeNS(null,"display")==="none"){return}}var d=ORYX.Core.Math.getTranslatedBoundingBox(f.node);B.include(new ORYX.Core.Bounds(d.x,d.y,d.x+d.width,d.y+d.height))}})});return B||new ORYX.Core.Bounds(0,0,0,0)}}catch(w){}}if(Ext.isIE9){y=true}if(y){var u=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();z=u.x;s=u.y;A=u.x+u.width;t=u.y+u.height;var l=function(d,a,f,c){if(!d&&!a&&!f&&!c){return}z=Math.min(z,d);s=Math.min(s,a);A=Math.max(A,f);t=Math.max(t,c)};this.getChildShapes(false).each(function(a){if(a instanceof ORYX.Core.Edge){l(a.bounds.a.x,a.bounds.a.y,a.bounds.b.x,a.bounds.b.y);a.getLabels().each(function(d){var c=d.node.getBBox();l(c.x,c.y,c.x+c.width,c.y+c.height)})}})}else{try{var v=9;var x=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();var r=this.getRootNode().childNodes[1].childNodes[0].childNodes[2].getBBox();if(!x.x&&!x.y&&!x.width&&!x.height){x=r}if(!r.x&&!r.y&&!r.width&&!r.height){r=x}z=Math.min(x.x,r.x+v);s=Math.min(x.y,r.y+v);A=Math.max(x.x+x.width,r.x+r.width-v);t=Math.max(x.y+x.height,r.y+r.height-v)}catch(w){return this.getShapeBounds()}}return new ORYX.Core.Bounds(z,s,A,t)},getShapeBounds:function(){var a;this.getChildShapes().each(function(c){var d=c.absoluteBounds();if(!a){a=d.clone()}else{a.include(d)}});return a||new ORYX.Core.Bounds(0,0,0,0)},getSVGRepresentation:function(n){var g=this.getRootNode().cloneNode(true);this._removeInvisibleElements(g);var m=this.getShapeSize();var d=50;var c,o,h,f;c=m.width();o=m.height();h=-m.upperLeft().x+(this.children.length?(d/2):0);f=-m.upperLeft().y+(this.children.length?(d/2):0);g.setAttributeNS(null,"width",Math.min.apply(Math,[c+d,this.imageMaxWidth||undefined].compact()));g.setAttributeNS(null,"height",Math.min.apply(Math,[o+d,this.imageMaxHeight||undefined].compact()));g.childNodes[1].firstChild.setAttributeNS(null,"transform","translate("+h+", "+f+")");g.childNodes[1].setAttributeNS(null,"transform","scale(1)");g.childNodes[1].setAttributeNS(null,"transform","");g.childNodes[1].removeAttributeNS(null,"transform");try{var a=g.childNodes[1].childNodes[1];a.parentNode.removeChild(a)}catch(l){}if(n){$A(g.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan")).each(function(e){e.textContent=e.textContent.escapeHTML()});$A(g.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text")).each(function(e){if(e.childNodes.length==0){e.textContent=e.textContent.escapeHTML()}})}$A(g.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"image")).each(function(e){e.parentNode.removeChild(e)});$A(g.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"a")).each(function(e){e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",(e.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").escapeHTML())});return g},_removeInvisibleElements:function(d){var c=0;var a=d.childNodes;var e=a.length;while(c<e){var f=a[c];if(f.getAttributeNS&&(f.getAttributeNS(null,"visibility")==="hidden"||f.getAttributeNS(null,"display")==="none"||(f.getAttribute("stroke")==="none"&&f.getAttribute("fill")==="none"))){d.removeChild(f);--e}else{this._removeInvisibleElements(f);c++}}},setLanguage:function(f,e){if(f==this.getLanguage()&&!(e instanceof Function)){this.language=f;return false}this.language=f;var d=[];this.getChildShapes(true,function(a){if(a.getStencil().properties().findAll(function(c){if(c.language()===f&&c.refToView().length>0){a.propertiesChanged[c.prefix()+"-"+c.id()]=true;return true}return false}).length>0){a._changed();d.push(a)}});if(e instanceof Function){e(d)}this.update()},getLanguage:function(){return(this.language||(this.languages||[]).first())||"de_de"},migrateLanguage:function(e){if(this.languages&&this.languages.length>0&&e&&this.languages.first()!==e){var f=this.languages.first();var d=function(l,a){var h=a.prefix()+"-"+a.id(),c=l.hiddenProperties[h+"_"+f];if("undefined"==typeof c){c=l.properties[h+"_"+f]}if(l.getStencil().property(h+"_"+e)){l.properties[h+"_"+e]=l.properties[h]}else{l.hiddenProperties[h+"_"+e]=l.properties[h]}if(l.formats&&l.formats[h]){l.formats[h+"_"+e]=l.formats[h]}l.properties[h]="undefined"==typeof c?"":c;if(l.formats&&l.formats[h+"_"+f]){l.formats[h]=l.formats[h+"_"+f];delete l.formats[h+"_"+f]}else{delete l.formats[h]}delete l.hiddenProperties[h+"_"+f];delete l.properties[h+"_"+f]};this.getChildShapes(true,function(a){a.getStencil().properties().each(function(c){if(c.multilanguage()&&c==c.origin()){d(a,c)}})});this.getStencil().properties().each(function(a){if(a.multilanguage()&&a==a.origin()){d(this,a)}}.bind(this))}},_delegateEvent:function(a){if(this.eventHandlerCallback&&(a.target==this.rootNode||a.target==this.rootNode.parentNode)){this.eventHandlerCallback(a,this)}},setOrientation:function(c){if(c!=="horizontal"&&c!=="vertical"){return}this.orientation=undefined;this.setProperty("oryx-orientation",c)},getOrientation:function(){return this.orientation||this.properties["oryx-orientation"]},toString:function(){return"Canvas "+this.id},deserialize:function(c,d){if(d.language){this.language=d.language}arguments.callee.$.deserialize.apply(this,arguments)},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);if(this.languages&&this.languages.length>0){a.language=this.languages.first()}a.stencilset={url:this.getStencil().stencilSet().source(),namespace:this.getStencil().stencilSet().namespace()};return a}});var idCounter=0;var ID_PREFIX="resource";function init(){Ext.BLANK_IMAGE_URL=(ORYX.CONFIG.BLANK_IMAGE)||(ORYX.PATH+"libs/ext-2.0.2/resources/images/default/s.gif");var e=ORYX.I18N.Language;document.documentElement.className+=" "+e.split("_").concat(e).uniq().join(" ");var c=Ext.isIE7?"x-ie x-ie7":(Ext.isIE?"x-ie":(Ext.isGecko?"x-gecko":(ORYX.Utils.isIPad()?"x-ipad":"x-other")));var a=ORYX.Utils.getBrowserVersion();document.documentElement.className+=" "+c+" "+c+"-"+a.replace(/\./g,"-");ORYX.Log.debug("Querying editor instances");ORYX.Editor.setMissingClasses();if(window.onOryxResourcesLoaded){window.onOryxResourcesLoaded()}else{if(window.location.pathname.include(ORYX.CONFIG.ORYX_NEW_URL)){new ORYX.Editor({id:"oryx-canvas123",fullscreen:true,stencilset:{url:"/oryx"+ORYX.Utils.getParamFromUrl("stencilset")}})}else{var d=window.location.href.replace(/#.*/g,"");if(d.endsWith("/self")){d=d.replace("/self","/json")}else{d+="&data"}ORYX.Editor.createByUrl(d,{id:d})}}}if(!ORYX){var ORYX={}}ORYX.Editor={DOMEventListeners:new Hash(),selection:[],zoomLevel:1,construct:function(e){this._eventsQueue=[];this.loadedPlugins=[];this.pluginsData=[];this.modelMetaData=e;var d=e;if(e.model){d=e.model}this.id=d.resourceId;if(!this.id){this.id=d.id;if(!this.id){this.id=ORYX.Editor.provideId()}}var f=(e.languages||[]).sort(function(l,m){return e.position-e.position});this._initNumberFormat(e.numberFormat,e.currency);this.fullscreen=e.fullscreen!==false;if(Signavio&&Signavio.Helper&&Signavio.Helper.ShowMask instanceof Function){Signavio.Helper.ShowMask(true,!this.fullscreen?this.id:Ext.getBody())}this._initEventListener();if(ORYX.CONFIG.BACKEND_SWITCH){var c=(d.stencilset.namespace||d.stencilset.url).replace("#","%23");ORYX.Core.StencilSet.loadStencilSet(ORYX.CONFIG.STENCILSET_HANDLER+c,this.id)}else{var c=d.stencilset.url;ORYX.Core.StencilSet.loadStencilSet(c,this.id)}this._loadStencilSetExtensionConfig();if(!!ORYX.CONFIG.SSEXTS){ORYX.CONFIG.SSEXTS.each(function(l){this.loadSSExtension(l.namespace)}.bind(this))}this._createCanvas(d.stencil?d.stencil.id:null,d.properties,f);this._generateGUI();var h=false;var g=false;var a=function(){if(!h||!g){return}this._finishedLoading()}.bind(this);ORYX.Editor.makeExtModalWindowKeysave(this._getPluginFacade());window.setTimeout(function(){this.loadPlugins();h=true;a()}.bind(this),100);window.setTimeout(function(){this.loadSerialized(d,f,true);this.getCanvas().update();g=true;a()}.bind(this),200)},_finishedLoading:function(){if(Ext.getCmp("oryx-loading-panel")){Ext.getCmp("oryx-loading-panel").hide()}this.renderModeSelection();this.layout.doLayout();new Ext.dd.DropTarget(this.getCanvas().rootNode.parentNode);Ext.Component.prototype.stateful=false;Ext.Component.prototype.saveState=Ext.Component.prototype.saveState.createInterceptor(function(){return this.stateful!==false});if(ORYX.CONFIG.PANEL_RIGHT_COLLAPSED===true){this.layout_regions.east.collapse()}if(ORYX.CONFIG.PANEL_LEFT_COLLAPSED===true){this.layout_regions.west.collapse()}if(String(window.navigator.userAgent).include("Firefox/3.5 Prism")&&"function"==typeof this.layout.fireResize){window.setTimeout(function(a){this.layout.fireResize(a.getWidth(),a.getHeight())}.bind(this,Ext.getBody()),100)}this.handleEvents({type:ORYX.CONFIG.EVENT_LOADED});this.zoomFitToModel()},_initNumberFormat:function(d,a){var c=new Signavio.Utils.NumberFormatter(d,a);Signavio.Utils.registerNumberFormatterFunctions(c)},zoomFitToModel:function(){var l=this.getCanvas().getHTMLContainer().parentNode.parentNode,c=l.getHeight()-30,e=l.getWidth()-30,d=this.getCanvas().getChildShapes();if(!d||d.length<1){return false}var h=d[0].absoluteBounds().clone();d.each(function(m){h.include(m.absoluteBounds().clone())});var g=e/h.width(),a=c/h.height(),f=a<g?a:g;if(f>this.maxFitToScreenLevel){f=this.maxFitToScreenLevel}this.setAFixZoomLevel(f);l.scrollTop=Math.round(h.upperLeft().y*this.zoomLevel)-5;l.scrollLeft=Math.round(h.upperLeft().x*this.zoomLevel)-5},setAFixZoomLevel:function(a){this.zoomLevel=a;this._checkZoomLevelRange();this.zoom(1)},_checkZoomLevelRange:function(){if(this.zoomLevel<this.minZoomLevel){this.zoomLevel=this.minZoomLevel}if(this.zoomLevel>this.maxZoomLevel){this.zoomLevel=this.maxZoomLevel}},zoom:function(e){this.zoomLevel*=e;var l=this.getCanvas().getHTMLContainer().parentNode.parentNode;var d=this.getCanvas();var h=d.bounds.width()*this.zoomLevel;var a=d.bounds.height()*this.zoomLevel;var g=(d.node.parentNode.parentNode.parentNode.offsetHeight-a)/2;g=g>20?g-20:0;d.node.parentNode.parentNode.style.marginTop=g+"px";g+=5;d.getHTMLContainer().style.top=g+"px";var c=l.scrollTop-Math.round((d.getHTMLContainer().parentNode.getHeight()-a)/2)+this.diff;var f=l.scrollLeft-Math.round((d.getHTMLContainer().parentNode.getWidth()-h)/2)+this.diff;d.setSize({width:h,height:a},true);d.node.setAttributeNS(null,"transform","scale("+this.zoomLevel+")");this.updateSelection();l.scrollTop=c;l.scrollLeft=f;d.zoomLevel=this.zoomLevel},_initEventListener:function(){document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYDOWN,this.catchKeyDownEvents.bind(this),false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYUP,this.catchKeyUpEvents.bind(this),false);this._keydownEnabled=true;this._keyupEnabled=true;this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEDOWN]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEUP]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOVER]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOUT]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_SELECTION_CHANGED]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEMOVE]=[]},_generateGUI:function(){var c=ORYX.CONFIG.WINDOW_HEIGHT,e=this.getCanvas().rootNode.parentNode,a=Ext.layout.BorderLayout.Region.prototype.getCollapsedEl;Ext.layout.BorderLayout.Region.prototype.getCollapsedEl=function(){a.apply(this,arguments);if(this.collapseMode!=="mini"&&this.floatable===false&&this.expandTriggerAll===true){this.collapsedEl.addClassOnOver("x-layout-collapsed-over");this.collapsedEl.on("mouseover",this.collapsedEl.addClass.bind(this.collapsedEl,"x-layout-collapsed-over"));this.collapsedEl.on("click",this.onExpandClick,this)}if(this.collapseTitle){var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.collapsedEl.dom,["svg",{style:"position:relative;left:"+(this.position==="west"?4:6)+"px;top:"+(this.position==="west"?2:5)+"px;"},["text",{transform:"rotate(90)",x:0,y:0,"stroke-width":"0px",fill:"#EEEEEE",style:"font-weight:bold;","font-size":"11"},this.collapseTitle]]),g=f.childNodes[0];f.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");if(this.position==="west"&&g.getComputedTextLength instanceof Function){window.setTimeout(function(){var h=g.getComputedTextLength();g.setAttributeNS(null,"transform","rotate(-90, "+((h/2)+7)+", "+((h/2)-3)+")")},1)}delete this.collapseTitle}return this.collapsedEl};this.layout_regions={north:new Ext.Panel({region:"north",cls:"x-panel-editor-north",autoEl:"div",border:false}),east:new Ext.Panel({region:"east",layout:"fit",cls:"x-panel-editor-east",autoEl:"div",collapseTitle:ORYX.I18N.View.East,titleCollapse:true,border:false,cmargins:{left:0,right:0},floatable:false,expandTriggerAll:true,collapsible:true,width:ORYX.CONFIG.PANEL_RIGHT_WIDTH||200,split:true,title:"East"}),south:new Ext.Panel({region:"south",cls:"x-panel-editor-south",autoEl:"div",border:false}),west:new Ext.Panel({region:"west",layout:"anchor",autoEl:"div",cls:"x-panel-editor-west",collapsible:true,titleCollapse:true,collapseTitle:ORYX.I18N.View.West,width:ORYX.CONFIG.PANEL_LEFT_WIDTH||200,autoScroll:Ext.isIPad?false:true,cmargins:{left:0,right:0},floatable:false,expandTriggerAll:true,split:true,title:"West"}),center:new Ext.Panel({region:"center",cls:"x-panel-editor-center",autoScroll:true,items:{layout:"fit",autoHeight:true,el:e}}),info:new Ext.Panel({region:"south",cls:"x-panel-editor-info",autoEl:"div",border:false,layout:"fit",cmargins:{top:0,bottom:0,left:0,right:0},collapseTitle:"Information",floatable:false,titleCollapse:false,expandTriggerAll:true,collapsible:true,split:true,title:"Information",height:100,tools:[{id:"close",handler:function(h,l,m){m.hide();m.ownerCt.layout.layout()}}]})};var d={layout:"border",items:[this.layout_regions.north,this.layout_regions.east,this.layout_regions.south,this.layout_regions.west,new Ext.Panel({layout:"border",region:"center",border:false,items:[this.layout_regions.center,this.layout_regions.info]})]};if(this.fullscreen){this.layout=new Ext.Viewport(d)}else{d.renderTo=this.id;d.height=c;this.layout=new Ext.Panel(d)}this.layout_regions.info.hide();if(Ext.isIPad&&"undefined"!=typeof iScroll){this.getCanvas().iscroll=new iScroll(this.layout_regions.center.body.dom.firstChild,{touchCount:2})}e.parentNode.setAttributeNS(null,"align","center");e.setAttributeNS(null,"align","left");this.getCanvas().setSize({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT})},renderModeSelection:function(){if(!ORYX.CONFIG.MODE_SELECTION_ENABLED){return}var d=$("header-mode-selection-container");if(!d){return}if(this.getStencilSets().keys()[0]==="http://b3mn.org/stencilset/bpmn2.0#"){var e=[{text:Signavio.I18N.ModeSelection.quickModel,description:Signavio.I18N.ModeSelection.quickModelDesc,icon:"/images/famfamfam/table_edit.png",handler:function f(){if(this.changeDifference!==0||(this.modelMetaData["new"]&&this.modelMetaData.model.childShapes)){this.showEditorChangeDialog()}else{this.changeToEditor()}}.bind(this)},{text:Signavio.I18N.ModeSelection.comparator,icon:"/images/famfamfam/report.png",handler:function(){if(this.changeDifference!==0||(this.modelMetaData["new"]&&this.modelMetaData.model.childShapes)){this.showComparatorChangeDialog()}else{this.changeToComparator()}}.bind(this)}];if(ORYX.CONFIG.MODE_SIMULATION_ENABLED){e.push({text:Signavio.I18N.ModeSelection.simulation,icon:"/images/famfamfam/chart_curve.png",handler:function(){if(this.changeDifference!==0||(this.modelMetaData["new"]&&this.modelMetaData.model.childShapes)){this.showSimulationChangeDialog()}else{this.changeToSimulation()}}.bind(this)})}this.modeSelection=new Ext.Toolbar.SplitButton({cls:"x-btn-text",id:"header-mode-selection",renderTo:"header-mode-selection-container",text:Signavio.I18N.ModeSelection.graphicalEditor,menu:new Ext.menu.Menu({cls:"mode-selection-menu",items:e}),listeners:{click:function(c,a){if(!c.menu.isVisible()&&!c.ignoreNextClick){c.showMenu()}else{c.hideMenu()}}}});this.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,function(){if(!this.modeSelection.menu.hidden){this.modeSelection.menu.hide()}}.bind(this))}},addToRegion:function(e,a,f){if(e.toLowerCase&&this.layout_regions[e.toLowerCase()]){var c=this.layout_regions[e.toLowerCase()];c.add(a);ORYX.Log.debug("original dimensions of region %0: %1 x %2",c.region,c.width,c.height);if(!c.width&&a.initialConfig&&a.initialConfig.width){ORYX.Log.debug("resizing width of region %0: %1",c.region,a.initialConfig.width);c.setWidth(a.initialConfig.width)}if(a.initialConfig&&a.initialConfig.height){ORYX.Log.debug("resizing height of region %0: %1",c.region,a.initialConfig.height);var d=c.height||0;c.height=a.initialConfig.height+d;c.setHeight(a.initialConfig.height+d)}if(typeof f=="string"){c.setTitle(f)}c.ownerCt.doLayout();c.show();if(Ext.isMac){ORYX.Editor.resizeFix()}return c}return null},getAvailablePlugins:function(){var a=ORYX.availablePlugins.clone();a.each(function(c){if(this.loadedPlugins.find(function(d){return d.type==this.name}.bind(c))){c.engaged=true}else{c.engaged=false}}.bind(this));return a},loadScript:function(c,d){var a=document.createElement("script");a.type="text/javascript";if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){a.onreadystatechange=null;d()}}}else{a.onload=function(){d()}}a.src=c;document.getElementsByTagName("head")[0].appendChild(a)},activatePluginByName:function(name,callback,loadTry){var match=this.getAvailablePlugins().find(function(value){return value.name==name});if(match&&(!match.engaged||(match.engaged==="false"))){var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();var me=this;ORYX.Log.debug("Initializing plugin '%0'",match.name);if(!match.requires||!match.requires.namespaces||match.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){if(!match.notUsesIn||!match.notUsesIn.namespaces||!match.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){try{var className=eval(match.name);var newPlugin=new className(facade,match);newPlugin.type=match.name;if(newPlugin.registryChanged){newPlugin.registryChanged(me.pluginsData)}if(newPlugin.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,newPlugin.onSelectionChanged.bind(newPlugin))}this.loadedPlugins.push(newPlugin);this.loadedPlugins.each(function(loaded){if(loaded.registryChanged){loaded.registryChanged(this.pluginsData)}}.bind(me));callback(true)}catch(e){ORYX.Log.warn("Plugin %0 is not available",match.name);if(!!loadTry){callback(false,"INITFAILED");return}this.loadScript("plugins/scripts/"+match.source,this.activatePluginByName.bind(this,match.name,callback,true))}}else{callback(false,"NOTUSEINSTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name)}}else{callback(false,"REQUIRESTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name)}}else{callback(false,match?"NOTFOUND":"YETACTIVATED")}},loadPlugins:function(){var me=this;var newPlugins=[];var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();if(ORYX.MashupAPI&&ORYX.MashupAPI.loadablePlugins&&ORYX.MashupAPI.loadablePlugins instanceof Array){ORYX.availablePlugins=$A(ORYX.availablePlugins).findAll(function(value){return ORYX.MashupAPI.loadablePlugins.include(value.name)});ORYX.MashupAPI.loadablePlugins.each(function(className){if(!(ORYX.availablePlugins.find(function(val){return val.name==className}))){ORYX.availablePlugins.push({name:className})}})}ORYX.availablePlugins.each(function(value){ORYX.Log.debug("Initializing plugin '%0'",value.name);if((!value.requires||!value.requires.namespaces||value.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(!value.notUsesIn||!value.notUsesIn.namespaces||!value.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(value.engaged||(value.engaged===undefined))){try{var className=eval(value.name);if(className){var plugin=new className(facade,value);plugin.type=value.name;newPlugins.push(plugin);plugin.engaged=true}}catch(e){ORYX.Log.warn("Plugin %0 is not available",value.name)}}else{ORYX.Log.info("Plugin need a stencilset which is not loaded'",value.name)}});newPlugins.each(function(value){if(value.registryChanged){value.registryChanged(me.pluginsData)}if(value.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,value.onSelectionChanged.bind(value))}});this.loadedPlugins=newPlugins;if(Ext.isMac){ORYX.Editor.resizeFix()}this.registerPluginsOnKeyEvents();this.setSelection()},_loadStencilSetExtensionConfig:function(){new Ajax.Request(ORYX.CONFIG.SS_EXTENSIONS_CONFIG,{method:"GET",asynchronous:false,onSuccess:(function(a){this.ss_extensions_def=Ext.decode(a.responseText)}).bind(this),onFailure:(function(a){ORYX.Log.error("Editor._loadStencilSetExtensionConfig: Loading stencil set extension configuration file failed."+a)}).bind(this)})},_createCanvas:function(d,e,f){if(d){if(d.search(/^http/)===-1){d=this.getStencilSets().values()[0].namespace()+d}}else{d=this.getStencilSets().values()[0].findRootStencilName()}var a=ORYX.Core.StencilSet.stencil(d);if(!a){ORYX.Log.fatal("Initialisation failed, because the stencil with the type %0 is not part of one of the loaded stencil sets.",d)}var g=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);g.addClassName("ORYX_Editor");this._canvas=new ORYX.Core.Canvas({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT,eventHandlerCallback:this.handleEvents.bind(this),id:this.id,parentNode:g,language:f},a);if(e&&e.properties){var c=[];for(field in e.properties){c.push({prefix:"oryx",name:field,value:e.properties[field],format:(e.formats?e.formats[field]:[])})}this._canvas.deserialize(c);if(this.modelMetaData.model&&this.modelMetaData.model.orientation){this._canvas.setOrientation(this.modelMetaData.model.orientation)}if(this.modelMetaData.imageMaxWidth&&this.modelMetaData.imageMaxWidth>0){this._canvas.imageMaxWidth=this.modelMetaData.imageMaxWidth}else{this._canvas.imageMaxWidth=undefined}if(this.modelMetaData.imageMaxHeight&&this.modelMetaData.imageMaxHeight>0){this._canvas.imageMaxHeight=this.modelMetaData.imageMaxHeight}else{this._canvas.imageMaxHeight=undefined}}},_getPluginFacade:function(){if(!(this._pluginFacade)){this._pluginFacade=(function(){return{activatePluginByName:this.activatePluginByName.bind(this),getAvailablePlugins:this.getAvailablePlugins.bind(this),offer:this.offer.bind(this),getStencilSets:this.getStencilSets.bind(this),getStencilSetExtensionDefinition:function(){return Object.clone(this.ss_extensions_def||{})}.bind(this),getRules:this.getRules.bind(this),loadStencilSet:this.loadStencilSet.bind(this),createShape:this.createShape.bind(this),deleteShape:this.deleteShape.bind(this),getSelection:this.getSelection.bind(this),setSelection:this.setSelection.bind(this),updateSelection:this.updateSelection.bind(this),getCanvas:this.getCanvas.bind(this),importJSON:this.importJSON.bind(this),importERDF:this.importERDF.bind(this),getERDF:this.getERDF.bind(this),getJSON:this.getJSON.bind(this),getSerializedJSON:this.getSerializedJSON.bind(this),executeCommands:this.executeCommands.bind(this),isExecutingCommands:this.isExecutingCommands.bind(this),registerOnEvent:this.registerOnEvent.bind(this),unregisterOnEvent:this.unregisterOnEvent.bind(this),raiseEvent:this.handleEvents.bind(this),enableEvent:this.enableEvent.bind(this),disableEvent:this.disableEvent.bind(this),eventCoordinates:this.eventCoordinates.bind(this),addToRegion:this.addToRegion.bind(this),getModelMetaData:this.getModelMetaData.bind(this),getAllLanguages:this.getAllLanguages.bind(this)}}.bind(this)())}return this._pluginFacade},getAllLanguages:function(){var a=this.getModelMetaData();return((a||{}).languages||[]).sort(function(e,f){return e.position-f.position}).pluck("rel")},isExecutingCommands:function(){return !!this.commandExecuting},executeCommands:function(a){if(!this.commandStack){this.commandStack=[]}if(!this.commandStackExecuted){this.commandStackExecuted=[]}this.commandStack=[].concat(this.commandStack).concat(a);if(this.commandExecuting){return}this.commandExecuting=true;while(this.commandStack.length>0){var c=this.commandStack.shift();c.execute();this.commandStackExecuted.push(c);if(this.commandStack.length==0){this.handleEvents({type:ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,commands:this.commandStackExecuted});this.getCanvas().update();this.updateSelection()}}this.handleEvents({type:ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,commands:this.commandStackExecuted});delete this.commandStack;delete this.commandStackExecuted;delete this.commandExecuting;this.updateSelection()},getJSON:function(){var a=this.getCanvas().toJSON();a.ssextensions=this.getStencilSets().values()[0].extensions().keys().findAll(function(c){return !c.endsWith("/meta#")});return a},getSerializedJSON:function(){return Ext.encode(this.getJSON())},getERDF:function(){var a=DataManager.serializeDOM(this._getPluginFacade());a='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="'+location.href.split("?")[0]+'" /></head><body>'+a+"</body></html>";return a},importJSON:function(d,c){if(d.stencilset.namespace&&d.stencilset.namespace!==this.getCanvas().getStencil().stencilSet().namespace()){Ext.Msg.alert(ORYX.I18N.JSONImport.title,String.format(ORYX.I18N.JSONImport.wrongSS,d.stencilset.namespace,this.getCanvas().getStencil().stencilSet().namespace()));return null}else{var a=ORYX.Core.Command.extend({construct:function(g,l,f,h){this.jsonObject=g;this.noSelection=f;this.facade=h;this.shapes=undefined;this.connections=[];this.parents=new Hash();this.selection=this.facade.getSelection();this.loadSerialized=l},execute:function(){try{if(!this.shapes){this.shapes=this.loadSerialized(this.jsonObject);this.shapes.each(function(h){if(h.getDockers){var g=h.getDockers();if(g){if(g.length>0){this.connections.push([g.first(),g.first().getDockedShape(),g.first().referencePoint])}if(g.length>1){this.connections.push([g.last(),g.last().getDockedShape(),g.last().referencePoint])}}}this.parents[h.id]=h.parent}.bind(this))}else{this.shapes.each(function(g){this.parents[g.id].add(g)}.bind(this));this.connections.each(function(g){g[0].setDockedShape(g[1]);g[0].setReferencePoint(g[2]);g[0].update()})}this.facade.getCanvas().update();if(!this.noSelection){this.facade.setSelection(this.shapes)}else{this.facade.updateSelection()}this.facade.getCanvas().updateSize()}catch(f){console.log("ImportJSON error: "+f.message)}},rollback:function(){var f=this.facade.getSelection();this.shapes.each(function(g){f=f.without(g);this.facade.deleteShape(g)}.bind(this));this.facade.getCanvas().update();this.facade.setSelection(f)}});var e=new a(d,this.loadSerialized.bind(this),c,this._getPluginFacade());this.executeCommands([e]);return e.shapes?e.shapes.clone():null}},renewResourceIds:function(c){if(Ext.type(c)==="string"){try{var e=c;c=Ext.decode(c)}catch(a){throw new SyntaxError(a.message)}}else{var e=Ext.encode(c)}var f=function(g){if(!g){return[]}return g.map(function(h){return f(h.childShapes).concat(h.resourceId)}).flatten()};var d=f(c.childShapes);d.each(function(g){var h=ORYX.Editor.provideId();e=e.gsub('"'+g+'"','"'+h+'"')});return Ext.decode(e)},importERDF:function(a){var c=this.parseToSerializeObjects(a);if(c){return this.importJSON(c,true)}},parseToSerializeObjects:function(d){if(d.normalize){d.normalize()}try{var f="";var a=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(e){f=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var o=new DOMParser();var h=d;var g=o.parseFromString(f,"text/xml");var l=new XSLTProcessor();var p=document.implementation.createDocument("","",null);l.importStylesheet(g);var q=l.transformToFragment(h,document);var c=(new XMLSerializer()).serializeToString(q)}catch(m){Ext.Msg.alert("Oryx",error);var c=""}c=!c.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+c:c;var n=new Ajax.Request(ORYX.CONFIG.ROOT_PATH+"rdf2json",{method:"POST",asynchronous:false,onSuccess:function(e){Ext.decode(e.responseText)},parameters:{rdf:c}});return Ext.decode(n.transport.responseText)},loadSerialized:function(f,e,l){var d=this.getCanvas();this.loadSSExtensions(f.ssextensions);this.loadIncludeAlwaysSSExtensionsWithoutPerspective();if(l===true){var n=this.getExtensionForMetaData();if(n){this.loadSSExtension(n)}}var c=this.getCanvas().addShapeObjects(f.childShapes,e,this.handleEvents.bind(this));if(f.properties){for(var m in f.properties){var h=this.getCanvas().getStencil().property("oryx-"+m);var a="undefined"!=typeof d.hiddenProperties["oryx-"+m];if(h&&a){d.setProperty("oryx-"+m,d.hiddenProperties["oryx-"+m]);d.setHiddenProperty("oryx-"+m)}var g=f.properties[m];if(Ext.type(g)==="object"&&(!h||!h.isList())){g=Ext.encode(g)}if(h){g=d.migrateOldGlossarySchema(h,g)}d.setProperty("oryx-"+m,g)}}this.getCanvas().updateSize();this.getCanvas().migrateLanguage(f.language);this.selection=[null];this.setSelection([]);return c},getExtensionForMetaData:function(){if(!this.ss_extensions_def||!(this.ss_extensions_def.extensions instanceof Array)){return null}var a=this.getStencilSets();var c=this.ss_extensions_def.extensions.find(function(d){return !!a[d["extends"]]&&d.namespace.endsWith("/meta#")});return c?c.namespace||null:null},loadIncludeAlwaysSSExtensionsWithoutPerspective:function(){if(!this.ss_extensions_def||!(this.ss_extensions_def.extensions instanceof Array)){return null}var c=this.ss_extensions_def.perspectives.pluck("extensions").flatten().uniq();var d=this.getStencilSets();this.ss_extensions_def.extensions.each(function(a){if(!!d[a["extends"]]&&a.includeAlways&&!c.include(a.namespace)&&!a.namespace.endsWith("/meta#")){this.loadSSExtension(a.namespace)}}.bind(this))},loadSSExtensions:function(a){if(!a){return}a.each(function(c){this.loadSSExtension(c)}.bind(this))},loadSSExtension:function(c){if(this.ss_extensions_def){var d=this.ss_extensions_def.extensions.find(function(e){return(e.namespace==c)});if(!d){return}var a=this.getStencilSets()[d["extends"]];if(!a){return}if((d.definition||"").startsWith("/")){a.addExtension(d.definition)}else{a.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+d.definition)}this.getRules().initializeRules(a);this._getPluginFacade().raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED})}},disableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=false}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=false}if(this.DOMEventListeners.keys().member(a)){var c=this.DOMEventListeners.remove(a);this.DOMEventListeners["disable_"+a]=c}},enableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=true}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=true}if(this.DOMEventListeners.keys().member("disable_"+a)){var c=this.DOMEventListeners.remove("disable_"+a);this.DOMEventListeners[a]=c}},registerOnEvent:function(a,c){if(!(this.DOMEventListeners.keys().member(a))){this.DOMEventListeners[a]=[]}this.DOMEventListeners[a].push(c)},unregisterOnEvent:function(a,c){if(this.DOMEventListeners.keys().member(a)){this.DOMEventListeners[a]=this.DOMEventListeners[a].without(c)}else{}},getSelection:function(){return this.selection||[]},getStencilSets:function(){return ORYX.Core.StencilSet.stencilSets(this.id)},getRules:function(){return ORYX.Core.StencilSet.rules(this.id)},loadStencilSet:function(a){try{ORYX.Core.StencilSet.loadStencilSet(a,this.id);this.handleEvents({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED})}catch(c){ORYX.Log.warn("Requesting stencil set file failed. ("+c+")")}},offer:function(a){if(!this.pluginsData.member(a)){this.pluginsData.push(a)}},registerPluginsOnKeyEvents:function(){this.pluginsData.each(function(a){if(a.keyCodes){a.keyCodes.each(function(d){var c="key.event";c+="."+d.keyAction;if(d.metaKeys){if(d.metaKeys.indexOf(ORYX.CONFIG.META_KEY_META_CTRL)>-1){c+="."+ORYX.CONFIG.META_KEY_META_CTRL}if(d.metaKeys.indexOf(ORYX.CONFIG.META_KEY_ALT)>-1){c+="."+ORYX.CONFIG.META_KEY_ALT}if(d.metaKeys.indexOf(ORYX.CONFIG.META_KEY_SHIFT)>-1){c+="."+ORYX.CONFIG.META_KEY_SHIFT}}if(d.keyCode){c+="."+d.keyCode}ORYX.Log.debug("Register Plugin on Key Event: %0",c);if(a.toggle===true&&a.buttonInstance){this.registerOnEvent(c,function(){a.buttonInstance.toggle(!a.buttonInstance.pressed);a.functionality.call(a,a.buttonInstance,a.buttonInstance.pressed)})}else{this.registerOnEvent(c,a.functionality)}}.bind(this))}}.bind(this))},isEqual:function(d,c){return d===c||(d.length===c.length&&d.all(function(a){return c.include(a)}))},isDirty:function(c){return c.any(function(a){return a.isPropertyChanged()})},setSelection:function(d,a,c){if(!d){d=[]}if(!(d instanceof Array)){d=[d]}d=d.findAll(function(e){return e&&e instanceof ORYX.Core.Shape});if(d[0] instanceof ORYX.Core.Canvas){d=[]}if(!c&&this.isEqual(this.selection,d)&&!this.isDirty(d)){return}this.selection=d;this._subSelection=a;this.handleEvents({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:d,subSelection:a,force:!!c})},updateSelection:function(){this.setSelection(this.selection,this._subSelection,true)},getCanvas:function(){return this._canvas},createShape:function(f){if(f&&f.serialize&&f.serialize instanceof Array){var l=f.serialize.find(function(s){return(s.prefix+"-"+s.name)=="oryx-type"});var q=ORYX.Core.StencilSet.stencil(l.value);if(q.type()=="node"){var h=new ORYX.Core.Node({eventHandlerCallback:this.handleEvents.bind(this)},q)}else{var h=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},q)}this.getCanvas().add(h);h.deserialize(f.serialize);return h}if(!f||!f.type||!f.namespace){throw"To create a new shape you have to give an argument with type and namespace"}var e=this.getCanvas();var h;var a=f.type;var n=ORYX.Core.StencilSet.stencilSet(f.namespace);if(n.stencil(a).type()=="node"){h=new ORYX.Core.Node({eventHandlerCallback:this.handleEvents.bind(this)},n.stencil(a))}else{h=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},n.stencil(a))}if(f.template){h._jsonStencil.properties=f.template._jsonStencil.properties;h.postProcessProperties()}if(f.parent&&h instanceof ORYX.Core.Node){f.parent.add(h)}else{e.add(h)}var o=f.position?f.position:{x:100,y:200};var c;if(f.connectingType&&f.connectedShape&&!(h instanceof ORYX.Core.Edge)){c=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},n.stencil(f.connectingType));c.dockers.first().setDockedShape(f.connectedShape);var p=f.connectedShape.getDefaultMagnet();var r=p?p.bounds.center():f.connectedShape.bounds.midPoint();c.dockers.first().setReferencePoint(r);c.dockers.last().setDockedShape(h);c.dockers.last().setReferencePoint(h.getDefaultMagnet().bounds.center());e.add(c)}if(h instanceof ORYX.Core.Edge&&f.connectedShape){h.dockers.first().setDockedShape(f.connectedShape);if(f.connectedShape instanceof ORYX.Core.Node){h.dockers.first().setReferencePoint(f.connectedShape.getDefaultMagnet().bounds.center());h.dockers.last().bounds.centerMoveTo(o)}else{h.dockers.first().setReferencePoint(f.connectedShape.bounds.midPoint())}}else{var m=h.bounds;if(h instanceof ORYX.Core.Node&&h.dockers.length==1){m=h.dockers.first().bounds}if(h instanceof ORYX.Core.Edge){m.extend({x:0,y:1});o.x-=8;o.y-=8}m.centerMoveTo(o);var d=m.upperLeft();m.moveBy(-Math.min(d.x,0),-Math.min(d.y,0));var g=m.lowerRight();m.moveBy(-Math.max(g.x-e.bounds.width(),0),-Math.max(g.y-e.bounds.height(),0))}if(h instanceof ORYX.Core.Edge){h._update(false)}if(!(h instanceof ORYX.Core.Edge)&&!(f.dontUpdateSelection)){this.setSelection([h])}if(c&&c.alignDockers){c.alignDockers()}if(h.alignDockers){h.alignDockers()}return h},deleteShape:function(a){if(!a||!a.parent){return}a.parent.remove(a);a.getOutgoingShapes().each(function(d){var c=d.getDockers().first();if(c&&c.getDockedShape()==a){c.setDockedShape(undefined)}});a.getIncomingShapes().each(function(c){var d=c.getDockers().last();if(d&&d.getDockedShape()==a){d.setDockedShape(undefined)}});a.getDockers().each(function(c){c.setDockedShape(undefined)})},getModelMetaData:function(){return this.modelMetaData},_executeEventImmediately:function(a){if(this.DOMEventListeners.keys().member(a.event.type)){this.DOMEventListeners[a.event.type].each((function(c){c(a.event,a.arg)}).bind(this))}},_executeEvents:function(){this._queueRunning=true;while(this._eventsQueue.length>0){var a=this._eventsQueue.shift();this._executeEventImmediately(a)}this._queueRunning=false},handleEvents:function(c,a){ORYX.Log.trace("Dispatching event type %0 on %1",c.type,a);switch(c.type){case ORYX.CONFIG.EVENT_MOUSEDOWN:this._handleMouseDown(c,a);break;case ORYX.CONFIG.EVENT_MOUSEMOVE:this._handleMouseMove(c,a);break;case ORYX.CONFIG.EVENT_MOUSEUP:this._handleMouseUp(c,a);break;case ORYX.CONFIG.EVENT_MOUSEOVER:this._handleMouseHover(c,a);break;case ORYX.CONFIG.EVENT_MOUSEOUT:this._handleMouseOut(c,a);break}if(c.forceExecution){this._executeEventImmediately({event:c,arg:a})}else{this._eventsQueue.push({event:c,arg:a})}if(!this._queueRunning){this._executeEvents()}return false},isValidEvent:function(d){try{var a=["INPUT","TEXTAREA"].include(d.target.tagName.toUpperCase());var c=d.target.className.include("x-grid3-focus")&&!d.target.className.include("x-grid3-focus-canvas");return !a&&!c}catch(d){return false}},catchKeyUpEvents:function(c){if(!this._keyupEnabled){return}if(!c){c=window.event}if(!this.isValidEvent(c)){return}var a=this.createKeyCombEvent(c,ORYX.CONFIG.KEY_ACTION_UP);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:c})},catchKeyDownEvents:function(c){if(!this._keydownEnabled){return}if(!c){c=window.event}if(!this.isValidEvent(c)){return}var a=this.createKeyCombEvent(c,ORYX.CONFIG.KEY_ACTION_DOWN);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:c})},createKeyCombEvent:function(d,c){var e=d.which||d.keyCode;var a="key.event";if(c){a+="."+c}if(d.ctrlKey||d.metaKey){a+="."+ORYX.CONFIG.META_KEY_META_CTRL}if(d.altKey){a+="."+ORYX.CONFIG.META_KEY_ALT}if(d.shiftKey){a+="."+ORYX.CONFIG.META_KEY_SHIFT}return a+"."+e},_handleMouseDown:function(a,n){var c=this.getCanvas();c.focus();var e=a.currentTarget;var d=n;var h=(d!==null)&&(d!==undefined)&&(d.isSelectable);var o=(d!==null)&&(d!==undefined)&&(d.isMovable);var m=a.shiftKey||a.ctrlKey;var l=this.selection.length===0;var f=this.selection.member(d);if(h&&l){this.setSelection([d]);ORYX.Log.trace("Rule #1 applied for mouse down on %0",e.id)}else{if(h&&!l&&!m&&!f){this.setSelection([d]);ORYX.Log.trace("Rule #3 applied for mouse down on %0",e.id)}else{if(h&&m&&!f){var g=this.selection.clone();g.push(d);this.setSelection(g);ORYX.Log.trace("Rule #4 applied for mouse down on %0",e.id)}else{if(h&&f&&m){var g=this.selection.clone();this.setSelection(g.without(d));ORYX.Log.trace("Rule #6 applied for mouse down on %0",d.id)}else{if(!h&&!o){this.setSelection([]);ORYX.Log.trace("Rule #2 applied for mouse down on %0",e.id);return}else{if(!h&&o&&!(d instanceof ORYX.Core.Controls.Docker)){ORYX.Log.trace("Rule #7 applied for mouse down on %0",e.id)}else{if(h&&f&&!m){this._subSelection=this._subSelection!=d?d:undefined;this.setSelection(this.selection,this._subSelection);ORYX.Log.trace("Rule #8 applied for mouse down on %0",e.id)}}}}}}}return},_handleMouseMove:function(c,a){return},_handleMouseUp:function(e,d){var a=this.getCanvas();var f=d;var c=this.eventCoordinates(e)},_handleMouseHover:function(c,a){return},_handleMouseOut:function(c,a){return},eventCoordinates:function(d){var c=this.getCanvas();var e=c.node.ownerSVGElement.createSVGPoint();e.x=d.clientX;e.y=d.clientY;var a=c.node.getScreenCTM();return e.matrixTransform(a.inverse())}};ORYX.Editor=Clazz.extend(ORYX.Editor);ORYX.Editor.createByUrl=function(c,a){if(!a){a={}}new Ajax.Request(c,{method:"GET",onSuccess:function(e){var d=Ext.decode(e.responseText);d=Ext.applyIf(d,a);new ORYX.Editor(d)}.bind(this)})};ORYX.Editor.graft=function(h,g,f,m){m=(m||(g&&g.ownerDocument)||document);var l;if(f===undefined){throw"Can't graft an undefined value"}else{if(f.constructor==String){l=m.createTextNode(f)}else{for(var d=0;d<f.length;d++){if(d===0&&f[d].constructor==String){var a;a=f[d].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){l=m.createElementNS(h,a[1]);l.setAttributeNS(null,"class",a[2]);continue}a=f[d].match(/^([a-z][a-z0-9]*)$/i);if(a){l=m.createElementNS(h,a[1]);continue}l=m.createElementNS(h,"span");l.setAttribute(null,"class","namelessFromLOL")}if(f[d]===undefined){throw"Can't graft an undefined value in a list!"}else{if(f[d].constructor==String||f[d].constructor==Array){this.graft(h,l,f[d],m)}else{if(f[d].constructor==Number){this.graft(h,l,f[d].toString(),m)}else{if(f[d].constructor==Object){for(var c in f[d]){l.setAttributeNS(null,c,f[d][c])}}else{}}}}}}}if(g){g.appendChild(l)}else{}return l};ORYX.Editor.provideId=function(){var c=[],d="0123456789ABCDEF";for(var a=0;a<36;a++){c[a]=Math.floor(Math.random()*16)}c[14]=4;c[19]=(c[19]&3)|8;for(var a=0;a<36;a++){c[a]=d[c[a]]}c[8]=c[13]=c[18]=c[23]="-";return"oryx_"+c.join("")};ORYX.Editor.resizeFix=function(){if(!ORYX.Editor._resizeFixTimeout){ORYX.Editor._resizeFixTimeout=window.setTimeout(function(){window.resizeBy(1,1);window.resizeBy(-1,-1);ORYX.Editor._resizefixTimeout=null},100)}};ORYX.Editor.Cookie={callbacks:[],onChange:function(c,a){this.callbacks.push(c);this.start(a)},start:function(a){if(this.pe){return}var c=document.cookie;this.pe=new PeriodicalExecuter(function(){if(c!=document.cookie){c=document.cookie;this.callbacks.each(function(d){d(this.getParams())}.bind(this))}}.bind(this),(a||10000)/1000)},stop:function(){if(this.pe){this.pe.stop();this.pe=null}},getParams:function(){var a={};var c=document.cookie;c.split("; ").each(function(d){a[d.split("=")[0]]=d.split("=")[1]});return a},toString:function(){return document.cookie}};ORYX.Editor.SVGClassElementsAreAvailable=true;ORYX.Editor.setMissingClasses=function(){try{SVGElement}catch(a){ORYX.Editor.SVGClassElementsAreAvailable=false;SVGSVGElement=document.createElementNS("http://www.w3.org/2000/svg","svg").toString();SVGGElement=document.createElementNS("http://www.w3.org/2000/svg","g").toString();SVGPathElement=document.createElementNS("http://www.w3.org/2000/svg","path").toString();SVGTextElement=document.createElementNS("http://www.w3.org/2000/svg","text").toString();SVGRectElement=document.createElementNS("http://www.w3.org/2000/svg","rect").toString();SVGImageElement=document.createElementNS("http://www.w3.org/2000/svg","image").toString();SVGCircleElement=document.createElementNS("http://www.w3.org/2000/svg","circle").toString();SVGEllipseElement=document.createElementNS("http://www.w3.org/2000/svg","ellipse").toString();SVGLineElement=document.createElementNS("http://www.w3.org/2000/svg","line").toString();SVGPolylineElement=document.createElementNS("http://www.w3.org/2000/svg","polyline").toString();SVGPolygonElement=document.createElementNS("http://www.w3.org/2000/svg","polygon").toString()}};ORYX.Editor.checkClassType=function(c,a){if(ORYX.Editor.SVGClassElementsAreAvailable){return c instanceof a}else{return c==a}};ORYX.Editor.makeExtModalWindowKeysave=function(a){Ext.override(Ext.Window,{beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var c=this.el.getAlignToXY(this.container,"c-c");var d=this.el.translatePoints(c[0],c[1]);this.x=this.x===undefined?d.left:this.x;this.y=this.y===undefined?d.top:this.y}this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false)}if(this.modal){a.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().addClass("x-body-masked");this.mask.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.mask.show()}},afterHide:function(){this.proxy.hide();if(this.monitorResize||this.modal||this.constrain||this.constrainHeader){Ext.EventManager.removeResizeListener(this.onWindowResize,this)}if(this.modal){this.mask.hide();a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().removeClass("x-body-masked")}if(this.keyMap){this.keyMap.disable()}this.fireEvent("hide",this)},beforeDestroy:function(){if(this.modal){a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}Ext.destroy(this.resizer,this.dd,this.proxy,this.mask);Ext.Window.superclass.beforeDestroy.call(this)}})};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}new function(){ORYX.Core.UIEnableDrag=function(f,e,d){this.uiObj=e;var g=e.bounds.upperLeft();var c=e.node.getScreenCTM();this.faktorXY={x:c.a,y:c.d};this.scrollNode=e.node.ownerSVGElement.parentNode.parentNode;this.offSetPosition={x:Event.pointerX(f)-(g.x*this.faktorXY.x),y:Event.pointerY(f)-(g.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.dragCallback=ORYX.Core.UIDragCallback.bind(this);this.disableCallback=ORYX.Core.UIDisableDrag.bind(this);this.movedCallback=d?d.movedCallback:undefined;this.upCallback=d?d.upCallback:undefined;document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false)};ORYX.Core.UIDragCallback=function(c){var a={x:Event.pointerX(c)-this.offSetPosition.x,y:Event.pointerY(c)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;this.uiObj.bounds.moveTo(a);if(this.movedCallback){this.movedCallback(c)}Event.stop(c)};ORYX.Core.UIDisableDrag=function(a){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);if(this.upCallback){this.upCallback(a)}this.upCallback=undefined;this.movedCallback=undefined;Event.stop(a)};ORYX.Core.MoveDockersCommand=ORYX.Core.Command.extend({construct:function(a){this.dockers=$H(a);this.edges=$H({})},execute:function(){if(this.changes){this.executeAgain();return}else{this.changes=$H({})}this.dockers.values().each(function(c){var a=c.docker.parent;if(!a){return}if(!this.changes[a.getId()]){this.changes[a.getId()]={edge:a,oldDockerPositions:a.dockers.map(function(d){return d.bounds.center()})}}c.docker.bounds.moveBy(c.offset);this.edges[a.getId()]=a;c.docker.update()}.bind(this));this.edges.each(function(a){this.updateEdge(a.value);if(this.changes[a.value.getId()]){this.changes[a.value.getId()].dockerPositions=a.value.dockers.map(function(c){return c.bounds.center()})}}.bind(this))},updateEdge:function(a){a._update(true);[a.getOutgoingShapes(),a.getIncomingShapes()].flatten().invoke("_update",[true])},executeAgain:function(){this.changes.values().each(function(a){this.removeAllDocker(a.edge);a.dockerPositions.each(function(e,c){if(c==0||c==a.dockerPositions.length-1){return}var d=a.edge.createDocker(undefined,e);d.bounds.centerMoveTo(e);d.update()}.bind(this));this.updateEdge(a.edge)}.bind(this))},rollback:function(){this.changes.values().each(function(a){this.removeAllDocker(a.edge);a.oldDockerPositions.each(function(e,c){if(c==0||c==a.oldDockerPositions.length-1){return}var d=a.edge.createDocker(undefined,e);d.bounds.centerMoveTo(e);d.update()}.bind(this));this.updateEdge(a.edge)}.bind(this))},removeAllDocker:function(a){a.dockers.slice(1,a.dockers.length-1).each(function(c){a.removeDocker(c)})}})}();if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Shape={construct:function(a,c){arguments.callee.$.construct.apply(this,arguments);this.dockers=[];this.magnets=[];this._defaultMagnet;this.incoming=[];this.outgoing=[];this.nodes=[];this._dockerChangedCallback=this._dockerChanged.bind(this);this._labels=new Hash();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{id:"svg-"+this.resourceId},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children"}],["g",{"class":"edge"}]],["g",{"class":"controls"},["g",{"class":"dockers"}],["g",{"class":"magnets"}]]]);this.fillButStroke={"http://b3mn.org/stencilset/bpmn2.0#Task":["sendTaskpath","sendTaskpath2"],"http://b3mn.org/stencilset/epc#Mail":["atText"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateMessageEventThrowing":["path1","path2"],"http://b3mn.org/stencilset/bpmn2.0#EndMessageEvent":["path1","path2"]};this.strokeAndFill={"http://b3mn.org/stencilset/bpmn2.0#Task":["userTaskcircle"],"http://b3mn.org/stencilset/bpmn2.0#Subprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#EventSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#CollapsedSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#CollapsedEventSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateSignalEventThrowing":["signalThrowing"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateCompensationEventThrowing":["poly1","poly2"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateEscalationEventThrowing":["path9"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateMultipleEventThrowing":["middlePolygonThrowing"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateLinkEventThrowing":["poly1"],"http://b3mn.org/stencilset/bpmn2.0#EndCompensationEvent":["poly1","poly2"],"http://b3mn.org/stencilset/bpmn2.0#EndCancelEvent":["path1"],"http://b3mn.org/stencilset/bpmn2.0#EndMultipleEvent":["middlepolygon"],"http://b3mn.org/stencilset/bpmn2.0#EndErrorEvent":["errorPolygon"],"http://b3mn.org/stencilset/bpmn2.0#EndEscalationEvent":["path9"],"http://b3mn.org/stencilset/bpmn2.0#EndSignalEvent":["signalThrowing"],"http://b3mn.org/stencilset/bpmn2.0#EndTerminateEvent":["circle1"],"http://b3mn.org/stencilset/bpmn2.0#processparticipant":["path1","path2","circle1"],"http://b3mn.org/stencilset/bpmn2.0#Exclusive_Databased_Gateway":["crosspath","crosspath2"],"http://b3mn.org/stencilset/bpmn2.0#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/bpmn2.0#DataObject":["output"],"http://b3mn.org/stencilset/bpmn2.0conversation#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/bpmn2.0choreography#IntermediateEscalationEventThrowing":["path9"],"http://b3mn.org/stencilset/bpmn2.0choreography#IntermediateLinkEventThrowing":["poly1"],"http://b3mn.org/stencilset/bpmn2.0choreography#EndTerminateEvent":["circle1"],"http://b3mn.org/stencilset/bpmn2.0choreography#Exclusive_Databased_Gateway":["crosspath","crosspath2"],"http://b3mn.org/stencilset/bpmn2.0choreography#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/epc#Fax":["opening"]}},getMeContainer:function(){return this.node.childNodes[0].childNodes[0]},getChildContainer:function(){return this.node.childNodes[0].childNodes[1]},getEdgeContainer:function(){return this.node.childNodes[0].childNodes[2]},update:function(){},_update:function(){},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var l=function(r,c){try{var t=c.node.ownerDocument.getElementById(c.id+"text");var f=r.properties["oryx-variants"];if(!f||f==""){t.getElementsByTagName("body")[0].innerHTML="Unset"}else{var d=r.properties["oryx-variants"].evalJSON();var u="";for(i=0;i<d.totalCount;i++){u+="<tr><td>"+d.items[i].id;if(d.items[i].name){u+="</td><td>"+d.items[i].name}if(d.items[i].type){u+="</td><td>"+ORYX.I18N.TGatewayType[d.items[i].type]}u+="</td></tr>"}t.getElementsByTagName("body")[0].innerHTML="<table>"+u+"</table>"}}catch(s){console.error("Unable to render ConfigurationAnnotation "+c.resourceId+": "+s.message)}};if(this.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation"){var g=false;var h=(function(a){this[a]().each((function(c,d){if(c.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Association_Undirected"){c[a]().each((function(r,f){g=true;l(r,this)}).bind(this))}}).bind(this))}).bind(this);h("getIncomingShapes");h("getOutgoingShapes");if(!g){this.node.ownerDocument.getElementById(this.id+"text").getElementsByTagName("body")[0].innerHTML="Unconnected"}}else{if(this.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Association_Undirected"){var e=false;var h=(function(c,a){this[c]().each((function(d){if(d.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation"){e=true;this[a]().each((function(f){l(f,d)}).bind(this))}}).bind(this))}).bind(this);h("getIncomingShapes","getOutgoingShapes");h("getOutgoingShapes","getIncomingShapes");if(e){this.node.setAttributeNS(null,"class","configuration-extension")}else{this.node.removeAttributeNS(null,"class")}}}if(this.properties["oryx-variants"]){var q=false;var h=(function(a){this[a]().each((function(c,d){if(c.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Association_Undirected"){c[a]().each((function(r,f){if(r.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation"){q=true;l(this,r)}}).bind(this))}}).bind(this))}).bind(this);h("getIncomingShapes");h("getOutgoingShapes");if(!q){}}if(this.node.ownerDocument){var n=function(a){return this.node.ownerDocument.getElementById(a)||Ext.fly(this.node).child("[id="+a+"]",true)}.bind(this);var o=function(a){return[].concat($A(this.node.ownerDocument.getElementsByTagNameNS("http://www.w3.org/2000/svg",a)),$A(this.node.getElementsByTagNameNS("http://www.w3.org/2000/svg",a))).compact()}.bind(this);var p=this.getStencil().id();var m=this;this.propertiesChanged.each((function(r){if(r.value){var a=this.properties[r.key];var c=this.getStencil().property(r.key);this.propertiesChanged[r.key]=false;if(c.type()==ORYX.CONFIG.TYPE_CHOICE){c.refToView().each((function(f){if(f!==""){var s=this._labels[this.id+f];if(s&&c.item(a)){s.text(m.wrapValueInPrefixAndSuffix(c,c.item(a).title()))}}}).bind(this));var d=new Hash();c.items().each((function(f){f.refToView().each((function(s){if(s===""){return}var t;t=n(this.id+s);if(!t){return}if(!d[t.id]||a==f.value()){if(Ext.isOpera){t.setAttributeNS(null,"visibility",((a==f.value())?"visible":"hidden"))}t.setAttributeNS(null,"display",((a==f.value())?"inherit":"none"));d[t.id]=t}if(ORYX.Editor.checkClassType(t,SVGImageElement)){t.setAttributeNS("http://www.w3.org/1999/xlink","href",t.getAttributeNS("http://www.w3.org/1999/xlink","href"))}}).bind(this))}).bind(this))}else{c.refToView().each((function(t){if(t===""){return}var v=this.id+t;var f=n(v);var A=false;try{containsInDOM=this.node.parentNode&&!(f.ownerSVGElement)}catch(K){containsInDOM=false}if(!f||containsInDOM){if(c.type()===ORYX.CONFIG.TYPE_URL||c.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){var H=o("a");f=$A(H).find(function(u){return u.getAttributeNS(null,"id")===v});if(!f){return}}else{return}}if(c.complexAttributeToView()){var J=this._labels[v];if(J){try{propJson=a.evalJSON();var G=propJson[c.complexAttributeToView()];J.text(("undefined"===typeof G)?a:G)}catch(K){J.text(a)}}}else{switch(c.type()){case ORYX.CONFIG.TYPE_BOOLEAN:if(typeof a=="string"){a=a==="true"}if(Ext.isOpera){f.setAttributeNS(null,"visibility",(!(a===c.inverseBoolean())?"visible":"hidden"))}f.setAttributeNS(null,"display",(!(a===c.inverseBoolean()))?"inherit":"none");break;case ORYX.CONFIG.TYPE_COLOR:if(c.fill()){if(f.tagName.toLowerCase()==="stop"){if(a){if(c.lightness()&&c.lightness()!==1){a=ORYX.Utils.adjustLightness(a,c.lightness())}f.setAttributeNS(null,"stop-color",a);if(f.parentNode.tagName.toLowerCase()==="radialgradient"){ORYX.Utils.adjustGradient(f.parentNode,f)}}if(f.parentNode.tagName.toLowerCase()==="radialgradient"){$A(f.parentNode.getElementsByTagName("stop")).each(function(u){u.setAttributeNS(null,"stop-opacity",a?u.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default-stop-opacity")||1:0)}.bind(this))}var s=this.getMeContainer().childNodes[0];if(s&&s.nodeType==1){if(a&&String(s.getAttributeNS(null,"pointer-events")).toLowerCase()=="stroke"){s.setAttributeNS(null,"pointer-events","all")}else{if(!a&&String(s.getAttributeNS(null,"pointer-events")).toLowerCase()=="all"){s.setAttributeNS(null,"pointer-events","stroke")}}}}else{f.setAttributeNS(null,"fill",a||"none")}}if(c.stroke()){if(this.fillButStroke[p]&&this.fillButStroke[p].include(t)){f.setAttributeNS(null,"fill",a||"none")}else{f.setAttributeNS(null,"stroke",a);if(this.strokeAndFill[p]&&this.strokeAndFill[p].include(t)){f.setAttributeNS(null,"fill",a||"none")}}}break;case ORYX.CONFIG.TYPE_STRING:var J=this._labels[v];if(J){J.text(m.wrapValueInPrefixAndSuffix(c,a));J.css=""}break;case ORYX.CONFIG.TYPE_INTEGER:var J=this._labels[v];if(J){J.text(m.wrapValueInPrefixAndSuffix(c,a))}break;case ORYX.CONFIG.TYPE_FLOAT:if(c.fillOpacity()){f.setAttributeNS(null,"fill-opacity",a)}if(c.strokeOpacity()){f.setAttributeNS(null,"stroke-opacity",a)}if(!c.fillOpacity()&&!c.strokeOpacity()){var J=this._labels[v];if(J){J.text(m.wrapValueInPrefixAndSuffix(c,a))}}break;case ORYX.CONFIG.TYPE_URL:case ORYX.CONFIG.TYPE_DIAGRAM_LINK:var D=f.getAttributeNodeNS("http://www.w3.org/1999/xlink","xlink:href");if(D){D.textContent=a}else{f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",a)}break;case ORYX.CONFIG.TYPE_COMPLEX:if(t=="text_variants"){var I=this._labels[v];if(I){try{var F=this.properties["oryx-variants"].evalJSON();var E="";for(i=0;i<F.totalCount;i++){E+=F.items[i].id;if(i<F.totalCount-1){E+=","}}I.text(E)}catch(C){I.text("")}}}else{if(J){var w=function(u,x){var N="";var y=[];var M=typeof u.rowDelimiter()==="undefined"?"\n":u.rowDelimiter();var L=typeof u.itemDelimiter()==="undefined"?" ":u.itemDelimiter();u.complexItems().each(function(O){if(O.includeInView()){y.push(O)}});var z;if(x){z=typeof x==="object"?x:x.evalJSON(true)}if(typeof z!=="undefined"&&z.items){var B=[];z.items.each(function(O){var P=[];y.each(function(ac){var V=false;var ab="";var aa=ac.viewPrefix();if(typeof aa!=="undefined"){ab=ab.concat(aa)}var Z=O[ac.id()];switch(ac.type()){case ORYX.CONFIG.TYPE_COMPLEX:if(typeof Z!=="undefined"&&Z.totalCount>0){ab=ab.concat(w(ac,Z))}V=true;break;case ORYX.CONFIG.TYPE_CHOICE:var Y=ac.items().find(function(Q){return Q.value()===Z});if(Y){ab=ab.concat(Y.title());V=true}break;case ORYX.CONFIG.TYPE_BOOLEAN:if(((typeof Z==="boolean"&&Z)||(typeof Z==="string"&&Z.toLowerCase()==="true"))&&typeof ac.representation()!=="undefined"){ab=ab.concat(ac.representation());V=true}break;default:if(ac.isList()){var X;if(Z instanceof Array){X=Z}else{if(typeof Z==="string"){X=Z.evalJSON(true)}}if(typeof X!=="undefined"){var ad=typeof ac.itemDelimiter()!=="undefined"?ac.itemDelimiter():", ";ab=ab.concat(X.join(ad));V=true}}else{if(typeof Z!=="undefined"&&Z!==""){ab=ab.concat(Z);V=true}}break}var W=ac.viewSuffix();if(typeof W!=="undefined"){ab=ab.concat(W)}if(V){P.push(ab)}});B.push(P.join(L))});N=B.join(M)}return N};J.text(w(c,a))}}break}}}).bind(this))}}}).bind(this));this._labels.values().each(function(a){a.update()})}},wrapValueInPrefixAndSuffix:function(l,m){if(typeof m==="undefined"||m===""){return m}var g=m;var f=l.viewPrefix();if(typeof f!=="undefined"){g=f+g}var h=l.viewSuffix();if(typeof h!=="undefined"){g+=h}return g},layout:function(){var a=this.getStencil().layout();if(a){a.each(function(c){c.shape=this;c.forceExecution=true;this._delegateEvent(c)}.bind(this))}},getLabels:function(){return this._labels.values()},getLabel:function(a){if(!a){return null}return(this._labels.find(function(c){return c.key.endsWith(a)})||{}).value||null},hideLabels:function(){this.getLabels().invoke("hide")},showLabels:function(){var a=this.getLabels();a.invoke("show");a.each(function(c){c.update()})},setOpacity:function(c,a){c=Math.max(Math.min((typeof c=="number"?c:1),1),0);if(c!==1){c=String(c);this.node.setAttributeNS(null,"fill-opacity",c);this.node.setAttributeNS(null,"stroke-opacity",c)}else{this.node.removeAttributeNS(null,"fill-opacity");this.node.removeAttributeNS(null,"stroke-opacity")}},getDockers:function(){return this.dockers},getMagnets:function(){return this.magnets},getDefaultMagnet:function(){if(this._defaultMagnet){return this._defaultMagnet}else{if(this.magnets.length>0){return this.magnets[0]}else{return undefined}}},getParentShape:function(){return this.parent},getIncomingShapes:function(a){if(a){this.incoming.each(a)}return this.incoming},getIncomingNodes:function(a){return this.incoming.select(function(c){var d=(c instanceof ORYX.Core.Node);if(d&&a){a(c)}return d})},getOutgoingShapes:function(a){if(a){this.outgoing.each(a)}return this.outgoing},getOutgoingNodes:function(a){return this.outgoing.select(function(c){var d=(c instanceof ORYX.Core.Node);if(d&&a){a(c)}return d})},getAllDockedShapes:function(c){var a=this.incoming.concat(this.outgoing);if(c){a.each(c)}return a},getCanvas:function(){if("undefined"!=typeof this.canvas){return this.canvas}if(this.parent instanceof ORYX.Core.Canvas){this.canvas=this.parent}else{if(this.parent instanceof ORYX.Core.Shape){this.canvas=this.parent.getCanvas()}else{this.canvas=null}}return this.canvas},getChildNodes:function(c,d){if(!c&&!d){return this.nodes.clone()}else{var a=[];this.nodes.each(function(e){if(!e.isVisible){return}if(d){d(e)}a.push(e);if(c&&e instanceof ORYX.Core.Shape){a=a.concat(e.getChildNodes(c,d))}});return a}},getParentWithStencilId:function(f){var d=this;b=[].concat(f);while(d&&!(d instanceof ORYX.Core.Canvas)){var a=d.getStencil().id();for(var e=0;e<f.length;e++){if(d instanceof ORYX.Core.Node&&a.endsWith(f[e])){return d}}d=d.parent}return undefined},is:function(e,f){var d=this.getStencil().id();e=[].concat(e);if(typeof f!=="undefined"){e=e.map(function(a){if(!a.startsWith(f)){return f+a}return a})}return e.any(function(a){return(a&&d.endsWith(a))})},add:function(c,e,d){if(c instanceof ORYX.Core.UIObject&&!(c instanceof ORYX.Core.Edge)){if(!(this.children.member(c))){if(c.parent){c.parent.remove(c,true)}if(e!=undefined){this.children.splice(e,0,c)}else{this.children.push(c)}c.parent=this;var f;if(c instanceof ORYX.Core.Node){f=this.node.childNodes[0].childNodes[1];if(e!=undefined){this.nodes.splice(e,0,c)}else{c.node=this.node.childNodes[0].childNodes[1].appendChild(c.node);this.nodes.push(c)}}else{if(c instanceof ORYX.Core.Controls.Control){var a=this.node.childNodes[1];if(c instanceof ORYX.Core.Controls.Docker){f=a.childNodes[0];if(this.dockers.length>=2){this.dockers.splice(e!==undefined?Math.min(e,this.dockers.length-1):this.dockers.length-1,0,c)}else{this.dockers.push(c)}}else{if(c instanceof ORYX.Core.Controls.Magnet){f=a.childNodes[1];this.magnets.push(c)}else{f=a}}}else{f=this.node}}if(!(c instanceof ORYX.Core.Shape)){if(e!=undefined&&e<f.childNodes.length){c.node=f.insertBefore(c.node,f.childNodes[e])}else{c.node=f.appendChild(c.node)}}this._changed();if(c instanceof ORYX.Core.Shape&&this.eventHandlerCallback&&d!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:c})}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.")}}else{ORYX.Log.warn("add: Parameter is not of type ORYX.Core.UIObject.")}},remove:function(a,c){if(this.children.member(a)){var d=a.parent;this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();if($A(this.node.childNodes[0].childNodes[2].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node)}}else{if($A(this.node.childNodes[0].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node)}this.nodes=this.nodes.without(a)}}else{if(a instanceof ORYX.Core.Controls.Control){if(a instanceof ORYX.Core.Controls.Docker){if($A(this.node.childNodes[1].childNodes[0].childNodes).include(a.node)){a.node=this.node.childNodes[1].childNodes[0].removeChild(a.node)}this.dockers=this.dockers.without(a)}else{if(a instanceof ORYX.Core.Controls.Magnet){if($A(this.node.childNodes[1].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[1].childNodes[1].removeChild(a.node)}this.magnets=this.magnets.without(a)}else{if($A(this.node.childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[1].removeChild(a.node)}}}}}if(this.eventHandlerCallback&&c!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEREMOVED,shape:a,parent:d})}this._changed()}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.")}},getIntersectionPoint:function(){var s,r,m,l;switch(arguments.length){case 2:s=arguments[0].x;r=arguments[0].y;m=arguments[1].x;l=arguments[1].y;break;case 4:s=arguments[0];r=arguments[1];m=arguments[2];l=arguments[3];break;default:throw"getIntersectionPoints needs two or four arguments"}var f,c,g,e;var a=this.absoluteBounds();if(this.isPointIncluded(s,r,a)){f=s;c=r}else{g=s;e=r}if(this.isPointIncluded(m,l,a)){f=m;c=l}else{g=m;e=l}if(!f||!c||!g||!e){return undefined}var q=0;var p=0;var u,t;var o=1;var d=ORYX.Core.Math.getIntersectionPointOfRect(g,e,f,c,a.upperLeft().x,a.upperLeft().y,a.lowerRight().x,a.lowerRight().y);if(d&&this.isPointIncluded(d.x,d.y,a)){return d}var n=0;while(true){var q=Math.min(f,g)+((Math.max(f,g)-Math.min(f,g))/2);var p=Math.min(c,e)+((Math.max(c,e)-Math.min(c,e))/2);if(this.isPointIncluded(q,p,a)){f=q;c=p}else{g=q;e=p}var h=Math.sqrt(Math.pow(f-g,2)+Math.pow(c-e,2));u=f+((g-f)/h),t=c+((e-c)/h);if(!this.isPointIncluded(u,t,a)){break}if(Math.abs(h)<1){break}}return{x:u,y:t}},isPointIncluded:function(){return false},containsNode:function(c){var a=this.node.firstChild.firstChild;while(c){if(c==a){return true}c=c.parentNode}return false},isPointOverOffset:function(){return this.isPointIncluded.apply(this,arguments)},getOverlap:function(a){var c=this;var o=c.absoluteBounds().upperLeft();var l=c.absoluteBounds().lowerRight();var q=a.absoluteBounds().upperLeft();var p=a.absoluteBounds().lowerRight();var e=Math.min(l.x,p.x)-Math.max(o.x,q.x);var g=Math.min(l.y,p.y)-Math.max(o.y,q.y);if(e>0||g>0){var h={x:Math.max(o.x,q.x),y:Math.min(l.y,p.y)};var n={x:Math.min(l.x,p.x),y:Math.max(o.y,q.y)};return new ORYX.Core.Bounds(h,n)}else{return false}},_dockerChanged:function(){},createDocker:function(c,a){var d=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});d.bounds.registerCallback(this._dockerChangedCallback);if(a){d.bounds.centerMoveTo(a)}this.add(d,c);return d},serialize:function(){var a=arguments.callee.$.serialize.apply(this);a.push({name:"bounds",prefix:"oryx",value:this.bounds.serializeForERDF(),type:"literal"});this.getOutgoingShapes().each((function(c){a.push({name:"outgoing",prefix:"raziel",value:"#"+ERDF.__stripHashes(c.resourceId),type:"resource"})}).bind(this));a.push({name:"parent",prefix:"raziel",value:"#"+ERDF.__stripHashes(this.parent.resourceId),type:"resource"});return a},deserialize:function(d,c){arguments.callee.$.deserialize.apply(this,arguments);var e=d.find(function(f){return"oryx-bounds"===(f.prefix+"-"+f.name)});if(e){var a=e.value.replace(/,/g," ").split(" ").without("");if(this instanceof ORYX.Core.Edge){if(!this.dockers.first().isChanged){this.dockers.first().bounds.centerMoveTo(parseFloat(a[0]),parseFloat(a[1]))}if(!this.dockers.last().isChanged){this.dockers.last().bounds.centerMoveTo(parseFloat(a[2]),parseFloat(a[3]))}}else{this.bounds.set(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]))}}if(c&&c.labels instanceof Array){c.labels.each(function(f){var g=this.getLabel(f.ref);if(g){g.deserialize(f,this)}}.bind(this))}},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);var d=[],c=this.id;this._labels.each(function(f){var e=f.value.serialize();if(e){e.ref=f.key.replace(c,"");d.push(e)}});if(d.length>0){a.labels=d}return a},_init:function(a){this._adjustIds(a,0)},_adjustIds:function(d,f){if(d instanceof Element){var a=d.getAttributeNS(null,"id");if(a&&a!==""){d.setAttributeNS(null,"id",this.id+a)}else{d.setAttributeNS(null,"id",this.id+"_"+this.id+"_"+f);f++}var e=d.getAttributeNS(null,"fill");if(e&&e.include("url(#")){e=e.replace(/url\(#/g,"url(#"+this.id);d.setAttributeNS(null,"fill",e)}if(d.hasChildNodes()){for(var c=0;c<d.childNodes.length;c++){f=this._adjustIds(d.childNodes[c],f)}}}return f},toString:function(){return"ORYX.Core.Shape "+this.getId()}};ORYX.Core.Shape=ORYX.Core.AbstractShape.extend(ORYX.Core.Shape);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Control=ORYX.Core.UIObject.extend({toString:function(){return"Control "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Docker=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.bounds.set(0,0,16,16);this.referencePoint=undefined;this._dockedShapeBounds=undefined;this._dockedShape=undefined;this._oldRefPoint1=undefined;this._oldRefPoint2=undefined;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g"]);this._dockerNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"all"},["circle",{cx:"8",cy:"8",r:"8",stroke:"none",fill:"none"}],["circle",{cx:"8",cy:"8",r:"3",stroke:"black",fill:"red","stroke-width":"1"}]]);this._referencePointNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"none"},["circle",{cx:this.bounds.upperLeft().x,cy:this.bounds.upperLeft().y,r:3,fill:"red","fill-opacity":0.4}]]);this.hide();this.addEventHandlers(this._dockerNode);this._updateCallback=this._changed.bind(this)},update:function(){if(this._dockedShape){if(this._dockedShapeBounds&&this._dockedShape instanceof ORYX.Core.Node){var h=this._dockedShapeBounds.width();var e=this._dockedShapeBounds.height();if(!h){h=1}if(!e){e=1}var q=this._dockedShape.bounds.width()/h;var o=this._dockedShape.bounds.height()/e;if(q!==1||o!==1){this.referencePoint.x*=q;this.referencePoint.y*=o}this._dockedShapeBounds=this._dockedShape.bounds.clone()}var c=this.parent.dockers.indexOf(this);var g=this;var f=this.parent.dockers.length>1?(c===0?this.parent.dockers[c+1]:this.parent.dockers[c-1]):undefined;var p=g.getDockedShape()?g.getAbsoluteReferencePoint():g.bounds.center();var m=f&&f.getDockedShape()?f.getAbsoluteReferencePoint():f?f.bounds.center():undefined;if(!m){var a=this._dockedShape.absoluteCenterXY();var n=this._dockedShape.bounds.width()*this._dockedShape.bounds.height();m={x:p.x+(a.x-p.x)*-n,y:p.y+(a.y-p.y)*-n}}var d=undefined;d=this._dockedShape.getIntersectionPoint(p,m);if(!d){d=this.getAbsoluteReferencePoint()}if(this.parent&&this.parent.parent){var l=this.parent.parent.absoluteXY();d.x-=l.x;d.y-=l.y}this.bounds.centerMoveTo(d);this._oldRefPoint1=p;this._oldRefPoint2=m}arguments.callee.$.update.apply(this,arguments)},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this._dockerNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")");a=Object.clone(this.referencePoint);if(a&&this._dockedShape){var c;if(this.parent instanceof ORYX.Core.Edge){c=this._dockedShape.absoluteXY()}else{c=this._dockedShape.bounds.upperLeft()}a.x+=c.x;a.y+=c.y}else{a=this.bounds.center()}this._referencePointNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")")},setReferencePoint:function(a){if(this.referencePoint!==a&&(!this.referencePoint||!a||this.referencePoint.x!==a.x||this.referencePoint.y!==a.y)){this.referencePoint=a;this._changed()}},getAbsoluteReferencePoint:function(){if(!this.referencePoint||!this._dockedShape){return undefined}else{var a=this._dockedShape.absoluteXY();return{x:this.referencePoint.x+a.x,y:this.referencePoint.y+a.y}}},setDockedShape:function(c){if(this._dockedShape){this._dockedShape.bounds.unregisterCallback(this._updateCallback);if(this===this.parent.dockers.first()){this.parent.incoming=this.parent.incoming.without(this._dockedShape);this._dockedShape.outgoing=this._dockedShape.outgoing.without(this.parent)}else{if(this===this.parent.dockers.last()){this.parent.outgoing=this.parent.outgoing.without(this._dockedShape);this._dockedShape.incoming=this._dockedShape.incoming.without(this.parent)}}}this._dockedShape=c;this._dockedShapeBounds=undefined;var a=undefined;if(this._dockedShape){if(this===this.parent.dockers.first()){this.parent.incoming.push(c);c.outgoing.push(this.parent)}else{if(this===this.parent.dockers.last()){this.parent.outgoing.push(c);c.incoming.push(this.parent)}}var d=this.bounds;var e=c.absoluteXY();a={x:d.center().x-e.x,y:d.center().y-e.y};this._dockedShapeBounds=this._dockedShape.bounds.clone();this._dockedShape.bounds.registerCallback(this._updateCallback);this.setDockerColor(ORYX.CONFIG.DOCKER_DOCKED_COLOR)}else{this.setDockerColor(ORYX.CONFIG.DOCKER_UNDOCKED_COLOR)}this.setReferencePoint(a);this._changed()},getDockedShape:function(){return this._dockedShape},isDocked:function(){return !!this._dockedShape},setDockerColor:function(a){this._dockerNode.lastChild.setAttributeNS(null,"fill",a)},preventHiding:function(a){this._preventHiding=Math.max(0,(this._preventHiding||0)+(a?1:-1))},hide:function(){if(this._preventHiding){return false}this.node.setAttributeNS(null,"visibility","hidden");this._referencePointNode.setAttributeNS(null,"visibility","hidden");this.children.each(function(a){a.hide()})},show:function(){this.node.setAttributeNS(null,"visibility","visible");if(this.getDockedShape() instanceof ORYX.Core.Edge){this._referencePointNode.setAttributeNS(null,"visibility","hidden")}else{this._referencePointNode.setAttributeNS(null,"visibility","visible")}this.children.each(function(a){a.show()})},toString:function(){return"Docker "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Magnet=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.bounds.set(0,0,16,16);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"all"},["circle",{cx:"8",cy:"8",r:"4",stroke:"none",fill:"red","fill-opacity":"0.3"}],]);this.hide()},update:function(){arguments.callee.$.update.apply(this,arguments)},_update:function(){arguments.callee.$.update.apply(this,arguments)},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this.node.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")")},show:function(){arguments.callee.$.show.apply(this,arguments)},toString:function(){return"Magnet "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Node={construct:function(a,c){arguments.callee.$.construct.apply(this,arguments);this.isSelectable=true;this.isMovable=true;this._dockerUpdated=false;this._oldBounds=new ORYX.Core.Bounds();this._svgShapes=[];this.minimumSize=undefined;this.maximumSize=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.dataId=undefined;this._init(this._stencil.view())},_update:function(){this.dockers.invoke("update");if(this.isChanged){var d=this.bounds;var e=this._oldBounds;if(this.isResized){var r=d.width()/e.width();var q=d.height()/e.height();this._svgShapes.each(function(y){if(y.isHorizontallyResizable){y.width=y.oldWidth*r}if(y.isVerticallyResizable){y.height=y.oldHeight*q}var x;var u=y.anchorLeft;var w=y.anchorRight;if(w){x=e.width()-(y.oldX+y.oldWidth);if(u){y.width=d.width()-y.x-x}else{y.x=d.width()-(x+y.width)}}else{if(!u){y.x=r*y.oldX;if(!y.isHorizontallyResizable){y.x=y.x+y.width*r/2-y.width/2}}}var p=y.anchorTop;var v=y.anchorBottom;if(v){x=e.height()-(y.oldY+y.oldHeight);if(p){y.height=d.height()-y.y-x}else{if(!y._isYLocked){y.y=d.height()-(x+y.height)}}}else{if(!p){y.y=q*y.oldY;if(!y.isVerticallyResizable){y.y=y.y+y.height*q/2-y.height/2}}}});var h={x:0,y:0};if(!this.isHorizontallyResizable&&d.width()!==e.width()){h.x=e.width()-d.width()}if(!this.isVerticallyResizable&&d.height()!==e.height()){h.y=e.height()-d.height()}if(h.x!==0||h.y!==0){d.extend(h)}h={x:0,y:0};var f,m;if(this.minimumSize){ORYX.Log.debug("Shape (%0)'s min size: (%1x%2)",this,this.minimumSize.width,this.minimumSize.height);f=this.minimumSize.width-d.width();if(f>0){h.x+=f}m=this.minimumSize.height-d.height();if(m>0){h.y+=m}}if(this.maximumSize){ORYX.Log.debug("Shape (%0)'s max size: (%1x%2)",this,this.maximumSize.width,this.maximumSize.height);f=d.width()-this.maximumSize.width;if(f>0){h.x-=f}m=d.height()-this.maximumSize.height;if(m>0){h.y-=m}}if(h.x!==0||h.y!==0){d.extend(h)}var r=d.width()/e.width();var q=d.height()/e.height();var o,n,s,g,c,a,t;this.magnets.each(function(p){o=p.anchorLeft;n=p.anchorRight;s=p.anchorTop;g=p.anchorBottom;c=p.bounds.center();if(o){a=c.x}else{if(n){a=d.width()-(e.width()-c.x)}else{a=c.x*r}}if(s){t=c.y}else{if(g){t=d.height()-(e.height()-c.y)}else{t=c.y*q}}if(c.x!==a||c.y!==t){p.bounds.centerMoveTo(a,t)}});this.getLabels().each(function(p){if(!p.isAnchorLeft()){if(p.isAnchorRight()){p.setX(d.width()-(e.width()-p.oldX))}else{p.setX((p.position?p.position.x:p.x)*r)}}if(!p.isAnchorTop()){if(p.isAnchorBottom()){p.setY(d.height()-(e.height()-p.oldY))}else{p.setY((p.position?p.position.y:p.y)*q)}}if(p.position){if(!p.isOriginAnchorLeft()){if(p.isOriginAnchorRight()){p.setOriginX(d.width()-(e.width()-p.oldX))}else{p.setOriginX(p.x*r)}}if(!p.isOriginAnchorTop()){if(p.isOriginAnchorBottom()){p.setOriginY(d.height()-(e.height()-p.oldY))}else{p.setOriginY(p.y*q)}}}});var l=this.dockers[0];if(l){l.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){l.bounds.centerMoveTo(this.bounds.center());this._dockerUpdated=false}l.update();l.bounds.registerCallback(this._dockerChangedCallback)}this.isResized=false}this.refresh();this.isChanged=false;this._oldBounds=this.bounds.clone()}this.children.each(function(p){if(!(p instanceof ORYX.Core.Controls.Docker)){p._update()}});if(this.dockers.length>0&&!this.dockers.first().getDockedShape()){this.dockers.each(function(p){p.bounds.centerMoveTo(this.bounds.center())}.bind(this))}},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft().x;var c=this.bounds.upperLeft().y;this.node.firstChild.setAttributeNS(null,"transform","translate("+a+", "+c+")");this.node.childNodes[1].childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+c+")");this._svgShapes.each(function(d){d.update()})},_dockerChanged:function(){var a=this.dockers[0];this.bounds.centerMoveTo(a.bounds.center());this._dockerUpdated=true},_initSVGShapes:function(d){var a=[];try{var g=new ORYX.Core.SVG.SVGShape(d);a.push(g)}catch(f){}if(d.hasChildNodes()){for(var c=0;c<d.childNodes.length;c++){a=a.concat(this._initSVGShapes(d.childNodes[c]))}}return a},isPointIncluded:function(a,m,d){var l=d&&d instanceof ORYX.Core.Bounds?d:this.absoluteBounds();if(!l.isIncluded(a,m)){return false}else{}var f=l.upperLeft();var h=a-f.x;var g=m-f.y;var e=0;do{var c=this._svgShapes[e++].isPointIncluded(h,g)}while(!c&&e<this._svgShapes.length);return c},isPointOverOffset:function(e,d){var c=arguments.callee.$.isPointOverOffset.apply(this,arguments);if(c){var a=this.absoluteBounds();a.widen(-ORYX.CONFIG.BORDER_OFFSET);if(!a.isIncluded(e,d)){return true}}return false},serialize:function(){var a=arguments.callee.$.serialize.apply(this);this.dockers.each((function(f){if(f.getDockedShape()){var e=f.referencePoint;e=e?e:f.bounds.center();a.push({name:"docker",prefix:"oryx",value:$H(e).values().join(","),type:"literal"})}}).bind(this));try{var c=this.getStencil().serialize();if(c.type){c.shape=this;c.data=a;c.result=undefined;c.forceExecution=true;this._delegateEvent(c);if(c.result){a=c.result}}}catch(d){}return a},deserialize:function(g){arguments.callee.$.deserialize.apply(this,arguments);try{var a=this.getStencil().deserialize();if(a.type){a.shape=this;a.data=g;a.result=undefined;a.forceExecution=true;this._delegateEvent(a);if(a.result){g=a.result}}}catch(h){}var c=g.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing"});c.each((function(l){if(!this.parent){return}var e=this.getCanvas().getChildShapeByResourceId(l.value);if(e){if(e instanceof ORYX.Core.Edge){e.dockers.first().setDockedShape(this);e.dockers.first().setReferencePoint(e.dockers.first().bounds.center())}else{if(e.dockers.length>0){e.dockers.first().setDockedShape(this)}}}}).bind(this));if(this.dockers.length===1){var f;f=g.find(function(e){return(e.prefix+"-"+e.name==="oryx-dockers")});if(f){var d=f.value.replace(/,/g," ").split(" ").without("").without("#");if(d.length===2&&this.dockers[0].getDockedShape()){this.dockers[0].setReferencePoint({x:parseFloat(d[0]),y:parseFloat(d[1])})}else{this.dockers[0].bounds.centerMoveTo(parseFloat(d[0]),parseFloat(d[1]))}}}},_init:function(p){arguments.callee.$._init.apply(this,arguments);var q=p.getElementsByTagName("g")[0];var t=p.ownerDocument.createAttributeNS(null,"title");t.nodeValue=this.getStencil().title();q.setAttributeNode(t);var w=p.ownerDocument.createAttributeNS(null,"id");w.nodeValue=this.id;q.setAttributeNode(w);var c=this.node.childNodes[0].childNodes[0];q=c.appendChild(q);this.addEventHandlers(q.parentNode);var v=q.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"minimumSize");if(v){v=v.replace("/,/g"," ");var m=v.split(" ");m=m.without("");if(m.length>1){this.minimumSize={width:parseFloat(m[0]),height:parseFloat(m[1])}}else{this.minimumSize={width:1,height:1}}}var h=q.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"maximumSize");if(h){h=h.replace("/,/g"," ");var n=h.split(" ");n=n.without("");if(n.length>1){this.maximumSize={width:parseFloat(n[0]),height:parseFloat(n[1])}}}if(this.minimumSize&&this.maximumSize&&(this.minimumSize.width>this.maximumSize.width||this.minimumSize.height>this.maximumSize.height)){throw this+": Minimum Size must be greater than maxiumSize."}this._svgShapes=this._initSVGShapes(q);var a={x:undefined,y:undefined};var e={x:undefined,y:undefined};var A=this;this._svgShapes.each(function(B){a.x=(a.x!==undefined)?Math.min(a.x,B.x):B.x;a.y=(a.y!==undefined)?Math.min(a.y,B.y):B.y;e.x=(e.x!==undefined)?Math.max(e.x,B.x+B.width):B.x+B.width;e.y=(e.y!==undefined)?Math.max(e.y,B.y+B.height):B.y+B.height;if(B.isHorizontallyResizable){A.isHorizontallyResizable=true;A.isResizable=true}if(B.isVerticallyResizable){A.isVerticallyResizable=true;A.isResizable=true}if(B.anchorTop&&B.anchorBottom){A.isVerticallyResizable=true;A.isResizable=true}if(B.anchorLeft&&B.anchorRight){A.isHorizontallyResizable=true;A.isResizable=true}});this._svgShapes.each(function(B){B.x-=a.x;B.y-=a.y;B.update()});var z=a.x;var y=a.y;e.x-=z;e.y-=y;a.x=0;a.y=0;if(e.x===0){e.x=1}if(e.y===0){e.y=1}this._oldBounds.set(a,e);this.bounds.set(a,e);var g=p.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnets");if(g&&g.length>0){g=$A(g[0].getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnet"));var A=this;g.each(function(C){var G=new ORYX.Core.Controls.Magnet({eventHandlerCallback:A.eventHandlerCallback});var B=parseFloat(C.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var H=parseFloat(C.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));G.bounds.centerMoveTo({x:B-z,y:H-y});var F=C.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(F){F=F.replace("/,/g"," ");F=F.split(" ").without("");for(var D=0;D<F.length;D++){switch(F[D].toLowerCase()){case"left":G.anchorLeft=true;break;case"right":G.anchorRight=true;break;case"top":G.anchorTop=true;break;case"bottom":G.anchorBottom=true;break}}}A.add(G);if(!this._defaultMagnet){var E=C.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default");if(E&&E.toLowerCase()==="yes"){A._defaultMagnet=G}}})}else{var l=new ORYX.Core.Controls.Magnet();l.bounds.centerMoveTo(this.bounds.width()/2,this.bounds.height()/2);this.add(l)}var u=p.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"docker");if(u&&u.length>0){u=u[0];var s=this.createDocker();var f=parseFloat(u.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var d=parseFloat(u.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));s.bounds.centerMoveTo({x:f-z,y:d-y});var r=u.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(r){r=r.replace("/,/g"," ");r=r.split(" ").without("");for(var x=0;x<r.length;x++){switch(r[x].toLowerCase()){case"left":s.anchorLeft=true;break;case"right":s.anchorRight=true;break;case"top":s.anchorTop=true;break;case"bottom":s.anchorBottom=true;break}}}}var o=q.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(o).each((function(C){var B=new ORYX.Core.SVG.Label({textElement:C,shapeId:this.id});B.x-=z;B.y-=y;this._labels[B.id]=B;B.registerOnChange(this.layout.bind(this))}).bind(this))},createDocker:function(){var a=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});a.bounds.registerCallback(this._dockerChangedCallback);this.dockers.push(a);a.parent=this;a.bounds.registerCallback(this._changedCallback);return a},toString:function(){return this._stencil.title()+" "+this.id}};ORYX.Core.Node=ORYX.Core.Shape.extend(ORYX.Core.Node);NAMESPACE_SVG="http://www.w3.org/2000/svg";NAMESPACE_ORYX="http://www.b3mn.org/oryx";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Edge={construct:function(a,d){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.isSelectable=true;this._dockerUpdated=false;this._markers=new Hash();this._paths=[];this._interactionPaths=[];this._dockersByPath=new Hash();this._markersByPath=new Hash();this.attachedNodePositionData=new Hash();var c=this.node.childNodes[0].childNodes[0];c=ORYX.Editor.graft("http://www.w3.org/2000/svg",c,["g",{"pointer-events":"painted"}]);this.addEventHandlers(c.parentNode);this._oldBounds=this.bounds.clone();this._init(this._stencil.view());if(d instanceof Array){this.deserialize(d)}},_update:function(c){if(this._dockerUpdated||this.isChanged||c){this.dockers.invoke("update");if(false&&(this.bounds.width()===0||this.bounds.height()===0)){var d=this.bounds.width();var r=this.bounds.height();this.bounds.extend({x:d===0?2:0,y:r===0?2:0});this.bounds.moveBy({x:d===0?-1:0,y:r===0?-1:0})}var e=this.bounds.upperLeft();var o=this._oldBounds.upperLeft();var f=this._oldBounds.width()===0?this.bounds.width():this._oldBounds.width();var q=this._oldBounds.height()===0?this.bounds.height():this._oldBounds.height();var n=e.x-o.x;var l=e.y-o.y;var p=(this.bounds.width()/f)||1;var g=(this.bounds.height()/q)||1;this.dockers.each((function(s){s.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){s.bounds.moveBy(n,l);if(p!==1||g!==1){var t=s.bounds.upperLeft().x-e.x;var a=s.bounds.upperLeft().y-e.y;s.bounds.moveTo(e.x+t*p,e.y+a*g)}}s.update();s.bounds.registerCallback(this._dockerChangedCallback)}).bind(this));if(this._dockerUpdated){var m=this.dockers.first().bounds.center();var h=this.dockers.first().bounds.center();this.dockers.each((function(s){var a=s.bounds.center();m.x=Math.min(m.x,a.x);m.y=Math.min(m.y,a.y);h.x=Math.max(h.x,a.x);h.y=Math.max(h.y,a.y)}).bind(this));this.bounds.set(Object.clone(m),Object.clone(h))}e=this.bounds.upperLeft();o=this._oldBounds.upperLeft();p=(this.bounds.width()/(f||this.bounds.width()));g=(this.bounds.height()/(q||this.bounds.height()));n=e.x-o.x;l=e.y-o.y;this.getLabels().each(function(D){if(D.getReferencePoint()){var z=D.getReferencePoint();var L=z.segment.from,s=z.segment.to;if(!L||!L.parent||!s||!s.parent){return}var K=L.bounds.center(),C=s.bounds.center();if(K.x===z.segment.fromPosition.x&&K.y===z.segment.fromPosition.y&&C.x===z.segment.toPosition.x&&C.y===z.segment.toPosition.y&&!z.dirty){return}if(!this.parent.initializingShapes){var M=ORYX.Core.Math.getDistanceBetweenTwoPoints(z.segment.fromPosition,z.segment.toPosition,z.intersection);var N=ORYX.Core.Math.getPointBetweenTwoPoints(K,C,isNaN(M)?0.5:M);var J=ORYX.Core.Math.getOrthogonalIdentityVector(K,C);var a=Math.abs(J.y)===1,G=Math.abs(J.x)===1;J.x*=z.distance;J.y*=z.distance;J.x+=N.x;J.y+=N.y;var I=a&&z.orientation&&(z.iorientation||z.orientation).endsWith("r")?-D.getWidth():0;var H=G&&z.orientation&&(z.iorientation||z.orientation).startsWith("l")?-D.getHeight()+2:0;D.setX(J.x+I);D.setY(J.y+H);this.updateReferencePointOfLabel(D,N,L,s)}else{var J=ORYX.Core.Math.getOrthogonalIdentityVector(K,C);J.x*=z.distance;J.y*=z.distance;J.x+=z.intersection.x;J.y+=z.intersection.y;D.setX(J.x);D.setY(J.y);z.segment.fromPosition=K;z.segment.toPosition=C}return}if(D.position&&!this.parent.initializingShapes){var F=D.position.x+(n*(p||1));if(F>this.bounds.lowerRight().x){F+=this.bounds.width()-(this.bounds.width()/(p||1))}var E=D.position.y+(l*(g||1));if(E>this.bounds.lowerRight().y){E+=this.bounds.height()-(this.bounds.height()/(g||1))}D.setX(F);D.setY(E);return}switch(D.getEdgePosition()){case"starttop":var O=this._getAngle(this.dockers[0],this.dockers[1]);var A=this.dockers.first().bounds.center();if(O<=90||O>270){D.horizontalAlign("left");D.verticalAlign("bottom");D.x=A.x+D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(360-O,A)}else{D.horizontalAlign("right");D.verticalAlign("bottom");D.x=A.x-D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(180-O,A)}break;case"startmiddle":var O=this._getAngle(this.dockers[0],this.dockers[1]);var A=this.dockers.first().bounds.center();if(O<=90||O>270){D.horizontalAlign("left");D.verticalAlign("bottom");D.x=A.x+2;D.y=A.y+4;D.rotate(360-O,A)}else{D.horizontalAlign("right");D.verticalAlign("bottom");D.x=A.x+1;D.y=A.y+4;D.rotate(180-O,A)}break;case"startbottom":var O=this._getAngle(this.dockers[0],this.dockers[1]);var A=this.dockers.first().bounds.center();if(O<=90||O>270){D.horizontalAlign("left");D.verticalAlign("top");D.x=A.x+D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(360-O,A)}else{D.horizontalAlign("right");D.verticalAlign("top");D.x=A.x-D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(180-O,A)}break;case"midtop":var w=this.dockers.length;if(w%2==0){var O=this._getAngle(this.dockers[w/2-1],this.dockers[w/2]);var v=this.dockers[w/2-1].bounds.center();var t=this.dockers[w/2].bounds.center();var A={x:(v.x+t.x)/2,y:(v.y+t.y)/2};D.horizontalAlign("center");D.verticalAlign("bottom");D.x=A.x;D.y=A.y-D.getOffsetTop();if(O<=90||O>270){D.rotate(360-O,A)}else{D.rotate(180-O,A)}}else{var B=parseInt(w/2);var O=this._getAngle(this.dockers[B],this.dockers[B+1]);var A=this.dockers[B].bounds.center();if(O<=90||O>270){D.horizontalAlign("left");D.verticalAlign("bottom");D.x=A.x+D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(360-O,A)}else{D.horizontalAlign("right");D.verticalAlign("bottom");D.x=A.x-D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(180-O,A)}}break;case"midbottom":var w=this.dockers.length;if(w%2==0){var O=this._getAngle(this.dockers[w/2-1],this.dockers[w/2]);var v=this.dockers[w/2-1].bounds.center();var t=this.dockers[w/2].bounds.center();var A={x:(v.x+t.x)/2,y:(v.y+t.y)/2};D.horizontalAlign("center");D.verticalAlign("top");D.x=A.x;D.y=A.y+D.getOffsetTop();if(O<=90||O>270){D.rotate(360-O,A)}else{D.rotate(180-O,A)}}else{var B=parseInt(w/2);var O=this._getAngle(this.dockers[B],this.dockers[B+1]);var A=this.dockers[B].bounds.center();if(O<=90||O>270){D.horizontalAlign("left");D.verticalAlign("top");D.x=A.x+D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(360-O,A)}else{D.horizontalAlign("right");D.verticalAlign("top");D.x=A.x-D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(180-O,A)}}break;case"endtop":var u=this.dockers.length;var O=this._getAngle(this.dockers[u-2],this.dockers[u-1]);var A=this.dockers.last().bounds.center();if(O<=90||O>270){D.horizontalAlign("right");D.verticalAlign("bottom");D.x=A.x-D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(360-O,A)}else{D.horizontalAlign("left");D.verticalAlign("bottom");D.x=A.x+D.getOffsetTop();D.y=A.y-D.getOffsetTop();D.rotate(180-O,A)}break;case"endbottom":var u=this.dockers.length;var O=this._getAngle(this.dockers[u-2],this.dockers[u-1]);var A=this.dockers.last().bounds.center();if(O<=90||O>270){D.horizontalAlign("right");D.verticalAlign("top");D.x=A.x-D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(360-O,A)}else{D.horizontalAlign("left");D.verticalAlign("top");D.x=A.x+D.getOffsetBottom();D.y=A.y+D.getOffsetBottom();D.rotate(180-O,A)}break}}.bind(this));this.children.each(function(a){if(a instanceof ORYX.Core.Node){this.calculatePositionOfAttachedChildNode.call(this,a)}}.bind(this));this.refreshAttachedNodes();this.refresh();this.isChanged=false;this._dockerUpdated=false;this._oldBounds=this.bounds.clone()}if(this.parent&&!this.node.parentNode){this.parent.getEdgeContainer().appendChild(this.node)}},movePointToUpperLeftOfNode:function(a,c){a.x-=c.width()/2;a.y-=c.height()/2},refreshAttachedNodes:function(){this.attachedNodePositionData.values().each(function(a){var e=a.segment.docker1.bounds.center();var c=a.segment.docker2.bounds.center();this.relativizePoint(e);this.relativizePoint(c);var d=new Object();d.x=e.x+a.relativDistanceFromDocker1*(c.x-e.x);d.y=e.y+a.relativDistanceFromDocker1*(c.y-e.y);this.movePointToUpperLeftOfNode(d,a.node.bounds);a.node.bounds.moveTo(d);a.node._update()}.bind(this))},calculatePositionOfAttachedChildNode:function(c){var a=new Object();a.x=0;a.y=0;if(!this.attachedNodePositionData[c.getId()]){this.attachedNodePositionData[c.getId()]=new Object();this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=0;this.attachedNodePositionData[c.getId()].node=c;this.attachedNodePositionData[c.getId()].segment=new Object();this.findEdgeSegmentForNode(c)}else{if(c.isChanged){this.findEdgeSegmentForNode(c)}}},findEdgeSegmentForNode:function(d){var c=this.dockers.length;var a=undefined;for(i=1;i<c;i++){var h=this.dockers[i-1].bounds.center();var f=this.dockers[i].bounds.center();this.relativizePoint(h);this.relativizePoint(f);var e=d.bounds.center();var g=ORYX.Core.Math.distancePointLinie(h,f,e,true);if((g||g==0)&&((!a&&a!=0)||g<a)){a=g;this.attachedNodePositionData[d.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[d.getId()].segment.docker2=this.dockers[i]}if(!g&&!a&&a!=0){(ORYX.Core.Math.getDistancePointToPoint(e,h)<ORYX.Core.Math.getDistancePointToPoint(e,f))?this.attachedNodePositionData[d.getId()].relativDistanceFromDocker1=0:this.attachedNodePositionData[d.getId()].relativDistanceFromDocker1=1;this.attachedNodePositionData[d.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[d.getId()].segment.docker2=this.dockers[i]}}if(a||a==0){this.attachedNodePositionData[d.getId()].relativDistanceFromDocker1=this.getLineParameterForPosition(this.attachedNodePositionData[d.getId()].segment.docker1,this.attachedNodePositionData[d.getId()].segment.docker2,d)}},findSegment:function(d){var c=this.dockers.length;var a;var e=d instanceof ORYX.Core.UIObject?d.bounds.center():d;for(i=1;i<c;i++){var h=this.dockers[i-1].bounds.center();var f=this.dockers[i].bounds.center();var g=ORYX.Core.Math.distancePointLinie(h,f,e,true);if(typeof g=="number"&&(a===undefined||g<a.distance)){a={distance:g,fromDocker:this.dockers[i-1],toDocker:this.dockers[i]}}}return a},getLineParameterForPosition:function(c,h,e){var g=c.bounds.center();var f=h.bounds.center();this.relativizePoint(g);this.relativizePoint(f);var d=ORYX.Core.Math.getPointOfIntersectionPointLine(g,f,e.bounds.center(),true);if(!d){return 0}var a=ORYX.Core.Math.getDistancePointToPoint(d,g)/ORYX.Core.Math.getDistancePointToPoint(g,f);return a},relativizePoint:function(a){a.x-=this.bounds.upperLeft().x;a.y-=this.bounds.upperLeft().y},optimizedUpdate:function(){var a=function(c){if(!c._dockedShape||!c._dockedShapeBounds){return}var d={x:c._dockedShape.bounds.a.x-c._dockedShapeBounds.a.x,y:c._dockedShape.bounds.a.y-c._dockedShapeBounds.a.y};c.bounds.moveBy(d);c._dockedShapeBounds.moveBy(d)};a(this.dockers.first());a(this.dockers.last());this.refresh()},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);this._paths.each((function(l,f){var h=undefined;var e=this._dockersByPath.values()[0];var n=undefined;var m=undefined;if(h){m="M"+h.x+" "+h.y}else{n=e[0].bounds.center();h=n;m="M"+n.x+" "+n.y}for(var g=1;g<e.length;g++){n=e[g].bounds.center();m=m+"L"+n.x+" "+n.y+" ";h=n}l.setAttributeNS(null,"d",m);this._interactionPaths[f].setAttributeNS(null,"d",m)}).bind(this));if(this.getChildNodes().length>0){var a=this.bounds.upperLeft().x;var c=this.bounds.upperLeft().y;this.node.firstChild.childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+c+")")}this.propertiesChanged.each((function(l){var d=this.properties[l.key];var f=this.getStencil().property(l.key);f.refToView().each((function(g){if(g=="selected"){var e=this.node.ownerDocument.getElementById(this.id+"selected");if(e){e.setAttributeNS(null,"visibility",this.getProperty("selected")?"inherit":"hidden");e.setAttributeNS(null,"stroke",this.getProperty("selectioncolor"))}}}).bind(this))}).bind(this))},getIntersectionPoint:function(){var a=Math.floor(this.dockers.length/2);return ORYX.Core.Math.midPoint(this.dockers[a-1].bounds.center(),this.dockers[a].bounds.center())},isBoundsIncluded:function(d){var a=this.dockers,c=a.length;return a.any(function(h,g){if(g==c-1){return false}var f=h.bounds.center();var e=a[g+1].bounds.center();return ORYX.Core.Math.isRectOverLine(f.x,f.y,e.x,e.y,d.a.x,d.a.y,d.b.x,d.b.y)})},isPointIncluded:function(h,g){var a=this.absoluteBounds().isIncluded(h,g,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);var f=undefined;if(a&&this.dockers.length>0){var d=0;var e,c;do{e=this.dockers[d].bounds.center();c=this.dockers[++d].bounds.center();f=ORYX.Core.Math.isPointInLine(h,g,e.x,e.y,c.x,c.y,ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}while(!f&&d<this.dockers.length-1)}return f},isPointOverOffset:function(){return false},containsNode:function(a){if(this._paths.include(a)||this._interactionPaths.include(a)){return true}return false},_getAngle:function(a,e){var d=a instanceof ORYX.Core.Controls.Docker?a.absoluteCenterXY():a;var c=e instanceof ORYX.Core.Controls.Docker?e.absoluteCenterXY():e;return ORYX.Core.Math.getAngle(d,c)},alignDockers:function(){this._update(true);var f=this.dockers.first().bounds.center();var e=this.dockers.last().bounds.center();var d=e.x-f.x;var a=e.y-f.y;var c=this.dockers.length-1;this.dockers.each((function(l,h){var g=h/c;l.bounds.unregisterCallback(this._dockerChangedCallback);l.bounds.moveTo(f.x+g*d,f.y+g*a);l.bounds.registerCallback(this._dockerChangedCallback)}).bind(this));this._dockerChanged()},add:function(a){arguments.callee.$.add.apply(this,arguments);if(a instanceof ORYX.Core.Controls.Docker&&this.dockers.include(a)){var c=this._dockersByPath.values()[0];if(c){c.splice(this.dockers.indexOf(a),0,a)}this.handleChildShapesAfterAddDocker(a)}},handleChildShapesAfterAddDocker:function(g){if(!g instanceof ORYX.Core.Controls.Docker){return undefined}var e=this.dockers.indexOf(g);if(!(0<e&&e<this.dockers.length-1)){return undefined}var f=this.dockers[e-1];var c=this.dockers[e+1];var d=this.getAttachedNodePositionDataForSegment(f,c);var a=ORYX.Core.Math.getDistancePointToPoint(f.bounds.center(),g.bounds.center());var l=ORYX.Core.Math.getDistancePointToPoint(c.bounds.center(),g.bounds.center());if(!(a+l)){return}var h=a/(a+l);d.each(function(o){if(o.value.relativDistanceFromDocker1<h){o.value.segment.docker2=g;o.value.relativDistanceFromDocker1=o.value.relativDistanceFromDocker1/h}else{o.value.segment.docker1=g;var n=1-h;var m=o.value.relativDistanceFromDocker1-h;o.value.relativDistanceFromDocker1=m/n}});this.getLabels().each(function(o){var q=o.getReferencePoint();if(!q||!q.intersection){return}var n=this.dockers.indexOf(g);if(n>=q.segment.fromIndex&&n<=q.segment.toIndex){var p=this.findSegment(q.intersection);if(!p){p.fromDocker=q.segment.fromIndex>=(this.dockers.length/2)?this.dockers[0]:this.dockers[this.dockers.length-2];p.toDocker=this.dockers[this.dockers.indexOf(from)+1]}var m=p.fromDocker.bounds.center(),r=p.toDocker.bounds.center();var s=ORYX.Core.Math.getPointOfIntersectionPointLine(m,r,q.intersection,true);this.updateReferencePointOfLabel(o,s,p.fromDocker,p.toDocker,true)}}.bind(this));this.refreshAttachedNodes()},getAttachedNodePositionDataForSegment:function(d,a){if(!((d instanceof ORYX.Core.Controls.Docker)&&(a instanceof ORYX.Core.Controls.Docker))){return[]}var c=this.attachedNodePositionData.findAll(function(e){return e.value.segment.docker1===d&&e.value.segment.docker2===a});if(!c){return[]}return c},remove:function(a){arguments.callee.$.remove.apply(this,arguments);if(this.attachedNodePositionData[a.getId()]){delete this.attachedNodePositionData[a.getId()]}if(a instanceof ORYX.Core.Controls.Docker){this.handleChildShapesAfterRemoveDocker(a)}},updateReferencePointOfLabel:function(a,h,g,f,c){if(!a.getReferencePoint()||!a.isVisible){return}var d=a.getReferencePoint();if(d.orientation&&d.orientation!=="ce"){var e=this._getAngle(g,f);if(d.distance>=0){if(e==0){a.horizontalAlign("left");a.verticalAlign("bottom")}else{if(e>0&&e<90){a.horizontalAlign("right");a.verticalAlign("bottom")}else{if(e==90){a.horizontalAlign("right");a.verticalAlign("top")}else{if(e>90&&e<180){a.horizontalAlign("right");a.verticalAlign("top")}else{if(e==180){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e>180&&e<270){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e==270){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e>270&&e<=360){a.horizontalAlign("left");a.verticalAlign("bottom")}}}}}}}}}else{if(e==0){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e>0&&e<90){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e==90){a.horizontalAlign("left");a.verticalAlign("top")}else{if(e>90&&e<180){a.horizontalAlign("left");a.verticalAlign("bottom")}else{if(e==180){a.horizontalAlign("left");a.verticalAlign("bottom")}else{if(e>180&&e<270){a.horizontalAlign("right");a.verticalAlign("bottom")}else{if(e==270){a.horizontalAlign("right");a.verticalAlign("top")}else{if(e>270&&e<=360){a.horizontalAlign("right");a.verticalAlign("top")}}}}}}}}}d.iorientation=d.iorientation||d.orientation;d.orientation=(a.verticalAlign()=="top"?"u":"l")+(a.horizontalAlign()=="left"?"l":"r")}a.setReferencePoint(Ext.apply({},{intersection:h,segment:{from:g,fromIndex:this.dockers.indexOf(g),fromPosition:g.bounds.center(),to:f,toIndex:this.dockers.indexOf(f),toPosition:f.bounds.center()},dirty:c||false},d))},handleChildShapesAfterRemoveDocker:function(a){if(!(a instanceof ORYX.Core.Controls.Docker)){return}this.attachedNodePositionData.each(function(d){if(d.value.segment.docker1===a){var c=this.dockers.indexOf(d.value.segment.docker2);if(c==-1){return}d.value.segment.docker1=this.dockers[c-1]}else{if(d.value.segment.docker2===a){var c=this.dockers.indexOf(d.value.segment.docker1);if(c==-1){return}d.value.segment.docker2=this.dockers[c+1]}}}.bind(this));this.getLabels().each(function(c){var e=c.getReferencePoint();if(!e){return}var h=e.segment.from;var g=e.segment.to;if(h!==a&&g!==a){return}var d=this.findSegment(e.intersection);if(!d){h=d.fromDocker;g=d.toDocker}else{h=h===a?this.dockers[this.dockers.indexOf(g)-1]:h;g=this.dockers[this.dockers.indexOf(h)+1]}var f=ORYX.Core.Math.getPointOfIntersectionPointLine(h.bounds.center(),g.bounds.center(),e.intersection,true);this.updateReferencePointOfLabel(c,f,h,g,true)}.bind(this));this.refreshAttachedNodes()},addDocker:function(c,e){var d;var a;this._dockersByPath.any((function(f){return f.value.any((function(m,g){if(!d){d=m;return false}else{var l=d.bounds.center();var h=m.bounds.center();if(ORYX.Core.Math.isPointInLine(c.x,c.y,l.x,l.y,h.x,h.y,10)){var o=this._paths.find(function(q){return q.id===f.key});if(o){var p=o.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(p&&p.toLowerCase()==="no"){return true}}var n=(e)?e:this.createDocker(this.dockers.indexOf(d)+1,c);n.bounds.centerMoveTo(c);if(e){this.add(n,this.dockers.indexOf(d)+1)}a=n;return true}else{d=m;return false}}}).bind(this))}).bind(this));return a},removeDocker:function(a){if(this.dockers.length>2&&!(this.dockers.first()===a)){this._dockersByPath.any((function(c){if(c.value.member(a)){if(a===c.value.last()){return true}else{this.remove(a);this._dockersByPath[c.key]=c.value.without(a);this.isChanged=true;this._dockerChanged();return true}}return false}).bind(this))}},removeUnusedDockers:function(){var a=$H({});this.dockers.each(function(f,c){if(c==0||c==this.dockers.length-1){return}var e=this.dockers[c-1];if(a.values().indexOf(e)!=-1&&this.dockers[c-2]){e=this.dockers[c-2]}var d=this.dockers[c+1];var g=e.getDockedShape()&&e.referencePoint?e.getAbsoluteReferencePoint():e.bounds.center();var l=d.getDockedShape()&&d.referencePoint?d.getAbsoluteReferencePoint():d.bounds.center();var h=f.bounds.center();if(ORYX.Core.Math.isPointInLine(h.x,h.y,g.x,g.y,l.x,l.y,1)){a[c]=f}}.bind(this));a.each(function(c){this.removeDocker(c.value)}.bind(this));if(a.values().length>0){this._update(true)}return a},_init:function(h){arguments.callee.$._init.apply(this,arguments);var f,d,u,s;var m=h.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(m.length>0){m=m[0];var e=$A(m.getElementsByTagNameNS(NAMESPACE_SVG,"marker"));var n;var q=this;e.each(function(v){try{n=new ORYX.Core.SVG.SVGMarker(v.cloneNode(true));q._markers[n.id]=n;var w=$A(n.element.getElementsByTagNameNS(NAMESPACE_SVG,"text"));var g;w.each(function(y){g=new ORYX.Core.SVG.Label({textElement:y,shapeId:this.id});q._labels[g.id]=g})}catch(x){}})}var c=h.getElementsByTagNameNS(NAMESPACE_SVG,"g");if(c.length<=0){throw"Edge: No g element found."}var o=c[0];o.setAttributeNS(null,"id",null);var l=true;$A(o.childNodes).each((function(I,C){if(ORYX.Editor.checkClassType(I,SVGPathElement)){I=I.cloneNode(false);var B=I.id;I.setAttributeNS(null,"id",B);this._paths.push(I);var E=[];var J=I.getAttributeNS(null,"marker-start");if(J&&J!==""){J=J.strip();J=J.replace(/^url\(#/,"");var A=this.id.concat(J.replace(/\)$/,""));I.setAttributeNS(null,"marker-start","url(#"+A+")");E.push(this._markers[A])}J=I.getAttributeNS(null,"marker-mid");if(J&&J!==""){J=J.strip();J=J.replace(/^url\(#/,"");var v=this.id.concat(J.replace(/\)$/,""));I.setAttributeNS(null,"marker-mid","url(#"+v+")");E.push(this._markers[v])}J=I.getAttributeNS(null,"marker-end");if(J&&J!==""){J=J.strip();J=J.replace(/^url\(#/,"");var D=this.id.concat(J.replace(/\)$/,""));I.setAttributeNS(null,"marker-end","url(#"+D+")");E.push(this._markers[D])}this._markersByPath[B]=E;var g=new PathParser();var H=new ORYX.Core.SVG.PointsPathHandler();g.setHandler(H);g.parsePath(I);if(H.points.length<4){throw"Edge: Path has to have two or more points specified."}this._dockersByPath[B]=[];for(var z=0;z<H.points.length;z+=2){var G=H.points[z];var F=H.points[z+1];if(l||z>0){var w=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});w.bounds.centerMoveTo(G,F);w.bounds.registerCallback(this._dockerChangedCallback);this.add(w,this.dockers.length);if(f){f=Math.min(G,f);d=Math.min(F,d)}else{f=G;d=F}if(u){u=Math.max(G,u);s=Math.max(F,s)}else{u=G;s=F}}}l=false}}).bind(this));this.bounds.set(f,d,u,s);if(false&&(this.bounds.width()===0||this.bounds.height()===0)){var a=this.bounds.width();var r=this.bounds.height();this.bounds.extend({x:a===0?2:0,y:r===0?2:0});this.bounds.moveBy({x:a===0?-1:0,y:r===0?-1:0})}this._oldBounds=this.bounds.clone();this._paths.reverse();var t=[];this._paths.each((function(g){t.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(g))}).bind(this));this._paths=t;this._paths.each((function(v){var g=v.cloneNode(false);g.setAttributeNS(null,"id",(g.getAttributeNS(null,"id")||"")+"_z");g.setAttributeNS(null,"stroke-width",10);g.setAttributeNS(null,"visibility","hidden");g.setAttributeNS(null,"stroke-dasharray",null);g.setAttributeNS(null,"stroke","black");g.setAttributeNS(null,"fill","none");g.setAttributeNS(null,"title",this.getStencil().title());this._interactionPaths.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(g))}).bind(this));this._paths.reverse();this._interactionPaths.reverse();var p=h.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(p).each((function(v){var g=new ORYX.Core.SVG.Label({textElement:v,shapeId:this.id});this.node.childNodes[0].childNodes[0].appendChild(g.node);this._labels[g.id]=g;g.registerOnChange(this.layout.bind(this))}).bind(this));this.propertiesChanged.each(function(g){g.value=true})},addMarkers:function(a){this._markers.each(function(c){if(!a.ownerDocument.getElementById(c.value.id)){c.value.element=a.appendChild(c.value.element)}})},removeMarkers:function(){var c=this.node.ownerSVGElement;if(c){var a=c.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(a.length>0){a=a[0];this._markers.each(function(d){var e=a.ownerDocument.getElementById(d.value.id);if(e){d.value.element=a.removeChild(d.value.element)}})}}},_dockerChanged:function(){this._dockerUpdated=true},serialize:function(){var a=arguments.callee.$.serialize.apply(this);var f="";this._dockersByPath.each((function(e){e.value.each(function(m){var l=m.getDockedShape()&&m.referencePoint?m.referencePoint:m.bounds.center();f=f.concat(l.x+" "+l.y+" ")});f+=" # "}).bind(this));a.push({name:"dockers",prefix:"oryx",value:f,type:"literal"});var c=this.dockers.last();var h=c.getDockedShape();if(h){a.push({name:"target",prefix:"raziel",value:"#"+ERDF.__stripHashes(h.resourceId),type:"resource"})}try{var d=this.getStencil().serialize();if(d.type){d.shape=this;d.data=a;d.result=undefined;d.forceExecution=true;this._delegateEvent(d);if(d.result){a=d.result}}}catch(g){}return a},deserialize:function(g){try{var d=this.getStencil().deserialize();if(d.type){d.shape=this;d.data=g;d.result=undefined;d.forceExecution=true;this._delegateEvent(d);if(d.result){g=d.result}}}catch(l){}var h=g.find(function(e){return(e.prefix+"-"+e.name)=="raziel-target"});var a;if(h){a=this.getCanvas().getChildShapeByResourceId(h.value)}var f=g.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing"});f.each((function(n){if(!this.parent){return}var e=this.getCanvas().getChildShapeByResourceId(n.value);if(e){if(e==a){this.dockers.last().setDockedShape(e);this.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2})}else{if(e instanceof ORYX.Core.Edge){e.dockers.first().setDockedShape(this)}}}}).bind(this));var c=g.find(function(e){return(e.prefix==="oryx"&&e.name==="dockers")});if(c){var m=c.value.split("#").without("").without(" ");m.each((function(n,q){var t=n.replace(/,/g," ").split(" ").without("");if(t.length%2===0){var u=this._paths[q];if(u){if(q===0){while(this._dockersByPath[u.id].length>2){this.removeDocker(this._dockersByPath[u.id][1])}}else{while(this._dockersByPath[u.id].length>1){this.removeDocker(this._dockersByPath[u.id][0])}}var e=this._dockersByPath[u.id];if(q===0){var s=parseFloat(t.shift());var r=parseFloat(t.shift());s=s||s===0?s:10;r=r||r===0?r:10;if(e.first().getDockedShape()){e.first().setReferencePoint({x:s,y:r})}else{e.first().bounds.centerMoveTo(s,r)}}r=parseFloat(t.pop());s=parseFloat(t.pop());s=s||s===0?s:10;r=r||r===0?r:10;if(e.last().getDockedShape()){e.last().setReferencePoint({x:s,y:r})}else{e.last().bounds.centerMoveTo(s,r)}for(var o=0;o<t.length;o++){s=parseFloat(t[o]);r=parseFloat(t[++o]);var p=this.createDocker();p.bounds.centerMoveTo(s,r)}}}}).bind(this))}else{this.alignDockers()}arguments.callee.$.deserialize.apply(this,arguments);this._changed()},toString:function(){return this.getStencil().title()+" "+this.id},getTarget:function(){return this.dockers.last()?this.dockers.last().getDockedShape():null},getSource:function(){return this.dockers.first()?this.dockers.first().getDockedShape():null},isDocked:function(){var a=false;this.dockers.each(function(c){if(c.isDocked()){a=true;throw $break}});return a},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);if(this.getTarget()){a.target={resourceId:this.getTarget().resourceId}}return a}};ORYX.Core.Edge=ORYX.Core.Shape.extend(ORYX.Core.Edge);if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.AbstractPlugin=Clazz.extend({facade:null,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onLoaded.bind(this))},onLoaded:function(){},onSelectionChanged:function(){},showOverlay:function(a,c,e,d){if(!(a instanceof Array)){a=[a]}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true)}return g}.bind(this)).compact();if(!this.overlayID){this.overlayID=this.type+ORYX.Editor.provideId()}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayID,shapes:a,attributes:c,node:e,nodePosition:d||"NW"})},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayID})},doTransform:function(e,a){if(!a||!e){return""}var d=new DOMParser();var m=d.parseFromString(e,"text/xml");source=a;new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(o){xsl=o.responseText}.bind(this),onFailure:(function(o){ORYX.Log.error("XSL load failed"+o)}).bind(this)});var g=new XSLTProcessor();var l=new DOMParser();var f=l.parseFromString(xsl,"text/xml");g.importStylesheet(f);try{var n=g.transformToFragment(m,document);var c=(new XMLSerializer()).serializeToString(n);c=!c.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+c:c;return c}catch(h){return -1}},openXMLWindow:function(a){var c=window.open("data:application/xml,"+encodeURIComponent(a),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes")},openDownloadWindow:function(c,d){var e=window.open("");if(e!=null){e.document.open();e.document.write("<html><body>");var a=e.document.createElement("form");e.document.body.appendChild(a);var f=function(g,h){var l=document.createElement("input");l.name=g;l.type="hidden";l.value=h;return l};a.appendChild(f("download",d));a.appendChild(f("file",c));a.method="POST";e.document.write("</body></html>");e.document.close();a.action=ORYX.CONFIG.EDITOR_PATH+"/download";a.submit()}},getSerializedDOM:function(){var a=DataManager.serializeDOM(this.facade);a='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="'+location.href.split("?")[0]+'" /></head><body>'+a+"</body></html>";return a},enableReadOnlyMode:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);this._stopSelectionChange=function(){if(this.facade.getSelection().length>0){this.facade.setSelection([])}};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this))},disableReadOnlyMode:function(){this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);if(this._stopSelectionChange){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));this._stopSelectionChange=undefined}},getRDFFromDOM:function(){try{var d="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(e){d=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var m=new DOMParser();var l=m.parseFromString(this.getSerializedDOM(),"text/xml");var g=m.parseFromString(d,"text/xml");var c=new XSLTProcessor();c.importStylesheet(g);var a=c.transformToFragment(l,document);var f=new XMLSerializer();return f.serializeToString(a)}catch(h){Ext.Msg.alert("Oryx",error);return""}},isStencilSetExtensionLoaded:function(a){return this.facade.getStencilSets().values().any(function(c){return c.extensions().keys().any(function(d){return d==a}.bind(this))}.bind(this))},doLayout:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LAYOUT,shapes:a})},layoutEdges:function(c,a,e){if(!this.facade.isExecutingCommands()){return}var d=ORYX.Core.Command.extend({construct:function(g,l,m,h){this.edges=g;this.node=l;this.plugin=h;this.offset=m;var f=l.absoluteXY();this.ulo={x:f.x-m.x,y:f.y-m.y}},execute:function(){if(this.changes){this.executeAgain();return}else{this.changes=[];this.edges.each(function(f){this.changes.push({edge:f,oldDockerPositions:f.dockers.map(function(g){return g.bounds.center()})})}.bind(this))}this.edges.findAll(function(f){return f.dockers.length>2}.bind(this)).each(function(h){if(h.dockers.first().getDockedShape()===this.node){var g=h.dockers[1];if(this.align(g.bounds,h.dockers.first())){g.update()}}else{if(h.dockers.last().getDockedShape()===this.node){var f=h.dockers[h.dockers.length-2];if(this.align(f.bounds,h.dockers.last())){f.update()}}}h._update(true);h.removeUnusedDockers();if(this.isBendPointIncluded(h)){this.plugin.doLayout(h);return}}.bind(this));this.edges.each(function(f){if(f.dockers.length==2){var h=f.dockers.first().getAbsoluteReferencePoint()||f.dockers.first().bounds.center();var g=f.dockers.last().getAbsoluteReferencePoint()||f.dockers.first().bounds.center();if(Math.abs(-Math.abs(h.x-g.x)+Math.abs(this.offset.x))<2||Math.abs(-Math.abs(h.y-g.y)+Math.abs(this.offset.y))<2){this.plugin.doLayout(f)}}}.bind(this));this.edges.each(function(g,f){this.changes[f].dockerPositions=g.dockers.map(function(h){return h.bounds.center()})}.bind(this))},align:function(m,g){var l=g.getAbsoluteReferencePoint()||g.bounds.center();var n=m.center().x-l.x;var h=m.center().y-l.y;if(Math.abs(-Math.abs(n)+Math.abs(this.offset.x))<3&&this.offset.xs===undefined){m.moveBy({x:-n,y:0})}if(Math.abs(-Math.abs(h)+Math.abs(this.offset.y))<3&&this.offset.ys===undefined){m.moveBy({y:-h,x:0})}if(this.offset.xs!==undefined||this.offset.ys!==undefined){var f=g.getDockedShape().absoluteXY();n=m.center().x-(f.x+((l.x-f.x)/this.offset.xs));h=m.center().y-(f.y+((l.y-f.y)/this.offset.ys));if(Math.abs(-Math.abs(n)+Math.abs(this.offset.x))<3){m.moveBy({x:-(m.center().x-l.x),y:0})}if(Math.abs(-Math.abs(h)+Math.abs(this.offset.y))<3){m.moveBy({y:-(m.center().y-l.y),x:0})}}},isBendPointIncluded:function(f){var g=f.dockers.first().getDockedShape();var h=f.dockers.last().getDockedShape();if(g){g=g.absoluteBounds();g.widen(5)}if(h){h=h.absoluteBounds();h.widen(20)}return f.dockers.any(function(m,l){var n=m.bounds.center();return l!=0&&l!=f.dockers.length-1&&((g&&g.isIncluded(n))||(h&&h.isIncluded(n)))})},removeAllDocker:function(f){f.dockers.slice(1,f.dockers.length-1).each(function(g){f.removeDocker(g)})},executeAgain:function(){this.changes.each(function(f){this.removeAllDocker(f.edge);f.dockerPositions.each(function(l,g){if(g==0||g==f.dockerPositions.length-1){return}var h=f.edge.createDocker(undefined,l);h.bounds.centerMoveTo(l);h.update()}.bind(this));f.edge._update(true)}.bind(this))},rollback:function(){this.changes.each(function(f){this.removeAllDocker(f.edge);f.oldDockerPositions.each(function(l,g){if(g==0||g==f.oldDockerPositions.length-1){return}var h=f.edge.createDocker(undefined,l);h.bounds.centerMoveTo(l);h.update()}.bind(this));f.edge._update(true)}.bind(this))}});this.facade.executeCommands([new d(a,c,e,this)])}});if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.AbstractLayouter=ORYX.Plugins.AbstractPlugin.extend({layouted:[],construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT,this._initLayout.bind(this))},isIncludedInLayout:function(a){if(!(this.layouted instanceof Array)){this.layouted=[this.layouted].compact()}if(this.layouted.length<=0){return true}return this.layouted.any(function(c){if(typeof c=="string"){return a.getStencil().id().include(c)}else{return a instanceof c}})},_initLayout:function(d){var c=[d.shapes].flatten().compact();var a=c.findAll(function(e){return this.isIncludedInLayout(e)}.bind(this));if(a.length>0){this.layout(a)}},layout:function(a){throw new Error("Layouter has to implement the layout function.")}});if(!Signavio){var Signavio={}}if(!Signavio.Core){Signavio.Core={}}Signavio.Core.Version="1.0.0";if(!Signavio){var Signavio=new Object()}if(!Signavio.Plugins){Signavio.Plugins=new Object()}if(!Signavio.Plugins.Utils){Signavio.Plugins.Utils=new Object()}if(!Signavio.Helper){Signavio.Helper=new Object()}new function(){var a;Signavio.Plugins.Utils.getFFVersion=function(){try{return Number(window.navigator.userAgent.match("Firefox.([0-9]+[.][0-9]+)")[1])||0}catch(c){return 0}};Signavio.Helper.ShowMask=function(d,g){if(ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY===true){return}if(a){return}var m="background:white;bottom:0;height:100%;left:0;position:absolute;right:0;top:0;width:100%;z-index:100000;";var n="left:50%;margin-left:-200px;margin-top:-90px;position:absolute;top:50%;display:none;width:391px;";var h="color:#ad0f5b;padding-right:10px;font-family:tahoma,arial,san-serif;font-size:12px;";var l="display:block;position:relative;text-align:right;top:0;width:100%;";var c="color:#ad0f5b;font-weight:bold;padding-right:10px;font-family:tahoma,arial,san-serif;font-size:12px;";var f="height:16px;width:16px;margin-bottom:-4px;background: transparent url(../libs/ext-2.0.2/resources/images/default/tree/loading.gif) no-repeat center;";var e="padding-bottom:10px;border-bottom:1px solid #ad0f5b;";g=(g?Ext.get(g):null)||Ext.getBody();if(g!==Ext.getBody()){g.setStyle("position","relative")}a=Ext.get(document.createElement("div"));g.appendChild(a);a.dom.setAttribute("style",m);a.dom.innerHTML="<div class='mask-logo' style='"+n+"'><div><img style='"+e+"' src='"+ORYX.CONFIG.EXPLORER_PATH+"/src/img/signavio/signavio_logo.jpg' /></div><span class='mask-text' style='"+l+"'><span class='mask-title' style='"+c+"'>Editor</span><span class='mask-version' style='"+h+"'>Version "+Signavio.Core.Version+"</span><img style='"+f+"' src='"+(ORYX.CONFIG.BLANK_IMAGE||Ext.BLANK_IMAGE_URL)+"'/></span></div>";a.first().show({duration:0.3})};Ext.onReady(Signavio.Helper.ShowMask);Signavio.Helper.HideMask=function(){window.setTimeout(function(){if(a){a.first().hide({duration:0.4,remove:true,block:true});a.hide({duration:0.3,remove:true,block:true});delete a}}.bind(this),2000)};Signavio.Plugins.Loading={facade:undefined,construct:function(c){this.facade=c;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,Signavio.Helper.HideMask);var d=this;new function(){var e=ORYX.Core.Canvas.prototype.toJSON;ORYX.Core.Canvas.prototype.toJSON=function(){var f=e.call(this);f.stencilset.namespace=d.facade.getModelMetaData().model.stencilset.namespace;return f}}()}};Signavio.Plugins.Loading=Clazz.extend(Signavio.Plugins.Loading);ORYX.Editor.provideId=function(){var d=[],e="0123456789ABCDEF";for(var c=0;c<36;c++){d[c]=Math.floor(Math.random()*16)}d[14]=4;d[19]=(d[19]&3)|8;for(var c=0;c<36;c++){d[c]=e[d[c]]}d[8]=d[13]=d[18]=d[23]="-";return"sid-"+d.join("")}}();new function(){Ext.LinkButton=Ext.extend(Ext.BoxComponent,{click:null,image:null,imageStyle:null,toggle:false,toggleStyle:null,selected:false,href:false,el:null,onRender:function(c,a){if(this.el==null){this.el=document.createElement("a");if(this.tabIndex){this.el.setAttribute("tabindex",this.tabIndex)}this.el.id=this.getId();this.el.className=this.cls||"x-link-button";if(!this.disabled){this.el.href=this.href?this.href:"#"+this.text}if(!this.disabled){Element.observe(this.el,"click",this.onClick.bind(this))}if(this.image){this.el.innerHTML='<img src="'+this.image+'" title="'+this.text+'"'+(this.imageStyle?' style="'+this.imageStyle+'"/>':"/>")}else{this.el.innerHTML=this.text?Ext.util.Format.htmlEncode(this.text):(this.html||"")}if(this.forId){this.el.setAttribute("htmlFor",this.forId)}}Ext.LinkButton.superclass.onRender.call(this,c,a)},onClick:function(a){if(this.disabled){Event.stop(a);return}if(this.toggle){this.selected=!this.selected;if(this.toggleStyle){this._setStyle(this.el.dom,"");this.el.dom.setAttribute("style","");if(this.selected){this.el.applyStyles(this.toggleStyle)}else{this.el.applyStyles(this.initialConfig.style)}}}if(this.click instanceof Function){this.click.apply(this.click,[this,a])}Event.stop(a)},setText:function(a,c){this.text=a;if(this.rendered){this.el.dom.innerHTML=c!==false?Ext.util.Format.htmlEncode(a):a}return this},_setStyle:function(c,a){if(Ext.isIE){c.style.setAttribute("cssText",a)}else{c.setAttribute("style",a)}}});Ext.reg("linkbutton",Ext.LinkButton)}();new function(){Signavio.Helper.RecordReader=function(meta){meta=meta||{};this.rels=meta.rels||this.rels;Signavio.Helper.RecordReader.superclass.constructor.call(this,meta,["rep","href","rel"])};Ext.extend(Signavio.Helper.RecordReader,Ext.data.JsonReader,{rels:["gitem"],read:function(response){var json=response.responseText;var o=eval("("+json+")");if(!o){throw {message:"JsonReader.read: Json object not found"}}var Record=this.recordType;var records=[],total=0;o.each(function(rec){if(this.rels.include(rec.rel)){records.push(new Record(rec))}if(rec.rel=="info"&&rec.rep.size){total=rec.rep.size}}.bind(this));return{success:true,records:records,totalRecords:total||records.length}}});Signavio.Helper.createRecord=function(rel,href,rep){var Rec=Ext.data.Record.create(["rel","href","rep"]);var record=new Rec({rel:rel,href:href,rep:rep});return record}}();if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Toolbar=Clazz.extend({facade:undefined,plugs:[],construct:function(c,a){this.facade=c;this.groupIndex=new Hash();a.properties.each((function(d){if(d.group&&d.index!=undefined){this.groupIndex[d.group]=d.index}}).bind(this));Ext.QuickTips.init();this.buttons=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BUTTON_UPDATE,this.onButtonUpdate.bind(this))},onButtonUpdate:function(c){var a=this.buttons.find(function(d){return d.id===c.id});if(c.pressed!==undefined){a.buttonInstance.toggle(c.pressed)}},registryChanged:function(d){var c=d.sortBy((function(h){return((this.groupIndex[h.group]!=undefined?this.groupIndex[h.group]:"")+h.group+""+h.index).toLowerCase()}).bind(this));var a=$A(c).findAll(function(h){return !this.plugs.include(h)&&(!h.target||h.target===ORYX.Plugins.Toolbar)}.bind(this));if(a.length<1){return}this.buttons=[];ORYX.Log.trace("Creating a toolbar.");if(!this.toolbar){this.toolbar=new Ext.ux.SlicedToolbar({height:24});var f=this.facade.addToRegion("north",this.toolbar,"Toolbar")}var g=this.plugs.last()?this.plugs.last().group:a[0].group;var e={};a.each((function(l){if(!l.name){return}this.plugs.push(l);if(g!=l.group){this.toolbar.add("-");g=l.group;e={}}if(l.dropDownGroupIcon){var n=e[l.dropDownGroupIcon];if(n===undefined){n=e[l.dropDownGroupIcon]=new Ext.Toolbar.SplitButton({cls:"x-btn-icon",icon:l.dropDownGroupIcon,menu:new Ext.menu.Menu({items:[]}),listeners:{click:function(o,p){if(!o.menu.isVisible()&&!o.ignoreNextClick){o.showMenu()}else{o.hideMenu()}}}});this.toolbar.add(n)}var m={icon:l.icon,text:l.name,itemId:l.id,handler:l.toggle?undefined:l.functionality,checkHandler:l.toggle?l.functionality:undefined,listeners:{render:function(o){if(l.description){new Ext.ToolTip({target:o.getEl(),title:l.description})}}}};if(l.toggle){var h=new Ext.menu.CheckItem(m)}else{var h=new Ext.menu.Item(m)}n.menu.add(h)}else{if(l.addFill){this.toolbar.addFill()}else{var h=new Ext.Toolbar.Button({icon:l.icon,cls:"x-btn-icon",itemId:l.id,tooltip:l.description,tooltipType:"title",handler:l.toggle?null:l.functionality,enableToggle:l.toggle,toggleHandler:l.toggle?l.functionality:null});this.toolbar.add(h);h.getEl().onclick=function(){this.blur()}}}l.buttonInstance=h;this.buttons.push(l)}).bind(this));this.enableButtons([]);this.toolbar.calcSlices();window.addEventListener("resize",function(h){this.toolbar.calcSlices()}.bind(this),false);window.addEventListener("onresize",function(h){this.toolbar.calcSlices()}.bind(this),false)},onSelectionChanged:function(a){this.enableButtons(a.elements)},enableButtons:function(a){this.buttons.each((function(c){c.buttonInstance.enable();if(c.minShape&&c.minShape>a.length){c.buttonInstance.disable()}if(c.maxShape&&c.maxShape<a.length){c.buttonInstance.disable()}if(c.isEnabled&&!c.isEnabled(c.buttonInstance)){c.buttonInstance.disable()}}).bind(this))}});Ext.ns("Ext.ux");Ext.ux.SlicedToolbar=Ext.extend(Ext.Toolbar,{currentSlice:0,iconStandardWidth:22,seperatorStandardWidth:2,toolbarStandardPadding:2,initComponent:function(){Ext.apply(this,{});Ext.ux.SlicedToolbar.superclass.initComponent.apply(this,arguments)},onRender:function(){Ext.ux.SlicedToolbar.superclass.onRender.apply(this,arguments)},onResize:function(){Ext.ux.SlicedToolbar.superclass.onResize.apply(this,arguments)},calcSlices:function(){var e=0;this.sliceMap={};var d=0;var a=this.getEl().getWidth();this.items.getRange().each(function(h,f){if(h.helperItem){h.destroy();return}var l=h.getEl().getWidth();if(d+l+5*this.iconStandardWidth>a){var g=this.items.indexOf(h);this.insertSlicingButton("next",e,g);if(e!==0){this.insertSlicingButton("prev",e,g)}this.insertSlicingSeperator(e,g);e+=1;d=0}this.sliceMap[h.id]=e;d+=l}.bind(this));if(e>0){this.insertSlicingSeperator(e,this.items.getCount()+1);this.insertSlicingButton("prev",e,this.items.getCount()+1);var c=new Ext.Toolbar.Spacer();this.insertSlicedHelperButton(c,e,this.items.getCount()+1);Ext.get(c.id).setWidth(this.iconStandardWidth)}this.maxSlice=e;this.setCurrentSlice(this.currentSlice)},insertSlicedButton:function(c,d,a){this.insertButton(a,c);this.sliceMap[c.id]=d},insertSlicedHelperButton:function(c,d,a){c.helperItem=true;this.insertSlicedButton(c,d,a)},insertSlicingSeperator:function(c,a){this.insertSlicedHelperButton(new Ext.Toolbar.Fill(),c,a)},insertSlicingButton:function(f,g,c){var e=function(){this.setCurrentSlice(this.currentSlice+1)}.bind(this);var a=function(){this.setCurrentSlice(this.currentSlice-1)}.bind(this);var d=new Ext.Toolbar.Button({cls:"x-btn-icon",icon:ORYX.CONFIG.ROOT_PATH+"images/toolbar_"+f+".png",handler:(f==="next")?e:a});this.insertSlicedHelperButton(d,g,c)},setCurrentSlice:function(a){if(a>this.maxSlice||a<0){return}this.currentSlice=a;this.items.getRange().each(function(c){c.setVisible(a===this.sliceMap[c.id])}.bind(this))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeMenuPlugin={construct:function(d){this.facade=d;this.alignGroups=new Hash();var a=this.facade.getCanvas().getHTMLContainer();this.shapeMenu=new ORYX.Plugins.ShapeMenu(a);this.currentShapes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_START,this.hideShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_END,this.showShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_START,(function(){this.hideShapeMenu();this.hideMorphMenu()}).bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.showShapeMenu.bind(this));var c=new Ext.dd.DragZone(a.parentNode,{shadow:!Ext.isMac});c.afterDragDrop=this.afterDragging.bind(this,c);c.beforeDragOver=this.beforeDragOver.bind(this,c);this.createdButtons={};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,(function(){this.registryChanged()}).bind(this));this.timer=null;this.resetElements=true},hideShapeMenu:function(a){window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.hide()},showShapeMenu:function(a){if(!a||this.resetElements){window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.shapeMenu.closeAllButtons();this.showMorphButton(this.currentShapes);this.showStencilButtons(this.currentShapes);this.shapeMenu.show(this.currentShapes);this.resetElements=false}.bind(this),300)}else{window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.show(this.currentShapes)}},registryChanged:function(a){if(a){a=a.each(function(e){e.group=e.group?e.group:"unknown"});this.pluginsData=a.sortBy(function(e){return(e.group+""+e.index)})}this.shapeMenu.removeAllButtons();this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_RIGHT,2);this.createdButtons={};this.createMorphMenu();if(!this.pluginsData){this.pluginsData=[]}this.baseMorphStencils=this.facade.getRules().baseMorphs();var c=this.facade.getRules().containsMorphingRules();var d=this.facade.getStencilSets();d.values().each((function(g){var f=g.nodes();f.each((function(m){var l={type:m.id(),namespace:m.namespace(),connectingType:true};var h=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,l),icon:m.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:m.title()+" - "+ORYX.I18N.ShapeMenuPlugin.clickDrag});this.shapeMenu.addButton(h);this.createdButtons[m.namespace()+m.type()+m.id()]=h;Ext.dd.Registry.register(h.node.lastChild,l)}).bind(this));var e=g.edges();e.each((function(m){var l={type:m.id(),namespace:m.namespace()};var h=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,l),icon:m.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:1,msg:(c?ORYX.I18N.Edge:m.title())+" - "+ORYX.I18N.ShapeMenuPlugin.drag});this.shapeMenu.addButton(h);this.createdButtons[m.namespace()+m.type()+m.id()]=h;Ext.dd.Registry.register(h.node.lastChild,l)}).bind(this))}).bind(this))},createMorphMenu:function(){this.morphMenu=new Ext.menu.Menu({id:"Oryx_morph_menu",items:[]});this.morphMenu.on("mouseover",function(){this.morphMenuHovered=true},this);this.morphMenu.on("mouseout",function(){this.morphMenuHovered=false},this);var a=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showMorphMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideMorphMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleMorphMenu.bind(this)),icon:ORYX.PATH+"images/wrench_orange.png",align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.morphMsg});this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_BOTTOM,1);this.shapeMenu.addButton(a);this.morphMenu.getEl().appendTo(a.node);this.morphButton=a},showMorphMenu:function(){this.morphMenu.show(this.morphButton.node);this._morphMenuShown=true},hideMorphMenu:function(){this.morphMenu.hide();this._morphMenuShown=false},toggleMorphMenu:function(){if(this._morphMenuShown){this.hideMorphMenu()}else{this.showMorphMenu()}},onSelectionChanged:function(a){var c=a.elements;this.hideShapeMenu();this.hideMorphMenu();if(this.currentShapes.inspect()!==c.inspect()){this.currentShapes=c;this.resetElements=true;this.showShapeMenu()}else{this.showShapeMenu(true)}},showMorphButton:function(c){if(c.length!=1){return}var a=this.facade.getRules().morphStencils({stencil:c[0].getStencil()});a=a.select(function(d){if(c[0].getStencil().type()==="node"){return this.facade.getRules().canContain({containingShape:c[0].parent,containedStencil:d})}else{return this.facade.getRules().canConnect({sourceShape:c[0].dockers.first().getDockedShape(),edgeStencil:d,targetShape:c[0].dockers.last().getDockedShape()})}}.bind(this));if(a.size()<=1){return}this.morphMenu.removeAll();a=a.sortBy(function(d){return d.position()});a.each((function(e){var d=new Ext.menu.Item({text:e.title(),icon:e.icon(),disabled:e.id()==c[0].getStencil().id(),disabledClass:ORYX.CONFIG.MORPHITEM_DISABLED,handler:(function(){this.morphShape(c[0],e)}).bind(this)});this.morphMenu.add(d)}).bind(this));this.morphButton.prepareToShow()},showStencilButtons:function(h){if(h.length!=1){return}var g=this.facade.getStencilSets()[h[0].getStencil().namespace()];var d=this.facade.getRules().outgoingEdgeStencils({canvas:this.facade.getCanvas(),sourceShape:h[0]});var a=new Array();var e=new Array();var f=this.facade.getRules().containsMorphingRules();d.each((function(m){if(f){if(this.baseMorphStencils.include(m)){var n=true}else{var l=this.facade.getRules().morphStencils({stencil:m});var n=!l.any((function(o){if(this.baseMorphStencils.include(o)&&d.include(o)){return true}return e.include(o)}).bind(this))}}if(n||!f){if(this.createdButtons[m.namespace()+m.type()+m.id()]){this.createdButtons[m.namespace()+m.type()+m.id()].prepareToShow()}e.push(m)}a=a.concat(this.facade.getRules().targetStencils({canvas:this.facade.getCanvas(),sourceShape:h[0],edgeStencil:m}))}).bind(this));a.uniq();var c=new Array();a.each((function(n){if(f){if(n.type()==="edge"){return}if(!this.facade.getRules().showInShapeMenu(n)){return}if(!this.baseMorphStencils.include(n)){var l=this.facade.getRules().morphStencils({stencil:n});if(l.size()==0){return}var m=l.any((function(o){if(this.baseMorphStencils.include(o)&&a.include(o)){return true}return c.include(o)}).bind(this));if(m){return}}}if(this.createdButtons[n.namespace()+n.type()+n.id()]){this.createdButtons[n.namespace()+n.type()+n.id()].prepareToShow()}c.push(n)}).bind(this))},beforeDragOver:function(p,o,c){if(this.shapeMenu.isVisible){this.hideShapeMenu()}var n=this.facade.eventCoordinates(c.browserEvent);var u=this.facade.getCanvas().getAbstractShapesAtPosition(n);if(u.length<=0){return false}var e=u.last();if(this._lastOverElement==e){return false}else{var l=Ext.dd.Registry.getHandle(o.DDM.currentTarget);if(l.backupOptions){for(key in l.backupOptions){l[key]=l.backupOptions[key]}delete l.backupOptions}var q=this.facade.getStencilSets()[l.namespace];var s=q.stencil(l.type);var t=u.last();if(s.type()==="node"){var d=this.facade.getRules().canContain({containingShape:t,containedStencil:s});if(!d){var r=this.facade.getRules().morphStencils({stencil:s});for(var h=0;h<r.size();h++){d=this.facade.getRules().canContain({containingShape:t,containedStencil:r[h]});if(d){l.backupOptions=Object.clone(l);l.type=r[h].id();l.namespace=r[h].namespace();break}}}this._currentReference=d?t:undefined}else{var m=t,f=t;var g=false;while(!g&&m&&!(m instanceof ORYX.Core.Canvas)){t=m;g=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:s,targetShape:m});m=m.parent}if(!g){t=f;var r=this.facade.getRules().morphStencils({stencil:s});for(var h=0;h<r.size();h++){var m=t;var g=false;while(!g&&m&&!(m instanceof ORYX.Core.Canvas)){t=m;g=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:r[h],targetShape:m});m=m.parent}if(g){l.backupOptions=Object.clone(l);l.type=r[h].id();l.namespace=r[h].namespace();break}else{t=f}}}this._currentReference=g?t:undefined}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeMenu",elements:[t],color:this._currentReference?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});var a=p.getProxy();a.setStatus(this._currentReference?a.dropAllowed:a.dropNotAllowed);a.sync()}this._lastOverElement=e;return false},afterDragging:function(m,g,c){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return}var f=this.currentShapes;this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeMenu"});var l=m.getProxy();if(l.dropStatus==l.dropNotAllowed){return this.facade.updateSelection()}if(!this._currentReference){return}var e=Ext.dd.Registry.getHandle(g.DDM.currentTarget);e.parent=this._currentReference;var t=c.getXY();var n={x:t[0],y:t[1]};var p=this.facade.getCanvas().node.getScreenCTM();n.x-=p.e;n.y-=p.f;n.x/=p.a;n.y/=p.d;n.x-=document.documentElement.scrollLeft;n.y-=document.documentElement.scrollTop;var s=this._currentReference.absoluteXY();n.x-=s.x;n.y-=s.y;if(!c.ctrlKey){var o=this.currentShapes[0].bounds.center();if(20>Math.abs(o.x-n.x)){n.x=o.x}if(20>Math.abs(o.y-n.y)){n.y=o.y}}e.position=n;e.connectedShape=this.currentShapes[0];if(e.connectingType){var r=this.facade.getStencilSets()[e.namespace];var q=r.stencil(e.type);var h={sourceShape:this.currentShapes[0],targetStencil:q};e.connectingType=this.facade.getRules().connectMorph(h).id()}if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete e.connectingType}var d=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(Object.clone(e),this._currentReference,n,this);this.facade.executeCommands([d]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,source:f,destination:this.currentShapes});if(e.backupOptions){for(key in e.backupOptions){e[key]=e.backupOptions[key]}delete e.backupOptions}this._currentReference=undefined},newShape:function(f,g){var a=this.facade.getStencilSets()[f.namespace];var e=a.stencil(f.type);if(this.facade.getRules().canContain({containingShape:this.currentShapes.first().parent,containedStencil:e})){f.connectedShape=this.currentShapes[0];f.parent=this.currentShapes.first().parent;f.containedStencil=e;var c={sourceShape:this.currentShapes[0],targetStencil:e};var d=this.facade.getRules().connectMorph(c);if(!d){return}f.connectingType=d.id();if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete f.connectingType}var h=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(f,undefined,undefined,this);this.facade.executeCommands([h])}},morphShape:function(a,c){var e=ORYX.Core.Command.extend({construct:function(f,h,g){this.shape=f;this.stencil=h;this.facade=g},execute:function(){var q=this.shape;var u=this.stencil;var p=q.resourceId;var l=q.serialize();u.properties().each((function(v){if(v.readonly()){l=l.reject(function(w){return w.name==v.id()})}}).bind(this));if(this.newShape){newShape=this.newShape;this.facade.getCanvas().add(newShape)}else{newShape=this.facade.createShape({type:u.id(),namespace:u.namespace(),resourceId:p})}var o=l.find(function(v){return(v.prefix==="oryx"&&v.name==="bounds")});var r=null;if(!this.facade.getRules().preserveBounds(q.getStencil())){var f=o.value.split(",");if(parseInt(f[0],10)>parseInt(f[2],10)){var m=f[0];f[0]=f[2];f[2]=m;m=f[1];f[1]=f[3];f[3]=m}f[2]=parseInt(f[0],10)+newShape.bounds.width();f[3]=parseInt(f[1],10)+newShape.bounds.height();o.value=f.join(",")}else{var t=q.bounds.height();var g=q.bounds.width();if(newShape.minimumSize){if(q.bounds.height()<newShape.minimumSize.height){t=newShape.minimumSize.height}if(q.bounds.width()<newShape.minimumSize.width){g=newShape.minimumSize.width}}if(newShape.maximumSize){if(q.bounds.height()>newShape.maximumSize.height){t=newShape.maximumSize.height}if(q.bounds.width()>newShape.maximumSize.width){g=newShape.maximumSize.width}}r={a:{x:q.bounds.a.x,y:q.bounds.a.y},b:{x:q.bounds.a.x+g,y:q.bounds.a.y+t}}}var s=q.bounds.center();if(r!==null){newShape.bounds.set(r)}this.setRelatedDockers(q,newShape);var n=q.node.parentNode;var h=q.node.nextSibling;this.facade.deleteShape(q);newShape.deserialize(l);if(q.getStencil().property("oryx-bgcolor")&&q.properties["oryx-bgcolor"]&&q.getStencil().property("oryx-bgcolor").value().toUpperCase()==q.properties["oryx-bgcolor"].toUpperCase()){if(newShape.getStencil().property("oryx-bgcolor")){newShape.setProperty("oryx-bgcolor",newShape.getStencil().property("oryx-bgcolor").value())}}if(r!==null){newShape.bounds.set(r)}if(newShape.getStencil().type()==="edge"||(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){newShape.bounds.centerMoveTo(s)}if(newShape.getStencil().type()==="node"&&(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){this.setRelatedDockers(newShape,newShape)}if(h){n.insertBefore(newShape.node,h)}else{n.appendChild(newShape.node)}this.facade.setSelection([newShape]);this.facade.getCanvas().update();this.facade.updateSelection();this.newShape=newShape},rollback:function(){if(!this.shape||!this.newShape||!this.newShape.parent){return}this.newShape.parent.add(this.shape);this.setRelatedDockers(this.newShape,this.shape);this.facade.deleteShape(this.newShape);this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection()},setRelatedDockers:function(f,g){if(f.getStencil().type()==="node"){(f.incoming||[]).concat(f.outgoing||[]).each(function(h){h.dockers.each(function(n){if(n.getDockedShape()==f){var m=Object.clone(n.referencePoint);var o={x:m.x*g.bounds.width()/f.bounds.width(),y:m.y*g.bounds.height()/f.bounds.height()};n.setDockedShape(g);n.setReferencePoint(o);if(h instanceof ORYX.Core.Edge){n.bounds.centerMoveTo(o)}else{var l=f.absoluteXY();n.bounds.centerMoveTo({x:o.x+l.x,y:o.y+l.y})}}})});if(f.dockers.length>0&&f.dockers.first().getDockedShape()){g.dockers.first().setDockedShape(f.dockers.first().getDockedShape());g.dockers.first().setReferencePoint(Object.clone(f.dockers.first().referencePoint))}}else{g.dockers.first().setDockedShape(f.dockers.first().getDockedShape());g.dockers.first().setReferencePoint(f.dockers.first().referencePoint);g.dockers.last().setDockedShape(f.dockers.last().getDockedShape());g.dockers.last().setReferencePoint(f.dockers.last().referencePoint)}}});var d=new e(a,c,this.facade);this.facade.executeCommands([d])}};ORYX.Plugins.ShapeMenuPlugin=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ShapeMenuPlugin);ORYX.Plugins.ShapeMenu={construct:function(a){this.bounds=undefined;this.shapes=undefined;this.buttons=[];this.isVisible=false;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(a),["div",{id:ORYX.Editor.provideId(),"class":"Oryx_ShapeMenu"}]);this.alignContainers=new Hash();this.numberOfButtonsPerLevel=new Hash()},addButton:function(c){this.buttons.push(c);if(!this.alignContainers[c.align]){this.alignContainers[c.align]=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["div",{"class":c.align}]);this.node.appendChild(this.alignContainers[c.align]);var a=false;this.alignContainers[c.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hoverAlignContainer.bind(this,c.align),a);this.alignContainers[c.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.resetAlignContainer.bind(this,c.align),a);this.alignContainers[c.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hoverAlignContainer.bind(this,c.align),a)}this.alignContainers[c.align].appendChild(c.node)},deleteButton:function(a){this.buttons=this.buttons.without(a);this.node.removeChild(a.node)},removeAllButtons:function(){var a=this;this.buttons.each(function(c){if(c.node&&c.node.parentNode){c.node.parentNode.removeChild(c.node)}});this.buttons=[]},closeAllButtons:function(){this.buttons.each(function(a){a.prepareToHide()});this.isVisible=false},show:function(f){if(f.length<=0){return}this.shapes=f;var h=undefined;var m=undefined;this.shapes.each(function(v){if(!v||!v.node||!v.node.parentNode){return}var u=v.node.getScreenCTM();var w=v.absoluteXY();u.e=u.a*w.x;u.f=u.d*w.y;m=new ORYX.Core.Bounds(u.e,u.f,u.e+u.a*v.bounds.width(),u.f+u.d*v.bounds.height());if(!h){h=m}else{h.include(m)}});if(!h){return}this.bounds=h;var d=this.bounds;var q=this.bounds.upperLeft();var l=0,e=0;var o=0,p=0;var c=0,r;var s=0,g=0;var t=Ext.isIPad?30:22;var n=this.getWillShowButtons();n.sortBy(function(a){return a.group});n.each(function(u){var v=this.getNumberOfButtonsPerLevel(u.align);if(u.align==ORYX.CONFIG.SHAPEMENU_LEFT){if(u.group!=e){l=0;e=u.group}var a=Math.floor(l/v);var w=l%v;u.setLevel(a);u.setPosition(q.x-5-(a+1)*t,q.y+v*u.group*t+u.group*0.3*t+w*t);l++}else{if(u.align==ORYX.CONFIG.SHAPEMENU_TOP){if(u.group!=p){o=0;p=u.group}var a=o%v;var w=Math.floor(o/v);u.setLevel(w);u.setPosition(q.x+v*u.group*t+u.group*0.3*t+a*t,q.y-5-(w+1)*t);o++}else{if(u.align==ORYX.CONFIG.SHAPEMENU_BOTTOM){if(u.group!=r){c=0;r=u.group}var a=c%v;var w=Math.floor(c/v);u.setLevel(w);u.setPosition(q.x+v*u.group*t+u.group*0.3*t+a*t,q.y+d.height()+5+w*t);c++}else{if(u.group!=g){s=0;g=u.group}var a=Math.floor(s/v);var w=s%v;u.setLevel(a);u.setPosition(q.x+d.width()+5+a*t,q.y+v*u.group*t+u.group*0.3*t+w*t-5);s++}}}u.show()}.bind(this));this.isVisible=true},hide:function(){this.buttons.each(function(a){a.hide()});this.isVisible=false},hoverAlignContainer:function(c,a){this.buttons.each(function(d){if(d.align==c){d.showOpaque()}})},resetAlignContainer:function(c,a){this.buttons.each(function(d){if(d.align==c){d.showTransparent()}})},isHover:function(){return this.buttons.any(function(a){return a.isHover()})},getWillShowButtons:function(){return this.buttons.findAll(function(a){return a.willShow})},getButtons:function(c,a){return this.getWillShowButtons().findAll(function(d){return d.align==c&&(a===undefined||d.group==a)})},setNumberOfButtonsPerLevel:function(c,a){this.numberOfButtonsPerLevel[c]=a},getNumberOfButtonsPerLevel:function(a){if(this.numberOfButtonsPerLevel[a]){return Math.min(this.getButtons(a,0).length,this.numberOfButtonsPerLevel[a])}else{return 1}}};ORYX.Plugins.ShapeMenu=Clazz.extend(ORYX.Plugins.ShapeMenu);ORYX.Plugins.ShapeMenuButton={construct:function(c){if(c){this.option=c;if(!this.option.arguments){this.option.arguments=[]}}else{}this.parentId=this.option.id?this.option.id:null;var f=this.option.caption?"Oryx_button_with_caption":"Oryx_button";this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":f}]);var d={src:this.option.icon};if(this.option.msg){d.title=this.option.msg}if(this.option.icon){ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["img",d])}if(this.option.caption){var e=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["span"]);ORYX.Editor.graft("http://www.w3.org/1999/xhtml",e,this.option.caption)}var a=false;this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hover.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.reset.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.activate.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hover.bind(this),a);this.node.addEventListener("click",this.trigger.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.move.bind(this),a);this.align=this.option.align?this.option.align:ORYX.CONFIG.SHAPEMENU_RIGHT;this.group=this.option.group?this.option.group:0;this.hide();this.dragStart=false;this.isVisible=false;this.willShow=false;this.resetTimer},hide:function(){this.node.style.display="none";this.isVisible=false},show:function(){this.node.style.display="";this.node.style.opacity=this.opacity;this.isVisible=true},showOpaque:function(){this.node.style.opacity=1},showTransparent:function(){this.node.style.opacity=this.opacity},prepareToShow:function(){this.willShow=true},prepareToHide:function(){this.willShow=false;this.hide()},setPosition:function(a,c){this.node.style.left=a+"px";this.node.style.top=c+"px"},setLevel:function(a){if(a==0){this.opacity=0.5}else{if(a==1){this.opacity=0.2}else{this.opacity=0}}},setChildWidth:function(a){this.childNode.style.width=a+"px"},reset:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=window.setTimeout(this.doReset.bind(this),100);if(this.option.resetcallback){this.option.arguments.push(a);var c=this.option.resetcallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},doReset:function(){if(this.node.hasClassName("Oryx_down")){this.node.removeClassName("Oryx_down")}if(this.node.hasClassName("Oryx_hover")){this.node.removeClassName("Oryx_hover")}},activate:function(a){this.node.addClassName("Oryx_down");this.dragStart=true},isHover:function(){return this.node.hasClassName("Oryx_hover")?true:false},hover:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=null;this.node.addClassName("Oryx_hover");this.dragStart=false;if(this.option.hovercallback){this.option.arguments.push(a);var c=this.option.hovercallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},move:function(a){if(this.dragStart&&this.option.dragcallback){this.option.arguments.push(a);var c=this.option.dragcallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},trigger:function(a){if(this.option.callback){this.option.arguments.push(a);var c=this.option.callback.apply(this,this.option.arguments);this.option.arguments.remove(a)}this.dragStart=false},toString:function(){return"HTML-Button "+this.id}};ORYX.Plugins.ShapeMenuButton=Clazz.extend(ORYX.Plugins.ShapeMenuButton);ORYX.Plugins.ShapeMenuPlugin.CreateCommand=ORYX.Core.Command.extend({construct:function(d,c,a,e){this.option=d;this.currentReference=c;this.position=a;this.plugin=e;this.shape;this.edge;this.targetRefPos;this.sourceRefPos;this.connectedShape=d.connectedShape;this.connectingType=d.connectingType;this.namespace=d.namespace;this.type=d.type;this.containedStencil=d.containedStencil;this.parent=d.parent;this.currentReference=c;this.shapeOptions=d.shapeOptions},execute:function(){var e=false;if(this.shape){if(this.shape instanceof ORYX.Core.Node){this.parent.add(this.shape);if(this.edge){this.plugin.facade.getCanvas().add(this.edge);this.edge.dockers.first().setDockedShape(this.connectedShape);this.edge.dockers.first().setReferencePoint(this.sourceRefPos);this.edge.dockers.last().setDockedShape(this.shape);this.edge.dockers.last().setReferencePoint(this.targetRefPos)}this.plugin.facade.setSelection([this.shape])}else{if(this.shape instanceof ORYX.Core.Edge){this.plugin.facade.getCanvas().add(this.shape);this.shape.dockers.first().setDockedShape(this.connectedShape);this.shape.dockers.first().setReferencePoint(this.sourceRefPos)}}e=true}else{this.shape=this.plugin.facade.createShape(this.option);this.edge=(!(this.shape instanceof ORYX.Core.Edge))?this.shape.getIncomingShapes().first():undefined}if(this.currentReference&&this.position){if(this.shape instanceof ORYX.Core.Edge){if(!(this.currentReference instanceof ORYX.Core.Canvas)){this.shape.dockers.last().setDockedShape(this.currentReference);var h=this.currentReference.absoluteXY();var f={x:this.position.x-h.x,y:this.position.y-h.y};this.shape.dockers.last().setReferencePoint(this.currentReference.bounds.midPoint())}else{this.shape.dockers.last().bounds.centerMoveTo(this.position)}this.sourceRefPos=this.shape.dockers.first().referencePoint;this.targetRefPos=this.shape.dockers.last().referencePoint}else{if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint}}}else{var d=this.containedStencil;var a=this.connectedShape;var g=a.bounds;var c=this.shape.bounds;var l=g.center();if(d.defaultAlign()==="north"){l.y-=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(c.height()/2)}else{if(d.defaultAlign()==="northeast"){l.x+=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.width()/2);l.y-=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.height()/2)}else{if(d.defaultAlign()==="southeast"){l.x+=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.width()/2);l.y+=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.height()/2)}else{if(d.defaultAlign()==="south"){l.y+=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(c.height()/2)}else{if(d.defaultAlign()==="southwest"){l.x-=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.width()/2);l.y+=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.height()/2)}else{if(d.defaultAlign()==="west"){l.x-=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(c.width()/2)}else{if(d.defaultAlign()==="northwest"){l.x-=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.width()/2);l.y-=(g.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(c.height()/2)}else{l.x+=(g.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(c.width()/2)}}}}}}}this.shape.bounds.centerMoveTo(l);if(this.shape instanceof ORYX.Core.Node){(this.shape.dockers||[]).each(function(m){m.bounds.centerMoveTo(l)})}this.position=l;if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint}}this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();if(!e){if(this.edge){this.plugin.doLayout(this.edge)}else{if(this.shape instanceof ORYX.Core.Edge){this.plugin.doLayout(this.shape)}}}},rollback:function(){this.plugin.facade.deleteShape(this.shape);if(this.edge){this.plugin.facade.deleteShape(this.edge)}this.plugin.facade.setSelection(this.plugin.facade.getSelection().without(this.shape,this.edge))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SelectStencilSetPerspective={facade:undefined,extensions:undefined,perspectives:undefined,construct:function(d){this.facade=d;var a=new Ext.Panel({cls:"selectssperspective",border:false,autoWidth:true,autoScroll:true});var e=this.facade.addToRegion("west",a);var c=this.facade.getStencilSetExtensionDefinition();this.extensions={};c.extensions.each(function(f){this.extensions[f.namespace]=f}.bind(this));this.perspectives={};c.perspectives.each(function(f){this.perspectives[f.namespace]=f}.bind(this));this.facade.getStencilSets().values().each((function(g){var f=c.perspectives.findAll(function(h){if(h.stencilset==g.namespace()){return true}else{return false}});if(f.size()===1){this.loadPerspective(f.first().namespace)}else{if(f.size()>1){this.createPerspectivesCombobox(a,g,f)}}}).bind(this))},createPerspectivesCombobox:function(d,a,g){var h=ORYX.I18N.Language.split("_").first();var f=[];g.each(function(l){f.push([l.namespace,(l["title_"+h]||l.title).unescapeHTML(),l["description_"+h]||l.description])});var e=new Ext.data.SimpleStore({fields:["namespace","title","tooltip"],data:f});var c=new Ext.form.ComboBox({store:e,displayField:"title",valueField:"namespace",forceSelection:true,typeAhead:true,mode:"local",allowBlank:false,autoWidth:true,triggerAction:"all",emptyText:"Select a perspective...",selectOnFocus:true,tpl:'<tpl for="."><div ext:qtip="{tooltip}" class="x-combo-list-item">{[(values.title||"").escapeHTML()]}</div></tpl>'});d.add(c);d.doLayout();c.on("beforeselect",this.onSelect,this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){this.facade.getStencilSets().values().each(function(l){var m=l.extensions().values();if(m.length>0){var n=g.find(function(o){return(o.extensions&&o.extensions.include(m[0].namespace))||(o.addExtensions&&o.addExtensions.any(function(p){return;(p.ifIsLoaded===l.namespace()&&p.add==m[0].namespace)||(p.ifIsLoaded!==l.namespace()&&p["default"]===m[0].namespace)}))});if(!n){n=g.find(function(o){return !(o.extensions instanceof Array)||o.extensions.length<=0})}if(n){c.setValue(f[g.indexOf(n)][1]);throw $break}}c.setValue(f[0][1]);this.loadPerspective(f[0][0])}.bind(this))}.bind(this))},onSelect:function(c,a){if(c.getValue()===a.get("namespace")||c.getValue()===a.get("title")){return}this.loadPerspective(a.json[0])},loadPerspective:function(f){if(!f){this._loadExtensions([],[],true);return}var e=this.facade.getStencilSets();var d=new Object();var g=this.perspectives[f];e.values().each(function(l){l.extensions().values().each(function(m){if(this.extensions[m.namespace]){d[m.namespace]=m}}.bind(this))}.bind(this));var a=new Array();if(g.addExtensions||g.extensions){[].concat(this.perspectives[f].addExtensions||[]).concat(this.perspectives[f].extensions||[]).compact().each(function(l){if(!l.ifIsLoaded){a.push(this.extensions[l]);return}if(d[l.ifIsLoaded]&&this.extensions[l.add]){a.push(this.extensions[l.add])}else{if(l["default"]&&this.extensions[l["default"]]){a.push(this.extensions[l["default"]])}}}.bind(this))}if(this.perspectives[f].removeAllExtensions){window.setTimeout(function(){this._loadExtensions(a,undefined,true)}.bind(this),10);return}var h=new Array();if(g.removeExtensions){g.removeExtensions.each(function(l){if(d[l]){h.push(this.extensions[l])}}.bind(this))}if(g.extensions&&!g.addExtensions&&!g.removeExtensions){var c=[].concat(a).concat(h).compact();$H(d).each(function(m){var l=m.key;if(!m.value.includeAlways&&!c.any(function(n){return n.namespace==l})){h.push(this.extensions[l])}}.bind(this))}window.setTimeout(function(){this._loadExtensions(a,h,false)}.bind(this),10)},_loadExtensions:function(a,e,d){var f=this.facade.getStencilSets();var g=false;f.values().each(function(h){var l=h.extensions().values().select(function(m){return a[m.namespace]==undefined});if(d){l.each(function(m){h.removeExtension(m.namespace);g=true})}else{l.each(function(n){var m=e.find(function(o){return n.namespace===o.namespace});if(m){h.removeExtension(n.namespace);g=true}})}});a.each(function(l){var h=f[l["extends"]];if(h){if((l.definition||"").startsWith("/")){h.addExtension(l.definition)}else{h.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+l.definition)}g=true}}.bind(this));if(g){f.values().each(function(h){this.facade.getRules().initializeRules(h)}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});var c=this.facade.getSelection();this.facade.setSelection();this.facade.setSelection(c)}}};ORYX.Plugins.SelectStencilSetPerspective=Clazz.extend(ORYX.Plugins.SelectStencilSetPerspective);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeRepository={facade:undefined,construct:function(d){this.facade=d;this._currentParent;this._canContain=undefined;this._canAttach=undefined;this.shapeList=new Ext.tree.TreeNode({});var a=new Ext.tree.TreePanel({cls:"shaperepository",loader:new Ext.tree.TreeLoader(),root:this.shapeList,autoScroll:true,rootVisible:false,lines:false,anchors:"0, -30"});var e=this.facade.addToRegion("west",a,ORYX.I18N.ShapeRepository.title);var c=new Ext.dd.DragZone(this.shapeList.getUI().getEl(),{shadow:!Ext.isMac});c.afterDragDrop=this.drop.bind(this,c);c.beforeDragOver=this.beforeDragOver.bind(this,c);c.beforeDragEnter=function(){this._lastOverElement=false;return true}.bind(this);this.setStencilSets();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.setStencilSets.bind(this))},setStencilSets:function(){var a=this.shapeList.firstChild;while(a){this.shapeList.removeChild(a);a=this.shapeList.firstChild}this.facade.getStencilSets().values().each((function(e){var c;var g=e.title();var d=e.extensions();if(d&&d.size()>0){g+=" / "+ORYX.Core.StencilSet.getTranslation(d.values()[0],"title")}this.shapeList.appendChild(c=new Ext.tree.TreeNode({text:g,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRep",singleClickExpand:true}));c.render();c.expand();var f=e.stencils(this.facade.getCanvas().getStencil(),this.facade.getRules());var h=new Hash();f=f.sortBy(function(l){return l.position()});f.each((function(m){if(f.length<=ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP){this.createStencilTreeNode(c,m);return}var l=m.groups();l.each((function(n){if(!h[n]){h[n]=new Ext.tree.TreeNode({text:n,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRepChild",singleClickExpand:true});c.appendChild(h[n]);h[n].render()}this.createStencilTreeNode(h[n],m)}).bind(this));if(l.length==0){this.createStencilTreeNode(c,m)}}).bind(this))}).bind(this));if(this.shapeList.firstChild.firstChild){this.shapeList.firstChild.firstChild.expand(false,true)}},createStencilTreeNode:function(a,c){var e=new Ext.tree.TreeNode({text:c.title(),icon:c.icon(),allowDrag:false,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree"});a.appendChild(e);e.render();var d=e.getUI();d.elNode.setAttributeNS(null,"title",c.description());Ext.dd.Registry.register(d.elNode,{node:d.node,handles:[d.elNode,d.textNode].concat($A(d.elNode.childNodes)),isHandle:false,type:c.id(),namespace:c.namespace()})},drop:function(m,h,c){this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"});var l=m.getProxy();if(l.dropStatus==l.dropNotAllowed){return}if(!this._currentParent){return}var g=Ext.dd.Registry.getHandle(h.DDM.currentTarget);var q=c.getXY();var n={x:q[0],y:q[1]};var o=this.facade.getCanvas().node.getScreenCTM();n.x-=o.e;n.y-=o.f;n.x/=o.a;n.y/=o.d;n.x-=document.documentElement.scrollLeft;n.y-=document.documentElement.scrollTop;var p=this._currentParent.absoluteXY();n.x-=p.x;n.y-=p.y;g.position=n;if(this._canAttach&&this._currentParent instanceof ORYX.Core.Node){g.parent=undefined}else{g.parent=this._currentParent}var e=ORYX.Core.Command.extend({construct:function(t,r,u,a,s){this.option=t;this.currentParent=r;this.canAttach=u;this.position=a;this.facade=s;this.selection=this.facade.getSelection();this.shape;this.parent},execute:function(){if(!this.shape){this.shape=this.facade.createShape(g);this.parent=this.shape.parent}else{this.parent.add(this.shape)}if(this.canAttach&&this.currentParent instanceof ORYX.Core.Node&&this.shape.dockers.length>0){var a=this.shape.dockers[0];if(this.currentParent.parent instanceof ORYX.Core.Node){this.currentParent.parent.add(a.parent)}a.bounds.centerMoveTo(this.position);a.setDockedShape(this.currentParent)}this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.facade.deleteShape(this.shape);this.facade.setSelection(this.selection.without(this.shape));this.facade.getCanvas().update();this.facade.updateSelection()}});var f=this.facade.eventCoordinates(c.browserEvent);var d=new e(g,this._currentParent,this._canAttach,f,this.facade);this.facade.executeCommands([d]);this._currentParent=undefined},beforeDragOver:function(l,g,c){var f=this.facade.eventCoordinates(c.browserEvent);var o=this.facade.getCanvas().getAbstractShapesAtPosition(f);if(o.length<=0){var a=l.getProxy();a.setStatus(a.dropNotAllowed);a.sync();return false}var d=o.last();if(o.lenght==1&&o[0] instanceof ORYX.Core.Canvas){return false}else{var e=Ext.dd.Registry.getHandle(g.DDM.currentTarget);var m=this.facade.getStencilSets()[e.namespace];var n=m.stencil(e.type);if(n.type()==="node"){var h=o.reverse().find(function(p){return(p instanceof ORYX.Core.Canvas||p instanceof ORYX.Core.Node||p instanceof ORYX.Core.Edge)});if(h!==this._lastOverElement){this._canAttach=undefined;this._canContain=undefined}if(h){if(!(h instanceof ORYX.Core.Canvas)&&h.isPointOverOffset(f.x,f.y)&&this._canAttach==undefined){this._canAttach=this.facade.getRules().canConnect({sourceShape:h,edgeStencil:n,targetStencil:n});if(this._canAttach){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.attached",elements:[h],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this._canContain=undefined}}if(!(h instanceof ORYX.Core.Canvas)&&!h.isPointOverOffset(f.x,f.y)){this._canAttach=this._canAttach==false?this._canAttach:undefined}if(this._canContain==undefined&&!this._canAttach){this._canContain=this.facade.getRules().canContain({containingShape:h,containedStencil:n});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.added",elements:[h],color:this._canContain?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"})}this._currentParent=this._canContain||this._canAttach?h:undefined;this._lastOverElement=h;var a=l.getProxy();a.setStatus(this._currentParent?a.dropAllowed:a.dropNotAllowed);a.sync()}}else{this._currentParent=this.facade.getCanvas();var a=l.getProxy();a.setStatus(a.dropAllowed);a.sync()}}return false}};ORYX.Plugins.ShapeRepository=Clazz.extend(ORYX.Plugins.ShapeRepository);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.PropertyWindow={facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW,this.init.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.selectDiagram.bind(this));this.init()},init:function(){this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);this.currentDateFormat;this.popularProperties=[];this.properties=[];this.shapeSelection=new Hash();this.shapeSelection.shapes=[];this.shapeSelection.commonProperties=[];this.shapeSelection.commonPropertiesValues=new Hash();this.suppressedProperties=new Hash();this.updaterFlag=false;var a=this.facade.getModelMetaData();var d=(a.languages||[]).sort(function(f,g){return f.position-g.position}).pluck("rel");this.defaultLanguage=d.first();this.languages=d;this.dataSource=new Ext.data.GroupingStore({proxy:new Ext.data.MemoryProxy(this.properties),reader:new Ext.data.ArrayReader({},[{name:"popular"},{name:"name"},{name:"value"},{name:"icons"},{name:"gridProperties"}]),sortInfo:{field:"popular",direction:"ASC"},sortData:function(l,m){m=m||"ASC";var g=this.fields.get(l).sortType;var h=function(n,f){var r=g(n.data[l]),q=g(f.data[l]);var p=n.data.popular,o=f.data.popular;return p<o?-1:(p>o?1:(r>q?1:(r<q?-1:0)))};this.data.sort(m,h);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(m,h)}},groupField:"popular"});this.dataSource.load();var e=this.dataSource;var c=this;this.columnModel=new Ext.grid.ColumnModel({columns:[{header:ORYX.I18N.PropertyWindow.name,dataIndex:"name",width:90,sortable:true,renderer:this.tooltipRenderer.bind(this)},{header:ORYX.I18N.PropertyWindow.value,dataIndex:"value",id:"propertywindow_column_value",width:110,editor:new Ext.form.TextField({allowBlank:false}),renderer:this.renderer.bind(this)},{header:"Pop",dataIndex:"popular",hidden:true,sortable:true}],isCellEditable:function(g,h){var f=e.getAt(h);if(c.suppressedProperties[f.data.gridProperties.propId]){return false}return Ext.grid.ColumnModel.prototype.isCellEditable.call(this,g,h)}});this.grid=new Ext.grid.EditorGridPanel({clicksToEdit:1,stripeRows:true,autoExpandColumn:"propertywindow_column_value",width:"auto",colModel:this.columnModel,enableHdMenu:false,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{[values.rs.first().data.popular == 1 ? ORYX.I18N.PropertyWindow.oftenUsed : values.rs.first().data.popular == 2 ? "Configuration attributes" : ORYX.I18N.PropertyWindow.moreProps]}'}),store:this.dataSource});region=this.facade.addToRegion("east",new Ext.Panel({width:220,layout:"fit",border:false,title:"Properties",items:[this.grid]}),ORYX.I18N.PropertyWindow.title);this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.view.on("refresh",this.hideMoreAttrs,this,true);this.grid.enableColumnMove=false},reduceLanguage:function(a){return a},getActiveLanguage:function(){return this.facade.getCanvas().getLanguage()},getAllLanguages:function(){return[].concat(this.getActiveLanguage(),this.languages).uniq()},selectDiagram:function(){this.shapeSelection.shapes=[this.facade.getCanvas()];this.setPropertyWindowTitle();this.identifyCommonProperties();this.createProperties()},specialKeyDown:function(c,a){if(c instanceof Ext.form.TextArea&&a.button==ORYX.CONFIG.KEY_Code_enter){return false}},tooltipRenderer:function(c,d,a){d.cellAttr='title="'+a.data.gridProperties.tooltip+'"';return this.suppressedProperties[a.data.gridProperties.propId]?('<div style="opacity: 0.5">'+c+"</div>"):c},renderer:function(g,h,a){h.cellAttr='title="'+a.data.gridProperties.tooltip+'"';if(g instanceof Date){g=g.dateFormat(ORYX.I18N.PropertyWindow.dateFormat)}else{if(String(g).search("<a href='")<0){g=String(g).gsub("<","&lt;");g=String(g).gsub(">","&gt;");g=String(g).gsub("%","&#37;");g=String(g).gsub("&","&amp;");if(a.data.gridProperties.type==ORYX.CONFIG.TYPE_COLOR){g="<div class='prop-background-color' style='background-color:"+g+"' />"}else{if(a.data.gridProperties.type==ORYX.CONFIG.TYPE_COMPLEX){try{var e="";var d=g.evalJSON();for(var c=0;c<d.totalCount;c++){if(c>0){e+=", "}e+=d.items[c].id}g=e}catch(f){}}}a.data.icons.each(function(l){if(l.name==g){if(l.icon){g="<img src='"+l.icon+"' /> "+g}}})}}return this.suppressedProperties[a.data.gridProperties.propId]?('<div style="opacity: 0.5">'+g+"</div>"):g},beforeEdit:function(d){var e=this.dataSource.getAt(d.row).data.gridProperties.editor;var a=this.dataSource.getAt(d.row).data.gridProperties.renderer;if(e){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);d.grid.getColumnModel().setEditor(1,e);e.field.row=d.row;e.render(this.grid);e.setSize(d.grid.getColumnModel().getColumnWidth(1),e.height)}else{return false}var c=this.dataSource.getAt(d.row).data.gridProperties.propId;this.oldValues=new Hash();this.shapeSelection.shapes.each(function(f){this.oldValues[f.getId()]=f.properties[c]}.bind(this))},afterEdit:function(g){g.grid.getStore().commitChanges();var h=g.record.data.gridProperties.propId;var d=this.shapeSelection.shapes;var l=this.oldValues;var a=g.value;var n=this.facade;var e=function(o){return(!o)||(o=="")};var m=function(o,q,p,u){if(q.key!="oryx-variants"){return}if(o.getStencil().type()=="edge"){return}if(e(p)){if(!e(u)){q.configurationAnnotationShape=n.createShape({type:"http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation",position:{x:o.bounds.upperLeft().x-50,y:o.bounds.upperLeft().y-40},namespace:o.getStencil().namespace(),parent:o.getParentShape()});q.configurationAnnotationAssociation=n.createShape({type:"http://b3mn.org/stencilset/bpmn2.0#Association_Undirected",position:{x:o.bounds.upperLeft().x,y:o.bounds.upperLeft().y+100},namespace:o.getStencil().namespace(),parent:o.getParentShape()});var s=q.configurationAnnotationAssociation.getDockers()[0];s.setDockedShape(o);s.setReferencePoint({x:o.bounds.width()/2,y:o.bounds.height()/2});var t=q.configurationAnnotationAssociation.getDockers()[1];t.setDockedShape(q.configurationAnnotationShape);t.setReferencePoint({x:q.configurationAnnotationShape.bounds.width()/2,y:q.configurationAnnotationShape.bounds.height()/2})}}else{if(e(u)){var r=function(v){o[v]().each(function(w){if(w.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Association_Undirected"){w[v]().each(function(x){if(x.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation"){q.configurationAnnotationShape=x;q.configurationAnnotationAssociation=w}})}})};r("getIncomingShapes");r("getOutgoingShapes");q.facade.deleteShape(q.configurationAnnotationAssociation);q.facade.deleteShape(q.configurationAnnotationShape)}}};var f=ORYX.Core.Command.extend({construct:function(){this.key=h;this.selectedElements=d;this.oldValues=l;this.newValue=a;this.facade=n},execute:function(){this.selectedElements.each(function(o){if(!o.getStencil().property(this.key).readonly()){o.setProperty(this.key,this.newValue);m(o,this,this.oldValues[o.getId()],this.newValue)}}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.selectedElements.each(function(o){o.setProperty(this.key,this.oldValues[o.getId()]);m(o,this,this.newValue,this.oldValues[o.getId()])}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection()}});var c=new f();this.facade.executeCommands([c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:d,key:h,value:g.value})},editDirectly:function(a,c){this.shapeSelection.shapes.each(function(e){if(!e.getStencil().property(a).readonly()){e.setProperty(a,c)}}.bind(this));var d=this.shapeSelection.shapes;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:d,key:a,value:c});this.facade.getCanvas().update()},updateAfterInvalid:function(a){this.shapeSelection.shapes.each(function(c){if(!c.getStencil().property(a).readonly()){c.setProperty(a,this.oldValues[c.getId()]);c.update()}}.bind(this));this.facade.getCanvas().update()},dialogClosed:function(a){var c=this.field?this.field.row:this.row;this.scope.afterEdit({grid:this.scope.grid,record:this.scope.grid.getStore().getAt(c),value:a});this.scope.grid.startEditing(c,this.col)},setPropertyWindowTitle:function(){if(this.shapeSelection.shapes.length==1){region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.first().getStencil().title()+")")}else{region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.length+" "+ORYX.I18N.PropertyWindow.selected+")")}},setCommonPropertiesValues:function(){this.shapeSelection.commonPropertiesValues=new Hash();this.shapeSelection.commonProperties.each(function(e){var d=e.prefix()+"-"+e.id();var c=false;var a=this.shapeSelection.shapes.first();this.shapeSelection.shapes.each(function(f){if(a.properties[d]!=f.properties[d]){c=true}}.bind(this));if(!c){this.shapeSelection.commonPropertiesValues[d]=a.properties[d]}}.bind(this))},getStencilSetOfSelection:function(){var a=new Hash();this.shapeSelection.shapes.each(function(c){a[c.getStencil().id()]=c.getStencil()});return a},identifyCommonProperties:function(){this.shapeSelection.commonProperties.clear();var e=this.getStencilSetOfSelection();var g=e.values().first();var c=e.values().without(g);if(c.length==0){this.shapeSelection.commonProperties=this.reorder(g.properties())}else{var f=new Hash();var a=new Hash();g.properties().each(function(d){if(d.alwaysAppearInMultiselect()){a[d.namespace()+"-"+d.id()+"-"+d.type()]=d}else{f[d.namespace()+"-"+d.id()+"-"+d.type()]=d}});c.each(function(h){var d=new Hash();h.properties().each(function(l){if(l.alwaysAppearInMultiselect()){a[l.namespace()+"-"+l.id()+"-"+l.type()]=l}else{if(f[l.namespace()+"-"+l.id()+"-"+l.type()]){d[l.namespace()+"-"+l.id()+"-"+l.type()]=l}}});f=d});a.each(function(d){f[d.key]=d.value});this.shapeSelection.commonProperties=this.reorder(f.values());if(this.shapeSelection.shapes.length>1){this.shapeSelection.commonProperties=this.shapeSelection.commonProperties.findAll(function(d){return d.type()!==ORYX.CONFIG.TYPE_DIAGRAM_LINK})}}},isTranslation:function(c){var a=false;var d=c.id();this.languages.each(function(e){if(d.endsWith("_"+e)){a=true;throw $break}});return a},isTranslatable:(function(){var a=[ORYX.CONFIG.TYPE_TEXT,ORYX.CONFIG.TYPE_STRING,ORYX.CONFIG.TYPE_COMPLEX];return function(c){return a.include(c.type())}}()),addTranslations:function(d,a,c){var e=d.id();this.languages.each(function(f){a.each(function(g){if(g.id()===e+"_"+f){c.push(g)}})})},reorder:function(a){var c=[];a.each(function(d){if(this.isTranslation(d)){return}c.push(d);if(this.isTranslatable(d)){this.addTranslations(d,a,c)}}.bind(this));return c},onSelectionChanged:function(a){this.grid.stopEditing();this.shapeSelection.shapes=a.elements;if(a.elements.length==0){this.shapeSelection.shapes=[this.facade.getCanvas()]}if(a.subSelection){this.shapeSelection.shapes=[a.subSelection]}this.setPropertyWindowTitle();this.identifyCommonProperties();this.setCommonPropertiesValues();this.createProperties()},createProperties:function(){this.properties=[];this.popularProperties=[];if(this.shapeSelection.commonProperties){this.shapeSelection.commonProperties.each((function(r,h){var x=r.prefix()+"-"+r.id();var y=r.title();var u=[];var n=this.shapeSelection.commonPropertiesValues[x];var a=undefined;var c=null;var m=false;if(!r.readonly()){switch(r.type()){case ORYX.CONFIG.TYPE_STRING:if(r.wrapLines()){var f=new Ext.form.TextArea({alignment:"tl-tl",allowBlank:r.optional(),msgTarget:"title",maxLength:r.length()});f.on("keyup",function(A,z){this.editDirectly(x,A.getValue())}.bind(this));a=new Ext.Editor(f)}else{var l=new Ext.form.TextField({allowBlank:r.optional(),msgTarget:"title",maxLength:r.length()});l.on("keyup",function(z,A){this.editDirectly(x,z.getValue())}.bind(this));l.on("blur",function(z){if(!z.isValid(false)){this.updateAfterInvalid(x)}}.bind(this));l.on("specialkey",function(z,A){if(!z.isValid(false)){this.updateAfterInvalid(x)}}.bind(this));a=new Ext.Editor(l)}break;case ORYX.CONFIG.TYPE_BOOLEAN:var v=new Ext.form.Checkbox();v.on("check",function(A,z){this.editDirectly(x,z)}.bind(this));a=new Ext.Editor(v);break;case ORYX.CONFIG.TYPE_INTEGER:var d=new Ext.form.NumberField({allowBlank:r.optional(),allowDecimals:false,msgTarget:"title",minValue:r.min(),maxValue:r.max()});d.on("keyup",function(z,A){this.editDirectly(x,z.getValue())}.bind(this));a=new Ext.Editor(d);break;case ORYX.CONFIG.TYPE_FLOAT:var d=new Ext.form.NumberField({allowBlank:r.optional(),allowDecimals:true,msgTarget:"title",minValue:r.min(),maxValue:r.max()});d.on("keyup",function(z,A){this.editDirectly(x,z.getValue())}.bind(this));a=new Ext.Editor(d);break;case ORYX.CONFIG.TYPE_COLOR:var t=new Ext.ux.ColorField({allowBlank:r.optional(),msgTarget:"title",facade:this.facade});a=new Ext.Editor(t);break;case ORYX.CONFIG.TYPE_CHOICE:var q=r.items();var e=[];q.each(function(z){if(z.value()==n){n=z.title()}if(z.refToView()[0]){m=true}e.push([z.icon(),z.title(),z.value()]);u.push({name:z.title(),icon:z.icon()})});var g=new Ext.data.SimpleStore({fields:[{name:"icon"},{name:"title"},{name:"value"}],data:e});var s=new Ext.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item">{[(values.icon) ? "<img src=\'" + values.icon + "\' />" : ""]} {title}</div></tpl>',store:g,displayField:"title",valueField:"value",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true});s.on("select",function(B,z,A){this.editDirectly(x,B.getValue())}.bind(this));a=new Ext.Editor(s);break;case ORYX.CONFIG.TYPE_DATE:var p=ORYX.I18N.PropertyWindow.dateFormat;if(!(n instanceof Date)){n=Date.parseDate(n,p)}a=new Ext.Editor(new Ext.form.DateField({allowBlank:r.optional(),format:p,msgTarget:"title"}));break;case ORYX.CONFIG.TYPE_TEXT:var o=new Ext.form.ComplexTextField({allowBlank:r.optional(),dataSource:this.dataSource,grid:this.grid,row:h,facade:this.facade});o.on("dialogClosed",this.dialogClosed,{scope:this,row:h,col:1,field:o});a=new Ext.Editor(o);break;case ORYX.CONFIG.TYPE_COMPLEX:var w=r._jsonProp.editortitle?r._jsonProp.editortitle:ORYX.I18N.PropertyWindow.complex;var o=new Ext.form.ComplexListField({allowBlank:r.optional()},r.complexItems(),x,this.facade,w);o.on("dialogClosed",this.dialogClosed,{scope:this,row:h,col:1,field:o});a=new Ext.Editor(o);break;case"CPNString":var l=new Ext.form.TextField({allowBlank:r.optional(),msgTarget:"title",maxLength:r.length(),enableKeyEvents:true});l.on("keyup",function(z,A){this.editDirectly(x,z.getValue())}.bind(this));a=new Ext.Editor(l);break;default:var l=new Ext.form.TextField({allowBlank:r.optional(),msgTarget:"title",maxLength:r.length(),enableKeyEvents:true});l.on("keyup",function(z,A){this.editDirectly(x,z.getValue())}.bind(this));a=new Ext.Editor(l)}a.on("beforehide",this.facade.enableEvent.bind(this,ORYX.CONFIG.EVENT_KEYDOWN));a.on("specialkey",this.specialKeyDown.bind(this))}else{if(r.type()===ORYX.CONFIG.TYPE_URL||r.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){n=String(n).search("http")!==0?("http://"+n):n;n="<a href='"+n+"' target='_blank'>"+n.split("://")[1]+"</a>"}}if(r.visible()){if(r.refToView()[0]||m||r.popular()==1){r.setPopular()}if(r.popular()){this.popularProperties.push([r.popular(),y,n,u,{editor:a,propId:x,type:r.type(),tooltip:r.description(),renderer:c}])}else{this.properties.push([r.popular(),y,n,u,{editor:a,propId:x,type:r.type(),tooltip:r.description(),renderer:c}])}}}).bind(this))}this.setProperties()},hideMoreAttrs:function(a){if(this.properties.length<=0){return}this.grid.view.toggleGroup(this.grid.view.getGroupId(this.properties[0][0]),false);this.grid.view.un("refresh",this.hideMoreAttrs,this)},setProperties:function(){var a=this.popularProperties.concat(this.properties);this.dataSource.loadData(a)}};ORYX.Plugins.PropertyWindow=Clazz.extend(ORYX.Plugins.PropertyWindow);Ext.form.ComplexListField=function(c,a,d,e,f){Ext.form.ComplexListField.superclass.constructor.call(this,c);this.items=a;this.key=d;this.facade=e;this.title=f};Ext.extend(Ext.form.ComplexListField,Ext.form.TriggerField,{triggerClass:"x-form-complex-trigger",readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,buildValue:function(){var g=this.grid.getStore();g.commitChanges();if(g.getCount()==0){return""}var e="[";for(var d=0;d<g.getCount();d++){var f=g.getAt(d);e+="{";for(var a=0;a<this.items.length;a++){var c=this.items[a].id();e+=c+":"+(""+f.get(c)).toJSON();if(a<(this.items.length-1)){e+=", "}}e+="}";if(d<(g.getCount()-1)){e+=", "}}e+="]";e="{'totalCount':"+g.getCount().toJSON()+", 'items':"+e+"}";return Object.toJSON(e.evalJSON())},getFieldKey:function(){return this.key},getValue:function(){if(this.grid){return this.buildValue()}else{if(this.data==undefined){return""}else{return this.data}}},setValue:function(a){if(a.length>0){if(this.data==undefined){this.data=a}}},keydownHandler:function(a){return false},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return},hide:function(){var a=this.dialogListeners;this.dialog.un("show",a.show,this);this.dialog.un("hide",a.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent("dialogClosed",this.data);Ext.form.ComplexListField.superclass.setValue.call(this,this.data)}},buildInitial:function(g,a){var c=new Hash();for(var d=0;d<a.length;d++){var f=a[d].id();c[f]=a[d].value()}var e=Ext.data.Record.create(g);return new e(c)},buildColumnModel:function(o){var l=[];for(var d=0;d<this.items.length;d++){var a=this.items[d].id();var e=this.items[d].name();var c=this.items[d].width();var h=this.items[d].type();var f;if(h==ORYX.CONFIG.TYPE_STRING){f=new Ext.form.TextField({allowBlank:this.items[d].optional(),width:c})}else{if(h==ORYX.CONFIG.TYPE_CHOICE){var g=this.items[d].items();var n=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",o,["select",{style:"display:none"}]);var m=new Ext.Template('<option value="{value}">{value}</option>');g.each(function(p){m.append(n,{value:p.value()})});f=new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",transform:n,lazyRender:true,msgTarget:"title",width:c})}else{if(h==ORYX.CONFIG.TYPE_BOOLEAN){f=new Ext.form.Checkbox({width:c})}}}l.push({id:a,header:e,dataIndex:a,resizable:true,editor:f,width:c})}return new Ext.grid.ColumnModel(l)},afterEdit:function(a){a.grid.getStore().commitChanges()},beforeEdit:function(l){var a=this.grid.getView().getScrollState();var c=l.column;var q=l.row;var f=this.grid.getColumnModel().config[c].id;for(var h=0;h<this.items.length;h++){var p=this.items[h];var n=p.disable();if(n!=undefined){var o=this.grid.getStore().getAt(q).get(p.id());for(var e=0;e<n.length;e++){var g=n[e];if(g.value==o){for(var d=0;d<g.items.length;d++){var m=g.items[d];if(m==f){this.grid.getColumnModel().getCellEditor(c,q).disable();return}}}}}}this.grid.getColumnModel().getCellEditor(c,q).enable()},onTriggerClick:function(){if(this.disabled){return}var dialogWidth=0;var recordType=[];for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var width=this.items[i].width();var type=this.items[i].type();if(type==ORYX.CONFIG.TYPE_CHOICE){type=ORYX.CONFIG.TYPE_STRING}dialogWidth+=width;recordType[i]={name:id,type:type}}if(dialogWidth>800){dialogWidth=800}dialogWidth+=22;var data=this.data;if(data==""){data="{}"}var ds=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:"items",totalProperty:"totalCount"},recordType)});ds.load();var cm=this.buildColumnModel();var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,icon:"../explorer/src/img/famfamfam/add.png",iconCls:"x-dummy",handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial(recordType,this.items);ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0)}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,icon:"../explorer/src/img/famfamfam/delete.png",iconCls:"x-dummy",handler:function(){var ds=this.grid.getStore();var selection=this.grid.getSelectionModel().getSelectedCell();if(selection==undefined){return}this.grid.getSelectionModel().clearSelections();this.grid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges()}.bind(this)}]);this.grid=new Ext.grid.EditorGridPanel({store:ds,cm:cm,stripeRows:true,clicksToEdit:1,autoScroll:true,stateId:"x-editor-complex-grid",anchor:"100% 100%",enableHdMenu:false,selModel:new Ext.grid.CellSelectionModel(),tbar:toolbar});this.dialog=new Ext.Window({autoCreate:true,layout:"anchor",title:this.title,height:350,width:dialogWidth,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();this.data=this.buildValue();this.dialog.hide()}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.hide()}.bind(this)}]});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.render()}});Ext.form.ComplexTextField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},onTriggerClick:function(){if(this.disabled){return}var c=new Ext.form.TextArea({anchor:"100% 100%",value:this.value,listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}.bind(this)}});var a=new Ext.Window({layout:"anchor",autoCreate:true,title:ORYX.I18N.PropertyWindow.text,height:500,width:500,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){a.hide()}.bind(this)}],items:[c],listeners:{hide:function(){this.fireEvent("dialogClosed",this.value);a.destroy()}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var d=c.getValue();this.setValue(d);this.dataSource.getAt(this.row).set("value",d);this.dataSource.commitChanges();a.hide()}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);a.hide()}.bind(this)}]});a.show();c.render();this.grid.stopEditing();c.focus(false,100)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Loading={construct:function(a){this.facade=a;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer().parentNode,["div",{"class":"LoadingIndicator"},""]);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,this.enableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,this.disableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,this.showStatus.bind(this));this.disableLoading()},enableLoading:function(a){if(a.text){this.node.innerHTML=a.text+"..."}else{this.node.innerHTML=ORYX.I18N.Loading.waiting}this.node.removeClassName("StatusIndicator");this.node.addClassName("LoadingIndicator");this.node.style.display="block";var c=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=c.offsetTop+"px";this.node.style.left=c.offsetLeft+"px"},disableLoading:function(){this.node.style.display="none"},showStatus:function(a){if(a.text){this.node.innerHTML=a.text;this.node.addClassName("StatusIndicator");this.node.removeClassName("LoadingIndicator");this.node.style.display="block";var d=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=d.offsetTop+"px";this.node.style.left=d.offsetLeft+"px";var c=a.timeout?a.timeout:2000;window.setTimeout((function(){this.disableLoading()}).bind(this),c)}}};ORYX.Plugins.Loading=Clazz.extend(ORYX.Plugins.Loading);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.CanvasResize=Clazz.extend({construct:function(a){this.facade=a;new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"N",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"W",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"E",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"S",this.resize.bind(this))},resize:function(a,d){resizeCanvas=function(n,o,q){var g=q.getCanvas();var p=g.bounds;var l=q.getCanvas().getHTMLContainer().parentNode.parentNode;if(n=="E"||n=="W"){g.setSize({width:(p.width()+o)*g.zoomLevel,height:(p.height())*g.zoomLevel})}else{if(n=="S"||n=="N"){g.setSize({width:(p.width())*g.zoomLevel,height:(p.height()+o)*g.zoomLevel})}}if(n=="N"||n=="W"){var h=n=="N"?{x:0,y:o}:{x:o,y:0};g.getChildNodes(false,function(s){s.bounds.moveBy(h)});var m=g.getChildEdges().findAll(function(s){return s.getAllDockedShapes().length>0});var r=m.collect(function(s){return s.dockers.findAll(function(t){return !t.getDockedShape()})}).flatten();r.each(function(s){s.bounds.moveBy(h)})}else{if(n=="S"){l.scrollTop+=o}else{if(n=="E"){l.scrollLeft+=o}}}g.update();q.updateSelection()};var c=ORYX.Core.Command.extend({construct:function(g,l,h){this.position=g;this.extentionSize=l;this.facade=h},execute:function(){resizeCanvas(this.position,this.extentionSize,this.facade)},rollback:function(){resizeCanvas(this.position,-this.extentionSize,this.facade)},update:function(){}});var e=ORYX.CONFIG.CANVAS_RESIZE_INTERVAL;if(d){e=-e}var f=new c(a,e,this.facade);this.facade.executeCommands([f])}});ORYX.Plugins.CanvasResizeButton=Clazz.extend({construct:function(d,l,p){this.canvas=d;var m=d.getHTMLContainer().parentNode.parentNode.parentNode;window.myParent=m;var e=m.firstChild;var c=e.firstChild.firstChild;var a=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",m,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_grow "+l,title:ORYX.I18N.RESIZE.tipGrow+ORYX.I18N.RESIZE[l]}]);var f=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",m,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_shrink "+l,title:ORYX.I18N.RESIZE.tipShrink+ORYX.I18N.RESIZE[l]}]);var g=60;var o=function(r){if(r.target!=m&&r.target!=e&&r.target!=e.firstChild&&r.target!=c&&r.target!=e){return false}var u=r.layerX!==undefined?r.layerX:r.offsetX;var t=r.layerY!==undefined?r.layerY:r.offsetY;if((u-e.scrollLeft)<0||Ext.isSafari){u+=e.scrollLeft}if((t-e.scrollTop)<0||Ext.isSafari){t+=e.scrollTop}if(l=="N"){return t<g+e.firstChild.offsetTop}else{if(l=="W"){return u<g+e.firstChild.offsetLeft}else{if(l=="E"){var q=(e.offsetWidth-(e.firstChild.offsetLeft+e.firstChild.offsetWidth));if(q<0){q=0}return u>e.scrollWidth-q-g}else{if(l=="S"){var s=(e.offsetHeight-(e.firstChild.offsetTop+e.firstChild.offsetHeight));if(s<0){s=0}return t>e.scrollHeight-s-g}}}}return false};var n=(function(){a.show();var r,y,q,x;try{var v=this.canvas.getRootNode().childNodes[1].getBBox();r=v.x;y=v.y;q=v.x+v.width;x=v.y+v.height}catch(u){this.canvas.getChildShapes(true).each(function(A){var C=A.absoluteBounds();var B=C.upperLeft();var w=C.lowerRight();if(r==undefined){r=B.x;y=B.y;q=w.x;x=w.y}else{r=Math.min(r,B.x);y=Math.min(y,B.y);q=Math.max(q,w.x);x=Math.max(x,w.y)}})}var z=d.bounds.width();var t=d.bounds.height();var s=d.getChildNodes().size()==0;if(l=="N"&&(y>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(s&&t>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){f.show()}else{if(l=="E"&&(z-q)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){f.show()}else{if(l=="S"&&(t-x)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){f.show()}else{if(l=="W"&&(r>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(s&&z>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){f.show()}else{f.hide()}}}}}).bind(this);var h=function(){a.hide();f.hide()};e.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,function(q){if(o(q)){n()}else{h()}},false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(q){n()},true);f.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(q){n()},true);m.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,function(q){h()},true);h();a.addEventListener("click",function(){p(l);n()},true);f.addEventListener("click",function(){p(l,true);n()},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.RenameShapes=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,this.actOnDBLClick.bind(this));this.facade.offer({keyCodes:[{keyCode:113,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.renamePerF2.bind(this)});document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.hide.bind(this),true)},renamePerF2:function(){var a=this.facade.getSelection();this.actOnDBLClick(undefined,a.first())},actOnDBLClick:function(q,m){if(!(m instanceof ORYX.Core.Shape)){return}this.destroy();var n=m.getStencil().properties().findAll(function(t){return(t.refToView()&&t.refToView().length>0&&t.directlyEditable())});n=n.findAll(function(t){return !t.readonly()&&t.type()==ORYX.CONFIG.TYPE_STRING});var o=n.collect(function(t){return t.refToView()}).flatten().compact();var g=m.getLabels().findAll(function(t){return o.any(function(u){return t.id.endsWith(u)})});if(g.length==0){return}var l=g.length<=1?g[0]:null;if(!l){l=g.find(function(t){return t.node==q.target||t.node==q.target.parentNode});if(!l){var r=this.facade.eventCoordinates(q);var s=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();r.x*=s.a;r.y*=s.d;var p=g.collect(function(v){var u=this.getCenterPosition(v.node);var t=Math.sqrt(Math.pow(u.x-r.x,2)+Math.pow(u.y-r.y,2));return{diff:t,label:v}}.bind(this));p.sort(function(u,t){return u.diff>t.diff});l=p[0].label}}var d=n.find(function(t){return t.refToView().any(function(u){return l.id==m.id+u})});var h=this.facade.getCanvas().getHTMLContainer().id;var e=Math.min(Math.max(100,m.bounds.width()),200);var a=this.getCenterPosition(l.node);a.x-=(e/2);var c=d.prefix()+"-"+d.id();var f={renderTo:h,value:m.properties[c],x:(a.x<10)?10:a.x,y:a.y,width:e,style:"position:absolute",allowBlank:d.optional(),maxLength:d.length(),emptyText:d.title(),cls:"x_form_text_set_absolute"};if(d.wrapLines()){f.y-=(60/2);f.grow=true;this.shownTextField=new Ext.form.TextArea(f)}else{f.y-=(20/2);this.shownTextField=new Ext.form.TextField(f)}this.shownTextField.focus();this.shownTextField.on("blur",this.destroy.bind(this));this.shownTextField.on("change",function(x,y){var w=m;var u=w.properties[c];var z=y;var v=this.facade;if(u!=z){var t=ORYX.Core.Command.extend({construct:function(){this.el=w;this.propId=c;this.oldValue=u;this.newValue=z;this.facade=v},execute:function(){this.el.setProperty(this.propId,this.newValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.el.setProperty(this.propId,this.oldValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection()}});var A=new t();this.facade.executeCommands([A])}}.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN)},getCenterPosition:function(h){if(!h){return{x:0,y:0}}var c={x:0,y:0};var n,g,d,a;var m=false;try{if(("hidden"===h.getAttributeNS(null,"visibility")&&h.childNodes.length>0)||h.childNodes.length===0){m=true}var f=m?h.parentNode:h;n=f.getTransformToElement(this.facade.getCanvas().rootNode.lastChild);g=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();d=f.getTransformToElement(f.parentNode)}catch(l){return{x:0,y:0}}c.x=n.e-d.e;c.y=n.f-d.f;try{a=h.getBBox();if(!m&&!(a.x<-1000)){a.y-=1}else{a={x:Number(h.getAttribute("x")),y:Number(h.getAttribute("y")),width:0,height:0}}}catch(l){a={x:Number(h.getAttribute("x")),y:Number(h.getAttribute("y")),width:0,height:0}}c.x+=a.x;c.y+=a.y;c.x+=a.width/2;c.y+=a.height/2;c.x*=g.a;c.y*=g.d;return c},hide:function(a){if(this.shownTextField&&(!a||!this.shownTextField.el||a.target!==this.shownTextField.el.dom)){this.shownTextField.onBlur()}},destroy:function(a){if(this.shownTextField){this.shownTextField.destroy();delete this.shownTextField;this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Undo=Clazz.extend({facade:undefined,undoStack:[],redoStack:[],construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Undo.undo,description:ORYX.I18N.Undo.undoDesc,icon:ORYX.PATH+"images/arrow_undo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:90,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doUndo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.undoStack.length>0}.bind(this),index:0});this.facade.offer({name:ORYX.I18N.Undo.redo,description:ORYX.I18N.Undo.redoDesc,icon:ORYX.PATH+"images/arrow_redo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:89,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doRedo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.redoStack.length>0}.bind(this),index:1});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,this.handleExecuteCommands.bind(this))},handleExecuteCommands:function(a){if(!a.commands){return}this.undoStack.push(a.commands);this.redoStack=[];this.facade.getCanvas().update();this.facade.updateSelection()},doUndo:function(){var a=this.undoStack.pop();if(a){this.redoStack.push(a);for(var c=a.length-1;c>=0;--c){a[c].rollback()}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_ROLLBACK,commands:a});this.facade.getCanvas().update();this.facade.updateSelection()}},doRedo:function(){var a=this.redoStack.pop();if(a){this.undoStack.push(a);a.each(function(c){c.execute()});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_EXECUTE,commands:a});this.facade.getCanvas().update();this.facade.updateSelection()}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ProcessLink=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this))},propertyChanged:function(a,c){if(a.name!=="oryx-refuri"||!c instanceof ORYX.Core.Node){return}if(a.value&&a.value.length>0&&a.value!="undefined"){this.show(c,a.value)}else{this.hide(c)}},show:function(a,c){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["a",{target:"_blank"},["path",{"stroke-width":1,stroke:"#00DD00",fill:"#00AA00",d:"M3,3 l0,-2.5 l7.5,0 l0,-2.5 l7.5,4.5 l-7.5,3.5 l0,-2.5 l-8,0","line-captions":"round"}]]);var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["a",{target:"_blank"},["path",{style:"fill:#92BFFC;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72",d:"M0 1.44 L0 15.05 L11.91 15.05 L11.91 5.98 L7.37 1.44 L0 1.44 Z"}],["path",{style:"stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72;fill:none;",transform:"translate(7.5, -8.5)",d:"M0 10.51 L0 15.05 L4.54 15.05"}],["path",{style:"fill:#f28226;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72",transform:"translate(-3, -1)",d:"M0 8.81 L0 13.06 L5.95 13.06 L5.95 15.05 A50.2313 50.2313 -175.57 0 0 10.77 11.08 A49.9128 49.9128 -1.28 0 0 5.95 6.54 L5.95 8.81 L0 8.81 Z"}],]);d.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",c);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"arissupport.urlref_"+a.id,shapes:[a],node:d,nodePosition:"SE"})},hide:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"arissupport.urlref_"+a.id})}});Array.prototype.insertFrom=function(f,e){e=Math.max(0,e);f=Math.min(Math.max(0,f),this.length-1);var c=this[f];var a=this.without(c);var d=a.slice(0,e);d.push(c);if(a.length>e){d=d.concat(a.slice(e))}return d};if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Arrangement=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Arrangement.am,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_MIDDLE]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_middle.png",description:ORYX.I18N.Arrangement.amDesc,index:1,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.ac,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_CENTER]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_center.png",description:ORYX.I18N.Arrangement.acDesc,index:2,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.as,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_SIZE]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_size.png",description:ORYX.I18N.Arrangement.asDesc,index:3,minShape:2});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,this.setZLevel.bind(this,this.setToTop));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACK,this.setZLevel.bind(this,this.setToBack));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD,this.setZLevel.bind(this,this.setForward));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD,this.setZLevel.bind(this,this.setBackward))},onSelectionChanged:function(a){var c=this.facade.getSelection();if(c.length===1&&c[0] instanceof ORYX.Core.Edge){this.setToTop(c)}},setZLevel:function(e,c){var a=ORYX.Core.Command.extend({construct:function(h,g,f){this.callback=h;this.elements=g;this.elAndIndex=g.map(function(l){return{el:l,previous:l.parent.children[l.parent.children.indexOf(l)-1]}});this.facade=f},execute:function(){this.callback(this.elements);this.facade.setSelection(this.elements)},rollback:function(){var h=this.elAndIndex.sortBy(function(p){var q=p.el;var o=$A(q.node.parentNode.childNodes);return o.indexOf(q.node)});for(var g=0;g<h.length;g++){var l=h[g].el;var m=l.parent;var n=m.children.indexOf(l);var f=m.children.indexOf(h[g].previous);f=f||0;m.children=m.children.insertFrom(n,f);l.node.parentNode.insertBefore(l.node,l.node.parentNode.childNodes[f+1])}this.facade.setSelection(this.elements)}});var d=new a(e,this.facade.getSelection(),this.facade);if(c.excludeCommand){d.execute()}else{this.facade.executeCommands([d])}},setToTop:function(c){var a=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node)});a.each(function(d){var e=d.parent;if(e.children.last()===d){return}e.children=e.children.without(d);e.children.push(d);d.node.parentNode.appendChild(d.node)})},setToBack:function(c){var a=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node)});a=a.reverse();a.each(function(d){var e=d.parent;e.children=e.children.without(d);e.children.unshift(d);d.node.parentNode.insertBefore(d.node,d.node.parentNode.firstChild)})},setBackward:function(d){var c=d.sortBy(function(g,e){var f=$A(g.node.parentNode.childNodes);return f.indexOf(g.node)});c=c.reverse();var a=c.findAll(function(e){return !c.some(function(f){return f.node==e.node.previousSibling})});a.each(function(f){if(f.node.previousSibling===null){return}var g=f.parent;var e=g.children.indexOf(f);g.children=g.children.insertFrom(e,e-1);f.node.parentNode.insertBefore(f.node,f.node.previousSibling)})},setForward:function(d){var c=d.sortBy(function(g,e){var f=$A(g.node.parentNode.childNodes);return f.indexOf(g.node)});var a=c.findAll(function(e){return !c.some(function(f){return f.node==e.node.nextSibling})});a.each(function(g){var e=g.node.nextSibling;if(e===null){return}var f=g.parent.children.indexOf(g);var h=g.parent;h.children=h.children.insertFrom(f,f+1);g.node.parentNode.insertBefore(e,g.node)})},alignShapes:function(c){var g=this.facade.getSelection();g=this.facade.getCanvas().getShapesWithSharedParent(g);g=g.findAll(function(l){return(l instanceof ORYX.Core.Node)});g=g.findAll(function(l){var m=l.getIncomingShapes();return m.length==0||!g.include(m[0])});if(g.length<2){return}var f=g[0].absoluteBounds().clone();g.each(function(l){f.include(l.absoluteBounds().clone())});var e=0;var d=0;g.each(function(l){e=Math.max(l.bounds.width(),e);d=Math.max(l.bounds.height(),d)});var a=ORYX.Core.Command.extend({construct:function(q,p,o,n,l,m){this.elements=q;this.bounds=p;this.maxHeight=o;this.maxWidth=n;this.way=l;this.facade=m.facade;this.plugin=m;this.orgPos=[]},setBounds:function(l,n){if(!n){n={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE}}if(!l.bounds){throw"Bounds not definined."}var m={a:{x:l.bounds.upperLeft().x-(this.maxWidth-l.bounds.width())/2,y:l.bounds.upperLeft().y-(this.maxHeight-l.bounds.height())/2},b:{x:l.bounds.lowerRight().x+(this.maxWidth-l.bounds.width())/2,y:l.bounds.lowerRight().y+(this.maxHeight-l.bounds.height())/2}};if(this.maxWidth>n.width){m.a.x=l.bounds.upperLeft().x-(n.width-l.bounds.width())/2;m.b.x=l.bounds.lowerRight().x+(n.width-l.bounds.width())/2}if(this.maxHeight>n.height){m.a.y=l.bounds.upperLeft().y-(n.height-l.bounds.height())/2;m.b.y=l.bounds.lowerRight().y+(n.height-l.bounds.height())/2}l.bounds.set(m)},execute:function(){this.elements.each(function(l,m){this.orgPos[m]=l.bounds.upperLeft();var n=this.bounds.clone();var q;if(l.parent&&!(l.parent instanceof ORYX.Core.Canvas)){var p=l.parent.absoluteBounds().upperLeft();n.moveBy(-p.x,-p.y)}switch(this.way){case ORYX.CONFIG.EDITOR_ALIGN_BOTTOM:q={x:l.bounds.upperLeft().x,y:n.b.y-l.bounds.height()};break;case ORYX.CONFIG.EDITOR_ALIGN_MIDDLE:q={x:l.bounds.upperLeft().x,y:(n.a.y+n.b.y-l.bounds.height())/2};break;case ORYX.CONFIG.EDITOR_ALIGN_TOP:q={x:l.bounds.upperLeft().x,y:n.a.y};break;case ORYX.CONFIG.EDITOR_ALIGN_LEFT:q={x:n.a.x,y:l.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_CENTER:q={x:(n.a.x+n.b.x-l.bounds.width())/2,y:l.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_RIGHT:q={x:n.b.x-l.bounds.width(),y:l.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_SIZE:if(l.isResizable){this.orgPos[m]={a:l.bounds.upperLeft(),b:l.bounds.lowerRight()};this.setBounds(l,l.maximumSize)}break}if(q){var o={x:l.bounds.upperLeft().x-q.x,y:l.bounds.upperLeft().y-q.y};l.bounds.moveTo(q);this.plugin.layoutEdges(l,l.getAllDockedShapes(),o)}}.bind(this))},rollback:function(){this.elements.each(function(l,m){if(this.way==ORYX.CONFIG.EDITOR_ALIGN_SIZE){if(l.isResizable){l.bounds.set(this.orgPos[m])}}else{l.bounds.moveTo(this.orgPos[m])}}.bind(this))}});var h=new a(g,f,d,e,parseInt(c),this);this.facade.executeCommands([h])}});if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.ApromoreSave=Clazz.extend({facade:undefined,changeSymbol:"*",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Save.save,functionality:this.save.bind(this,false),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk.png",description:ORYX.I18N.Save.saveDesc,index:1,minShape:0,maxShape:0,keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:83,keyAction:ORYX.CONFIG.KEY_ACTION_UP}]});document.addEventListener("keydown",function(c){if(c.ctrlKey&&c.keyCode===83){Event.stop(c)}},false);this.facade.offer({name:ORYX.I18N.Save.saveAs,functionality:this.save.bind(this,true),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk_multi.png",description:ORYX.I18N.Save.saveAsDesc,index:2,minShape:0,maxShape:0});window.onbeforeunload=this.onUnLoad.bind(this);this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++;this.updateTitle()}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++;this.updateTitle()}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--;this.updateTitle()}.bind(this))},updateTitle:function(){var c=window.document.title;var a=document.getElementsByTagName("title")[0];if(a){var d=a.childNodes[0];if(d){c=a.nodeValue}}if(c){if(this.changeDifference===0&&c.startsWith(this.changeSymbol)){window.document.title=c.slice(1)}else{if(this.changeDifference!==0&&!c.startsWith(this.changeSymbol)){window.document.title=this.changeSymbol+""+c}}}},onUnLoad:function(){if(this.changeDifference!==0||(this.facade.getModelMetaData()["new"]&&this.facade.getCanvas().getChildShapes().size()>0)){return ORYX.I18N.Save.unsavedData}},getSVG:function(){var c=this.facade.getSelection();this.facade.setSelection([]);var e=this.facade.getCanvas().getSVGRepresentation(true);this.facade.setSelection(c);if(this.facade.getCanvas().properties["oryx-showstripableelements"]===false){var d=e.getElementsByClassName("stripable-element");for(var a=d.length-1;a>=0;a--){d[a].parentNode.removeChild(d[a])}}var d=e.getElementsByClassName("stripable-element-force");for(var a=d.length-1;a>=0;a--){d[a].parentNode.removeChild(d[a])}return DataManager.serialize(e)},save:function(d,e){if(this.saving){return false}this.saving=true;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ABOUT_TO_SAVE});var c=Ext.encode(this.facade.getJSON());var a=this.getSVG();if(d){if(ORYX.Plugins.ApromoreSave.apromoreSaveAs){ORYX.Plugins.ApromoreSave.apromoreSaveAs(c,a)}else{alert("Apromore Save As method is missing!")}}else{if(ORYX.Plugins.ApromoreSave.apromoreSave){ORYX.Plugins.ApromoreSave.apromoreSave(c,a)}else{alert("Apromore Save method is missing!")}}this.saving=false;return true}});function getObjectClass(c){if(c&&c.constructor&&c.constructor.toString){var a=c.constructor.toString().match(/function\s*(\w+)/);if(a&&a.length==2){return a[1]}}return undefined}if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.ApromoreBimp=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Bimp.upload,functionality:this.sendToBimp.bind(this,false),group:ORYX.I18N.Bimp.group,icon:ORYX.PATH+"images/BIMP.png",description:ORYX.I18N.Bimp.uploadDesc,index:1})},sendToBimp:function(){if(this.getDiagramType()=="xpdl"||this.getDiagramType()=="bpmn"){this.form=new Ext.form.FormPanel({url:ORYX.CONFIG.BIMP_URL,method:"POST",items:new Ext.form.Hidden({name:"file"}),bodyStyle:"background-color:white; border: none;",submit:function(){var d=this.getForm().getEl().dom;var c=document.createAttribute("target");c.nodeValue="_blank";d.setAttributeNode(c);d.action=this.getForm().url;d.submit()}});var a=new Ext.Panel({bodyStyle:"background-color:white; border: none;",layout:"anchor",html:'<style type="text/css"> .format p { margin-bottom: 10px; }</style><div class="format" style="width: 100%; position: relative; left: 0; top: 0; float: left;"><p style="text-align: justify;">Web based business process simulator is easy to use and can be accessed directly from a web browser.</p> <p style="text-align: justify;">You must have a business process diagram in BPMN 2.0 or Visio 2013 BPMN (VSDX) format. With the web based simulator interface you can upload your business process diagram and add the additional information that is required for simulation. Additional information like the number of process instances, their arrival rate, activity durations, amount of various resources, path execution probabilities and etc is essential for the simulation.</p> <p style="text-align: justify;">After the simulation data has been entered, the simulation can be started. You can also enable MXML log creation to produce the logs in a standard XML format that can be downloaded and analyzed further with other process mining tools.</p> <p style="text-align: justify;">From the results you can analyze the performance of the business process. You can download the process model with the simulation data to be simulated later again. You can always go back modify the entered simulation specific information and run the simulation again.</p> <p style="text-align: justify;">Online Business Process Simulator is free for academic use, contact us for commercial use.</p> </div><div style="clear:both;"></div>'});this.window=new Ext.Window({title:"BIMP Simulator",bodyStyle:"background-color:white; padding: 10px; color: black; overflow: visible;",resizable:true,closeable:true,minimizable:false,modal:true,width:600,minHeight:300,items:[a,this.form],buttons:[{text:"Simulate",disabled:true,handler:function(){this.ownerCt.items.item(1).submit();this.ownerCt.close()}},{text:"Cancel",handler:function(){this.ownerCt.close()}}]});new Ajax.Request(this.getExportUrl(this.getDiagramType()),{method:"POST",parameters:{data:this.facade.getSerializedJSON()},asynchronous:true,encoding:"UTF-8",requestHeaders:{Accept:"application/json"},onSuccess:function(c){if(c!=null){this.form.items.item(0).getEl().dom.value=c.responseText;this.window.buttons[0].enable()}else{Ext.Msg.show({title:"Error",msg:"An error occured while loading your process.",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize();this.window.close()}}.bind(this),onFailure:function(c){Ext.Msg.show({title:"Error",msg:"An error occured while loading your process.",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize();this.window.close()}.bind(this)});this.window.show()}else{Ext.Msg.show({title:"Error",msg:"The BIMP Simulator only works with BPMN models!",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize()}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/bpmn1.1#":return("xpdl");case"http://b3mn.org/stencilset/bpmn2.0#":return("bpmn");case"http://b3mn.org/stencilset/epc#":return("epml");case"http://b3mn.org/stencilset/yawl2.2#":return("yawl");default:return("")}},getExportUrl:function(a){switch(a){case"xpdl":return ORYX.CONFIG.EDITOR_PATH+"/xpdlexport";case"bpmn":return ORYX.CONFIG.EDITOR_PATH+"/bpmnexport";case"epml":return ORYX.CONFIG.EDITOR_PATH+"/epmlexport";case"yawl":return ORYX.CONFIG.EDITOR_PATH+"/yawlexport";default:return("")}}});if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.ApromoreBpstruct=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.BPStruct.upload,functionality:this.showInfoDialog.bind(this,false),group:ORYX.I18N.Bimp.group,icon:ORYX.PATH+"images/BPStruct.png",description:ORYX.I18N.BPStruct.uploadDesc,index:1})},showInfoDialog:function(){this.dialog=new Ext.Window({resizable:true,closeable:true,minimizable:false,modal:true,width:600,minHeight:300,layout:"anchor",bodyStyle:"background-color:white; padding: 10px; color: black; overflow: visible;",title:"BPStruct",html:'<style>.format p { margin-bottom: 10px; } </style><div class="format" style="width: 100%; position: relative; left: 0; top: 0; float: left;"><p style="text-align: justify;">BPStruct is a tool for transforming unstructured programs/service compositions/(business) process models (models of concurrency) into well-structured ones. A model is well-structured, if for every node with multiple outgoing arcs (a split) there is a corresponding node with multiple incoming arcs (a join), and vice versa, such that the fragment of the model between the split and the join forms a single-entry-single-exit (SESE) component; otherwise the model is unstructured. The transformation preserves concurrency in resulting well-structured models.</p></div><div style="clear: both;"></div>',buttons:[{text:"Transform",handler:this.bpstruct.bind(this)},{text:"Cancel",handler:function(){this.ownerCt.close()}}]});this.dialog.show()},bpstruct:function(){if(this.dialog){this.dialog.close()}var a=this.facade.getSerializedJSON();if(this.facade.getCanvas().nodes.size()==0){Ext.Msg.show({title:"Info",msg:"There is nothing to structure.",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO}).getDialog().syncSize();return}var c=Ext.Msg.wait("Waiting for BPStruct to process model.");new Ajax.Request(ORYX.CONFIG.BPSTRUCT_URL,{parameters:{data:a,type:this.getDiagramType()},method:"POST",asynchronous:true,onSuccess:function(e){c.hide();var d=e.responseText.evalJSON(true);if(d!=null){if(d.hasOwnProperty("errors")){this.showErrors(d.errors)}else{if(d.hasChanged){if(d.hasOwnProperty("data_json")){this.replaceProcess(d.data_json)}}else{this.showCouldntStructure()}}}}.bind(this),onFailure:function(d){c.hide();Ext.Msg.show({title:"Error",msg:"The communication with the BPStruct failed.",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize()}.bind(this)})},replaceProcess:function(c){var a=ORYX.Core.Command.extend({construct:function(d,e){this.facade=d;this.oldProcess=d.getJSON();this.newProcess=e},execute:function(){try{this.facade.getCanvas().getChildShapes().each(function(e){this.facade.getCanvas().remove(e)}.bind(this));this.facade.importJSON(this.newProcess,true)}catch(d){console.log("BPStruct Update Canvas error: "+d.message)}},rollback:function(){this.facade.getCanvas().getChildShapes().each(function(d){this.facade.getCanvas().remove(d)}.bind(this));this.facade.importJSON(this.oldProcess,true)}});this.facade.executeCommands([new a(this.facade,c)]);Ext.Msg.show({title:"Result",msg:"Your process was structured successfully.",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO}).getDialog().syncSize()},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/bpmn1.1#":return("xpdl");case"http://b3mn.org/stencilset/bpmn2.0#":return("bpmn");case"http://b3mn.org/stencilset/epc#":return("epc");case"http://b3mn.org/stencilset/yawl2.2#":return("yawl");default:return("")}},showErrors:function(e){if(e.size()==0){Ext.Msg.show({title:"Error",msg:"An error occured while structuring your process.",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize()}else{Ext.Msg.show({title:"Error",msg:"It was not possible to structure the process because of some unsupported content.",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}).getDialog().syncSize();var d=new Ext.ux.grid.ErrorGridPanel(e,this.facade);var c=new Ext.Window({resizable:true,closeable:true,minimizable:false,width:300,minHeight:250,x:0,layout:"anchor",bodyStyle:"background-color:white; color: black; overflow: visible;",title:"Errors that occurred",items:d,buttons:[{text:"OK",handler:function(){this.ownerCt.close()}}]});c.show()}},showCouldntStructure:function(){Ext.Msg.show({title:"Result",msg:"It was not possible to structure the process",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO}).getDialog().syncSize()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.View={facade:undefined,construct:function(c,a){this.facade=c;this.zoomLevel=1;this.maxFitToScreenLevel=1.5;this.minZoomLevel=0.1;this.maxZoomLevel=2.5;this.diff=5;a.properties.each(function(d){if(d.zoomLevel){this.zoomLevel=Number(1)}if(d.maxFitToScreenLevel){this.maxFitToScreenLevel=Number(d.maxFitToScreenLevel)}if(d.minZoomLevel){this.minZoomLevel=Number(d.minZoomLevel)}if(d.maxZoomLevel){this.maxZoomLevel=Number(d.maxZoomLevel)}}.bind(this));this.facade.offer({name:ORYX.I18N.View.zoomIn,functionality:this.zoom.bind(this,[1+ORYX.CONFIG.ZOOM_OFFSET]),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/magnifier_zoom_in.png",description:ORYX.I18N.View.zoomInDesc,index:1,minShape:0,maxShape:0,isEnabled:function(){return this.zoomLevel<this.maxZoomLevel}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomOut,functionality:this.zoom.bind(this,[1-ORYX.CONFIG.ZOOM_OFFSET]),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/magnifier_zoom_out.png",description:ORYX.I18N.View.zoomOutDesc,index:2,minShape:0,maxShape:0,isEnabled:function(){return this._checkSize()}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomStandard,functionality:this.setAFixZoomLevel.bind(this,1),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/zoom_standard.png",cls:"icon-large",description:ORYX.I18N.View.zoomStandardDesc,index:3,minShape:0,maxShape:0,isEnabled:function(){return this.zoomLevel!=1}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomFitToModel,functionality:this.zoomFitToModel.bind(this),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/image.png",description:ORYX.I18N.View.zoomFitToModelDesc,index:4,minShape:0,maxShape:0})},setAFixZoomLevel:function(a){this.zoomLevel=a;this._checkZoomLevelRange();this.zoom(1)},zoom:function(e){this.zoomLevel*=e;var l=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var d=this.facade.getCanvas();var h=d.bounds.width()*this.zoomLevel;var a=d.bounds.height()*this.zoomLevel;var g=(d.node.parentNode.parentNode.parentNode.offsetHeight-a)/2;g=g>20?g-20:0;d.node.parentNode.parentNode.style.marginTop=g+"px";g+=5;d.getHTMLContainer().style.top=g+"px";var c=l.scrollTop-Math.round((d.getHTMLContainer().parentNode.getHeight()-a)/2)+this.diff;var f=l.scrollLeft-Math.round((d.getHTMLContainer().parentNode.getWidth()-h)/2)+this.diff;d.setSize({width:h,height:a},true);d.node.setAttributeNS(null,"transform","scale("+this.zoomLevel+")");this.facade.updateSelection();l.scrollTop=c;l.scrollLeft=f;d.zoomLevel=this.zoomLevel},zoomFitToModel:function(){var l=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var c=l.getHeight()-30;var e=l.getWidth()-30;var d=this.facade.getCanvas().getChildShapes();if(!d||d.length<1){return false}var h=d[0].absoluteBounds().clone();d.each(function(m){h.include(m.absoluteBounds().clone())});var g=e/h.width();var a=c/h.height();var f=a<g?a:g;if(f>this.maxFitToScreenLevel){f=this.maxFitToScreenLevel}this.setAFixZoomLevel(f);l.scrollTop=Math.round(h.upperLeft().y*this.zoomLevel)-5;l.scrollLeft=Math.round(h.upperLeft().x*this.zoomLevel)-5},_checkSize:function(){var a=this.facade.getCanvas().getHTMLContainer().parentNode;var c=Math.min((a.parentNode.getWidth()/a.getWidth()),(a.parentNode.getHeight()/a.getHeight()));return 1.05>c},_checkZoomLevelRange:function(){if(this.zoomLevel<this.minZoomLevel){this.zoomLevel=this.minZoomLevel}if(this.zoomLevel>this.maxZoomLevel){this.zoomLevel=this.maxZoomLevel}}};ORYX.Plugins.View=Clazz.extend(ORYX.Plugins.View);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DragDropResize=ORYX.Plugins.AbstractPlugin.extend({construct:function(c){this.facade=c;this.currentShapes=[];this.toMoveShapes=[];this.distPoints=[];this.isResizing=false;this.dragEnable=false;this.dragIntialized=false;this.edgesMovable=true;this.offSetPosition={x:0,y:0};this.faktorXY={x:1,y:1};this.containmentParentNode;this.isAddingAllowed=false;this.isAttachingAllowed=false;this.callbackMouseMove=this.handleMouseMove.bind(this);this.callbackMouseUp=this.handleMouseUp.bind(this);var a=this.facade.getCanvas().getSvgContainer();this.selectedRect=new ORYX.Plugins.SelectedRect(a);if(ORYX.CONFIG.SHOW_GRIDLINE){this.vLine=new ORYX.Plugins.GridLine(a,ORYX.Plugins.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Plugins.GridLine(a,ORYX.Plugins.GridLine.DIR_HORIZONTAL)}a=this.facade.getCanvas().getHTMLContainer();this.scrollNode=this.facade.getCanvas().rootNode.parentNode.parentNode;this.resizerSE=new ORYX.Plugins.Resizer(a,"southeast",this.facade);this.resizerSE.registerOnResize(this.onResize.bind(this));this.resizerSE.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerSE.registerOnResizeStart(this.onResizeStart.bind(this));this.resizerNW=new ORYX.Plugins.Resizer(a,"northwest",this.facade);this.resizerNW.registerOnResize(this.onResize.bind(this));this.resizerNW.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerNW.registerOnResizeStart(this.onResizeStart.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},handleMouseDown:function(e,d){if(!this.dragBounds||!this.currentShapes.member(d)||!this.toMoveShapes.length){return}this.dragEnable=true;this.dragIntialized=true;this.edgesMovable=true;var c=this.facade.getCanvas().node.getScreenCTM();this.faktorXY.x=c.a;this.faktorXY.y=c.d;var f=this.dragBounds.upperLeft();this.offSetPosition={x:Event.pointerX(e)-(f.x*this.faktorXY.x),y:Event.pointerY(e)-(f.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);return},handleMouseUp:function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});if(this.dragEnable){if(!this.dragIntialized){this.afterDrag();if(this.isAttachingAllowed&&this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0){var c=this.facade.eventCoordinates(e);var f=this.toMoveShapes[0].dockers[0];var d=ORYX.Core.Command.extend({construct:function(m,g,l,h){this.docker=m;this.newPosition=g;this.newDockedShape=l;this.newParent=l.parent||h.getCanvas();this.oldPosition=m.parent.bounds.center();this.oldDockedShape=m.getDockedShape();this.oldParent=m.parent.parent||h.getCanvas();this.facade=h;if(this.oldDockedShape){this.oldPosition=m.parent.absoluteBounds().center()}},execute:function(){this.dock(this.newDockedShape,this.newParent,this.newPosition);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,excludeCommand:true})},rollback:function(){this.dock(this.oldDockedShape,this.oldParent,this.oldPosition)},dock:function(g,h,l){h.add(this.docker.parent);this.docker.setDockedShape(undefined);this.docker.bounds.centerMoveTo(l);this.docker.setDockedShape(g);this.facade.setSelection([this.docker.parent]);this.facade.getCanvas().update();this.facade.updateSelection()}});var a=[new d(f,c,this.containmentParentNode,this.facade)];this.facade.executeCommands(a)}else{if(this.isAddingAllowed){this.refreshSelectedShapes()}}this.facade.updateSelection();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_END})}if(this.vLine){this.vLine.hide()}if(this.hLine){this.hLine.hide()}}this.dragEnable=false;document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);return},handleMouseMove:function(h){if(!this.dragEnable){return}if(this.dragIntialized){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_START});this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();this._onlyEdges=this.currentShapes.all(function(c){return(c instanceof ORYX.Core.Edge)});this.beforeDrag();this._currentUnderlyingNodes=[]}var a={x:Event.pointerX(h)-this.offSetPosition.x,y:Event.pointerY(h)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;var d=h.shiftKey||h.ctrlKey;if(ORYX.CONFIG.GRID_ENABLED&&!d){a=this.snapToGrid(a)}else{if(this.vLine){this.vLine.hide()}if(this.hLine){this.hLine.hide()}}a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;a.x=Math.max(0,a.x);a.y=Math.max(0,a.y);var l=this.facade.getCanvas();a.x=Math.min(l.bounds.width()-this.dragBounds.width(),a.x);a.y=Math.min(l.bounds.height()-this.dragBounds.height(),a.y);this.dragBounds.moveTo(a);this.resizeRectangle(this.dragBounds);this.isAttachingAllowed=false;var e=$A(this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(h)));var g=this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0;g=g&&e.length!=1;if(!g&&e.length===this._currentUnderlyingNodes.length&&e.all(function(m,c){return this._currentUnderlyingNodes[c]===m}.bind(this))){return}else{if(this._onlyEdges){this.isAddingAllowed=true;this.containmentParentNode=this.facade.getCanvas()}else{var f={event:h,underlyingNodes:e,checkIfAttachable:g};this.checkRules(f)}}this._currentUnderlyingNodes=e.reverse();if(this.isAttachingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.attached",elements:[this.containmentParentNode],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"})}if(!this.isAttachingAllowed){if(this.isAddingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_VALID_COLOR})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_INVALID_COLOR})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"})}return},checkRules:function(e){var g=e.event;var d=e.underlyingNodes;var f=e.checkIfAttachable;var c=e.noEdges;this.containmentParentNode=d.reverse().find((function(h){return(h instanceof ORYX.Core.Canvas)||(((h instanceof ORYX.Core.Node)||((h instanceof ORYX.Core.Edge)&&!c))&&(!(this.currentShapes.member(h)||this.currentShapes.any(function(l){return(l.children.length>0&&l.getChildNodes(true).member(h))}))))}).bind(this));if(f){this.isAttachingAllowed=this.facade.getRules().canConnect({sourceShape:this.containmentParentNode,edgeShape:this.toMoveShapes[0],targetShape:this.toMoveShapes[0]});if(this.isAttachingAllowed){var a=this.facade.eventCoordinates(g);this.isAttachingAllowed=this.containmentParentNode.isPointOverOffset(a.x,a.y)}}if(!this.isAttachingAllowed){this.isAddingAllowed=this.toMoveShapes.all((function(h){if(h instanceof ORYX.Core.Edge||h instanceof ORYX.Core.Controls.Docker||this.containmentParentNode===h.parent){return true}else{if(this.containmentParentNode!==h){if(!(this.containmentParentNode instanceof ORYX.Core.Edge)||!c){if(this.facade.getRules().canContain({containingShape:this.containmentParentNode,containedShape:h})){return true}}}}return false}).bind(this))}if(!this.isAttachingAllowed&&!this.isAddingAllowed&&(this.containmentParentNode instanceof ORYX.Core.Edge)){e.noEdges=true;e.underlyingNodes.reverse();this.checkRules(e)}},refreshSelectedShapes:function(){if(!this.dragBounds){return}var e=this.dragBounds.upperLeft();var c=this.oldDragBounds.upperLeft();var d={x:e.x-c.x,y:e.y-c.y};var a=[new ORYX.Core.Command.Move(this.toMoveShapes,d,this.containmentParentNode,this.currentShapes,this)];if(this._undockedEdgesCommand instanceof ORYX.Core.Command){a.unshift(this._undockedEdgesCommand)}this.facade.executeCommands(a);if(this.dragBounds){this.oldDragBounds=this.dragBounds.clone()}},onResize:function(a){if(!this.dragBounds){return}this.dragBounds=a;this.isResizing=true;this.resizeRectangle(this.dragBounds)},onResizeStart:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_START})},onResizeEnd:function(){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return}if(this.isResizing){var a=ORYX.Core.Command.extend({construct:function(g,l,h){this.shape=g;this.oldBounds=g.bounds.clone();this.newBounds=l;this.plugin=h},execute:function(){this.shape.bounds.set(this.newBounds.a,this.newBounds.b);this.update(this.getOffset(this.oldBounds,this.newBounds))},rollback:function(){this.shape.bounds.set(this.oldBounds.a,this.oldBounds.b);this.update(this.getOffset(this.newBounds,this.oldBounds))},getOffset:function(h,g){return{x:g.a.x-h.a.x,y:g.a.y-h.a.y,xs:g.width()/h.width(),ys:g.height()/h.height()}},update:function(h){this.shape.getLabels().each(function(l){l.changed()});var g=[].concat(this.shape.getIncomingShapes()).concat(this.shape.getOutgoingShapes()).findAll(function(l){return l instanceof ORYX.Core.Edge}.bind(this));this.plugin.layoutEdges(this.shape,g,h);this.plugin.facade.setSelection([this.shape]);this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var d=this.dragBounds.clone();var c=this.currentShapes[0];if(c.parent){var f=c.parent.absoluteXY();d.moveBy(-f.x,-f.y)}var e=new a(c,d,this);this.facade.executeCommands([e]);this.isResizing=false;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_END})}},beforeDrag:function(){var a=ORYX.Core.Command.extend({construct:function(c){this.dockers=c.collect(function(d){return d instanceof ORYX.Core.Controls.Docker?{docker:d,dockedShape:d.getDockedShape(),refPoint:d.referencePoint}:undefined}).compact()},execute:function(){this.dockers.each(function(c){c.docker.setDockedShape(undefined)})},rollback:function(){this.dockers.each(function(c){c.docker.setDockedShape(c.dockedShape);c.docker.setReferencePoint(c.refPoint)})}});this._undockedEdgesCommand=new a(this.toMoveShapes);this._undockedEdgesCommand.execute()},hideAllLabels:function(a){a.getLabels().each(function(c){c.hide()});a.getAllDockedShapes().each(function(c){var d=c.getLabels();if(d.length>0){d.each(function(e){e.hide()})}});a.getChildren().each((function(c){if(c instanceof ORYX.Core.Shape){this.hideAllLabels(c)}}).bind(this))},afterDrag:function(){},showAllLabels:function(a){for(var e=0;e<a.length;e++){var c=a[e];c.show()}var g=a.getAllDockedShapes();for(var e=0;e<g.length;e++){var d=g[e];var h=d.getLabels();if(h.length>0){h.each(function(l){l.show()})}}for(var e=0;e<a.children.length;e++){var f=a.children[e];if(f instanceof ORYX.Core.Shape){this.showAllLabels(f)}}},onSelectionChanged:function(c){var e=c.elements;this.dragEnable=false;this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();if(!e||e.length==0){this.selectedRect.hide();this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.oldDragBounds=undefined}else{this.currentShapes=e;var f=this.facade.getCanvas().getShapesWithSharedParent(e);this.toMoveShapes=f;this.toMoveShapes=this.toMoveShapes.findAll(function(g){return g instanceof ORYX.Core.Node&&(g.dockers.length===0||!e.member(g.dockers.first().getDockedShape()))});e.each((function(g){if(!(g instanceof ORYX.Core.Edge)){return}var l=g.getDockers();var m=e.member(l.first().getDockedShape());var h=e.member(l.last().getDockedShape());if(!m&&!h){var n=!l.first().getDockedShape()&&!l.last().getDockedShape();if(n){this.toMoveShapes=this.toMoveShapes.concat(l)}}if(g.dockers.length>2&&m&&h){this.toMoveShapes=this.toMoveShapes.concat(l.findAll(function(p,o){return o>0&&o<l.length-1}))}}).bind(this));var d=undefined;this.toMoveShapes.each(function(h){var g=h;if(h instanceof ORYX.Core.Controls.Docker){g=h.parent}if(!d){d=g.absoluteBounds()}else{d.include(g.absoluteBounds())}}.bind(this));if(!d){e.each(function(g){if(!d){d=g.absoluteBounds()}else{d.include(g.absoluteBounds())}})}this.dragBounds=d;this.oldDragBounds=d.clone();this.resizeRectangle(d);this.selectedRect.show();if(e.length==1&&e[0].isResizable){var a=e[0].getStencil().fixedAspectRatio()?e[0].bounds.width()/e[0].bounds.height():undefined;this.resizerSE.setBounds(this.dragBounds,e[0].minimumSize,e[0].maximumSize,a);this.resizerSE.show();this.resizerNW.setBounds(this.dragBounds,e[0].minimumSize,e[0].maximumSize,a);this.resizerNW.show()}else{this.resizerSE.setBounds(undefined);this.resizerNW.setBounds(undefined)}if(ORYX.CONFIG.GRID_ENABLED){this.distPoints=[];if(this.distPointTimeout){window.clearTimeout(this.distPointTimeout)}this.distPointTimeout=window.setTimeout(function(){var g=this.facade.getCanvas().getChildShapes(true).findAll(function(l){var h=l.parent;while(h){if(e.member(h)){return false}h=h.parent}return true});g.each((function(n){if(!(n instanceof ORYX.Core.Edge)){var l=n.absoluteXY();var m=n.bounds.width();var h=n.bounds.height();this.distPoints.push({ul:{x:l.x,y:l.y},c:{x:l.x+(m/2),y:l.y+(h/2)},lr:{x:l.x+m,y:l.y+h}})}}).bind(this))}.bind(this),10)}}},snapToGrid:function(l){var a=this.dragBounds;var r={};var q=6;var o=10;var s=6;var d=this.vLine?this.vLine.getScale():1;var n={x:(l.x/d),y:(l.y/d)};var p={x:(l.x/d)+(a.width()/2),y:(l.y/d)+(a.height()/2)};var h={x:(l.x/d)+(a.width()),y:(l.y/d)+(a.height())};var g,e;var m,f;this.distPoints.each(function(u){var c,w,v,t;if(Math.abs(u.c.x-p.x)<o){c=u.c.x-p.x;v=u.c.x}if(Math.abs(u.c.y-p.y)<o){w=u.c.y-p.y;t=u.c.y}if(c!==undefined){g=g===undefined?c:(Math.abs(c)<Math.abs(g)?c:g);if(g===c){m=v}}if(w!==undefined){e=e===undefined?w:(Math.abs(w)<Math.abs(e)?w:e);if(e===w){f=t}}});if(g!==undefined){n.x+=g;n.x*=d;if(this.vLine&&m){this.vLine.update(m)}}else{n.x=(l.x-(l.x%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.vLine){this.vLine.hide()}}if(e!==undefined){n.y+=e;n.y*=d;if(this.hLine&&f){this.hLine.update(f)}}else{n.y=(l.y-(l.y%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.hLine){this.hLine.hide()}}return n},showGridLine:function(){},resizeRectangle:function(a){this.selectedRect.resize(a)}});ORYX.Plugins.SelectedRect=Clazz.extend({construct:function(a){this.parentId=a;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",$(a),["g"]);this.dashedArea=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["rect",{x:0,y:0,"stroke-width":1,stroke:"#777777",fill:"none","stroke-dasharray":"2,2","pointer-events":"none"}]);this.hide()},hide:function(){this.node.setAttributeNS(null,"display","none")},show:function(){this.node.setAttributeNS(null,"display","")},resize:function(a){var d=a.upperLeft();var c=ORYX.CONFIG.SELECTED_AREA_PADDING;this.dashedArea.setAttributeNS(null,"width",a.width()+2*c);this.dashedArea.setAttributeNS(null,"height",a.height()+2*c);this.node.setAttributeNS(null,"transform","translate("+(d.x-c)+", "+(d.y-c)+")")}});ORYX.Plugins.GridLine=Clazz.extend({construct:function(c,a){if(ORYX.Plugins.GridLine.DIR_HORIZONTAL!==a&&ORYX.Plugins.GridLine.DIR_VERTICAL!==a){a=ORYX.Plugins.GridLine.DIR_HORIZONTAL}this.parent=$(c);this.direction=a;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent,["g"]);this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":1,stroke:"silver",fill:"none","stroke-dasharray":"5,5","pointer-events":"none"}]);this.hide()},hide:function(){this.node.setAttributeNS(null,"display","none")},show:function(){this.node.setAttributeNS(null,"display","")},getScale:function(){try{return this.parent.parentNode.transform.baseVal.getItem(0).matrix.a}catch(a){return 1}},update:function(f){if(this.direction===ORYX.Plugins.GridLine.DIR_HORIZONTAL){var e=f instanceof Object?f.y:f;var d=this.parent.parentNode.parentNode.width.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M 0 "+e+" L "+d+" "+e)}else{var a=f instanceof Object?f.x:f;var c=this.parent.parentNode.parentNode.height.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M"+a+" 0 L "+a+" "+c)}this.show()}});ORYX.Plugins.GridLine.DIR_HORIZONTAL="hor";ORYX.Plugins.GridLine.DIR_VERTICAL="ver";ORYX.Plugins.Resizer=Clazz.extend({construct:function(d,a,c){this.parentId=d;this.orientation=a;this.facade=c;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":"resizer_"+this.orientation,style:"left:0px; top:0px;"}]);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMove.bind(this),false);this.dragEnable=false;this.offSetPosition={x:0,y:0};this.bounds=undefined;this.canvasNode=this.facade.getCanvas().node;this.minSize=undefined;this.maxSize=undefined;this.aspectRatio=undefined;this.resizeCallbacks=[];this.resizeStartCallbacks=[];this.resizeEndCallbacks=[];this.hide();this.scrollNode=this.node.parentNode.parentNode.parentNode},handleMouseDown:function(a){this.dragEnable=true;this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.offSetPosition={x:Event.pointerX(a)-this.position.x,y:Event.pointerY(a)-this.position.y};this.resizeStartCallbacks.each((function(c){c(this.bounds)}).bind(this))},handleMouseUp:function(a){this.dragEnable=false;this.containmentParentNode=null;this.resizeEndCallbacks.each((function(c){c(this.bounds)}).bind(this))},handleMouseMove:function(d){if(!this.dragEnable){return}if(d.shiftKey||d.ctrlKey){this.aspectRatio=this.bounds.width()/this.bounds.height()}else{this.aspectRatio=undefined}var c={x:Event.pointerX(d)-this.offSetPosition.x,y:Event.pointerY(d)-this.offSetPosition.y};c.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;c.y-=this.offsetScroll.y-this.scrollNode.scrollTop;c.x=Math.min(c.x,this.facade.getCanvas().bounds.width());c.y=Math.min(c.y,this.facade.getCanvas().bounds.height());var e={x:c.x-this.position.x,y:c.y-this.position.y};if(this.aspectRatio){newAspectRatio=(this.bounds.width()+e.x)/(this.bounds.height()+e.y);if(newAspectRatio>this.aspectRatio){e.x=this.aspectRatio*(this.bounds.height()+e.y)-this.bounds.width()}else{if(newAspectRatio<this.aspectRatio){e.y=(this.bounds.width()+e.x)/this.aspectRatio-this.bounds.height()}}}if(this.orientation==="northwest"){if(this.bounds.width()-e.x>this.maxSize.width){e.x=-(this.maxSize.width-this.bounds.width());if(this.aspectRatio){e.y=this.aspectRatio*e.x}}if(this.bounds.width()-e.x<this.minSize.width){e.x=-(this.minSize.width-this.bounds.width());if(this.aspectRatio){e.y=this.aspectRatio*e.x}}if(this.bounds.height()-e.y>this.maxSize.height){e.y=-(this.maxSize.height-this.bounds.height());if(this.aspectRatio){e.x=e.y/this.aspectRatio}}if(this.bounds.height()-e.y<this.minSize.height){e.y=-(this.minSize.height-this.bounds.height());if(this.aspectRatio){e.x=e.y/this.aspectRatio}}}else{if(this.bounds.width()+e.x>this.maxSize.width){e.x=this.maxSize.width-this.bounds.width();if(this.aspectRatio){e.y=this.aspectRatio*e.x}}if(this.bounds.width()+e.x<this.minSize.width){e.x=this.minSize.width-this.bounds.width();if(this.aspectRatio){e.y=this.aspectRatio*e.x}}if(this.bounds.height()+e.y>this.maxSize.height){e.y=this.maxSize.height-this.bounds.height();if(this.aspectRatio){e.x=e.y/this.aspectRatio}}if(this.bounds.height()+e.y<this.minSize.height){e.y=this.minSize.height-this.bounds.height();if(this.aspectRatio){e.x=e.y/this.aspectRatio}}}if(this.orientation==="northwest"){var a={x:this.bounds.lowerRight().x,y:this.bounds.lowerRight().y};this.bounds.extend({x:-e.x,y:-e.y});this.bounds.moveBy(e)}else{this.bounds.extend(e)}this.update();this.resizeCallbacks.each((function(f){f(this.bounds)}).bind(this));Event.stop(d)},registerOnResizeStart:function(a){if(!this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks.push(a)}},unregisterOnResizeStart:function(a){if(this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks=this.resizeStartCallbacks.without(a)}},registerOnResizeEnd:function(a){if(!this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks.push(a)}},unregisterOnResizeEnd:function(a){if(this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks=this.resizeEndCallbacks.without(a)}},registerOnResize:function(a){if(!this.resizeCallbacks.member(a)){this.resizeCallbacks.push(a)}},unregisterOnResize:function(a){if(this.resizeCallbacks.member(a)){this.resizeCallbacks=this.resizeCallbacks.without(a)}},hide:function(){this.node.style.display="none"},show:function(){if(this.bounds){this.node.style.display=""}},setBounds:function(e,c,a,d){this.bounds=e;if(!c){c={width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE}}if(!a){a={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE}}this.minSize=c;this.maxSize=a;this.aspectRatio=d;this.update()},update:function(){if(!this.bounds){return}var d=this.bounds.upperLeft();if(this.bounds.width()<this.minSize.width){this.bounds.set(d.x,d.y,d.x+this.minSize.width,d.y+this.bounds.height())}if(this.bounds.height()<this.minSize.height){this.bounds.set(d.x,d.y,d.x+this.bounds.width(),d.y+this.minSize.height)}if(this.bounds.width()>this.maxSize.width){this.bounds.set(d.x,d.y,d.x+this.maxSize.width,d.y+this.bounds.height())}if(this.bounds.height()>this.maxSize.height){this.bounds.set(d.x,d.y,d.x+this.bounds.width(),d.y+this.maxSize.height)}var c=this.canvasNode.getScreenCTM();d.x*=c.a;d.y*=c.d;if(this.orientation==="northwest"){d.x-=13;d.y-=26}else{d.x+=(c.a*this.bounds.width())+3;d.y+=(c.d*this.bounds.height())+3}this.position=d;this.node.style.left=this.position.x+"px";this.node.style.top=this.position.y+"px"}});ORYX.Core.Command.Move=ORYX.Core.Command.extend({construct:function(c,f,d,a,e){this.moveShapes=c;this.selectedShapes=a;this.offset=f;this.plugin=e;this.newParents=c.collect(function(g){return d||g.parent});this.oldParents=c.collect(function(g){return g.parent});this.dockedNodes=c.findAll(function(g){return g instanceof ORYX.Core.Node&&g.dockers.length==1}).collect(function(g){return{docker:g.dockers[0],dockedShape:g.dockers[0].getDockedShape(),refPoint:g.dockers[0].referencePoint}})},execute:function(){this.dockAllShapes();this.move(this.offset);this.addShapeToParent(this.newParents);this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){var a={x:-this.offset.x,y:-this.offset.y};this.move(a);this.addShapeToParent(this.oldParents);this.dockAllShapes(true);this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},move:function(e,a){for(var h=0;h<this.moveShapes.length;h++){var m=this.moveShapes[h];m.bounds.moveBy(e);if(m instanceof ORYX.Core.Node){(m.dockers||[]).each(function(n){n.bounds.moveBy(e)});var f=[].concat(m.getIncomingShapes()).concat(m.getOutgoingShapes()).findAll(function(n){return n instanceof ORYX.Core.Edge&&!this.moveShapes.any(function(o){return o==n||(o instanceof ORYX.Core.Controls.Docker&&o.parent==n)})}.bind(this)).findAll(function(n){return(n.dockers.first().getDockedShape()==m||!this.moveShapes.include(n.dockers.first().getDockedShape()))&&(n.dockers.last().getDockedShape()==m||!this.moveShapes.include(n.dockers.last().getDockedShape()))}.bind(this));this.plugin.layoutEdges(m,f,e);var l=[].concat(m.getIncomingShapes()).concat(m.getOutgoingShapes()).findAll(function(n){return n instanceof ORYX.Core.Edge&&n.dockers.first().isDocked()&&n.dockers.last().isDocked()&&!this.moveShapes.include(n)&&!this.moveShapes.any(function(o){return o==n||(o instanceof ORYX.Core.Controls.Docker&&o.parent==n)})}.bind(this)).findAll(function(n){return this.moveShapes.indexOf(n.dockers.first().getDockedShape())>h||this.moveShapes.indexOf(n.dockers.last().getDockedShape())>h}.bind(this));for(var g=0;g<l.length;g++){for(var c=1;c<l[g].dockers.length-1;c++){var d=l[g].dockers[c];if(!d.getDockedShape()&&!this.moveShapes.include(d)){d.bounds.moveBy(e)}}}}}},dockAllShapes:function(a){for(var c=0;c<this.dockedNodes.length;c++){var d=this.dockedNodes[c].docker;d.setDockedShape(a?this.dockedNodes[c].dockedShape:undefined);if(d.getDockedShape()){d.setReferencePoint(this.dockedNodes[c].refPoint)}}},addShapeToParent:function(e){for(var f=0;f<this.moveShapes.length;f++){var d=this.moveShapes[f];if(d instanceof ORYX.Core.Node&&d.parent!==e[f]){var g=e[f].absoluteXY();var h=d.absoluteXY();var c=h.x-g.x;var l=h.y-g.y;e[f].add(d);d.getOutgoingShapes((function(m){if(m instanceof ORYX.Core.Node&&!this.moveShapes.member(m)){e[f].add(m)}}).bind(this));if(d instanceof ORYX.Core.Node&&d.dockers.length==1){var a=d.bounds;c+=a.width()/2;l+=a.height()/2;d.dockers.first().bounds.centerMoveTo(c,l)}else{d.bounds.moveTo(c,l)}}}},selectCurrentShapes:function(){this.plugin.facade.setSelection(this.selectedShapes)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this))},setHighlight:function(a){if(a&&a.highlightId){var c=this.highlightNodes[a.highlightId];if(!c){c=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,fill:"none"}]);this.highlightNodes[a.highlightId]=c}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(c,a);this.show(c)}else{this.hide(c)}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId])}},hide:function(a){a.setAttributeNS(null,"display","none")},show:function(a){a.setAttributeNS(null,"display","")},setAttributesByStyle:function(c,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var e=a.elements[0].absoluteBounds();var d=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;c.setAttributeNS(null,"d",this.getPathRectangle(e.a,e.b,d));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);c.setAttributeNS(null,"stroke-width",d)}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){c.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);c.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}else{c.setAttributeNS(null,"d",this.getPathByElements(a.elements));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);c.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2)}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined}var d=ORYX.CONFIG.SELECTED_AREA_PADDING;var c="";a.each((function(g){if(!g){return}var h=g.absoluteBounds();h.widen(d);var f=h.upperLeft();var e=h.lowerRight();c=c+this.getPath(f,e)}).bind(this));return c},getPath:function(d,c){return this.getPathCorners(d,c)},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f},getPathEdge:function(a){var c=a.length;var d="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<c;i++){var e=a[i].bounds.center();d=d+" L"+e.x+" "+e.y}return d}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DragDocker=Clazz.extend({construct:function(a){this.facade=a;this.VALIDCOLOR=ORYX.CONFIG.SELECTION_VALID_COLOR;this.INVALIDCOLOR=ORYX.CONFIG.SELECTION_INVALID_COLOR;this.shapeSelection=undefined;this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;this.isStartDocker=undefined;this.isEndDocker=undefined;this.undockTreshold=10;this.initialDockerPosition=undefined;this.outerDockerNotMoved=undefined;this.isValid=false;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DOCKERDRAG,this.handleDockerDrag.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.handleMouseOut.bind(this))},handleMouseOut:function(c,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.hide()}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.each(function(d){d.hide()})}}},handleMouseOver:function(c,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.show()}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.each(function(d){d.show()})}}},handleDockerDrag:function(c,a){this.handleMouseDown(c.uiEvent,a)},handleMouseDown:function(e,d){if(d instanceof ORYX.Core.Controls.Docker&&d.isMovable){this.shapeSelection=this.facade.getSelection();this.facade.setSelection();this.docker=d;this.initialDockerPosition=this.docker.bounds.center();this.outerDockerNotMoved=false;this.dockerParent=d.parent;this._commandArg={docker:d,dockedShape:d.getDockedShape(),refPoint:d.referencePoint||d.bounds.center()};this.docker.show();if(d.parent instanceof ORYX.Core.Edge&&(d.parent.dockers.first()==d||d.parent.dockers.last()==d)){if(d.parent.dockers.first()==d&&d.parent.dockers.last().getDockedShape()){this.dockerTarget=d.parent.dockers.last().getDockedShape()}else{if(d.parent.dockers.last()==d&&d.parent.dockers.first().getDockedShape()){this.dockerSource=d.parent.dockers.first().getDockedShape()}}}else{this.dockerSource=undefined;this.dockerTarget=undefined}this.isStartDocker=this.docker.parent.dockers.first()===this.docker;this.isEndDocker=this.docker.parent.dockers.last()===this.docker;this.facade.getCanvas().add(this.docker.parent);this.docker.parent.getLabels().each(function(f){f.hide()});if((!this.isStartDocker&&!this.isEndDocker)||!this.docker.isDocked()){this.docker.setDockedShape(undefined);var c=this.facade.eventCoordinates(e);this.docker.bounds.centerMoveTo(c);this.dockerParent._update()}else{this.outerDockerNotMoved=true}var a={movedCallback:this.dockerMoved.bind(this),upCallback:this.dockerMovedFinished.bind(this)};ORYX.Core.UIEnableDrag(e,d,a)}},dockerMoved:function(w){this.outerDockerNotMoved=false;var n=undefined;if(this.docker.parent){if(this.isStartDocker||this.isEndDocker){var q=this.facade.eventCoordinates(w);if(this.docker.isDocked()){var c=ORYX.Core.Math.getDistancePointToPoint(q,this.initialDockerPosition);if(c<this.undockTreshold){this.outerDockerNotMoved=true;return}this.docker.setDockedShape(undefined);this.dockerParent._update()}var u=this.facade.getCanvas().getAbstractShapesAtPosition(q);var s=u.pop();if(this.docker.parent===s){s=u.pop()}if(this.lastUIObj==s){}else{if(s instanceof ORYX.Core.Shape){var v=this.docker.parent.getStencil().stencilSet();if(this.docker.parent instanceof ORYX.Core.Edge){var x=this.getHighestParentBeforeCanvas(s);if(x instanceof ORYX.Core.Edge&&this.docker.parent===x){this.isValid=false;this.dockerParent._update();return}this.isValid=false;var a=s,d=s;while(!this.isValid&&a&&!(a instanceof ORYX.Core.Canvas)){s=a;this.isValid=this.facade.getRules().canConnect({sourceShape:this.dockerSource?this.dockerSource:(this.isStartDocker?s:undefined),edgeShape:this.docker.parent,targetShape:this.dockerTarget?this.dockerTarget:(this.isEndDocker?s:undefined)});a=a.parent}if(!this.isValid){s=d}}else{this.isValid=this.facade.getRules().canConnect({sourceShape:s,edgeShape:this.docker.parent,targetShape:this.docker.parent})}if(this.lastUIObj){this.hideMagnets(this.lastUIObj)}if(this.isValid){this.showMagnets(s)}this.showHighlight(s,this.isValid?this.VALIDCOLOR:this.INVALIDCOLOR);this.lastUIObj=s}else{this.hideHighlight();this.lastUIObj?this.hideMagnets(this.lastUIObj):null;this.lastUIObj=undefined;this.isValid=false}}if(this.lastUIObj&&this.isValid&&!(w.shiftKey||w.ctrlKey)){n=this.lastUIObj.magnets.find(function(A){return A.absoluteBounds().isIncluded(q)});if(n){this.docker.bounds.centerMoveTo(n.absoluteCenterXY())}}}}if(!(w.shiftKey||w.ctrlKey)&&!n){var p=ORYX.CONFIG.DOCKER_SNAP_OFFSET;var l=p+1;var g=p+1;var z=this.docker.bounds.center();if(this.docker.parent){this.docker.parent.dockers.each((function(B){if(this.docker==B){return}var A=B.referencePoint?B.getAbsoluteReferencePoint():B.bounds.center();l=Math.abs(l)>Math.abs(A.x-z.x)?A.x-z.x:l;g=Math.abs(g)>Math.abs(A.y-z.y)?A.y-z.y:g}).bind(this));if(Math.abs(l)<p||Math.abs(g)<p){l=Math.abs(l)<p?l:0;g=Math.abs(g)<p?g:0;this.docker.bounds.centerMoveTo(z.x+l,z.y+g)}else{var e=this.docker.parent.dockers[Math.max(this.docker.parent.dockers.indexOf(this.docker)-1,0)];var t=this.docker.parent.dockers[Math.min(this.docker.parent.dockers.indexOf(this.docker)+1,this.docker.parent.dockers.length-1)];if(e&&t&&e!==this.docker&&t!==this.docker){var f=e.bounds.center();var h=t.bounds.center();var r=this.docker.bounds.center();if(ORYX.Core.Math.isPointInLine(r.x,r.y,f.x,f.y,h.x,h.y,10)){var y=(Number(h.y)-Number(f.y))/(Number(h.x)-Number(f.x));var o=((f.y-(f.x*y))-(r.y-(r.x*(-Math.pow(y,-1)))))/((-Math.pow(y,-1))-y);var m=(f.y-(f.x*y))+(y*o);if(isNaN(o)||isNaN(m)){return}this.docker.bounds.centerMoveTo(o,m)}}}}}this.dockerParent._update()},dockerMovedFinished:function(f){this.facade.setSelection(this.shapeSelection);this.hideHighlight();this.dockerParent.getLabels().each(function(h){h.show()});if(this.lastUIObj&&(this.isStartDocker||this.isEndDocker)){if(this.isValid){this.docker.setDockedShape(this.lastUIObj);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,docker:this.docker,parent:this.docker.parent,target:this.lastUIObj})}this.hideMagnets(this.lastUIObj)}this.docker.hide();if(this.outerDockerNotMoved){var e=this.facade.eventCoordinates(f);var a=this.facade.getCanvas().getAbstractShapesAtPosition(e);var c=a.findAll(function(h){return h instanceof ORYX.Core.Node});a=c.length?c:a;this.facade.setSelection(a)}else{var d=ORYX.Core.Command.extend({construct:function(p,l,h,o,n,m){this.docker=p;this.index=p.parent.dockers.indexOf(p);this.newPosition=l;this.newDockedShape=o;this.oldPosition=h;this.oldDockedShape=n;this.facade=m;this.index=p.parent.dockers.indexOf(p);this.shape=p.parent},execute:function(){if(!this.docker.parent){this.docker=this.shape.dockers[this.index]}this.dock(this.newDockedShape,this.newPosition);this.removedDockers=this.shape.removeUnusedDockers();this.facade.updateSelection()},rollback:function(){this.dock(this.oldDockedShape,this.oldPosition);(this.removedDockers||$H({})).each(function(h){this.shape.add(h.value,Number(h.key));this.shape._update(true)}.bind(this));this.facade.updateSelection()},dock:function(h,l){this.docker.setDockedShape(undefined);if(h){this.docker.setDockedShape(h);this.docker.setReferencePoint(l)}else{this.docker.bounds.centerMoveTo(l)}this.facade.getCanvas().update()}});if(this.docker.parent){var g=new d(this.docker,this.docker.getDockedShape()?this.docker.referencePoint:this.docker.bounds.center(),this._commandArg.refPoint,this.docker.getDockedShape(),this._commandArg.dockedShape,this.facade);this.facade.executeCommands([g])}}this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined},hideHighlight:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"validDockedShape"})},showHighlight:function(c,a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"validDockedShape",elements:[c],color:a})},showMagnets:function(a){a.magnets.each(function(c){c.show()})},hideMagnets:function(a){a.magnets.each(function(c){c.hide()})},getHighestParentBeforeCanvas:function(a){if(!(a instanceof ORYX.Core.Shape)){return undefined}var c=a.parent;while(c&&!(c.parent instanceof ORYX.Core.Canvas)){c=c.parent}return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AddDocker=Clazz.extend({construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.AddDocker.add,functionality:this.enableAddDocker.bind(this),group:ORYX.I18N.AddDocker.group,icon:ORYX.PATH+"images/vector_add.png",description:ORYX.I18N.AddDocker.addDesc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.AddDocker.del,functionality:this.enableDeleteDocker.bind(this),group:ORYX.I18N.AddDocker.group,icon:ORYX.PATH+"images/vector_delete.png",description:ORYX.I18N.AddDocker.delDesc,index:2,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},enableAddDocker:function(a,c){this.addDockerButton=a;if(c&&this.deleteDockerButton){this.deleteDockerButton.toggle(false)}},enableDeleteDocker:function(a,c){this.deleteDockerButton=a;if(c&&this.addDockerButton){this.addDockerButton.toggle(false)}},enabledAdd:function(){return this.addDockerButton?this.addDockerButton.pressed:false},enabledDelete:function(){return this.deleteDockerButton?this.deleteDockerButton.pressed:false},handleMouseDown:function(c,a){if(this.enabledAdd()&&a instanceof ORYX.Core.Edge){this.newDockerCommand({edge:a,position:this.facade.eventCoordinates(c)})}else{if(this.enabledDelete()&&a instanceof ORYX.Core.Controls.Docker&&a.parent instanceof ORYX.Core.Edge){this.newDockerCommand({edge:a.parent,docker:a})}else{if(this.enabledAdd()){this.addDockerButton.toggle(false)}else{if(this.enabledDelete()){this.deleteDockerButton.toggle(false)}}}}},newDockerCommand:function(c){if(!c.edge){return}var a=ORYX.Core.Command.extend({construct:function(l,g,f,h,m,e){this.addEnabled=l;this.deleteEnabled=g;this.edge=f;this.docker=h;this.pos=m;this.facade=e},execute:function(){if(this.addEnabled){if(!this.docker){this.docker=this.edge.addDocker(this.pos);this.index=this.edge.dockers.indexOf(this.docker)}else{this.edge.add(this.docker,this.index)}}else{if(this.deleteEnabled){this.index=this.edge.dockers.indexOf(this.docker);this.pos=this.docker.bounds.center();this.edge.removeDocker(this.docker)}}this.edge.getLabels().invoke("show");this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){if(this.addEnabled){if(this.docker instanceof ORYX.Core.Controls.Docker){this.edge.removeDocker(this.docker)}}else{if(this.deleteEnabled){this.edge.add(this.docker,this.index)}}this.edge.getLabels().invoke("show");this.facade.getCanvas().update();this.facade.updateSelection()}});var d=new a(this.enabledAdd(),this.enabledDelete(),c.edge,c.docker,c.position,this.facade);this.facade.executeCommands([d])}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SelectionFrame=Clazz.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);this.position={x:0,y:0};this.size={width:0,height:0};this.offsetPosition={x:0,y:0};this.moveCallback=undefined;this.offsetScroll={x:0,y:0};this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer(),["div",{"class":"Oryx_SelectionFrame"}]);this.hide()},handleMouseDown:function(e,d){if(d instanceof ORYX.Core.Canvas){var f=d.rootNode.parentNode.parentNode;var c=this.facade.getCanvas().node.getScreenCTM();this.offsetPosition={x:c.e,y:c.f};this.setPos({x:Event.pointerX(e)-this.offsetPosition.x,y:Event.pointerY(e)-this.offsetPosition.y});this.resize({width:0,height:0});this.moveCallback=this.handleMouseMove.bind(this);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.offsetScroll={x:f.scrollLeft,y:f.scrollTop};this.show()}Event.stop(e)},handleMouseUp:function(f){if(this.moveCallback){this.hide();document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.moveCallback=undefined;var e=this.facade.getCanvas().node.getScreenCTM();var d={x:this.size.width>0?this.position.x:this.position.x+this.size.width,y:this.size.height>0?this.position.y:this.position.y+this.size.height};var c={x:d.x+Math.abs(this.size.width),y:d.y+Math.abs(this.size.height)};d.x/=e.a;d.y/=e.d;c.x/=e.a;c.y/=e.d;var g=this.facade.getCanvas().getChildShapes(true).findAll(function(h){var a=h.absoluteBounds();var m=a.upperLeft();var l=a.lowerRight();if(m.x>d.x&&m.y>d.y&&l.x<c.x&&l.y<c.y){return true}return false});this.facade.setSelection(g)}},handleMouseMove:function(c){var a={width:Event.pointerX(c)-this.position.x-this.offsetPosition.x,height:Event.pointerY(c)-this.position.y-this.offsetPosition.y,};var d=this.facade.getCanvas().rootNode.parentNode.parentNode;a.width-=this.offsetScroll.x-d.scrollLeft;a.height-=this.offsetScroll.y-d.scrollTop;this.resize(a);Event.stop(c)},hide:function(){this.node.style.display="none"},show:function(){this.node.style.display=""},setPos:function(a){this.node.style.top=a.y+"px";this.node.style.left=a.x+"px";this.position=a},resize:function(a){this.setPos(this.position);this.size=Object.clone(a);if(a.width<0){this.node.style.left=(this.position.x+a.width)+"px";a.width=-a.width}if(a.height<0){this.node.style.top=(this.position.y+a.height)+"px";a.height=-a.height}this.node.style.width=a.width+"px";this.node.style.height=a.height+"px"}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this))},setHighlight:function(a){if(a&&a.highlightId){var c=this.highlightNodes[a.highlightId];if(!c){c=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,fill:"none"}]);this.highlightNodes[a.highlightId]=c}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(c,a);this.show(c)}else{this.hide(c)}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId])}},hide:function(a){a.setAttributeNS(null,"display","none")},show:function(a){a.setAttributeNS(null,"display","")},setAttributesByStyle:function(c,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var e=a.elements[0].absoluteBounds();var d=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;c.setAttributeNS(null,"d",this.getPathRectangle(e.a,e.b,d));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);c.setAttributeNS(null,"stroke-width",d)}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){c.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);c.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}else{c.setAttributeNS(null,"d",this.getPathByElements(a.elements));c.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);c.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);c.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2)}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined}var d=ORYX.CONFIG.SELECTED_AREA_PADDING;var c="";a.each((function(g){if(!g){return}var h=g.absoluteBounds();h.widen(d);var f=h.upperLeft();var e=h.lowerRight();c=c+this.getPath(f,e)}).bind(this));return c},getPath:function(d,c){return this.getPathCorners(d,c)},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f},getPathEdge:function(a){var c=a.length;var d="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<c;i++){var e=a[i].bounds.center();d=d+" L"+e.x+" "+e.y}return d}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Overlay=Clazz.extend({facade:undefined,styleNode:undefined,construct:function(a){this.facade=a;this.changes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_SHOW,this.show.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_HIDE,this.hide.bind(this));this.styleNode=document.createElement("style");this.styleNode.setAttributeNS(null,"type","text/css");document.getElementsByTagName("head")[0].appendChild(this.styleNode)},show:function(a){if(!a||!a.shapes||!a.shapes instanceof Array||!a.id||!a.id instanceof String||a.id.length==0){return}if(a.attributes){a.shapes.each(function(e){if(!e instanceof ORYX.Core.Shape){return}this.setAttributes(e.node,a.attributes)}.bind(this))}var d=true;try{d=a.node&&a.node instanceof SVGElement}catch(c){}if(a.node&&d){a._temps=[];a.shapes.each(function(h,g){if(!h instanceof ORYX.Core.Shape){return}var f={};f.svg=a.dontCloneNode?a.node:a.node.cloneNode(true);h.node.firstChild.appendChild(f.svg);if(h instanceof ORYX.Core.Edge&&!a.nodePosition){a.nodePosition="START"}if(a.nodePosition){var e=h.bounds;var l=a.nodePosition.toUpperCase();if(h instanceof ORYX.Core.Node&&l=="START"){l="NW"}else{if(h instanceof ORYX.Core.Node&&l=="END"){l="SE"}else{if(h instanceof ORYX.Core.Edge&&l=="START"){e=h.getDockers().first().bounds}else{if(h instanceof ORYX.Core.Edge&&l=="END"){e=h.getDockers().last().bounds}}}}f.callback=function(){var m=0;var n=0;if(l=="NW"){}else{if(l=="N"){m=e.width()/2}else{if(l=="NE"){m=e.width()}else{if(l=="E"){m=e.width();n=e.height()/2}else{if(l=="SE"){m=e.width();n=e.height()}else{if(l=="S"){m=e.width()/2;n=e.height()}else{if(l=="SW"){n=e.height()}else{if(l=="W"){n=e.height()/2}else{if(l=="START"||l=="END"){m=e.width()/2;n=e.height()/2}else{return}}}}}}}}}if(h instanceof ORYX.Core.Edge){m+=e.upperLeft().x;n+=e.upperLeft().y}f.svg.setAttributeNS(null,"transform","translate("+m+", "+n+")")}.bind(this);f.element=h;f.callback();e.registerCallback(f.callback)}a._temps.push(f)}.bind(this))}if(!this.changes[a.id]){this.changes[a.id]=[]}this.changes[a.id].push(a)},hide:function(a){if(!a||!a.id||!a.id instanceof String||a.id.length==0||!this.changes[a.id]){return}this.changes[a.id].each(function(c){c.shapes.each(function(e,d){if(!e instanceof ORYX.Core.Shape){return}this.deleteAttributes(e.node)}.bind(this));if(c._temps){c._temps.each(function(d){if(d.svg&&d.svg.parentNode){d.svg.parentNode.removeChild(d.svg)}if(d.callback&&d.element){d.element.bounds.unregisterCallback(d.callback)}}.bind(this))}}.bind(this));this.changes[a.id]=null},setAttributes:function(d,e){var l=this.getAllChilds(d.firstChild.firstChild);var a=[];l.each(function(o){a.push($A(o.attributes).findAll(function(p){return p.nodeValue.startsWith("url(#")}))});a=a.flatten().compact();a=a.collect(function(o){return o.nodeValue}).uniq();a=a.collect(function(o){return o.slice(5,o.length-1)});a.unshift(d.id+" .me");var h=$H(e);var f=h.toJSON().gsub(",",";").gsub('"',"");var m=e.stroke?f.slice(0,f.length-1)+"; fill:"+e.stroke+";}":f;var g;if(e.fill){var c=Object.clone(e);c.fill="black";g=$H(c).toJSON().gsub(",",";").gsub('"',"")}csstags=a.collect(function(p,o){return"#"+p+" * "+(!o?f:m)+""+(g?" #"+p+" text * "+g:"")});var n=csstags.join(" ")+"\n";this.styleNode.appendChild(document.createTextNode(n))},deleteAttributes:function(c){var a=$A(this.styleNode.childNodes).findAll(function(d){return d.textContent.include("#"+c.id)});a.each(function(d){d.parentNode.removeChild(d)})},getAllChilds:function(a){var c=$A(a.childNodes);$A(a.childNodes).each(function(d){c.push(this.getAllChilds(d))}.bind(this));return c.flatten()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Edit=Clazz.extend({construct:function(a){this.facade=a;this.clipboard=new ORYX.Plugins.Edit.ClipBoard();this.facade.offer({name:ORYX.I18N.Edit.cut,description:ORYX.I18N.Edit.cutDesc,icon:ORYX.PATH+"images/cut.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:88,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCut),group:ORYX.I18N.Edit.group,index:1,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.copy,description:ORYX.I18N.Edit.copyDesc,icon:ORYX.PATH+"images/page_copy.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:67,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCopy,[true,false]),group:ORYX.I18N.Edit.group,index:2,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.paste,description:ORYX.I18N.Edit.pasteDesc,icon:ORYX.PATH+"images/page_paste.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:86,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editPaste),isEnabled:this.clipboard.isOccupied.bind(this.clipboard),group:ORYX.I18N.Edit.group,index:3,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Edit.del,description:ORYX.I18N.Edit.delDesc,icon:ORYX.PATH+"images/cross.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:8,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN},{keyCode:46,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editDelete),group:ORYX.I18N.Edit.group,index:4,minShape:1})},callEdit:function(c,a){window.setTimeout(function(){c.apply(this,(a instanceof Array?a:[]))}.bind(this),1)},handleMouseDown:function(a){if(this._controlPressed){this._controlPressed=false;this.editCopy();this.editPaste();a.forceExecution=true;this.facade.raiseEvent(a,this.clipboard.shapesAsJson)}},getAllShapesToConsider:function(c){var a=[];var d=[];c.each(function(f){isChildShapeOfAnother=c.any(function(h){return h.hasChildShape(f)});if(isChildShapeOfAnother){return}a.push(f);if(f instanceof ORYX.Core.Node){var g=f.getOutgoingNodes();g=g.findAll(function(h){return !c.include(h)});a=a.concat(g)}d=d.concat(f.getChildShapes(true))}.bind(this));var e=this.facade.getCanvas().getChildEdges().select(function(f){if(a.include(f)){return false}if(f.getAllDockedShapes().size()===0){return false}return f.getAllDockedShapes().all(function(g){return g instanceof ORYX.Core.Edge||d.include(g)})});a=a.concat(e);return a},editCut:function(){this.editCopy(false,true);this.editDelete(true);return false},editCopy:function(d,a){var c=this.facade.getSelection();if(c.length==0){return}this.clipboard.refresh(c,this.getAllShapesToConsider(c),this.facade.getCanvas().getStencil().stencilSet().namespace(),a);if(d){this.facade.updateSelection()}},editPaste:function(){var c={childShapes:this.clipboard.shapesAsJson,stencilset:{namespace:this.clipboard.SSnamespace}};Ext.apply(c,ORYX.Core.AbstractShape.JSONHelper);var a=c.getChildShapes(true).pluck("resourceId");var d={};c.eachChild(function(e,f){e.outgoing=e.outgoing.select(function(g){return a.include(g.resourceId)});e.outgoing.each(function(g){if(!d[g.resourceId]){d[g.resourceId]=[]}d[g.resourceId].push(e)});return e}.bind(this),true,true);c.eachChild(function(e,f){if(e.target&&!(a.include(e.target.resourceId))){e.target=undefined;e.targetRemoved=true}if(e.dockers&&e.dockers.length>=1&&e.dockers[0].getDocker&&((e.dockers[0].getDocker().getDockedShape()&&!a.include(e.dockers[0].getDocker().getDockedShape().resourceId))||!e.getShape().dockers[0].getDockedShape()&&!d[e.resourceId])){e.sourceRemoved=true}return e}.bind(this),true,true);c.eachChild(function(e,f){if(this.clipboard.useOffset){e.bounds={lowerRight:{x:e.bounds.lowerRight.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:e.bounds.lowerRight.y+ORYX.CONFIG.COPY_MOVE_OFFSET},upperLeft:{x:e.bounds.upperLeft.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:e.bounds.upperLeft.y+ORYX.CONFIG.COPY_MOVE_OFFSET}}}if(e.dockers){e.dockers=e.dockers.map(function(h,g){if((e.targetRemoved===true&&g==e.dockers.length-1&&h.getDocker)||(e.sourceRemoved===true&&g==0&&h.getDocker)){h=h.getDocker().bounds.center()}if((g==0&&h.getDocker instanceof Function&&e.sourceRemoved!==true&&(h.getDocker().getDockedShape()||((d[e.resourceId]||[]).length>0&&(!(e.getShape() instanceof ORYX.Core.Node)||d[e.resourceId][0].getShape() instanceof ORYX.Core.Node))))||(g==e.dockers.length-1&&h.getDocker instanceof Function&&e.targetRemoved!==true&&(h.getDocker().getDockedShape()||e.target))){return{x:h.x,y:h.y,getDocker:h.getDocker}}else{if(this.clipboard.useOffset){return{x:h.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:h.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:h.getDocker}}else{return{x:h.x,y:h.y,getDocker:h.getDocker}}}}.bind(this))}else{if(e.getShape() instanceof ORYX.Core.Node&&e.dockers&&e.dockers.length>0&&(!e.dockers.first().getDocker||e.sourceRemoved===true||!(e.dockers.first().getDocker().getDockedShape()||d[e.resourceId]))){e.dockers=e.dockers.map(function(h,g){if((e.sourceRemoved===true&&g==0&&h.getDocker)){h=h.getDocker().bounds.center()}if(this.clipboard.useOffset){return{x:h.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:h.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:h.getDocker}}else{return{x:h.x,y:h.y,getDocker:h.getDocker}}}.bind(this))}}return e}.bind(this),false,true);this.clipboard.useOffset=true;this.facade.importJSON(c)},editDelete:function(){var a=this.facade.getSelection();var c=new ORYX.Plugins.Edit.ClipBoard();c.refresh(a,this.getAllShapesToConsider(a));var d=new ORYX.Plugins.Edit.DeleteCommand(c,this.facade);this.facade.executeCommands([d])}});ORYX.Plugins.Edit.ClipBoard=Clazz.extend({construct:function(){this.shapesAsJson=[];this.selection=[];this.SSnamespace="";this.useOffset=true},isOccupied:function(){return this.shapesAsJson.length>0},refresh:function(e,c,d,a){this.selection=e;this.SSnamespace=d;this.outgoings={};this.parents={};this.targets={};this.useOffset=a!==true;this.shapesAsJson=c.map(function(f){var g=f.toJSON();g.parent={resourceId:f.getParentShape().resourceId};g.parentIndex=f.getParentShape().getChildShapes().indexOf(f);return g})}});ORYX.Plugins.Edit.DeleteCommand=ORYX.Core.Command.extend({construct:function(c,a){this.clipboard=c;this.shapesAsJson=c.shapesAsJson;this.facade=a;this.dockers=this.shapesAsJson.map(function(h){var f=h.getShape();var g=f.getIncomingShapes().map(function(l){return l.getDockers().last()});var e=f.getOutgoingShapes().map(function(l){return l.getDockers().first()});var d=f.getDockers().concat(g,e).compact().map(function(l){return{object:l,referencePoint:l.referencePoint,dockedShape:l.getDockedShape()}});return d}).flatten()},execute:function(){this.shapesAsJson.each(function(a){this.facade.deleteShape(a.getShape())}.bind(this));this.facade.setSelection([]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.shapesAsJson.each(function(d){var a=d.getShape();var c=this.facade.getCanvas().getChildShapeByResourceId(d.parent.resourceId)||this.facade.getCanvas();c.add(a,a.parentIndex)}.bind(this));this.dockers.each(function(a){a.object.setDockedShape(a.dockedShape);a.object.setReferencePoint(a.referencePoint)}.bind(this));this.facade.setSelection(this.selectedShapes);this.facade.getCanvas().update();this.facade.updateSelection()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.KeysMove=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.copyElements=[];this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:65,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.selectAll.bind(this)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,true)})},selectAll:function(a){Event.stop(a.event);this.facade.setSelection(this.facade.getCanvas().getChildShapes(true))},move:function(q,m,n){Event.stop(n.event);var c=m?20:5;var o=this.facade.getSelection();var h=this.facade.getSelection();var d={x:0,y:0};switch(q){case ORYX.CONFIG.KEY_CODE_LEFT:d.x=-1*c;break;case ORYX.CONFIG.KEY_CODE_RIGHT:d.x=c;break;case ORYX.CONFIG.KEY_CODE_UP:d.y=-1*c;break;case ORYX.CONFIG.KEY_CODE_DOWN:d.y=c;break}o=o.findAll(function(e){if(e instanceof ORYX.Core.Node&&e.dockers.length==1&&o.include(e.dockers.first().getDockedShape())){return false}var p=e.parent;do{if(o.include(p)){return false}}while(p=p.parent);return true});var g=true;var l=o.all(function(e){if(e instanceof ORYX.Core.Edge){if(e.isDocked()){g=false}return true}return false});if(l&&!g){return}o=o.map(function(p){if(p instanceof ORYX.Core.Node){return p}else{if(p instanceof ORYX.Core.Edge){var e=p.dockers;if(o.include(p.dockers.first().getDockedShape())){e=e.without(p.dockers.first())}if(o.include(p.dockers.last().getDockedShape())){e=e.without(p.dockers.last())}return e}else{return null}}}).flatten().compact();if(o.size()>0){var a=[this.facade.getCanvas().bounds.lowerRight().x,this.facade.getCanvas().bounds.lowerRight().y,0,0];o.each(function(e){a[0]=Math.min(a[0],e.bounds.upperLeft().x);a[1]=Math.min(a[1],e.bounds.upperLeft().y);a[2]=Math.max(a[2],e.bounds.lowerRight().x);a[3]=Math.max(a[3],e.bounds.lowerRight().y)});if(a[0]+d.x<0){d.x=-a[0]}if(a[1]+d.y<0){d.y=-a[1]}if(a[2]+d.x>this.facade.getCanvas().bounds.lowerRight().x){d.x=this.facade.getCanvas().bounds.lowerRight().x-a[2]}if(a[3]+d.y>this.facade.getCanvas().bounds.lowerRight().y){d.y=this.facade.getCanvas().bounds.lowerRight().y-a[3]}if(d.x!=0||d.y!=0){var f=[new ORYX.Core.Command.Move(o,d,null,h,this)];this.facade.executeCommands(f)}}},getUndockedCommant:function(c){var a=ORYX.Core.Command.extend({construct:function(d){this.dockers=d.collect(function(e){return e instanceof ORYX.Core.Controls.Docker?{docker:e,dockedShape:e.getDockedShape(),refPoint:e.referencePoint}:undefined}).compact()},execute:function(){this.dockers.each(function(d){d.docker.setDockedShape(undefined)})},rollback:function(){this.dockers.each(function(d){d.docker.setDockedShape(d.dockedShape);d.docker.setReferencePoint(d.refPoint)})}});command=new a(c);command.execute();return command},});if(!ORYX.Plugins){ORYX.Plugins={}}if(!ORYX.Plugins.Layouter){ORYX.Plugins.Layouter={}}new function(){ORYX.Plugins.Layouter.EdgeLayouter=ORYX.Plugins.AbstractLayouter.extend({layouted:["http://b3mn.org/stencilset/bpmn1.1#SequenceFlow","http://b3mn.org/stencilset/bpmn1.1#MessageFlow","http://b3mn.org/stencilset/timjpdl3#SequenceFlow","http://b3mn.org/stencilset/jbpm4#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0choreography#MessageFlow","http://b3mn.org/stencilset/bpmn2.0choreography#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink","http://b3mn.org/stencilset/epc#ControlFlow","http://www.signavio.com/stencilsets/processmap#ProcessLink","http://www.signavio.com/stencilsets/organigram#connection"],layout:function(a){a.each(function(c){this.doLayout(c)}.bind(this))},doLayout:function(c){var e=c.getIncomingNodes()[0];var d=c.getOutgoingNodes()[0];if(!e||!d){return}var a=this.getPositions(e,d,c);if(a.length>0){this.setDockers(c,a[0].a,a[0].b)}},getPositions:function(u,d,f){var z=u.absoluteBounds();var e=d.absoluteBounds();var B=z.center();var y=e.center();var t=z.midPoint();var c=e.midPoint();var A=f.getStencil().keepState();if(A&&f.dockers.length<=3){var x=u.getOverlap(d);if(x){var r=Math.round(Math.min(z.lowerRight().x,e.lowerRight().x)-Math.max(z.upperLeft().x,e.upperLeft().x));var w=Math.round(Math.min(z.lowerRight().y,e.lowerRight().y)-Math.max(z.upperLeft().y,e.upperLeft().y));var v=12;if(r>v||w>v){var h=f.dockers.first().getAbsoluteReferencePoint();var n=f.dockers.last().getAbsoluteReferencePoint();if(x.isIncluded({x:r>0?h.x:x.center().x,y:r>0?x.center().y:h.y})&&x.isIncluded({x:r>0?n.x:x.center().x,y:r>0?x.center().y:n.y})){return[]}}else{f.dockers.first().setReferencePoint(t);f.dockers.last().setReferencePoint(c)}}}var g=Object.clone(f.dockers.first().referencePoint);var p=Object.clone(f.dockers.last().referencePoint);var o=f.dockers.first().getAbsoluteReferencePoint();var q=f.dockers.last().getAbsoluteReferencePoint();if(Math.abs(o.x-q.x)<1||Math.abs(o.y-q.y)<1){return[]}var s={};s.x=B.x<y.x?(((y.x-e.width()/2)-(B.x+z.width()/2))/2)+(B.x+z.width()/2):(((B.x-z.width()/2)-(y.x+e.width()/2))/2)+(y.x+e.width()/2);s.y=B.y<y.y?(((y.y-e.height()/2)-(B.y+z.height()/2))/2)+(B.y+z.height()/2):(((B.y-z.height()/2)-(y.y+e.height()/2))/2)+(y.y+e.height()/2);z.widen(5);e.widen(20);var l=[];var C=this.getOffset.bind(this);if(!z.isIncluded(y.x,B.y)&&!e.isIncluded(y.x,B.y)){l.push({a:{x:y.x+C(p,c,"x"),y:B.y+C(g,t,"y")},z:this.getWeight(u,B.x<y.x?"r":"l",d,B.y<y.y?"t":"b",f)*(A?2:1)})}if(!z.isIncluded(B.x,y.y)&&!e.isIncluded(B.x,y.y)){l.push({a:{x:B.x+C(g,t,"x"),y:y.y+C(p,c,"y")},z:this.getWeight(u,B.y<y.y?"b":"t",d,B.x<y.x?"l":"r",f)*(A?2:1)})}if((!z.isIncluded(s.x,B.y)&&!e.isIncluded(s.x,y.y))||(!z.isIncluded(s.x,B.y)&&e.isIncluded(s.x,B.y))){l.push({a:{x:s.x,y:B.y+C(g,t,"y")},b:{x:s.x,y:y.y+C(p,c,"y")},z:this.getWeight(u,"r",d,"l",f,B.x>y.x)})}if((!z.isIncluded(B.x,s.y)&&!e.isIncluded(y.x,s.y))||(!z.isIncluded(B.x,y.y)&&e.isIncluded(B.x,y.y))){l.push({a:{x:B.x+C(g,t,"x"),y:s.y},b:{x:y.x+C(p,c,"x"),y:s.y},z:this.getWeight(u,"b",d,"t",f,B.y>y.y)})}return l.sort(function(D,m){return D.z<m.z?1:(D.z==m.z?-1:-1)})},getOffset:function(d,c,a){return d[a]-c[a]},getWeight:function(p,c,q,a,f,l){c=(c||"").toLowerCase();a=(a||"").toLowerCase();if(!["t","r","b","l"].include(c)){c="r"}if(!["t","r","b","l"].include(a)){c="l"}if(l){c=c=="t"?"b":(c=="r"?"l":(c=="b"?"t":(c=="l"?"r":"r")));a=a=="t"?"b":(a=="r"?"l":(a=="b"?"t":(a=="l"?"r":"r")))}var h=0;var e=this.facade.getCanvas().getOrientation();var s=this.facade.getRules().getLayoutingRules(p,f,e)["out"];var r=this.facade.getRules().getLayoutingRules(q,f,e)["in"];var g=s[c];var d=r[a];var o=function(v,u,t){switch(v){case"t":return Math.abs(u.x-t.x)<2&&u.y<t.y;case"r":return u.x>t.x&&Math.abs(u.y-t.y)<2;case"b":return Math.abs(u.x-t.x)<2&&u.y>t.y;case"l":return u.x<t.x&&Math.abs(u.y-t.y)<2;default:return false}};var n=p.getIncomingShapes().findAll(function(t){return t instanceof ORYX.Core.Edge}).any(function(t){return o(c,t.dockers[t.dockers.length-2].bounds.center(),t.dockers.last().bounds.center())});var m=q.getOutgoingShapes().findAll(function(t){return t instanceof ORYX.Core.Edge}).any(function(t){return o(a,t.dockers[1].bounds.center(),t.dockers.first().bounds.center())});return(n||m?0:g+d)},setDockers:function(e,d,c){if(!e){return}e.dockers.each(function(a){e.removeDocker(a)});[d,c].compact().each(function(f){var a=e.createDocker(undefined,f);a.bounds.centerMoveTo(f)});e.dockers.each(function(a){a.update()});e._update(true)}})}();if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.SyntaxChecker.name,functionality:this.perform.bind(this),group:ORYX.I18N.SyntaxChecker.group,icon:ORYX.PATH+"images/checker_syntax.png",description:ORYX.I18N.SyntaxChecker.desc,index:0,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this))},perform:function(a,c){if(!c){this.resetErrors()}else{this.checkForErrors({onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000})}.bind(this),onErrors:function(){this.enableDeactivationHandler(a)}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid)}.bind(this)})}},enableDeactivationHandler:function(a){var c=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,c)};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,c.bind(this))},setActivated:function(c,a){c.toggle(a);if(a===undefined){this.active=!this.active}else{this.active=a}},checkForErrors:function(a){Ext.applyIf(a||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var c=this.facade.getStencilSets();var e=null;var d=false;if(c.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0choreography#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")){e=this.facade.getSerializedJSON();d=true}else{e=this.getRDFFromDOM()}new Ajax.Request(ORYX.CONFIG.SYNTAXCHECKER_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data_json:e,context:a.context,isJson:d},onSuccess:function(f){var g=(f&&f.responseText?f.responseText:"{}").evalJSON();Ext.Msg.hide();if(g instanceof Object){g=$H(g);if(g.size()>0){if(a.showErrors){this.showErrors(g)}a.onErrors()}else{a.onNoErrors()}}else{a.onFailure()}}.bind(this),onFailure:function(){Ext.Msg.hide();a.onFailure()}})},doShowErrors:function(c,a){this.showErrors(c.errors)},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a)}a.keys().each(function(d){var c=this.facade.getCanvas().getChildShapeByResourceId(d);if(c){this.raiseOverlay(c,this.parseCodeToMsg(a[d]))}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000})},parseCodeToMsg:function(f){var g=f.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=g.split("<br />");for(var c=0;c<a.length;c++){var e=a[c];var d=this.parseSingleCodeToMsg(e);if(e!=d){g=g.replace(e,d)}}return g},parseSingleCodeToMsg:function(a){return ORYX.I18N.SyntaxChecker[a]||a},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[];this.active=false},raiseOverlay:function(a,c){var g="syntaxchecker."+this.raisedEventIds.length;var e=ORYX.Editor.provideId();var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:e,title:"","stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:g,shapes:[a],node:f,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});var d=new Ext.ToolTip({showDelay:50,html:c,target:e});this.raisedEventIds.push(g);return f}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ConfigurationExtension=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.ConfigurationExtension.name,functionality:this.perform.bind(this),group:ORYX.I18N.ConfigurationExtension.group,icon:ORYX.PATH+"images/configuration_extension.png",description:ORYX.I18N.ConfigurationExtension.desc,index:0,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.Plugins.ConfigurationExtension.TOGGLE_CONFIGURATION_ANNOTATION_VISIBILITY,this.toggleVisibility.bind(this))},perform:function(c,e){var a=this.facade.getCanvas().getHTMLContainer().ownerDocument.head.lastElementChild.sheet;try{while(a.cssRules.length>0){a.deleteRule(0)}if(e){a.insertRule(".configuration-extension { display: none }",0)}}catch(d){console.warn("Unable to insert CSS rule: "+d)}},setActivated:function(c,a){c.toggle(a);if(a===undefined){this.active=!this.active}else{this.active=a}},toggleVisibility:function(a){console.info("ConfigurationExtension toggled")},});ORYX.Plugins.ConfigurationExtension.TOGGLE_CONFIGURATION_ANNOTATION_VISIBILITY="toggleVisibility";if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SelectionExtension=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.SelectionExtension.name,functionality:this.showDialog.bind(this),group:ORYX.I18N.SelectionExtension.group,icon:ORYX.PATH+"images/selection_extension.png",description:ORYX.I18N.SelectionExtension.desc,index:1,minShape:0,maxShape:0});this.color="#7777FF";this.selectedVariants=[]},showDialog:function(){var d=this.findAllVariants();if(d.length==0){Ext.Msg.alert("There are no variants in this model to select.");return}if(this.minFrequency===undefined){this.minFrequency=1}if(this.maxFrequency===undefined){this.maxFrequency=d.length}var g=new Ext.form.FormPanel({baseCls:"x-plain",layout:"table",layoutConfig:{columns:2},labelWidth:50,defaultType:"textfield",items:[new Ext.form.Label({html:"<h4>Selected variants</h4>",colspan:2,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%"})]});g.variantCheckboxFields=[];var e=[];d.each(function(n){var l=new Ext.form.Checkbox({boxLabel:n,hideLabel:true,name:"variants"});l.setValue(this.selectedVariants.indexOf(n)>-1);g.variantCheckboxFields.push(l);g.add(l);var o=this.color;var m=d.indexOf(n);if(this.variantColorFields&&m>-1&&m<this.variantColorFields.length){o=this.variantColorFields[m].getValue()}var p=new Ext.ux.ColorField({value:o});e.push(p);g.add(p)}.bind(this));this.variantColorFields=e;g.add(new Ext.form.Label({text:"More than one",style:"padding-right: 0.5em"}));g.add(g.colorField=new Ext.ux.ColorField({fieldLabel:"Selection color",name:"color",value:this.color}));g.add(new Ext.Button({text:"All",style:"padding: 0.5em 1em",handler:function(){g.variantCheckboxFields.each(function(l){l.setValue(true)}.bind(this))}}));g.add(new Ext.Button({text:"Clear",style:"padding: 0.5em 1em",handler:function(){g.variantCheckboxFields.each(function(l){l.setValue(false)}.bind(this))}}));var h,a;var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[new Ext.form.Label({html:"<h4>Frequency range</h4>",colspan:2,style:"font-size:12px;margin-bottom:10px;margin-top:10px;display:block;",anchor:"100%"}),a=new Ext.form.NumberField({allowDecimals:false,allowNegative:false,fieldLabel:"Minimum",minValue:1,msgTarget:"side",name:"min",validator:function(l){if(l>h.getValue()){return"Minimum frequency cannot be greater than maximum frequency"}return true},value:this.minFrequency,width:50}),h=new Ext.form.NumberField({allowDecimals:false,allowNegative:false,fieldLabel:"Maximum",maxValue:d.length,msgTarget:"side",name:"max",validator:function(l){if(l<a.getValue()){return"Maximum frequency cannot be less than minimum frequency"}return true},value:this.maxFrequency,width:50})]});var f=new Ext.Window({autoCreate:true,layout:"table",layoutConfig:{columns:1},plain:true,bodyStyle:"padding:5px;",title:"Make selection",height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[g,c],buttons:[{text:"Select",handler:function(){var l=new Ext.LoadMask(Ext.getBody(),{msg:"Selecting checked variants"});l.show();window.setTimeout(function(){var n=[];for(k=0;k<d.length;k++){if(g.variantCheckboxFields[k].getValue()){n.push(d[k])}}this.selectedVariants=n;this.minFrequency=a.getValue();this.maxFrequency=h.getValue();this.color=g.colorField.getValue();try{this.selectVariants(n,this.minFrequency,this.maxFrequency);f.close()}catch(m){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,m.message)}finally{l.hide()}}.bind(this),100)}.bind(this)},{text:"Reset",handler:function(){var l=new Ext.LoadMask(Ext.getBody(),{msg:"Removing selection"});l.show();window.setTimeout(function(){try{this.resetSelection();f.close()}catch(m){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,m.message)}finally{l.hide()}}.bind(this),100)}.bind(this)},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){f.close()}.bind(this)}]});f.show()},selectVariants:function(a,d,f){try{var e=Object.create(null);this.facade.getCanvas().getChildShapes().each(function(g){e[g.resourceId]=[]}.bind(this));a.each(function(h){var g=this.findElementsInVariant([h]);g.each(function(l){e[l.resourceId].push(h)}.bind(this))}.bind(this));this.facade.getCanvas().getChildShapes().each(function(g){var l=e[g.resourceId];var h=l.length;g.setProperty("selected",d<=h&&h<=f);g.setProperty("selectioncolor",(h==1)?(this.variantColorFields[this.findAllVariants().indexOf(l[0])].getValue()):this.color);if(g.getProperty("selected")){g.node.removeAttributeNS(null,"style")}else{g.node.setAttributeNS(null,"style","opacity: 0.25")}}.bind(this));this.facade.getCanvas().update()}catch(c){alert("Unable to select variants "+variants+": "+c.message)}},resetSelection:function(){try{this.facade.getCanvas().getChildShapes().each(function(c){c.setProperty("selected",false);c.node.removeAttributeNS(null,"style")}.bind(this));this.facade.getCanvas().update()}catch(a){alert("Unable to clear selection: "+a.message)}},startStencilIds:["http://b3mn.org/stencilset/bpmn2.0#IntermediateLinkEventCatching","http://b3mn.org/stencilset/bpmn2.0#StartCompensationEvent","http://b3mn.org/stencilset/bpmn2.0#StartConditionalEvent","http://b3mn.org/stencilset/bpmn2.0#StartErrorEvent","http://b3mn.org/stencilset/bpmn2.0#StartEscalationEvent","http://b3mn.org/stencilset/bpmn2.0#StartMessageEvent","http://b3mn.org/stencilset/bpmn2.0#StartMultipleEvent","http://b3mn.org/stencilset/bpmn2.0#StartParallelMultipleEvent","http://b3mn.org/stencilset/bpmn2.0#StartNoneEvent","http://b3mn.org/stencilset/bpmn2.0#StartSignalEvent","http://b3mn.org/stencilset/bpmn2.0#StartTimerEvent"],endStencilIds:["http://b3mn.org/stencilset/bpmn2.0#EndCancelEvent","http://b3mn.org/stencilset/bpmn2.0#EndCompensationEvent","http://b3mn.org/stencilset/bpmn2.0#EndErrorEvent","http://b3mn.org/stencilset/bpmn2.0#EndEscalationEvent","http://b3mn.org/stencilset/bpmn2.0#EndMessageEvent","http://b3mn.org/stencilset/bpmn2.0#EndMultipleEvent","http://b3mn.org/stencilset/bpmn2.0#EndNoneEvent","http://b3mn.org/stencilset/bpmn2.0#EndSignalEvent","http://b3mn.org/stencilset/bpmn2.0#EndTerminateEvent","http://b3mn.org/stencilset/bpmn2.0#IntermediateLinkEventThrowing"],artifactStencilIds:["http://b3mn.org/stencilset/bpmn2.0#ConfigurationAnnotation","http://b3mn.org/stencilset/bpmn2.0#DataObject","http://b3mn.org/stencilset/bpmn2.0#DataStore","http://b3mn.org/stencilset/bpmn2.0#ITSystem","http://b3mn.org/stencilset/bpmn2.0#Message","http://b3mn.org/stencilset/bpmn2.0#TextAnnotation"],associationStencilIds:["http://b3mn.org/stencilset/bpmn2.0#Association_Undirected","http://b3mn.org/stencilset/bpmn2.0#Association_Unidirectional","http://b3mn.org/stencilset/bpmn2.0#Association_Bidirectional","http://b3mn.org/stencilset/bpmn2.0#MessageFlow"],findAllVariants:function(){var a=[];this.facade.getCanvas().getChildShapes().each(function(c){if(c.hasProperty("variants")&&c.properties["oryx-variants"]){var e=c.properties["oryx-variants"].evalJSON();for(i=0;i<e.totalCount;i++){var d=e.items[i].id;if(a.indexOf(d)==-1){a.push(d)}}}}.bind(this));a.sort();return a},findElementsWithStencilIds:function(a){var c=[];this.facade.getCanvas().getChildShapes().each(function(d){if(a.indexOf(d.getStencil().id())>-1){c.push(d)}}.bind(this));return c},findElementsInVariant:function(m){var o=this.findElementsWithStencilIds(this.startStencilIds);var c=this.findElementsWithStencilIds(this.endStencilIds);var h=this.findElementsWithStencilIds(this.artifactStencilIds);var d=this.findElementsWithStencilIds(this.associationStencilIds);var g=function(q){if("http://b3mn.org/stencilset/bpmn2.0#SequenceFlow"==q.getStencil().id()&&q.hasProperty("variants")&&q.properties["oryx-variants"]){var p=q.properties["oryx-variants"].evalJSON();var r=false;for(i=0;i<p.totalCount;i++){for(j=0;j<m.length;j++){if(m[j]==p.items[i].id){r=true}}}return r}else{return true}};var e=[];var l=function(p){if(g(p)&&e.indexOf(p)==-1&&d.indexOf(p)==-1){e.push(p);p.getOutgoingShapes().each(function(q){l(q)}.bind(this))}};o.each(function(p){l(p)}.bind(this));var n=[];var f=function(p){if(g(p)&&n.indexOf(p)==-1&&d.indexOf(p)==-1){n.push(p);p.getIncomingShapes().each(function(q){f(q)}.bind(this))}};c.each(function(p){f(p)}.bind(this));var a=[];this.facade.getCanvas().getChildShapes().each(function(p){if(e.indexOf(p)>-1&&n.indexOf(p)>-1){a.push(p)}}.bind(this));d.each(function(p){var q=function(s,r){s.each(function(t){if(a.indexOf(t)>-1){r.each(function(u){if(h.indexOf(u)>-1){if(a.indexOf(p)==-1){a.push(p)}if(a.indexOf(u)==-1){a.push(u)}}else{if(a.indexOf(u)>-1){if(a.indexOf(p)==-1){a.push(p)}}}}.bind(this))}}.bind(this))};q(p.getIncomingShapes(),p.getOutgoingShapes());q(p.getOutgoingShapes(),p.getIncomingShapes())}.bind(this));return a},});Ext.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:"Browse...",buttonOnly:false,buttonOffset:3,readOnly:true,autoSize:Ext.emptyFn,initComponent:function(){Ext.form.FileUploadField.superclass.initComponent.call(this);this.addEvents("fileselected")},onRender:function(d,a){Ext.form.FileUploadField.superclass.onRender.call(this,d,a);this.wrap=this.el.wrap({cls:"x-form-field-wrap x-form-file-wrap"});this.el.addClass("x-form-file-text");this.el.dom.removeAttribute("name");this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:"x-form-file",tag:"input",type:"file",size:1});var c=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(c,{renderTo:this.wrap,cls:"x-form-file-btn"+(c.iconCls?" x-btn-icon":"")}));if(this.buttonOnly){this.el.hide();this.wrap.setWidth(this.button.getEl().getWidth())}this.fileInput.on("change",function(){var e=this.fileInput.dom.value;this.setValue(e);this.fireEvent("fileselected",this,e)},this)},getFileInputId:function(){return this.id+"-file"},onResize:function(a,c){Ext.form.FileUploadField.superclass.onResize.call(this,a,c);this.wrap.setWidth(a);if(!this.buttonOnly){var a=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset;this.el.setWidth(a)}},preFocus:Ext.emptyFn,getResizeEl:function(){return this.wrap},getPositionEl:function(){return this.wrap},alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0])}});Ext.reg("fileuploadfield",Ext.form.FileUploadField);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AnimationExtension=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.AnimationExtension.name,functionality:this.showDialog.bind(this),group:ORYX.I18N.AnimationExtension.group,icon:ORYX.PATH+"images/animation_extension.png",description:ORYX.I18N.AnimationExtension.desc,index:2,minShape:0,maxShape:0})},showDialog:function(){var e=this.facade.getJSON();e=Ext.encode(e);var d=document.createElement("input");d.setAttribute("type","hidden");d.setAttribute("value",e);d.setAttribute("id","jsonForAnimation");document.body.appendChild(d);var a=new Ext.FormPanel({fileUpload:true,width:500,frame:true,autoHeight:true,bodyStyle:"padding: 10px 10px 0 10px;",labelWidth:50,defaults:{anchor:"95%",allowBlank:false,msgTarget:"side"},items:[new Ext.form.Hidden({id:"json",name:"json",value:d.getAttribute("value")}),new Ext.form.FileUploadField({id:"form-file",emptyText:"Select a process log",fieldLabel:"Log file",name:"log",buttonCfg:{text:"",iconCls:"upload-icon"}}),new Ext.ux.ColorField({fieldLabel:"Color",name:"color",value:"#7777FF"})]});var c=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:"Select log files for animation",height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[a],buttons:[{text:"Animate",handler:function(){if(a.getForm().isValid()){a.getForm().submit({url:ORYX.CONFIG.EDITOR_PATH+"/editor/bpmnanimation",params:{newStatus:"delivered"},waitMsg:"Uploading process log(s)...",success:function(f,m){var g=document.getElementById("jsonForAnimation");if(!g){g=document.createElement("input");g.setAttribute("type","hidden");g.setAttribute("id","jsonForAnimation");document.body.appendChild(g)}g.setAttribute("value",e);m.result.success=undefined;var l=Ext.encode(m.result);console.log("data");console.dir(m.result);console.log(l);var h=document.getElementById("jsonForAnimation2");if(!h){h=document.createElement("input");h.setAttribute("type","hidden");h.setAttribute("id","jsonForAnimation2");document.body.appendChild(h)}h.setAttribute("value",l);window.open(ORYX.CONFIG.EDITOR_PATH+"/editor/animation/animation.html","_blank")},failure:function(f,g){switch(g.failureType){case Ext.form.Action.CLIENT_INVALID:Ext.Msg.alert("Failure","Form fields may not be submitted with invalid values");break;case Ext.form.Action.CONNECT_FAILURE:Ext.Msg.alert("Failure","Ajax communication failed");break;case Ext.form.Action.SERVER_INVALID:Ext.Msg.alert("Failure","Server Error. Please read the server log.");break;default:Ext.Msg.alert("Failure","Unknown server failure code: "+g.failureType)}}})}}},{text:"Add log",handler:function(){a.add(new Ext.form.FileUploadField({emptyText:"Select a process log",fieldLabel:"Log file",name:"log",buttonCfg:{text:"",iconCls:"upload-icon"}}));a.add(new Ext.ux.ColorField({fieldLabel:"Color",name:"color",value:(c.defaultLogColors.length>0)?c.defaultLogColors.pop():"black"}));a.doLayout(false)}},{text:"Reset",handler:function(){a.getForm().reset()}},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){c.close()}.bind(this)}]});c.defaultLogColors=["#FF00FF","#00CCFF","FFCC00","#00CC00"];c.show()},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}new function(){ORYX.Plugins.BPMN11={construct:function(c){this.facade=c;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.bpmn11.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmn11.subprocess",this.handleSubProcess.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,this.handleShapeRemove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));this.stencilsetNs=c.getStencilSets().entries()[0][0]},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(c){if(c.getStencil().id().endsWith("Pool")){this.handleLayoutPool({shape:c})}}.bind(this))},onSelectionChanged:function(h){var f=h.elements;if(f&&f.length===1){var c=f[0];if(c.getStencil().idWithoutNs()==="Pool"){if(c.getChildNodes().length===0){var e={type:this.stencilsetNs+"Lane",position:{x:0,y:0},namespace:c.getStencil().namespace(),parent:c};this.facade.createShape(e);this.facade.getCanvas().update();this.facade.setSelection([c])}}}if(f.any(function(m){return m instanceof ORYX.Core.Node&&m.getStencil().id().endsWith("Lane")})){var d=f.findAll(function(m){return m instanceof ORYX.Core.Node&&m.getStencil().id().endsWith("Lane")});var g=[];var l=[];d.each(function(m){g.push(this.getParentPool(m))}.bind(this));g=g.uniq().findAll(function(m){var n=this.getLanes(m,true);if(n.all(function(o){return d.include(o)})){l=l.concat(n);return true}else{if(f.include(m)&&n.any(function(o){return d.include(o)})){l=l.concat(n);return true}else{return false}}}.bind(this));if(l.length>0&&g.length>0){f=f.without.apply(f,l);f=f.concat(g);this.facade.setSelection(f.uniq())}}},handleShapeRemove:function(f){var g=f.shape;var n=f.parent;if(g instanceof ORYX.Core.Node&&g.getStencil().idWithoutNs()==="Lane"&&this.facade.isExecutingCommands()){var h=this.getParentPool(n);if(h&&h.parent){var l=function(o){return !o.getChildNodes().any(function(p){return p.getStencil().idWithoutNs()==="Lane"})};var d=l(g);var m=n.getChildNodes().any(function(o){return o.getStencil().idWithoutNs()==="Lane"});if(d&&m){var e=new a(g,n,h,this);this.facade.executeCommands([e])}else{if(!d&&!this.facade.getSelection().any(function(o){return o instanceof ORYX.Core.Node&&o.getStencil().idWithoutNs()==="Lane"&&o.isParent(g)&&l(o)})){var c=ORYX.Core.Command.extend({construct:function(o,p){this.children=o.getChildNodes(true);this.facade=p},execute:function(){this.children.each(function(o){o.bounds.moveBy(30,0)});this.facade.getCanvas().update()},rollback:function(){this.children.each(function(o){o.bounds.moveBy(-30,0)});this.facade.getCanvas().update()}});this.facade.executeCommands([new c(g,this.facade)])}else{if(d&&!m&&n==h){n.add(g)}}}}}},hashedSubProcesses:{},hashChildShapes:function(c){var d=c.getChildNodes();d.each(function(e){if(this.hashedSubProcesses[e.id]){this.hashedSubProcesses[e.id]=e.absoluteXY();this.hashedSubProcesses[e.id].width=e.bounds.width();this.hashedSubProcesses[e.id].height=e.bounds.height();this.hashChildShapes(e)}}.bind(this))},handleSubProcess:function(e){var d=e.shape;if(!this.hashedSubProcesses[d.id]){this.hashedSubProcesses[d.id]=d.absoluteXY();this.hashedSubProcesses[d.id].width=d.bounds.width();this.hashedSubProcesses[d.id].height=d.bounds.height();return}var f=d.absoluteXY();f.x-=this.hashedSubProcesses[d.id].x;f.y-=this.hashedSubProcesses[d.id].y;var c=this.hashedSubProcesses[d.id].width!==d.bounds.width()||this.hashedSubProcesses[d.id].height!==d.bounds.height();this.hashedSubProcesses[d.id]=d.absoluteXY();this.hashedSubProcesses[d.id].width=d.bounds.width();this.hashedSubProcesses[d.id].height=d.bounds.height();this.hashChildShapes(d);if(this.facade.isExecutingCommands()&&!c){this.moveChildDockers(d,f)}},moveChildDockers:function(e,h){if(!h.x&&!h.y){return}var f=e.getChildNodes(true);var d=f.map(function(l){return[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes())}).flatten().uniq().map(function(l){return l.dockers.length>2?l.dockers.slice(1,l.dockers.length-1):[]}).flatten();var c=e.absoluteBounds();c.moveBy(-h.x,-h.y);var g={};d.each(function(o){if(o.isChanged){return}var m=Object.clone(h);if(!c.isIncluded(o.bounds.center())){var q=o.parent.dockers.indexOf(o);var u=o.parent.dockers.length;var s=o.parent.getSource();var t=o.parent.getTarget();var n=f.include(s)&&f.include(t);if(!n){var p=q!==0?c.isIncluded(o.parent.dockers[q-1].bounds.center()):false;var r=q!==u-1?c.isIncluded(o.parent.dockers[q+1].bounds.center()):false;if(!p&&!r){return}var l=o.parent.dockers[p?q-1:q+1];if(Math.abs(-Math.abs(l.bounds.center().x-o.bounds.center().x))<2){m.y=0}else{if(Math.abs(-Math.abs(l.bounds.center().y-o.bounds.center().y))<2){m.x=0}else{return}}}}g[o.getId()]={docker:o,offset:m}});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(g)])},handleDockerDocked:function(e){var f=e.parent;var d=e.target;if(f.getStencil().id()===this.stencilsetNs+"SequenceFlow"){var c=d.getStencil().groups().find(function(g){if(g=="Gateways"){return g}});if(!c&&(f.properties["oryx-conditiontype"]=="Expression")){f.setProperty("oryx-showdiamondmarker",true)}else{f.setProperty("oryx-showdiamondmarker",false)}this.facade.getCanvas().update()}},handlePropertyChanged:function(e){var d=e.elements;var f=e.key;var c=e.value;var g=false;d.each(function(l){if((l.getStencil().id()===this.stencilsetNs+"SequenceFlow")&&(f==="oryx-conditiontype")){if(c!="Expression"){l.setProperty("oryx-showdiamondmarker",false)}else{var m=l.getIncomingShapes();if(!m){l.setProperty("oryx-showdiamondmarker",true)}var h=m.find(function(n){var o=n.getStencil().groups().find(function(p){if(p=="Gateways"){return p}});if(o){return o}});if(!h){l.setProperty("oryx-showdiamondmarker",true)}else{l.setProperty("oryx-showdiamondmarker",false)}}g=true}}.bind(this));if(g){this.facade.getCanvas().update()}},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},handleLayoutPool:function(q){var m=q.shape;var A=this.facade.getSelection();var s=A.include(m)?m:A.first();if(s instanceof ORYX.Core.UIObject){s=s.isParent(m)?s:m}else{s=m}if(!(s.getStencil().id().endsWith("Pool")||s.getStencil().id().endsWith("Lane"))){return}if(!this.hashedBounds[m.id]){this.hashedBounds[m.id]={}}this.currentPool=m;var u=this.getLanes(m);if(u.length<=0){return}var t=this.getLanes(m,true);var e=t.clone();if(u.length===1&&this.getLanes(u.first()).length<=0){u.first().setProperty("oryx-showcaption",u.first().properties["oryx-name"].trim().length>0)}else{t.invoke("setProperty","oryx-showcaption",true)}var p=[];var l=[];var r=-1;while(++r<t.length){if(!this.hashedBounds[m.id][t[r].id]){l.push(t[r])}}if(l.length>0){s=l.first()}var w=$H(this.hashedBounds[m.id]).keys();var r=-1;while(++r<w.length){if(!t.any(function(x){return x.id==w[r]})){p.push(this.hashedBounds[m.id][w[r]]);A=A.without(function(x){return x.id==w[r]})}}var n,o,h,g;if(p.length>0||l.length>0){if(l.length===1&&this.getLanes(l[0].parent).length===1){n=this.adjustHeight(u,l[0].parent)}else{n=this.updateHeight(m)}o=this.adjustWidth(u,m.bounds.width());m.update()}else{if(m==s){if(A.length===1&&this.isResized(m,this.hashedPoolPositions[m.id])){var v=this.hashedPoolPositions[m.id].upperLeft();var d=m.bounds.upperLeft();var z=0;if(this.shouldScale(m)){var c=this.hashedPoolPositions[m.id];z=c.height()/m.bounds.height()}this.adjustLanes(m,t,v.x-d.x,v.y-d.y,z)}n=this.adjustHeight(u,undefined,m.bounds.height());o=this.adjustWidth(u,m.bounds.width())}else{if(A.length===1&&this.isResized(s,this.hashedBounds[m.id][s.id])){var v=this.hashedBounds[m.id][s.id].upperLeft();var d=s.absoluteXY();h=v.x-d.x;g=v.y-d.y;if(h||g){e=e.without(s);this.adjustLanes(m,this.getAllExcludedLanes(m,s),h,0)}var f=this.getLanes(s,true);if(f.length>0){if(this.shouldScale(s)){var c=this.hashedBounds[m.id][s.id];var z=c.height()/s.bounds.height();this.adjustLanes(m,f,h,g,z)}else{this.adjustLanes(m,f,h,g,0)}}}n=this.adjustHeight(u,s);o=this.adjustWidth(u,s.bounds.width()+(this.getDepth(s,m)*30))}}this.setDimensions(m,o,n,h,g);if(this.facade.isExecutingCommands()&&(p.length===0||l.length!==0)){this.updateDockers(e,m)}this.hashedBounds[m.id]={};var r=-1;while(++r<t.length){this.hashedBounds[m.id][t[r].id]=t[r].absoluteBounds();this.hashChildShapes(t[r]);this.hashedLaneDepth[t[r].id]=this.getDepth(t[r],m);this.forceToUpdateLane(t[r])}this.hashedPoolPositions[m.id]=m.bounds.clone()},shouldScale:function(c){var d=c.getChildNodes().findAll(function(e){return e.getStencil().id().endsWith("Lane")});return d.length>1||d.any(function(e){return this.shouldScale(e)}.bind(this))},isResized:function(c,e){if(!e||!c){return false}var d=e;return Math.round(d.width()-c.bounds.width())!==0||Math.round(d.height()-c.bounds.height())!==0},adjustLanes:function(e,d,c,g,f){f=f||0;d.each(function(h){h.getChildNodes().each(function(m){if(!m.getStencil().id().endsWith("Lane")){var l=f?m.bounds.center().y-(m.bounds.center().y/f):-g;m.bounds.moveBy((c||0),-l);if(f&&m.getStencil().id().endsWith("Subprocess")){this.moveChildDockers(m,{x:(0),y:-l})}}}.bind(this));this.hashedBounds[e.id][h.id].moveBy(-(c||0),!f?-g:0);if(f){h.isScaled=true}}.bind(this))},getAllExcludedLanes:function(e,c){var d=[];e.getChildNodes().each(function(f){if((!c||f!==c)&&f.getStencil().id().endsWith("Lane")){d.push(f);d=d.concat(this.getAllExcludedLanes(f,c))}}.bind(this));return d},forceToUpdateLane:function(c){if(c.bounds.height()!==c._svgShapes[0].height){c.isChanged=true;c.isResized=true;c._update()}},getDepth:function(e,d){var c=0;while(e&&e.parent&&e!==d){e=e.parent;++c}return c},updateDepth:function(d,c,e){var f=(c-e)*30;d.getChildNodes().each(function(g){g.bounds.moveBy(f,0);[].concat(children[j].getIncomingShapes()).concat(children[j].getOutgoingShapes())})},setDimensions:function(f,g,d,c,h){var e=f.getStencil().id().endsWith("Lane");f.bounds.set(e?30:(f.bounds.a.x-(c||0)),e?f.bounds.a.y:(f.bounds.a.y-(h||0)),g?f.bounds.a.x+g-(e?30:(c||0)):f.bounds.b.x,d?f.bounds.a.y+d-(e?0:(h||0)):f.bounds.b.y)},setLanePosition:function(c,d){c.bounds.moveTo(30,d)},adjustWidth:function(c,d){(c||[]).each(function(e){this.setDimensions(e,d);this.adjustWidth(this.getLanes(e),d-30)}.bind(this));return d},adjustHeight:function(f,h,d){var l=0;if(!h&&d){var g=-1;while(++g<f.length){l+=f[g].bounds.height()}}var g=-1;var c=0;while(++g<f.length){if(f[g]===h){this.adjustHeight(this.getLanes(f[g]),undefined,f[g].bounds.height());f[g].bounds.set({x:30,y:c},{x:f[g].bounds.width()+30,y:f[g].bounds.height()+c})}else{if(!h&&d){var e=(f[g].bounds.height()*d)/l;this.adjustHeight(this.getLanes(f[g]),undefined,e);this.setDimensions(f[g],null,e);this.setLanePosition(f[g],c)}else{var e=this.adjustHeight(this.getLanes(f[g]),h,d);if(!e){e=f[g].bounds.height()}this.setDimensions(f[g],null,e);this.setLanePosition(f[g],c)}}c+=f[g].bounds.height()}return c},updateHeight:function(d){var e=this.getLanes(d);if(e.length==0){return d.bounds.height()}var c=0;var f=-1;while(++f<e.length){this.setLanePosition(e[f],c);c+=this.updateHeight(e[f])}this.setDimensions(d,null,c);return c},getOffset:function(c,e,d){var g={x:0,y:0};var g=c.absoluteXY();var f=this.hashedBounds[d.id][c.id]||(e===true?this.hashedPoolPositions[c.id]:undefined);if(f){g.x-=f.upperLeft().x;g.y-=f.upperLeft().y}else{return{x:0,y:0}}return g},getNextLane:function(c){while(c&&!c.getStencil().id().endsWith("Lane")){if(c instanceof ORYX.Core.Canvas){return null}c=c.parent}return c},getParentPool:function(c){while(c&&!c.getStencil().id().endsWith("Pool")){if(c instanceof ORYX.Core.Canvas){return null}c=c.parent}return c},updateDockers:function(A,t){var r=t.absoluteBounds();var s=(this.hashedPoolPositions[t.id]||r).clone();var z=-1,y=-1,x=-1,v=-1,u;var B={};while(++z<A.length){if(!this.hashedBounds[t.id][A[z].id]){continue}var e=A[z].isScaled;delete A[z].isScaled;var m=A[z].getChildNodes();var p=A[z].absoluteBounds();var f=(this.hashedBounds[t.id][A[z].id]||p);var n=this.getOffset(A[z],true,t);var g=0;var D=this.getDepth(A[z],t);if(this.hashedLaneDepth[A[z].id]!==undefined&&this.hashedLaneDepth[A[z].id]!==D){g=(this.hashedLaneDepth[A[z].id]-D)*30;n.x+=g}y=-1;while(++y<m.length){if(g&&!m[y].getStencil().id().endsWith("Lane")){m[y].bounds.moveBy(g,0)}if(m[y].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(m[y],n)}var d=[].concat(m[y].getIncomingShapes()).concat(m[y].getOutgoingShapes()).findAll(function(l){return l instanceof ORYX.Core.Edge}).uniq();x=-1;while(++x<d.length){if(d[x].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(m[y],[d[x]],n);continue}v=-1;while(++v<d[x].dockers.length){u=d[x].dockers[v];if(u.getDockedShape()||u.isChanged){continue}pos=u.bounds.center();var c=f.isIncluded(pos);var q=!s.isIncluded(pos);var h=v==0?c:f.isIncluded(d[x].dockers[v-1].bounds.center());var o=v==d[x].dockers.length-1?c:f.isIncluded(d[x].dockers[v+1].bounds.center());var C=Object.clone(n);if(e&&c&&this.isResized(A[z],this.hashedBounds[t.id][A[z].id])){var w=(pos.y-p.upperLeft().y+C.y);C.y-=(w-(w*(p.height()/f.height())))}if(c){B[u.id]={docker:u,offset:C}}}}}}this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(B)])},moveBy:function(d,c){d.x+=c.x;d.y+=c.y;return d},getHashedBounds:function(c){return this.currentPool&&this.hashedBounds[this.currentPool.id][c.id]?this.hashedBounds[this.currentPool.id][c.id]:c.bounds.clone()},getLanes:function(c,e){var d=c.getChildNodes(e||false).findAll(function(f){return(f.getStencil().id()===this.stencilsetNs+"Lane")}.bind(this));d=d.sort(function(x,v){var w=Math.round(x.bounds.upperLeft().y);var q=Math.round(v.bounds.upperLeft().y);var t=Math.round(x.bounds.lowerRight().y);var n=Math.round(v.bounds.lowerRight().y);var h=this.getHashedBounds(x);var g=this.getHashedBounds(v);var p=Math.round(h.upperLeft().y);var z=Math.round(g.upperLeft().y);var m=Math.round(h.lowerRight().y);var y=Math.round(g.lowerRight().y);if(w==q&&t==n){w=p;q=z;t=m;n=y}if(Math.round(x.bounds.height()-h.height())===0&&Math.round(v.bounds.height()-g.height())===0){return w<q?-1:(w>q?1:0)}var u=w<q&&t<n;var r=w>q&&t>n;var l=w<q&&t>=n&&m<y;var o=w>=q&&t<n&&p<z;var s=w>q&&t<=n&&m>y;var f=w<=q&&t>n&&p>z;return(u||l||o?-1:(r||s||f?1:0))}.bind(this));return d}};var a=ORYX.Core.Command.extend({construct:function(c,e,d,f){this.facade=f.facade;this.plugin=f;this.shape=c;this.changes;this.pool=d;this.parent=e;this.shapeChildren=[];this.shape.getChildShapes().each(function(g){this.shapeChildren.push({shape:g,bounds:{a:{x:g.bounds.a.x,y:g.bounds.a.y},b:{x:g.bounds.b.x,y:g.bounds.b.y}}})}.bind(this));this.shapeUpperLeft=this.shape.absoluteXY();this.parentHeight=this.parent.bounds.height()},getLeafLanes:function(c){var d=this.plugin.getLanes(c).map(function(e){return this.getLeafLanes(e)}.bind(this)).flatten();return d.length>0?d:[c]},findNewLane:function(){var c=this.plugin.getLanes(this.parent);var d=this.getLeafLanes(this.parent);d=d.sort(function(f,e){var h=f.absoluteXY().y;var g=e.absoluteXY().y;return h<g?-1:(h>g?1:0)});this.lane=d.find(function(e,f){return f==d.length-1||e.absoluteXY().y>=this.shapeUpperLeft.y}.bind(this));this.laneUppperLeft=this.lane.absoluteXY()},execute:function(){if(this.changes){this.executeAgain();return}if(!this.lane){this.findNewLane()}if(this.lane){var g=this.laneUppperLeft;var e=this.shapeUpperLeft;var d=this.plugin.getDepth(this.lane,this.parent)-1;this.changes=$H({});if(g.y>e.y){this.lane.getChildShapes().each(function(h){if(!this.changes[h.getId()]){this.changes[h.getId()]=this.computeChanges(h,this.lane,this.lane,this.shape.bounds.height())}h.bounds.moveBy(0,this.shape.bounds.height())}.bind(this));this.plugin.hashChildShapes(this.lane);this.shapeChildren.each(function(h){h.shape.bounds.set(h.bounds);h.shape.bounds.moveBy((e.x-30)-(d*30),0);if(!this.changes[h.shape.getId()]){this.changes[h.shape.getId()]=this.computeChanges(h.shape,this.shape,this.lane,0)}this.lane.add(h.shape)}.bind(this));this.lane.bounds.moveBy(0,e.y-g.y)}else{if(e.y>g.y){this.shapeChildren.each(function(h){h.shape.bounds.set(h.bounds);h.shape.bounds.moveBy((e.x-30)-(d*30),this.lane.bounds.height());if(!this.changes[h.shape.getId()]){this.changes[h.shape.getId()]=this.computeChanges(h.shape,this.shape,this.lane,0)}this.lane.add(h.shape)}.bind(this))}}}var f=this.lane.bounds.height();var c=this.lane.length===1?this.parentHeight:this.lane.bounds.height()+this.shape.bounds.height();this.setHeight(c,f,this.parent,this.parentHeight,true);this.update()},setHeight:function(c,g,f,e,d){this.plugin.setDimensions(this.lane,this.lane.bounds.width(),c);this.plugin.hashedBounds[this.pool.id][this.lane.id]=this.lane.absoluteBounds();this.plugin.adjustHeight(this.plugin.getLanes(f),this.lane);if(d===true){this.changes[this.shape.getId()]=this.computeChanges(this.shape,f,f,0,g,c)}this.plugin.setDimensions(f,f.bounds.width(),e);if(f!==this.pool){this.plugin.setDimensions(this.pool,this.pool.bounds.width(),this.pool.bounds.height()+(c-g))}},update:function(){this.plugin.hashedBounds[this.pool.id]["REMOVED"]=true;this.facade.getCanvas().update()},rollback:function(){var d=this.laneUppperLeft;var c=this.shapeUpperLeft;this.changes.each(function(l){var h=l.value.oldParent;var f=l.value.shape;var g=l.value.parentHeight;var m=l.value.oldHeight;var e=l.value.newHeight;if(m){this.setHeight(m,e,h,h.bounds.height()+(m-e));if(d.y>c.y){this.lane.bounds.moveBy(0,this.shape.bounds.height())}}else{h.add(f);f.bounds.moveTo(l.value.oldPosition)}}.bind(this))},executeAgain:function(){this.changes.each(function(g){var e=g.value.newParent;var d=g.value.shape;var c=g.value.newHeight;var l=g.value.oldHeight;if(c){var h=this.laneUppperLeft.y;var f=this.shapeUpperLeft.y;if(h>f){this.lane.bounds.moveBy(0,f-h)}this.setHeight(c,l,e,e.bounds.height()+(c-l))}else{e.add(d);d.bounds.moveTo(g.value.newPosition)}}.bind(this));this.update()},computeChanges:function(e,n,m,d,o,c){n=this.changes[e.getId()]?this.changes[e.getId()].oldParent:n;var l=this.changes[e.getId()]?this.changes[e.getId()].oldPosition:e.bounds.upperLeft();var g=e.bounds.upperLeft();var f={x:g.x,y:g.y+d};var h={shape:e,parentHeight:n.bounds.height(),oldParent:n,oldPosition:l,oldHeight:o,newParent:m,newPosition:f,newHeight:c};return h}});ORYX.Plugins.BPMN11=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN11)}();if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayout";ORYX.Plugins.BpmnLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-BPMN",description:"Layout BPMN Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.BPMN_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON(),output:"coordinatesonly"},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(c){var a=ORYX.Core.Command.extend({construct:function(g,f){this.layoutArray=g;this.plugin=f;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(l){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(l.id);var h={id:l.id,bounds:f.bounds.clone()};this.oldLayoutArray.push(h);var g=l.bounds.split(" ");f.bounds.set(g[0],g[1],g[2],g[3]);if(l.dockers!=null){this.plugin.setDockersBad(f,l.dockers)}f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(g){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(g.id);f.bounds.set(g.bounds);f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var e=c.responseText.evalJSON();if(e instanceof Array&&e.size()>0){var d=new a(e,this);this.facade.executeCommands([d])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(d,a){var c="";a.each(function(e){c+=e.x+" "+e.y+" "});c+=" # ";d.deserialize([{prefix:"oryx",name:"dockers",value:c}])},setDockersGood:function(d,a){if(elem.dockers.length==1){}else{var a=d.getDockers().slice(1,-1);a.each(function(g){d.removeDocker(g)});var f=d.getDockers()[0];if(f.getDockedShape()){f.setReferencePoint(elem.dockers[0])}else{f.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}f.refresh();var e=d.getDockers()[1];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{e.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}e.refresh();var c=elem.dockers.slice(1,-1);c.each(function(h){var g=d.createDocker(undefined,h);g.parent=d;g.bounds.centerMoveTo(h.x,h.y);g.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}new function(){ORYX.Plugins.BPMN2_0={construct:function(c){this.facade=c;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.subprocess",this.handleSubProcess.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_HASHCHILD,this.handleHashChild.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,this.handleShapeRemove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));this.namespace=undefined},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(c){if(c.getStencil().id().endsWith("Pool")){this.handleLayoutPool({shape:c})}}.bind(this))},onSelectionChanged:function(l){var g=l.elements;if(g&&g.length===1){var f=this.getNamespace();var c=g[0];if(c.getStencil().idWithoutNs()==="Pool"){if(c.getChildNodes().length===0){var e={type:f+"Lane",position:{x:0,y:0},namespace:c.getStencil().namespace(),parent:c};this.facade.createShape(e);this.facade.getCanvas().update();this.facade.setSelection([c])}}}if(g.any(function(n){return n instanceof ORYX.Core.Node&&n.getStencil().id().endsWith("Lane")})){var d=g.findAll(function(n){return n instanceof ORYX.Core.Node&&n.getStencil().id().endsWith("Lane")});var h=[];var m=[];d.each(function(n){h.push(this.getParentPool(n))}.bind(this));h=h.uniq().findAll(function(n){var o=this.getLanes(n,true);if(o.all(function(p){return d.include(p)})){m=m.concat(o);return true}else{if(g.include(n)&&o.any(function(p){return d.include(p)})){m=m.concat(o);return true}else{return false}}}.bind(this));if(m.length>0&&h.length>0){g=g.without.apply(g,m);g=g.concat(h);this.facade.setSelection(g.uniq())}}},handleShapeRemove:function(f){var g=f.shape;var n=f.parent;if(g instanceof ORYX.Core.Node&&g.getStencil().idWithoutNs()==="Lane"&&this.facade.isExecutingCommands()){var h=this.getParentPool(n);if(h&&h.parent){var l=function(o){return !o.getChildNodes().any(function(p){return p.getStencil().idWithoutNs()==="Lane"})};var d=l(g);var m=n.getChildNodes().any(function(o){return o.getStencil().idWithoutNs()==="Lane"});if(d&&m){var e=new a(g,n,h,this);this.facade.executeCommands([e])}else{if(!d&&!this.facade.getSelection().any(function(o){return o instanceof ORYX.Core.Node&&o.getStencil().idWithoutNs()==="Lane"&&o.isParent(g)&&l(o)})){var c=ORYX.Core.Command.extend({construct:function(o,p){this.children=o.getChildNodes(true);this.facade=p},execute:function(){this.children.each(function(o){o.bounds.moveBy(30,0)})},rollback:function(){this.children.each(function(o){o.bounds.moveBy(-30,0)})}});this.facade.executeCommands([new c(g,this.facade)])}else{if(d&&!m&&n==h){n.add(g)}}}}}},hashedSubProcesses:{},handleHashChild:function(c){var d=c.shape;if(d){this.hashChildShapes(d)}},hashChildShapes:function(c){var d=c.getChildNodes();d.each(function(e){if(this.hashedSubProcesses[e.id]){this.hashedSubProcesses[e.id]=e.absoluteXY();this.hashedSubProcesses[e.id].width=e.bounds.width();this.hashedSubProcesses[e.id].height=e.bounds.height();this.hashChildShapes(e)}}.bind(this))},handleSubProcess:function(e){var d=e.shape;if(!this.hashedSubProcesses[d.id]){this.hashedSubProcesses[d.id]=d.absoluteXY();this.hashedSubProcesses[d.id].width=d.bounds.width();this.hashedSubProcesses[d.id].height=d.bounds.height();return}var f=d.absoluteXY();f.x-=this.hashedSubProcesses[d.id].x;f.y-=this.hashedSubProcesses[d.id].y;var c=Math.abs(this.hashedSubProcesses[d.id].width-d.bounds.width())>1||Math.abs(this.hashedSubProcesses[d.id].height!==d.bounds.height())>1;this.hashedSubProcesses[d.id]=d.absoluteXY();this.hashedSubProcesses[d.id].width=d.bounds.width();this.hashedSubProcesses[d.id].height=d.bounds.height();this.hashChildShapes(d);if(this.facade.isExecutingCommands()&&!c){this.moveChildDockers(d,f)}},moveChildDockers:function(e,h){if(!h.x&&!h.y){return}var f=e.getChildNodes(true);var d=f.map(function(l){return[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes())}).flatten().uniq().map(function(l){return l.dockers.length>2?l.dockers.slice(1,l.dockers.length-1):[]}).flatten();var c=e.absoluteBounds();c.moveBy(-h.x,-h.y);var g={};d.each(function(o){if(o.isChanged){return}var m=Object.clone(h);if(!c.isIncluded(o.bounds.center())){var q=o.parent.dockers.indexOf(o);var u=o.parent.dockers.length;var s=o.parent.getSource();var t=o.parent.getTarget();var n=f.include(s)&&f.include(t);if(!n){var p=q!==0?c.isIncluded(o.parent.dockers[q-1].bounds.center()):false;var r=q!==u-1?c.isIncluded(o.parent.dockers[q+1].bounds.center()):false;if(!p&&!r){return}var l=o.parent.dockers[p?q-1:q+1];if(Math.abs(-Math.abs(l.bounds.center().x-o.bounds.center().x))<2){m.y=0}else{if(Math.abs(-Math.abs(l.bounds.center().y-o.bounds.center().y))<2){m.x=0}else{return}}}}g[o.getId()]={docker:o,offset:m}});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(g)])},handleDockerDocked:function(e){var f=this.getNamespace();var g=e.parent;var d=e.target;if(g.getStencil().id()===f+"SequenceFlow"){var c=d.getStencil().groups().find(function(h){if(h=="Gateways"){return h}});if(!c&&(g.properties["oryx-conditiontype"]=="Expression")){g.setProperty("oryx-showdiamondmarker",true)}else{g.setProperty("oryx-showdiamondmarker",false)}this.facade.getCanvas().update()}},handlePropertyChanged:function(f){var e=this.getNamespace();var d=f.elements;var g=f.key;var c=f.value;var h=false;d.each(function(m){if((m.getStencil().id()===e+"SequenceFlow")&&(g==="oryx-conditiontype")){if(c!="Expression"){m.setProperty("oryx-showdiamondmarker",false)}else{var n=m.getIncomingShapes();if(!n){m.setProperty("oryx-showdiamondmarker",true)}var l=n.find(function(o){var p=o.getStencil().groups().find(function(q){if(q=="Gateways"){return q}});if(p){return p}});if(!l){m.setProperty("oryx-showdiamondmarker",true)}else{m.setProperty("oryx-showdiamondmarker",false)}}h=true}}.bind(this));if(h){this.facade.getCanvas().update()}},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},hashedPositions:{},handleLayoutPool:function(w){var q=w.shape;var H=this.facade.getSelection();var A=H.include(q)?q:H.first();A=A||q;this.currentPool=q;if(!(A.getStencil().id().endsWith("Pool")||A.getStencil().id().endsWith("Lane"))){return}if(A!==q&&!A.isParent(q)&&!this.hashedBounds[q.id][A.id]){return}if(!this.hashedBounds[q.id]){this.hashedBounds[q.id]={}}var C=this.getLanes(q);if(C.length<=0){return}var B=this.getLanes(q,true),c;var h=B.clone();var m=$H({});B.each(function(x){m[x.id]=x.bounds.upperLeft()});if(C.length===1&&this.getLanes(C.first()).length<=0){C.first().setProperty("oryx-showcaption",C.first().properties["oryx-name"].trim().length>0);var e=C.first().node.getElementsByTagName("rect");e[0].setAttributeNS(null,"display","none")}else{B.invoke("setProperty","oryx-showcaption",true);B.each(function(x){var y=x.node.getElementsByTagName("rect");y[0].removeAttributeNS(null,"display")})}var v=[];var p=[];var z=-1;while(++z<B.length){if(!this.hashedBounds[q.id][B[z].id]){p.push(B[z])}}if(p.length>0){A=p.first()}var E=$H(this.hashedBounds[q.id]).keys();var z=-1;while(++z<E.length){if(!B.any(function(x){return x.id==E[z]})){v.push(this.hashedBounds[q.id][E[z]]);H=H.without(function(x){return x.id==E[z]})}}var s,u,o,n;if(v.length>0||p.length>0){if(p.length===1&&this.getLanes(p[0].parent).length===1){s=this.adjustHeight(C,p[0].parent)}else{s=this.updateHeight(q)}u=this.adjustWidth(C,q.bounds.width());q.update()}else{if(q==A){if(H.length===1&&this.isResized(q,this.hashedPoolPositions[q.id])){var D=this.hashedPoolPositions[q.id].upperLeft();var g=q.bounds.upperLeft();var G=0;if(this.shouldScale(q)){var d=this.hashedPoolPositions[q.id];G=d.height()/q.bounds.height()}this.adjustLanes(q,B,D.x-g.x,D.y-g.y,G)}s=this.adjustHeight(C,undefined,q.bounds.height());u=this.adjustWidth(C,q.bounds.width())}else{if(H.length===1&&this.isResized(A,this.hashedBounds[q.id][A.id])){var D=this.hashedBounds[q.id][A.id].upperLeft();var g=A.absoluteXY();o=D.x-g.x;n=D.y-g.y;if(o||n){h=h.without(A);this.adjustLanes(q,this.getAllExcludedLanes(q,A),o,0)}var l=this.getLanes(A,true);if(l.length>0){if(this.shouldScale(A)){var d=this.hashedBounds[q.id][A.id];var G=d.height()/A.bounds.height();this.adjustLanes(q,l,o,n,G)}else{this.adjustLanes(q,l,o,n,0)}}}var F=B.map(function(x){return{shape:x,bounds:x.bounds.clone()}});s=this.adjustHeight(C,A);this.checkForChanges(B,F);u=this.adjustWidth(C,A.bounds.width()+(this.getDepth(A,q)*30))}}this.setDimensions(q,u,s,o,n);if(this.facade.isExecutingCommands()&&(v.length===0||p.length!==0)){this.updateDockers(h,q);if(this.hashedPositions[q.id]&&this.hashedPositions[q.id].keys().any(function(y,x){return(B[x]||{}).id!==y})){var t=ORYX.Core.Command.extend({construct:function(J,I,y,K,x){this.originPosition=Object.clone(J);this.newPosition=Object.clone(I);this.lanes=y;this.plugin=K;this.pool=x},execute:function(){if(!this.executed){this.executed=true;this.lanes.each(function(x){if(this.newPosition[x.id]){x.bounds.moveTo(this.newPosition[x.id])}}.bind(this));this.plugin.hashedPositions[this.pool]=Object.clone(this.newPosition)}},rollback:function(){this.lanes.each(function(x){if(this.originPosition[x.id]){x.bounds.moveTo(this.originPosition[x.id])}}.bind(this));this.plugin.hashedPositions[this.pool]=Object.clone(this.originPosition)}});var r=$H({});B.each(function(x){r[x.id]=x.bounds.upperLeft()});var f=new t(m,r,B,this,q.id);this.facade.executeCommands([f])}}this.hashedBounds[q.id]={};this.hashedPositions[q.id]=m;var z=-1;while(++z<B.length){this.hashedBounds[q.id][B[z].id]=B[z].absoluteBounds();this.hashChildShapes(B[z]);this.hashedLaneDepth[B[z].id]=this.getDepth(B[z],q);this.forceToUpdateLane(B[z])}this.hashedPoolPositions[q.id]=q.bounds.clone()},shouldScale:function(c){var d=c.getChildNodes().findAll(function(e){return e.getStencil().id().endsWith("Lane")});return d.length>1||d.any(function(e){return this.shouldScale(e)}.bind(this))},checkForChanges:function(c,d){if(this.facade.isExecutingCommands()&&d.any(function(f){return f.shape.bounds.toString()!==f.bounds.toString()})){var e=ORYX.Core.Command.extend({construct:function(f){this.oldState=f;this.newState=f.map(function(g){return{shape:g.shape,bounds:g.bounds.clone()}})},execute:function(){if(this.executed){this.applyState(this.newState)}this.executed=true},rollback:function(){this.applyState(this.oldState)},applyState:function(f){f.each(function(g){g.shape.bounds.set(g.bounds.upperLeft(),g.bounds.lowerRight())})}});this.facade.executeCommands([new e(d)])}},isResized:function(c,e){if(!e||!c){return false}var d=e;return Math.round(d.width()-c.bounds.width())!==0||Math.round(d.height()-c.bounds.height())!==0},adjustLanes:function(e,d,c,g,f){f=f||0;d.each(function(h){h.getChildNodes().each(function(m){if(!m.getStencil().id().endsWith("Lane")){var l=f?m.bounds.center().y-(m.bounds.center().y/f):-g;m.bounds.moveBy((c||0),-l);if(f&&m.getStencil().id().endsWith("Subprocess")){this.moveChildDockers(m,{x:(0),y:-l})}}}.bind(this));this.hashedBounds[e.id][h.id].moveBy(-(c||0),!f?-g:0);if(f){h.isScaled=true}}.bind(this))},getAllExcludedLanes:function(e,c){var d=[];e.getChildNodes().each(function(f){if((!c||f!==c)&&f.getStencil().id().endsWith("Lane")){d.push(f);d=d.concat(this.getAllExcludedLanes(f,c))}}.bind(this));return d},forceToUpdateLane:function(c){if(c.bounds.height()!==c._svgShapes[0].height){c.isChanged=true;c.isResized=true;c._update()}},getDepth:function(e,d){var c=0;while(e&&e.parent&&e!==d){e=e.parent;++c}return c},updateDepth:function(d,c,e){var f=(c-e)*30;d.getChildNodes().each(function(g){g.bounds.moveBy(f,0);[].concat(children[j].getIncomingShapes()).concat(children[j].getOutgoingShapes())})},setDimensions:function(f,g,d,c,h){var e=f.getStencil().id().endsWith("Lane");f.bounds.set(e?30:(f.bounds.a.x-(c||0)),e?f.bounds.a.y:(f.bounds.a.y-(h||0)),g?f.bounds.a.x+g-(e?30:(c||0)):f.bounds.b.x,d?f.bounds.a.y+d-(e?0:(h||0)):f.bounds.b.y)},setLanePosition:function(c,d){c.bounds.moveTo(30,d)},adjustWidth:function(c,d){(c||[]).each(function(e){this.setDimensions(e,d);this.adjustWidth(this.getLanes(e),d-30)}.bind(this));return d},adjustHeight:function(f,h,d){var l=0;if(!h&&d){var g=-1;while(++g<f.length){l+=f[g].bounds.height()}}var g=-1;var c=0;while(++g<f.length){if(f[g]===h){this.adjustHeight(this.getLanes(f[g]),undefined,f[g].bounds.height());f[g].bounds.set({x:30,y:c},{x:f[g].bounds.width()+30,y:f[g].bounds.height()+c})}else{if(!h&&d){var e=(f[g].bounds.height()*d)/l;this.adjustHeight(this.getLanes(f[g]),undefined,e);this.setDimensions(f[g],null,e);this.setLanePosition(f[g],c)}else{var e=this.adjustHeight(this.getLanes(f[g]),h,d);if(!e){e=f[g].bounds.height()}this.setDimensions(f[g],null,e);this.setLanePosition(f[g],c)}}c+=f[g].bounds.height()}return c},updateHeight:function(d){var e=this.getLanes(d);if(e.length==0){return d.bounds.height()}var c=0;var f=-1;while(++f<e.length){this.setLanePosition(e[f],c);c+=this.updateHeight(e[f])}this.setDimensions(d,null,c);return c},getOffset:function(c,e,d){var g={x:0,y:0};var g=c.absoluteXY();var f=this.hashedBounds[d.id][c.id]||(e===true?this.hashedPoolPositions[c.id]:undefined);if(f){g.x-=f.upperLeft().x;g.y-=f.upperLeft().y}else{return{x:0,y:0}}return g},getNextLane:function(c){while(c&&!c.getStencil().id().endsWith("Lane")){if(c instanceof ORYX.Core.Canvas){return null}c=c.parent}return c},getParentPool:function(c){while(c&&!c.getStencil().id().endsWith("Pool")){if(c instanceof ORYX.Core.Canvas){return null}c=c.parent}return c},updateDockers:function(C,u){var s=u.absoluteBounds(),w=[];var t=(this.hashedPoolPositions[u.id]||s).clone();var B=-1,A=-1,z=-1,x=-1,v;var D={};while(++B<C.length){if(!this.hashedBounds[u.id][C[B].id]){continue}var e=C[B].isScaled;delete C[B].isScaled;var m=C[B].getChildNodes();var q=C[B].absoluteBounds();var f=(this.hashedBounds[u.id][C[B].id]||q);var n=this.getOffset(C[B],true,u);var g=0;var F=this.getDepth(C[B],u);if(this.hashedLaneDepth[C[B].id]!==undefined&&this.hashedLaneDepth[C[B].id]!==F){g=(this.hashedLaneDepth[C[B].id]-F)*30;n.x+=g}A=-1;while(++A<m.length){if(g&&!m[A].getStencil().id().endsWith("Lane")){w.push({xOffset:g,shape:m[A]});m[A].bounds.moveBy(g,0)}if(m[A].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(m[A],n)}var d=[].concat(m[A].getIncomingShapes()).concat(m[A].getOutgoingShapes()).findAll(function(l){return l instanceof ORYX.Core.Edge});z=-1;while(++z<d.length){if(d[z].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(m[A],[d[z]],n);continue}x=-1;while(++x<d[z].dockers.length){v=d[z].dockers[x];if(v.getDockedShape()||v.isChanged){continue}pos=v.bounds.center();var c=f.isIncluded(pos);var r=!t.isIncluded(pos);var h=x==0?c:f.isIncluded(d[z].dockers[x-1].bounds.center());var o=x==d[z].dockers.length-1?c:f.isIncluded(d[z].dockers[x+1].bounds.center());var E=Object.clone(n);if(e&&c&&this.isResized(C[B],this.hashedBounds[u.id][C[B].id])){var y=(pos.y-q.upperLeft().y+E.y);E.y-=(y-(y*(q.height()/f.height())))}if(c){D[v.id]={docker:v,offset:E}}}}}}var p=ORYX.Core.Command.extend({construct:function(l){this.state=l},execute:function(){if(this.executed){this.state.each(function(l){l.shape.bounds.moveBy(l.xOffset,0)})}this.executed=true},rollback:function(){this.state.each(function(l){l.shape.bounds.moveBy(-l.xOffset,0)})}});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(D),new p(w)])},moveBy:function(d,c){d.x+=c.x;d.y+=c.y;return d},getHashedBounds:function(c){return this.currentPool&&this.hashedBounds[this.currentPool.id][c.id]?this.hashedBounds[this.currentPool.id][c.id]:c.absoluteBounds()},getLanes:function(c,e){var f=this.getNamespace();var d=c.getChildNodes(e||false).findAll(function(g){return(g.getStencil().id()===f+"Lane")});d=d.sort(function(y,w){var x=Math.round(y.bounds.upperLeft().y);var r=Math.round(w.bounds.upperLeft().y);var u=Math.round(y.bounds.lowerRight().y);var o=Math.round(w.bounds.lowerRight().y);var l=this.getHashedBounds(y);var h=this.getHashedBounds(w);var q=Math.round(l.upperLeft().y);var A=Math.round(h.upperLeft().y);var n=Math.round(l.lowerRight().y);var z=Math.round(h.lowerRight().y);if(x==r&&u==o){x=q;r=A;u=n;o=z}if(Math.round(y.bounds.height()-l.height())===0&&Math.round(w.bounds.height()-h.height())===0){return x<r?-1:(x>r?1:0)}var v=x<r&&u<o;var s=x>r&&u>o;var m=x<r&&u>=o&&n<z;var p=x>=r&&u<o&&q<A;var t=x>r&&u<=o&&n>z;var g=x<=r&&u>o&&q>A;return(v||m||p?-1:(s||t||g?1:0))}.bind(this));return d},getNamespace:function(){if(!this.namespace){var c=this.facade.getStencilSets();if(c.keys()){this.namespace=c.keys()[0]}else{return undefined}}return this.namespace}};var a=ORYX.Core.Command.extend({construct:function(c,e,d,f){this.facade=f.facade;this.plugin=f;this.shape=c;this.changes;this.pool=d;this.parent=e;this.shapeChildren=[];this.shape.getChildShapes().each(function(g){this.shapeChildren.push({shape:g,bounds:{a:{x:g.bounds.a.x,y:g.bounds.a.y},b:{x:g.bounds.b.x,y:g.bounds.b.y}}})}.bind(this));this.shapeUpperLeft=this.shape.bounds.upperLeft();this.parentHeight=this.parent.bounds.height()},getLeafLanes:function(c){var d=this.plugin.getLanes(c).map(function(e){return this.getLeafLanes(e)}.bind(this)).flatten();return d.length>0?d:[c]},findNewLane:function(){var c=this.plugin.getLanes(this.parent);var d=this.getLeafLanes(this.parent);this.lane=d.find(function(e){return e.bounds.upperLeft().y>=this.shapeUpperLeft.y}.bind(this))||d.last();this.laneUpperLeft=this.lane.bounds.upperLeft()},execute:function(){if(this.changes){this.executeAgain();return}if(!this.lane){this.findNewLane()}if(this.lane){var g=this.laneUpperLeft;var e=this.shapeUpperLeft;var d=this.plugin.getDepth(this.lane,this.parent)-1;this.changes=$H({});if(g.y>=e.y){this.lane.getChildShapes().each(function(h){if(!this.changes[h.getId()]){this.changes[h.getId()]=this.computeChanges(h,this.lane,this.lane,this.shape.bounds.height())}h.bounds.moveBy(0,this.shape.bounds.height())}.bind(this));this.plugin.hashChildShapes(this.lane);this.shapeChildren.each(function(h){h.shape.bounds.set(h.bounds);h.shape.bounds.moveBy((e.x-30)-(d*30),0);if(!this.changes[h.shape.getId()]){this.changes[h.shape.getId()]=this.computeChanges(h.shape,this.shape,this.lane,0)}this.lane.add(h.shape)}.bind(this));this.lane.bounds.moveBy(0,e.y-g.y)}else{if(e.y>g.y){this.shapeChildren.each(function(h){h.shape.bounds.set(h.bounds);h.shape.bounds.moveBy((e.x-30)-(d*30),this.lane.bounds.height());if(!this.changes[h.shape.getId()]){this.changes[h.shape.getId()]=this.computeChanges(h.shape,this.shape,this.lane,0)}this.lane.add(h.shape)}.bind(this))}}}var f=this.lane.bounds.height();var c=this.lane.length===1?this.parentHeight:this.lane.bounds.height()+this.shape.bounds.height();this.setHeight(c,f,this.parent,this.parentHeight,true);this.plugin.getLanes(this.parent).each(function(h){if(!this.changes[h.getId()]&&h!==this.lane&&h!==this.shape){this.changes[h.getId()]=this.computeChanges(h,this.parent,this.parent,0)}}.bind(this));this.update()},setHeight:function(c,g,f,e,d){this.plugin.setDimensions(this.lane,this.lane.bounds.width(),c);this.plugin.hashedBounds[this.pool.id][this.lane.id]=this.lane.absoluteBounds();this.plugin.adjustHeight(this.plugin.getLanes(f),this.lane);if(d===true){this.changes[this.shape.getId()]=this.computeChanges(this.shape,f,f,0,g,c)}this.plugin.setDimensions(f,f.bounds.width(),e);if(f!==this.pool){this.plugin.setDimensions(this.pool,this.pool.bounds.width(),this.pool.bounds.height()+(c-g))}},update:function(){this.plugin.hashedBounds[this.pool.id]["REMOVED"]=true},rollback:function(){var d=this.laneUpperLeft;var c=this.shapeUpperLeft;this.changes.each(function(l){var h=l.value.oldParent;var f=l.value.shape;var g=l.value.parentHeight;var m=l.value.oldHeight;var e=l.value.newHeight;if(f.getStencil().id().endsWith("Lane")){f.bounds.moveTo(l.value.oldPosition)}if(m){this.setHeight(m,e,h,h.bounds.height()+(m-e));if(d.y>=c.y){this.lane.bounds.moveBy(0,this.shape.bounds.height()-1)}}else{h.add(f);f.bounds.moveTo(l.value.oldPosition)}}.bind(this))},executeAgain:function(){this.changes.each(function(g){var e=g.value.newParent;var d=g.value.shape;var c=g.value.newHeight;var l=g.value.oldHeight;if(c){var h=this.laneUpperLeft.y;var f=this.shapeUpperLeft.y;if(h>=f){this.lane.bounds.moveBy(0,f-h)}this.setHeight(c,l,e,e.bounds.height()+(c-l))}else{e.add(d);d.bounds.moveTo(g.value.newPosition)}}.bind(this));this.update()},computeChanges:function(e,n,m,d,o,c){n=this.changes[e.getId()]?this.changes[e.getId()].oldParent:n;var l=this.changes[e.getId()]?this.changes[e.getId()].oldPosition:e.bounds.upperLeft();var g=e.bounds.upperLeft();var f={x:g.x,y:g.y+d};var h={shape:e,parentHeight:n.bounds.height(),oldParent:n,oldPosition:l,oldHeight:o,newParent:m,newPosition:f,newHeight:c};return h}});ORYX.Plugins.BPMN2_0=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0)}();if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2CONVERSATION={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,this.handleDragDrop.bind(this))},checkForMultiInstance:function(c){var d=c.getIncomingShapes();var e=c.getOutgoingShapes();var a=c.properties["oryx-multiinstance"];if(d){d.find(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){f.setProperty("oryx-showforkend",true)}else{f.setProperty("oryx-showforkend",false)}}})}if(e){e.find(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){f.setProperty("oryx-showforkstart",true)}else{f.setProperty("oryx-showforkstart",false)}}})}},handleDockerDocked:function(c){var d=c.parent;var a=c.target;if(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(a);this.facade.getCanvas().update()}}},handlePropertyChanged:function(c){var a=c.elements;var d=false;a.each(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(e);d=true}}.bind(this));if(d){this.facade.getCanvas().update()}},handleDragDrop:function(c){var d=c.source;var a=c.destination;var e=false;d.each(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(f);e=true}}.bind(this));a.each(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Communication"){var g=f.getOutgoingShapes();if(g){g.each(function(h){var l=h.getTarget();if(l){if(l.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(l);e=true}}}.bind(this))}}if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(f);e=true}}.bind(this));if(e){this.facade.getCanvas().update()}}};ORYX.Plugins.BPMN2CONVERSATION=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2CONVERSATION);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Bpmn2_0Choreography={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.handleStencilSetLoaded.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){if(!this._eventsRegistered){this.handleStencilSetLoaded({});this.afterLoad()}}.bind(this));this.participantSize=20;this.extensionSizeForMarker=10;this.choreographyTasksMeta=new Hash();this._isLayoutEnabled=false},handleStencilSetLoaded:function(a){if(a.lazyLoaded){this._isLayoutEnabled=true}this.registerPluginOnEvents()},registerPluginOnEvents:function(){this._eventsRegistered=true;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.addParticipantsOnCreation.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.task",this.handleLayoutChoreographyTask.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.expanded",this.handleLayoutChoreographySubprocessExpanded.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.collapsed",this.handleLayoutChoreographySubprocessCollapsed.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},unregisterPluginOnEvents:function(){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},afterLoad:function(a){this._isLayoutEnabled=true;this.facade.getCanvas().getChildNodes(true).each(function(e){if(!(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"||e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"||e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded")){return}var l=new Array();var h=new Array();var m=this.addOrGetChoreographyTaskMeta(e);var g=e.getChildNodes(false).findAll(function(n){return n.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"});g=g.sort(function(o,n){var p=Math.round(o.absoluteBounds().upperLeft().y);var q=Math.round(n.absoluteBounds().upperLeft().y);return p<q?-1:(p>q?1:0)});var d=0;var f=0;var c=0;g.each(function(o){o.isResizable=false;var n=(o.properties["oryx-multiple_instance"]===""?false:o.properties["oryx-multiple_instance"]);if(o.bounds.upperLeft().y==d){l.push(o);d=o.bounds.lowerRight().y;if(n){f++}}else{h.push(o);if(n){c++}}});m.numOfParticipantsOnTop=l.length;m.numOfParticipantsOnBottom=h.length;m.numOfParticipantsExtendedOnBottom=c;m.numOfParticipantsExtendedOnTop=f;m.bottomYStartValue=(h.first()?h.first().bounds.upperLeft().y:e.bounds.height());m.topYEndValue=(l.last()?l.last().bounds.lowerRight().y:0);m.center=m.topYEndValue+(m.bottomYStartValue-m.topYEndValue)/2;m.oldHeight=e.bounds.height();m.oldBounds=e.bounds.clone();m.topParticipants=l;m.bottomParticipants=h;e.isChanged=true;e.initialParticipantsAdded=true}.bind(this));this.facade.getCanvas().update()},handleLayoutChoreographySubprocessExpanded:function(c){if(!this._isLayoutEnabled){return}var f=c.shape;var g=this.addOrGetChoreographyTaskMeta(f);var e=f.bounds.height()/f._oldBounds.height();var a=f._labels[f.getId()+"text_name"];if(a){var d=g.topYEndValue+5;if(f.isResized&&e){a.y=d/e}else{a.y=d}}},handleLayoutChoreographySubprocessCollapsed:function(c){if(!this._isLayoutEnabled){return}var e=c.shape;var f=this.addOrGetChoreographyTaskMeta(e);var a=e._svgShapes.find(function(g){return g.element.id==e.getId()+"plus_marker"});var d=e._svgShapes.find(function(g){return g.element.id==e.getId()+"plus_marker_border"});if(a&&d){a._isYLocked=true;a.y=f.bottomYStartValue-12;d._isYLocked=true;d.y=f.bottomYStartValue-14}},addParticipantsOnCreation:function(a){if(!this._isLayoutEnabled){return}var c=a.elements.findAll(function(d){return d._stencil&&!d.initialParticipantsAdded&&(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded")});if(c.length===0){return}this._isLayoutEnabled=false;c.each(function(e){e.initialParticipantsAdded=true;if(this.hasParticipants(e)){return}var g={type:"http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant",position:{x:0,y:0},namespace:e.getStencil().namespace(),parent:e};var f=this.facade.createShape(g);f.setProperty("oryx-initiating",true);var h={elements:[f],key:"oryx-initiating",value:true};this.handlePropertyChanged(h);var d={type:"http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant",position:{x:0,y:e.bounds.lowerRight().y},namespace:e.getStencil().namespace(),parent:e};this.facade.createShape(d)}.bind(this));this._isLayoutEnabled=true;this.facade.getCanvas().update();this.facade.setSelection(c)},hasParticipants:function(a){return a.getChildNodes().any(function(c){return(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant")})},addOrGetChoreographyTaskMeta:function(a){if(!this.choreographyTasksMeta[a.getId()]){this.choreographyTasksMeta[a.getId()]=new Object();this.choreographyTasksMeta[a.getId()].numOfParticipantsOnTop=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnTop=0;this.choreographyTasksMeta[a.getId()].bottomYStartValue=a.bounds.height();this.choreographyTasksMeta[a.getId()].topYEndValue=0;this.choreographyTasksMeta[a.getId()].center=a.bounds.height()/2;this.choreographyTasksMeta[a.getId()].oldHeight=a.bounds.height();this.choreographyTasksMeta[a.getId()].oldBounds=a.bounds.clone();this.choreographyTasksMeta[a.getId()].topParticipants=new Array();this.choreographyTasksMeta[a.getId()].bottomParticipants=new Array()}return this.choreographyTasksMeta[a.getId()]},handleResizingOfChoreographyTask:function(h,l){if(h.bounds.height()==l.oldHeight){return}var d=l.numOfParticipantsOnTop*this.participantSize+l.numOfParticipantsExtendedOnTop*this.extensionSizeForMarker+l.numOfParticipantsOnBottom*this.participantSize+l.numOfParticipantsExtendedOnBottom*this.extensionSizeForMarker+40;if(d>h.bounds.height()){var f=h.bounds.upperLeft();var e=l.oldBounds.upperLeft();var c=h.bounds.lowerRight();var a=l.oldBounds.lowerRight();if(f.y!=e.y){h.bounds.set(f.x,c.y-d,c.x,c.y)}else{if(c.y!=a.y){h.bounds.set(f.x,f.y,c.x,f.y+d)}}}var g=l.oldHeight-h.bounds.height();l.bottomYStartValue-=g;return true},handleLayoutChoreographyTask:function(event){if(!this._isLayoutEnabled){return}var choreographyTask=event.shape;var isNew=!this.choreographyTasksMeta[choreographyTask.getId()];var choreographyTaskMeta=this.addOrGetChoreographyTaskMeta(choreographyTask);var isResized=this.handleResizingOfChoreographyTask(choreographyTask,choreographyTaskMeta);var oldCountTop=choreographyTaskMeta.numOfParticipantsOnTop;var oldCountBottom=choreographyTaskMeta.numOfParticipantsOnBottom;if(isResized){var participants=choreographyTaskMeta.topParticipants}else{var participants=this.getParticipants(choreographyTask,true,false);if(!participants){return}this.ensureParticipantsParent(choreographyTask,participants)}var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtended=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),0);if(isExtended){numOfParticipantsExtended++}if(i==0){participant.setProperty("oryx-corners","Top")}this.adjustTopBackground(participant)}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnTop;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnTop;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y-resizeFactor*this.participantSize-resizeFactorExtended*this.extensionSizeForMarker,lr.x,lr.y)}choreographyTaskMeta.topYEndValue=participants.length*this.participantSize+numOfParticipantsExtended*this.extensionSizeForMarker;choreographyTaskMeta.numOfParticipantsExtendedOnTop=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnTop=participants.length;choreographyTaskMeta.topParticipants=participants;if(isResized){var participants=choreographyTaskMeta.bottomParticipants}else{var participants=this.getParticipants(choreographyTask,false,true);if(!participants){return}this.ensureParticipantsParent(choreographyTask,participants)}if(isNew){choreographyTaskMeta.bottomYStartValue=(bounds.height()-(participants.length!=0?eval(participants.map(function(p){return this.participantSize+(this.isExtended(p)?this.extensionSizeForMarker:0)}.bind(this)).join("+")):0))}else{choreographyTaskMeta.bottomYStartValue+=resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker}var bottomStartYValue=choreographyTaskMeta.bottomYStartValue;var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtendedParticipant=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),bottomStartYValue);if(isExtendedParticipant){numOfParticipantsExtended++}if(i==participants.length-1){participant.setProperty("oryx-corners","Bottom")}this.adjustTopBackground(participant)}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnBottom;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnBottom;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y,lr.x,lr.y+resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker)}choreographyTaskMeta.numOfParticipantsExtendedOnBottom=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnBottom=participants.length;choreographyTaskMeta.bottomParticipants=participants;var participantsHasChanged=oldCountTop!==choreographyTaskMeta.numOfParticipantsOnTop||oldCountBottom!==choreographyTaskMeta.numOfParticipantsOnBottom;this.ensureCenterPositionOfMagnets(choreographyTask,isResized,participantsHasChanged);this.adjustTextFieldAndMarkerPosition(choreographyTask);choreographyTaskMeta.oldHeight=bounds.height();choreographyTaskMeta.oldBounds=bounds.clone();choreographyTask.minimumSize={width:50,height:40+((choreographyTaskMeta.numOfParticipantsOnBottom+choreographyTaskMeta.numOfParticipantsOnTop)*this.participantSize)+((choreographyTaskMeta.numOfParticipantsExtendedOnBottom+choreographyTaskMeta.numOfParticipantsExtendedOnTop)*this.extensionSizeForMarker)}},isExtended:function(a){return(!a||a.properties["oryx-multiple_instance"]===""?false:!!a.properties["oryx-multiple_instance"])},setBoundsOfParticipantDependOnProperties:function(c,e,h,f,g){var a=this.isExtended(c);var l=g+e*this.participantSize+h*this.extensionSizeForMarker;var d=g+this.participantSize+e*this.participantSize+(a?(h+1)*this.extensionSizeForMarker:h*this.extensionSizeForMarker);c.bounds.set(0,l,f,d);return a},adjustTextFieldAndMarkerPosition:function(h){var l=this.addOrGetChoreographyTaskMeta(h);var g=h.bounds.height()/h._oldBounds.height();var e=h._labels[h.getId()+"text_name"];if(e){var a=l.topYEndValue+(l.bottomYStartValue-l.topYEndValue)/2;if(h.isResized&&g){e.y=a/g}else{e.y=a}}var d=h._svgShapes.find(function(m){return m.element.id==h.getId()+"loop_path"});if(d){d._isYLocked=true;d.y=l.bottomYStartValue-7}var c=h._svgShapes.find(function(m){return m.element.id==h.getId()+"mi_path"});if(c){c._isYLocked=true;c.y=l.bottomYStartValue-11}var f=h._svgShapes.find(function(m){return m.element.id==h.getId()+"mi_sequential_path"});if(f){f._isYLocked=true;f.y=l.bottomYStartValue-11}},ensureCenterPositionOfMagnets:function(e,n,d){var g=this.addOrGetChoreographyTaskMeta(e);var a=g.topYEndValue+(g.bottomYStartValue-g.topYEndValue)/2;var c=a-g.center;var h=e.bounds.height()/g.oldBounds.height();if(!c&&!h){return}var l=e.magnets.findAll(function(p){return(!p.anchorTop&&!p.anchorBottom)});l.each(function(q){var p=q.bounds.center().x;var r=(q.bounds.center().y+c)/h;q.bounds.centerMoveTo(p,r)});var f=e.absoluteBounds().upperLeft().y+g.topYEndValue;var m=e.absoluteBounds().upperLeft().y+g.bottomYStartValue;var o=new Array();e.incoming.each(function(p){if(!(p instanceof ORYX.Core.Edge)){return}var q=p.dockers.last();if(f<=q.bounds.center().y&&q.bounds.center().y<=m){o.push(q)}});e.outgoing.each(function(p){if(!(p instanceof ORYX.Core.Edge)){return}var q=p.dockers.first();if(f<=q.bounds.center().y&&q.bounds.center().y<=m){o.push(q)}});if(d&&e.initialParticipantsAdded){o.each(function(p){var q=p.referencePoint;p.setReferencePoint({x:q.x,y:(q.y+c)/h})})}g.center=a},ensureParticipantsParent:function(a,c){if(!a||!c){return}c.each(function(d){if(d.parent.getId()==a.getId()){return}d.parent.remove(d);a.add(d)})},getParticipants:function(c,l,f){if(c.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"&&c.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"&&c.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded"){return null}var h=this.addOrGetChoreographyTaskMeta(c);var a=c.absoluteBounds().upperLeft().y+h.topYEndValue+(h.bottomYStartValue-h.topYEndValue)/2;var g=c.getChildNodes(true).findAll(function(m){return(l&&m.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&m.absoluteBounds().center().y<=a&&this.isParticipantOfShape(c,m))}.bind(this));var e=c.getChildNodes(true).findAll(function(m){return(f&&m.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&m.absoluteBounds().center().y>a&&this.isParticipantOfShape(c,m))}.bind(this));var d=g.concat(e);d=d.sort(function(n,m){var o=Math.round(n.absoluteBounds().upperLeft().y);var p=Math.round(m.absoluteBounds().upperLeft().y);return o<p?-1:(o>p?1:0)});return d},isParticipantOfShape:function(c,a){var d=a.parent;while(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"){d=d.parent}return d.getId()===c.getId()},adjustTopBackground:function(a){var e=a.properties["oryx-corners"];var c=$(a.getId()+"roundedBgRect");if(!c){return}if(e==="Top"){c.setAttributeNS(null,"fill","url(#"+a.getId()+"background_top) white")}else{var d=a.properties["oryx-color"];c.setAttributeNS(null,"fill",d)}},handlePropertyChanged:function(d){var c=d.elements;var e=d.key||d.name;var a=d.value;var f=false;c.each(function(g){if(g.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&e==="oryx-initiating"){if(!a||a==="false"){g.setProperty("oryx-color","#acacac")}else{g.setProperty("oryx-color","#ffffff")}f=true}});if(f){this.facade.getCanvas().update()}}};ORYX.Plugins.Bpmn2_0Choreography=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.Bpmn2_0Choreography);if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayout";ORYX.Plugins.BpmnLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-BPMN",description:"Layout BPMN Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.BPMN_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON(),output:"coordinatesonly"},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(c){var a=ORYX.Core.Command.extend({construct:function(g,f){this.layoutArray=g;this.plugin=f;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(l){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(l.id);var h={id:l.id,bounds:f.bounds.clone()};this.oldLayoutArray.push(h);var g=l.bounds.split(" ");f.bounds.set(g[0],g[1],g[2],g[3]);if(l.dockers!=null){this.plugin.setDockersBad(f,l.dockers)}f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(g){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(g.id);f.bounds.set(g.bounds);f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var e=c.responseText.evalJSON();if(e instanceof Array&&e.size()>0){var d=new a(e,this);this.facade.executeCommands([d])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(d,a){var c="";a.each(function(e){c+=e.x+" "+e.y+" "});c+=" # ";d.deserialize([{prefix:"oryx",name:"dockers",value:c}])},setDockersGood:function(d,a){if(elem.dockers.length==1){}else{var a=d.getDockers().slice(1,-1);a.each(function(g){d.removeDocker(g)});var f=d.getDockers()[0];if(f.getDockedShape()){f.setReferencePoint(elem.dockers[0])}else{f.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}f.refresh();var e=d.getDockers()[1];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{e.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}e.refresh();var c=elem.dockers.slice(1,-1);c.each(function(h){var g=d.createDocker(undefined,h);g.parent=d;g.bounds.centerMoveTo(h.x,h.y);g.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.CONFIG.YAWLIMPORTURL=ORYX.CONFIG.ROOT_PATH+"yawlimport";ORYX.CONFIG.YAWLEXPORTURL=ORYX.CONFIG.ROOT_PATH+"yawlexport";ORYX.Plugins.YAWLSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.progressDialog=null;this._dummyRootnetData='{"resourceId":"canvas","properties":{"yawlid":"","name":"","documentation":"","title":"","creators":"","subject":"","description":"","contributor":"","coverage":"","validfrom":"","validto":"","created":"","version":"","status":"","persistent":"","uri":"","datatypedefinitions":"","bgcolor":"#FFFFFF","isrootnet":true,"externaldatagateway":"","decompositionid":"","decompositionname":"","decompositionexternalinteraction":"","decompositioncodelet":"","decompositionvariables":"","decompositionlogpredicate":""},"stencil":{"id":"Diagram"},"childShapes":[{"resourceId":"sid-A72E7647-D0AA-41BE-86FB-CB771A630869","properties":{"yawlid":"","name":"","documentation":""},"stencil":{"id":"InputCondition"},"childShapes":[],"outgoing":[],"bounds":{"lowerRight":{"x":107,"y":213},"upperLeft":{"x":75,"y":181}},"dockers":[]},{"resourceId":"sid-0B3EA74F-3F63-45DC-8F15-DF8D8E6A3718","properties":{"yawlid":"","name":"","documentation":""},"stencil":{"id":"OutputCondition"},"childShapes":[],"outgoing":[],"bounds":{"lowerRight":{"x":797,"y":213},"upperLeft":{"x":765,"y":181}},"dockers":[]}],"bounds":{"lowerRight":{"x":1485,"y":1050},"upperLeft":{"x":0,"y":0}},"stencilset":{"url":"/Apromore-editor/editor/stencilsets//yawl/yawl.json","namespace":"http://b3mn.org/stencilset/yawl2.2#"},"ssextensions":[]}';this._dummySubnetData='{"resourceId":"canvas","properties":{"yawlid":"","name":"","documentation":"","title":"","creators":"","subject":"","description":"","contributor":"","coverage":"","validfrom":"","validto":"","created":"","version":"","status":"","persistent":"","uri":"","datatypedefinitions":"","bgcolor":"#FFFFFF","isrootnet":false,"externaldatagateway":"","decompositionid":"","decompositionname":"","decompositionexternalinteraction":"","decompositioncodelet":"","decompositionvariables":"","decompositionlogpredicate":""},"stencil":{"id":"Diagram"},"childShapes":[{"resourceId":"sid-A72E7647-D0AA-41BE-86FB-CB771A630869","properties":{"yawlid":"","name":"","documentation":""},"stencil":{"id":"InputCondition"},"childShapes":[],"outgoing":[],"bounds":{"lowerRight":{"x":107,"y":213},"upperLeft":{"x":75,"y":181}},"dockers":[]},{"resourceId":"sid-0B3EA74F-3F63-45DC-8F15-DF8D8E6A3718","properties":{"yawlid":"","name":"","documentation":""},"stencil":{"id":"OutputCondition"},"childShapes":[],"outgoing":[],"bounds":{"lowerRight":{"x":797,"y":213},"upperLeft":{"x":765,"y":181}},"dockers":[]}],"bounds":{"lowerRight":{"x":1485,"y":1050},"upperLeft":{"x":0,"y":0}},"stencilset":{"url":"/Apromore-editor/editor/stencilsets//yawl/yawl.json","namespace":"http://b3mn.org/stencilset/yawl2.2#"},"ssextensions":[]}';this._dummySVG="<svg/>";this._dummyParameters={json_xml:this._dummySubnetData,svg_xml:this._dummySVG,name:"",description:"",parent:"/directory/root-directory",namespace:"http://b3mn.org/stencilset/yawl2.2#",type:"YAWL 2.2",comment:"",glossary_xml:"[]",views:"[]"};this.facade.offer({name:ORYX.I18N.YAWL.importName,description:ORYX.I18N.YAWL.importDesc,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/yawl/yawl_import.png",functionality:this.doImport.bind(this),group:ORYX.I18N.YAWL.importGroup,isEnabled:function(){return true}.bind(this),index:1});this.facade.offer({name:ORYX.I18N.YAWL.exportName,description:ORYX.I18N.YAWL.exportDesc,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/yawl/yawl_export.png",functionality:this.doExport.bind(this),group:ORYX.I18N.YAWL.exportGroup,isEnabled:function(){return true}.bind(this),index:2});this._showingCancelationSetFor=null;this.facade.offer({name:ORYX.I18N.YAWL.cancelationSetName,description:ORYX.I18N.YAWL.cancelationSetDesc,dropDownGroupIcon:ORYX.PATH+"images/yawl/yawl.png",icon:ORYX.PATH+"images/magnifier_zoom_out.png",functionality:this.doHighlightCancelationSet.bind(this),group:ORYX.I18N.YAWL.yawlGroup,index:1,toggle:true,minShape:1,maxShape:1});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.initialiseDiagram.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.onSelectElement.bind(this))},_extractNetID:function(a){return this._extractNet(a).properties.yawlid},_extractNetName:function(a){return this._extractNet(a).properties.name},_extractNet:function(a){return a},_getShapeSVGElement:function(c,a){var e=c.node.id+a;var d=c.node.ownerDocument.getElementById(e);if(!d){e=c.id+a;d=c.node.ownerDocument.getElementById(e)}return d},doImport:function(){this._showImportDialog()},_showRootNet:function(a){this.facade.importJSON(a.diagrams[0])},_buildDiagramTitle:function(c,a){if(a){return(c.properties.spectitle)?c.properties.spectitle:c.properties.specuri}else{var d=this._extractNetName(c);return(d)?d:this._extractNetID(c)}},_prepareAndImportNets:function(d){var a=[];var c=false;var e=d.diagrams.length;Ext.each(d.diagrams,function(l,h){var m=this._extractNetID(l);var f=Object.clone(this._dummyParameters);f.name=this._buildDiagramTitle(l,(d.rootNetName===m));f.description=((l.properties.specdescription)?l.properties.specdescription:"");f.json_xml=this._dummyRootnetData;var g=e-1;new Ajax.Request(ORYX.CONFIG.SERVER_MODEL_HANDLER,{parameters:f,asynchronous:false,method:"POST",onSuccess:function(o){var n=Ext.decode(o.responseText);var p=this._extractModelId(n);a.push({yawlid:m,data:l,signavioid:p,isRoot:(d.rootNetName===m)});e--;this.progressDialog.updateProgress(0.4,ORYX.I18N.YAWL.messageGetIDofNet+m);if(e==0){this._insertSubnetIdentifiers(a);this._saveSubnets(a)}}.bind(this),onFailure:function(){c=true;this.progressDialog.hide();Ext.Msg.alert(ORYX.I18N.YAWL.importFailed)}.bind(this)});return !c}.bind(this))},_extractModelId:function(a){return a.href.substr(7)},_buildDecomposeToLink:function(a){return ORYX.CONFIG.SERVER_EDITOR_HANDLER+"?id="+a},_extractModelIdFromLink:function(a){return a.substr(ORYX.CONFIG.SERVER_EDITOR_HANDLER.length+4)},_insertSubnetIdentifiers:function(a){this.progressDialog.updateProgress(0.5,ORYX.I18N.YAWL.messageInsertSubnetUrls);Ext.each(a,function(d,c){Ext.each(a,function(e,f){e.data.childShapes.each(function(g){if(g.stencil.id==="CompositeTask"||g.stencil.id==="CompositeMultipleTask"){if(g.properties.decompositionid===d.yawlid){g.properties.decompositionlink=this._buildDecomposeToLink(d.signavioid)}}}.bind(this))}.bind(this))}.bind(this))},_generateSVG:function(e){var g=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);g.addClassName("ORYX_Editor");g.visibility="hidden";$(document.body).appendChild(g);var c=ORYX.Core.StencilSet.stencil("http://b3mn.org/stencilset/yawl2.2#Diagram");var f=new ORYX.Core.Canvas({width:100,height:100,eventHandlerCallback:function(){return false},id:ORYX.Editor.provideId(),parentNode:g},c);var d=[];for(field in e){d.push({prefix:"oryx",name:field,value:e[field]})}f.deserialize(d);var a=f.addShapeObjects(e.childShapes,function(){return false});f.update();f.updateSize();return f.getSVGRepresentation(true)},_saveSubnets:function(a){var c=a.length;Ext.each(a,function(g,d){var h=ORYX.CONFIG.SERVER_MODEL_HANDLER+"/"+g.signavioid;var l=this._generateSVG(g.data);var f=DataManager.serialize(l);var e=Object.clone(this._dummyParameters);e.name=this._buildDiagramTitle(g.data,g.isRoot);e.description=((g.data.properties.specdescription)?g.data.properties.specdescription:"");e.json_xml=Ext.encode(g.data);e.svg_xml=f;new Ajax.Request(h,{parameters:e,asynchronous:false,method:"PUT",onSuccess:function(m){c--;this.progressDialog.updateProgress(0.7,ORYX.I18N.YAWL.messageSavingNet+g.yawlid);if(c==0){a.each(function(n){if(n.isRoot){this.progressDialog.updateProgress(1,"Import finished!");this.progressDialog.hide();Ext.Msg.getDialog().on("beforehide",function(){document.location=this._buildDecomposeToLink(n.signavioid)},this,{single:true});Ext.Msg.alert(ORYX.I18N.YAWL.importFinished,ORYX.I18N.YAWL.importFinishedText)}}.bind(this))}}.bind(this),onFailure:function(){this.progressDialog.hide();Ext.Msg.alert(ORYX.I18N.YAWL.importFailed)}})}.bind(this))},_showImportDialog:function(){var a=ORYX.CONFIG.YAWLIMPORTURL;var d=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.YAWL.selectFileText,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.YAWL.fileText,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var c=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.YAWL.importTitle,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[d],buttons:[{text:ORYX.I18N.YAWL.importButtonText,handler:function(){this.progressDialog=Ext.MessageBox.progress(ORYX.I18N.YAWL.importProgress);window.setTimeout(function(){var e=d.items.items[2].getValue();Ext.Ajax.request({url:a,method:"POST",success:function(f){var g=Ext.decode(f.responseText);if(g.hasFailed){alert(ORYX.I18N.YAWL.messageConversionFailed+g.warnings);this.progressDialog.hide()}else{if(g.hasWarnings){alert(ORYX.I18N.YAWL.messageConversionWarnings+g.warnings)}if(g.diagrams.length===1){this._showRootNet(g);this.progressDialog.hide()}else{this._prepareAndImportNets(g)}}}.bind(this),failure:function(){this.progressDialog.hide();Ext.Msg.alert(ORYX.I18N.YAWL.importFailed)},params:{data:e,action:"Import",standalone:"true"}})}.bind(this),100);c.hide()}.bind(this)},{text:ORYX.I18N.YAWL.closeButtonText,handler:function(){c.hide()}.bind(this)}]});c.on("hide",function(){c.destroy(true);delete c});c.show();d.items.items[1].getEl().dom.addEventListener("change",function(f){var e=new FileReader();var g=f.target.files[0];if(typeof(FileReader.prototype.addEventListener)==="function"){e.addEventListener("loadend",function(h){d.items.items[2].setValue(h.target.result)},false)}else{e.onload=function(h){d.items.items[2].setValue(h.target.result)}}e.readAsText(g,"UTF-8")},true)},_exportAjaxRequestCounter:0,doExport:function(){if(this._exportAjaxRequestCounter===0){var d=Ext.decode(this.facade.getSerializedJSON());var a={subDiagrams:[],rootDiagram:d};var c=this._extractNet(d);this._fetchSubnets(c,this._processSubnet.bind(this,a),this._submitExportData.bind(this,a))}else{Ext.Msg.alert("Export already in progress!")}},_fetchSubnets:function(d,a,c){this._exportAjaxRequestCounter+=d.childShapes.findAll(function(e){return((e.stencil.id==="CompositeTask"||e.stencil.id==="CompositeMultipleTask")&&e.properties.decompositionlink)}).size();if(this._exportAjaxRequestCounter===0){c()}d.childShapes.each(function(f){if(f.stencil.id==="CompositeTask"||f.stencil.id==="CompositeMultipleTask"){if(f.properties.decompositionlink){var g=this._extractModelIdFromLink(f.properties.decompositionlink);if(g){var m=ORYX.CONFIG.SERVER_MODEL_HANDLER+"/"+g+"/json";new Ajax.Request(m,{asynchronous:true,method:"GET",onSuccess:function(n){var p=Ext.decode(n.responseText);var o=this._extractNetID(p);f.properties.decompositionid=o;if(a&&typeof(a)==="function"){a(o,p)}this._exportAjaxRequestCounter--;if(this._exportAjaxRequestCounter===0){if(c&&typeof(c)==="function"){c()}}}.bind(this),onFailure:function(){Ext.Msg.alert(ORYX.I18N.YAWL.exportFailed);this._exportAjaxRequestCounter--}.bind(this)})}else{this._exportAjaxRequestCounter--}}else{var l=ORYX.Editor.provideId();var h=Ext.decode(this._dummySubnetData);var e=this._extractNet(h);e.properties.yawlid=l;f.properties.decompositionid=l;a(l,h)}}}.bind(this))},_processSubnet:function(a,d,c){a.subDiagrams.push({id:d,diagram:c});this._fetchSubnets(this._extractNet(c),this._processSubnet.bind(this,a),this._submitExportData.bind(this,a))},_submitExportData:function(c){var a=Ext.encode(c);Ext.Ajax.request({url:ORYX.CONFIG.YAWLEXPORTURL,method:"POST",success:function(e){var d=Ext.decode(e.responseText);if(d.hasFailed){Ext.Msg.alert(ORYX.I18N.YAWL.messageConversionFailed+d.warnings)}else{if(d.hasWarnings){alert(ORYX.I18N.YAWL.messageConversionWarnings+d.warnings)}this.openXMLWindow(d.yawlXML)}}.bind(this),failure:function(){Ext.Msg.alert(ORYX.I18N.YAWL.exportFailed)},params:{data:a,action:"Export",standalone:"true"}})},doHighlightCancelationSet:function(d,f){if(!this._showingCancelationSetFor){var e=this.facade.getSelection();if(e&&e.length>0){this._showingCancelationSetFor=e[0]}}if(this._showingCancelationSetFor){var c=Ext.decode(this._showingCancelationSetFor.properties["oryx-cancelationset"]);var g=this.facade.getCanvas().getChildShapes(true);var a=g.findAll(function(h){var l=c.items.find(function(m){return h.properties["oryx-yawlid"]==m.element});return l!=undefined});if(f){this.showOverlay(a)}else{this.hideOverlay()}}if(!f){this._showingCancelationSetFor=null}},showOverlay:function(a){var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":1,stroke:"red",d:"M0,0 L-10,-10 M-10,0 L0,-10","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"yawl.cancelationset",shapes:a,attributes:{stroke:"#FF0000"},node:c,nodePosition:"NE"})},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"yawl.cancelationset"})},propertyChanged:function(d,e){if(d.name=="oryx-cancelationset"){if(e){var a=this._getShapeSVGElement(e,"cancelation");if(a){if(d.value&&(d.value!="")){var c=Ext.decode(d.value);if((c.totalCount>0)||(c.items.length>0)){a.setAttribute("visibility","visible")}else{a.setAttribute("visibility","hidden")}}else{a.setAttribute("visibility","hidden")}}else{console.warn("Cancellation set marker not found on element: "+e)}}}},_unfoldMenu:null,onSelectElement:function(d){if(this._unfoldMenu){this._unfoldMenu.destroy();this._unfoldMenu=null}var c=d.elements[0];if(c&&d.elements.length===1&&c._stencil&&(c.getStencil().idWithoutNs()==="CompositeTask"||c.getStencil().idWithoutNs()==="CompositeMultipleTask")){var a=this._getShapeSVGElement(c,"decompositionlink");if(a){if(c.properties["oryx-decompositionlink"]&&c.properties["oryx-decompositionlink"]!=""){a.setAttribute("pointer-events","visiblePainted")}else{a.setAttribute("pointer-events","none");if(this._unfoldMenu){this._showUnfoldMenu(c)}else{this._createNewSubnetMenu(c,a)}}}else{Ext.Msg.alert('Error creating the "Unfold to Net menu"!')}}},_createNewSubnetMenu:function(c,a){this._unfoldMenu=new Ext.menu.Menu({id:"unfoldmenu",items:[{text:"Unfold to",icon:ORYX.PATH+"images/shape_ungroup.png",menu:{xtype:"menu",items:[new Ext.menu.Item({text:ORYX.I18N.YAWL.unfoldMenuNewSubnet,handler:function(e,d){this._createNewSubnet(c,a)}.bind(this)}),{id:c.node.id+"_menu_existing",text:ORYX.I18N.YAWL.unfoldMenuExistingSubnet,menu:{xtype:"menu",items:[ORYX.I18N.YAWL.unfoldMenuChooseSubnet,"-"]}}]}}]});this._retrieveAvailableSubnets(c,a,Ext.getCmp(c.node.id+"_menu_existing").menu);this._showUnfoldMenu(c)},_showUnfoldMenu:function(a){this._unfoldMenu.show(a.node);this._unfoldMenu.getEl().move("r",50);this._unfoldMenu.getEl().move("b",50)},_createNewSubnet:function(e,a){var d="<svg/>";var c=Object.clone(this._dummyParameters);if(e.properties["oryx-name"]){c.name=e.properties["oryx-name"]}new Ajax.Request(ORYX.CONFIG.SERVER_MODEL_HANDLER,{parameters:c,asynchronous:true,method:"POST",onSuccess:function(h){var f=Ext.decode(h.responseText);var g=this._buildDecomposeToLink(this._extractModelId(model));a.setAttribute("pointer-events","visiblePainted");e.setProperty("oryx-decompositionlink",g);e.refresh();this._unfoldMenu.destroy();Ext.Msg.alert(ORYX.I18N.YAWL.unfoldMenuSuccess,ORYX.I18N.YAWL.unfoldMenuSuccessText+g)}.bind(this),onFailure:function(){Ext.Msg.alert(ORYX.I18N.YAWL.unfoldNewMenuFailure)}.bind(this)})},_retrieveAvailableSubnets:function(c,a,d){new Ajax.Request(ORYX.CONFIG.SERVER_HANDLER_ROOT+"/directory/root-directory",{asynchronous:true,method:"GET",onSuccess:function(f){var e=Ext.decode(f.responseText);Ext.each(e,function(g){if(g.rel==="mod"){if(g.rep.type==="YAWL 2.2"){d.add(new Ext.menu.Item({text:g.rep.name,handler:function(m,l){a.setAttribute("pointer-events","visiblePainted");var h=this._buildDecomposeToLink(this._extractModelId(g));c.setProperty("oryx-decompositionlink",h);c.refresh();this._unfoldMenu.destroy();Ext.Msg.alert(ORYX.I18N.YAWL.unfoldMenuSuccess,ORYX.I18N.YAWL.unfoldMenuSuccessText+h)}.bind(this)}))}}}.bind(this))}.bind(this),onFailure:function(){Ext.Msg.alert(ORYX.I18N.YAWL.unfoldExistingMenuFailure)}.bind(this)})},initialiseDiagram:function(){},handlePropertiesDecorator:function(d,c){var a=c.getStencil().idWithoutNs();if(a==="AtomicTask"||a==="CompositeTask"||a==="MultipleAtomicTask"||a==="MultipleCompositeTask"){if(d.oldValue!=""){this._resetMagnet(d);if(d.elements[0].properties["oryx-join"]=="andL"||d.elements[0].properties["oryx-join"]=="xorL"||d.elements[0].properties["oryx-join"]=="orL"||d.elements[0].properties["oryx-split"]=="andL"||d.elements[0].properties["oryx-split"]=="xorL"||d.elements[0].properties["oryx-split"]=="orL"){d.elements[0].magnets[15].node.style.display="";d.elements[0].magnets[16].node.style.display="";d.elements[0].magnets[17].node.style.display="";d.elements[0].magnets[18].node.style.display="";d.elements[0].magnets[19].node.style.display=""}if(d.elements[0].properties["oryx-join"]=="andR"||d.elements[0].properties["oryx-join"]=="xorR"||d.elements[0].properties["oryx-join"]=="orR"||d.elements[0].properties["oryx-split"]=="andR"||d.elements[0].properties["oryx-split"]=="xorR"||d.elements[0].properties["oryx-split"]=="orR"){d.elements[0].magnets[20].node.style.display="";d.elements[0].magnets[21].node.style.display="";d.elements[0].magnets[22].node.style.display="";d.elements[0].magnets[23].node.style.display="";d.elements[0].magnets[24].node.style.display=""}if(d.elements[0].properties["oryx-join"]=="andT"||d.elements[0].properties["oryx-join"]=="xorT"||d.elements[0].properties["oryx-join"]=="orT"||d.elements[0].properties["oryx-split"]=="andT"||d.elements[0].properties["oryx-split"]=="xorT"||d.elements[0].properties["oryx-split"]=="orT"){d.elements[0].magnets[5].node.style.display="";d.elements[0].magnets[6].node.style.display="";d.elements[0].magnets[7].node.style.display="";d.elements[0].magnets[8].node.style.display="";d.elements[0].magnets[9].node.style.display=""}if(d.elements[0].properties["oryx-join"]=="andB"||d.elements[0].properties["oryx-join"]=="xorB"||d.elements[0].properties["oryx-join"]=="orB"||d.elements[0].properties["oryx-split"]=="andB"||d.elements[0].properties["oryx-split"]=="xorB"||d.elements[0].properties["oryx-split"]=="orB"){d.elements[0].magnets[10].node.style.display="";d.elements[0].magnets[11].node.style.display="";d.elements[0].magnets[12].node.style.display="";d.elements[0].magnets[13].node.style.display="";d.elements[0].magnets[14].node.style.display=""}}}},_resetMagnet:function(a){console.dir(a);a.elements[0].magnets[5].node.style.display="none";a.elements[0].magnets[6].node.style.display="none";a.elements[0].magnets[7].node.style.display="none";a.elements[0].magnets[8].node.style.display="none";a.elements[0].magnets[9].node.style.display="none";a.elements[0].magnets[10].node.style.display="none";a.elements[0].magnets[11].node.style.display="none";a.elements[0].magnets[12].node.style.display="none";a.elements[0].magnets[13].node.style.display="none";a.elements[0].magnets[14].node.style.display="none";a.elements[0].magnets[15].node.style.display="none";a.elements[0].magnets[16].node.style.display="none";a.elements[0].magnets[17].node.style.display="none";a.elements[0].magnets[18].node.style.display="none";a.elements[0].magnets[19].node.style.display="none";a.elements[0].magnets[20].node.style.display="none";a.elements[0].magnets[21].node.style.display="none";a.elements[0].magnets[22].node.style.display="none";a.elements[0].magnets[23].node.style.display="none";a.elements[0].magnets[24].node.style.display="none"}});(function(){var a=ORYX.Core.StencilSet.Rules.prototype;var c=a.canConnect;a.canConnect=function(e){var d=true;d=d&&c.apply(this,arguments);if(d){var f=e.edgeStencil.stencilSet().jsonRules();if(f.canConnect!==undefined){d=f.canConnect(e)}}return d}})();if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.CONFIG.EPMLLAYOUTURL=ORYX.CONFIG.ROOT_PATH+"epmllayout";ORYX.Plugins.EPCLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-EPC",description:"Layout EPC Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.EPMLLAYOUTURL,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON()},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(c){var a=ORYX.Core.Command.extend({construct:function(g,f){this.layoutArray=g;this.plugin=f;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(l){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(l.id);var h={id:l.id,bounds:f.bounds.clone()};this.oldLayoutArray.push(h);var g=l.bounds.split(" ");f.bounds.set(g[0],g[1],g[2],g[3]);if(l.dockers!=null){this.plugin.setDockersBad(f,l.dockers)}f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(g){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(g.id);f.bounds.set(g.bounds);f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var e=c.responseText.evalJSON();if(e instanceof Array&&e.size()>0){var d=new a(e,this);this.facade.executeCommands([d])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(d,a){var c="";a.each(function(e){c+=e.x+" "+e.y+" "});c+=" # ";d.deserialize([{prefix:"oryx",name:"dockers",value:c}])},setDockersGood:function(d,a){if(elem.dockers.length==1){}else{var a=d.getDockers().slice(1,-1);a.each(function(g){d.removeDocker(g)});var f=d.getDockers()[0];if(f.getDockedShape()){f.setReferencePoint(elem.dockers[0])}else{f.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}f.refresh();var e=d.getDockers()[1];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{e.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}e.refresh();var c=elem.dockers.slice(1,-1);c.each(function(h){var g=d.createDocker();g.parent=d;g.bounds.centerMoveTo(h.x,h.y);g.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.PetriNet={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this))},handlePropertyChanged:function(d){var c=d.elements;var e=d.key;var a=d.value;var f=false;c.each(function(g){if((g.getStencil().id()==="http://b3mn.org/stencilset/petrinet#Place")&&(e==="oryx-numberoftokens")){if(a==0){g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","0")}else{if(a==1){g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","1")}else{if(a==2){g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","2")}else{if(a==3){g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","3")}else{if(a==4){g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","4")}else{var h=parseInt(a,10);if(h&&h>0){g.setProperty("oryx-numberoftokens_text",""+h);g.setProperty("oryx-numberoftokens_drawing","0")}else{g.setProperty("oryx-numberoftokens_text","");g.setProperty("oryx-numberoftokens_drawing","0")}}}}}}f=true}});if(f){this.facade.getCanvas().update()}}};ORYX.Plugins.PetriNet=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.PetriNet);if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayout";ORYX.Plugins.BpmnLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-BPMN",description:"Layout BPMN Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.BPMN_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON(),output:"coordinatesonly"},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(c){var a=ORYX.Core.Command.extend({construct:function(g,f){this.layoutArray=g;this.plugin=f;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(l){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(l.id);var h={id:l.id,bounds:f.bounds.clone()};this.oldLayoutArray.push(h);var g=l.bounds.split(" ");f.bounds.set(g[0],g[1],g[2],g[3]);if(l.dockers!=null){this.plugin.setDockersBad(f,l.dockers)}f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(g){var f=this.plugin.facade.getCanvas().getChildShapeByResourceId(g.id);f.bounds.set(g.bounds);f.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var e=c.responseText.evalJSON();if(e instanceof Array&&e.size()>0){var d=new a(e,this);this.facade.executeCommands([d])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(d,a){var c="";a.each(function(e){c+=e.x+" "+e.y+" "});c+=" # ";d.deserialize([{prefix:"oryx",name:"dockers",value:c}])},setDockersGood:function(d,a){if(elem.dockers.length==1){}else{var a=d.getDockers().slice(1,-1);a.each(function(g){d.removeDocker(g)});var f=d.getDockers()[0];if(f.getDockedShape()){f.setReferencePoint(elem.dockers[0])}else{f.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}f.refresh();var e=d.getDockers()[1];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{e.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}e.refresh();var c=elem.dockers.slice(1,-1);c.each(function(h){var g=d.createDocker(undefined,h);g.parent=d;g.bounds.centerMoveTo(h.x,h.y);g.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Save=Clazz.extend({facade:undefined,processURI:undefined,changeSymbol:"*",construct:function(a){this.facade=a},updateTitle:function(){var c=window.document.title;var a=document.getElementsByTagName("title")[0];if(a){var d=a.childNodes[0];if(d){c=a.nodeValue}}if(c){if(this.changeDifference===0&&c.startsWith(this.changeSymbol)){window.document.title=c.slice(1)}else{if(this.changeDifference!==0&&!c.startsWith(this.changeSymbol)){window.document.title=this.changeSymbol+""+c}}}},onUnLoad:function(){if(this.changeDifference!==0||(this.facade.getModelMetaData()["new"]&&this.facade.getCanvas().getChildShapes().size()>0)){return ORYX.I18N.Save.unsavedData}},saveSynchronously:function(g,h){if(!h){return}var d=this.facade.getModelMetaData();var e=d.modelHandler;var m=this.facade.getStencilSets().values()[0];var l=m.title();var a=(d["new"]&&d.name==="")?ORYX.I18N.Save.newProcess:h.name;var c={title:Signavio.Utils.escapeHTML(a||""),summary:Signavio.Utils.escapeHTML(h.description||""),type:l,url:e,namespace:h.model.stencilset.namespace,comment:""};var f=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">',"<fieldset>",'<p class="description">'+ORYX.I18N.Save.dialogDesciption+"</p>",'<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{title}" id="edit_model_title" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label><textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{summary}</textarea></p>',(d.versioning)?'<p><label for="edit_model_comment">'+ORYX.I18N.Save.dialogLabelComment+'</label><textarea rows="5" name="comment" id="edit_model_comment" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{comment}</textarea></p>':"",'<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>',"</fieldset>","</form>");callback=function(q){var E=q.elements.title.value.strip();E=E.length==0?c.title:E;var t=q.elements.summary.value.strip();t=t.length==0?c.summary:t;var x=q.elements.namespace.value.strip();x=x.length==0?c.namespace:x;var o=q.elements.comment.value.strip();o=o.length==0?c.comment:o;d.name=E;d.description=t;d.parent=h.parent;d.namespace=x;if(!g){window.document.title=this.changeSymbol+E+" | "+ORYX.CONFIG.APPNAME}var B=this.facade.getJSON();var y=[];if(this.facade.hasGlossaryExtension){Ext.apply(B,ORYX.Core.AbstractShape.JSONHelper);var z=B.getChildShapes(true);var p={};this.facade.getGlossary().each(function(F){if("undefined"==typeof p[F.shape.resourceId+"-"+F.property.prefix()+"-"+F.property.id()]){p[F.shape.resourceId+"-"+F.property.prefix()+"-"+F.property.id()]=0}y.push({itemId:F.glossary,elementId:F.shape.resourceId,propertyId:F.property.prefix()+"-"+F.property.id(),order:p[F.shape.resourceId+"-"+F.property.prefix()+"-"+F.property.id()]++});if(F.property.refToView()&&F.property.refToView().length>0){F.property.refToView().each(function(H){var G=$(F.shape.id+""+H);if(G){G.setAttribute("oryx:glossaryIds",F.glossary+";")}})}}.bind(this));B=B.serialize()}else{B=Ext.encode(B)}y=Ext.encode(y);var D=this.facade.getSelection();this.facade.setSelection([]);var n=this.facade.getCanvas().getSVGRepresentation(true);this.facade.setSelection(D);if(this.facade.getCanvas().properties["oryx-showstripableelements"]===false){var s=n.getElementsByClassName("stripable-element");for(var A=s.length-1;A>=0;A--){s[A].parentNode.removeChild(s[A])}}var s=n.getElementsByClassName("stripable-element-force");for(var A=s.length-1;A>=0;A--){s[A].parentNode.removeChild(s[A])}var r=DataManager.serialize(n);var C={json_xml:B,svg_xml:r,name:E,type:c.type,parent:d.parent,description:t,comment:o,glossary_xml:y,namespace:d.namespace,views:Ext.util.JSON.encode(d.views||[])};var u=false;var v=function(J){var I=J.getResponseHeader.location;if(!this.processURI&&I){this.processURI=I}if(g){var H=J.responseText.evalJSON();var G=location.href.substring(0,location.href.indexOf(location.search))+"?id="+H.href.substring(7);var F=new Ext.Window({title:ORYX.I18N.Save.savedAs,bodyStyle:"background:white;padding:10px",width:"auto",height:"auto",html:"<div style='font-weight:bold;margin-bottom:10px'>"+ORYX.I18N.Save.savedDescription+":</div><span><a href='"+G+"' target='_blank'>"+G+"</a></span>",buttons:[{text:"Ok",handler:function(){F.destroy()}}]});F.show();window.open(G)}u=true;win.close();if(u){this.changeDifference=0;this.updateTitle();if(d["new"]){d["new"]=false}}delete this.saving}.bind(this);var w=function(F){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.close();if(F.status&&F.status===401){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.notAuthorized).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize()}else{if(F.status&&F.status===403){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize()}else{if(F.statusText==="transaction aborted"){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.transAborted).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize()}else{if(F.statusText==="communication failure"){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.comFailed).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize()}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize()}}}}delete this.saving}.bind(this);if(d["new"]){C.id=d.modelId;this.sendSaveRequest("POST",e,C,g,v,w)}else{if(g){this.sendSaveRequest("POST",e,C,g,v,w)}else{if(!e.include(d.modelId)){e+="/"+d.modelId}C.id=d.modelId;this.sendSaveRequest("PUT",e,C,false,v,w)}}}.bind(this);win=new Ext.Window({id:"Propertie_Window",width:"auto",height:"auto",title:g?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save,modal:true,resize:false,bodyStyle:"background:#FFFFFF",html:f.apply(c),defaultButton:0,buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){win.body.mask(ORYX.I18N.Save.pleaseWait,"x-waiting-box");window.setTimeout(function(){callback($("edit_model"))}.bind(this),10)},listeners:{render:function(){this.focus()}}},{text:ORYX.I18N.Save.close,handler:function(){win.close()}.bind(this)}],listeners:{close:function(){win.destroy();delete this.saving}.bind(this)}});win.show()},retrieveModelData:function(c){var a=function(){Ext.getBody().unmask()};new Ajax.Request(window.location.href.replace(/#.*/g,"")+"&data",{method:"get",asynchronous:true,requestHeaders:{Accept:"application/json"},encoding:"UTF-8",onSuccess:(function(d){modelInfo=(d.responseText||"{}").evalJSON();a();c(modelInfo)}).bind(this),onException:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.exception).setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize()}.bind(this),onFailure:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,"from file.js").setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize()}).bind(this),on401:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.notAuthorized).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).syncSize()}).bind(this),on403:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights).setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize()}).bind(this)})},sendSaveRequest:function(g,c,f,d,e,a){Ext.Ajax.request({url:c,method:g,timeout:1800000,disableCaching:true,headers:{Accept:"application/json","Content-Type":"charset=UTF-8"},params:f,success:e,failure:a})},save:function(a,c){if(this.saving){return}this.saving=true;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ABOUT_TO_SAVE});window.setTimeout((function(){var d=this.facade.getModelMetaData();if(d["new"]){this.saveSynchronously(a,d)}else{Ext.getBody().mask(ORYX.I18N.Save.retrieveData,"x-waiting-box");this.retrieveModelData(this.saveSynchronously.bind(this,a))}}).bind(this),10);return true}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.File=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.File.print,functionality:this.print.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/printer.png",description:ORYX.I18N.File.printDesc,index:3,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.pdf,functionality:this.exportPDF.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/page_white_acrobat.png",description:ORYX.I18N.File.pdfDesc,index:3,minShape:0,maxShape:0})},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var d=location.href;var c=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(c);new Ajax.Request(ORYX.CONFIG.PDF_EXPORT_URL,{method:"POST",parameters:{resource:d,data:a,format:"pdf"},onSuccess:(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});window.open(e.responseText)}).bind(this),onFailure:(function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.File.genPDFFailed)}).bind(this)})},print:function(){Ext.Msg.show({title:ORYX.I18N.File.printTitle,msg:ORYX.I18N.File.printMsg,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(d){if(d=="yes"){var f=$H({width:300,height:400,toolbar:"no",status:"no",menubar:"yes",dependent:"yes",resizable:"yes",scrollbars:"yes"});var g=window.open("","PrintWindow",f.invoke("join","=").join(","));var c=g.document.getElementsByTagName("head")[0];var e=document.createElement("style");e.innerHTML=" body {padding:0px; margin:0px} .svgcontainer { display:none; }";c.appendChild(e);g.document.getElementsByTagName("body")[0].appendChild(this.facade.getCanvas().getSVGRepresentation());var a=g.document.getElementsByTagName("body")[0].getElementsByTagName("svg")[0];a.setAttributeNS(null,"width",1100);a.setAttributeNS(null,"height",1400);a.lastChild.setAttributeNS(null,"transform","scale(0.47, 0.47) rotate(270, 1510, 1470)");var l=["marker-start","marker-mid","marker-end"];var h=$A(g.document.getElementsByTagName("path"));h.each(function(m){l.each(function(n){var o=m.getAttributeNS(null,n);if(!o){return}o="url(about:blank#"+o.slice(5);m.setAttributeNS(null,n,o)})});g.print();return true}}.bind(this)})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.JSONSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.JSONSupport.exp.name,functionality:this.exportJSON.bind(this),group:ORYX.I18N.JSONSupport.exp.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_javascript.png",description:ORYX.I18N.JSONSupport.exp.desc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.JSONSupport.imp.name,functionality:this.showImportDialog.bind(this),group:ORYX.I18N.JSONSupport.imp.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/page_white_javascript.png",description:ORYX.I18N.JSONSupport.imp.desc,index:1,minShape:0,maxShape:0})},exportJSON:function(){var a=this.facade.getSerializedJSON();this.openDownloadWindow(window.document.title+".json",a)},showImportDialog:function(a){var d=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.JSONSupport.imp.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.JSONSupport.imp.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var c=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.JSONSupport.imp.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[d],buttons:[{text:ORYX.I18N.JSONSupport.imp.btnImp,handler:function(){var e=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.JSONSupport.imp.progress});e.show();window.setTimeout(function(){var g=d.items.items[2].getValue();try{this.facade.importJSON(g,true);c.close()}catch(f){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,f.message)}finally{e.hide()}}.bind(this),100)}.bind(this)},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){c.close()}.bind(this)}]});c.show();d.items.items[1].getEl().dom.addEventListener("change",function(e){var f=e.target.files[0].getAsText("UTF-8");d.items.items[2].setValue(f)},true)}});ORYX.CONFIG.EDITOR_PATH="/editor";